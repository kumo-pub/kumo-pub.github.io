(self.webpackChunkkumo_website=self.webpackChunkkumo_website||[]).push([[1847],{53464:(n,e,l)=>{n.exports={src:{srcSet:l.p+"assets/ideal-img/pchan.90ee64a.640.png 640w,"+l.p+"assets/ideal-img/pchan.9677ab5.746.png 746w",images:[{path:l.p+"assets/ideal-img/pchan.90ee64a.640.png",width:640,height:269},{path:l.p+"assets/ideal-img/pchan.9677ab5.746.png",width:746,height:314}],src:l.p+"assets/ideal-img/pchan.90ee64a.640.png",toString:function(){return l.p+"assets/ideal-img/pchan.90ee64a.640.png"},placeholder:void 0,width:640,height:269},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAECAYAAAC3OK7NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAXElEQVR4nGWNWQqAMAxEe/+zVpt0SV2qT1LwRwcGBmYLqoqIYGa01qi1Msbgi+DmG+hmqAiSEhwHdIPepw4557momimlsK4LMUbu84SX10XwS1/zggddb/v2u34AzxubucR0AxUAAAAASUVORK5CYII="}},26239:(n,e,l)=>{"use strict";l.r(e),l.d(e,{assets:()=>p,contentTitle:()=>t,default:()=>u,frontMatter:()=>i,metadata:()=>h,toc:()=>o});var r=l(74848),s=l(28453),a=l(53464),c=l.n(a);const i={},t="\u670d\u52a1\u6cbb\u7406",h={id:"cpp/krpc/combo_channel",title:"\u670d\u52a1\u6cbb\u7406",description:'\u968f\u7740\u670d\u52a1\u89c4\u6a21\u7684\u589e\u5927\uff0c\u5bf9\u4e0b\u6e38\u7684\u8bbf\u95ee\u6d41\u7a0b\u4f1a\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u5176\u4e2d\u5f80\u5f80\u5305\u542b\u591a\u4e2a\u540c\u65f6\u53d1\u8d77\u7684RPC\u6216\u6709\u590d\u6742\u7684\u5c42\u6b21\u7ed3\u6784\u3002\u4f46\u8fd9\u7c7b\u4ee3\u7801\u7684\u591a\u7ebf\u7a0b\u9677\u9631\u5f88\u591a\uff0c\u7528\u6237\u53ef\u80fd\u5199\u51fa\u4e86bug\u4e5f\u4e0d\u81ea\u77e5\uff0c\u590d\u73b0\u548c\u8c03\u8bd5\u4e5f\u6bd4\u8f83\u56f0\u96be\u3002\u800c\u4e14\u5b9e\u73b0\u8981\u4e48\u53ea\u80fd\u652f\u6301\u540c\u6b65\u7684\u60c5\u51b5\uff0c\u8981\u4e48\u5f97\u4e3a\u5f02\u6b65\u91cd\u5199\u4e00\u5957\u3002\u4ee5"\u5728\u591a\u4e2a\u5f02\u6b65RPC\u5b8c\u6210\u540e\u8fd0\u884c\u4e00\u4e9b\u4ee3\u7801"\u4e3a\u4f8b\uff0c\u5b83\u7684\u540c\u6b65\u5b9e\u73b0\u4e00\u822c\u662f\u5f02\u6b65\u5730\u53d1\u8d77\u591a\u4e2aRPC\uff0c\u7136\u540e\u9010\u4e2a\u7b49\u5f85\u5404\u81ea\u5b8c\u6210\uff1b\u5b83\u7684\u5f02\u6b65\u5b9e\u73b0\u4e00\u822c\u662f\u7528\u4e00\u4e2a\u5e26\u8ba1\u6570\u5668\u7684\u56de\u8c03\uff0c\u6bcf\u5f53\u4e00\u4e2aRPC\u5b8c\u6210\u65f6\u8ba1\u6570\u5668\u51cf\u4e00\uff0c\u76f4\u52300\u65f6\u8c03\u7528\u56de\u8c03\u3002\u53ef\u4ee5\u770b\u5230\u5b83\u7684\u7f3a\u70b9\uff1a',source:"@site/docs/cpp/krpc/combo_channel.mdx",sourceDirName:"cpp/krpc",slug:"/cpp/krpc/combo_channel",permalink:"/docs/next/cpp/krpc/combo_channel",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"http\u5ef6\u5c55\u9605\u8bfb",permalink:"/docs/next/cpp/krpc/http_derivatives"},next:{title:"kthread",permalink:"/docs/next/cpp/krpc/kthread"}},p={},o=[{value:"ParallelChannel",id:"ParallelChannel",level:2},{value:"\u63d2\u5165sub channel",id:"\u63d2\u5165sub-channel",level:3},{value:"CallMapper",id:"callmapper",level:3},{value:"ResponseMerger",id:"responsemerger",level:3},{value:"\u83b7\u5f97\u8bbf\u95eesub channel\u65f6\u7684controller",id:"\u83b7\u5f97\u8bbf\u95eesub-channel\u65f6\u7684controller",level:3},{value:"SelectiveChannel",id:"selectivechannel",level:2},{value:"\u4f7f\u7528SelectiveChannel",id:"\u4f7f\u7528selectivechannel",level:3},{value:"\u4f8b\u5b50: \u5f80\u591a\u4e2a\u547d\u540d\u670d\u52a1\u5206\u6d41",id:"\u4f8b\u5b50-\u5f80\u591a\u4e2a\u547d\u540d\u670d\u52a1\u5206\u6d41",level:3},{value:"PartitionChannel",id:"partitionchannel",level:2},{value:"\u4f7f\u7528PartitionChannel",id:"\u4f7f\u7528partitionchannel",level:3},{value:"\u4f7f\u7528DynamicPartitionChannel",id:"\u4f7f\u7528dynamicpartitionchannel",level:3}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"\u670d\u52a1\u6cbb\u7406",children:"\u670d\u52a1\u6cbb\u7406"})}),"\n",(0,r.jsx)(e.p,{children:'\u968f\u7740\u670d\u52a1\u89c4\u6a21\u7684\u589e\u5927\uff0c\u5bf9\u4e0b\u6e38\u7684\u8bbf\u95ee\u6d41\u7a0b\u4f1a\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u5176\u4e2d\u5f80\u5f80\u5305\u542b\u591a\u4e2a\u540c\u65f6\u53d1\u8d77\u7684RPC\u6216\u6709\u590d\u6742\u7684\u5c42\u6b21\u7ed3\u6784\u3002\u4f46\u8fd9\u7c7b\u4ee3\u7801\u7684\u591a\u7ebf\u7a0b\u9677\u9631\u5f88\u591a\uff0c\u7528\u6237\u53ef\u80fd\u5199\u51fa\u4e86bug\u4e5f\u4e0d\u81ea\u77e5\uff0c\u590d\u73b0\u548c\u8c03\u8bd5\u4e5f\u6bd4\u8f83\u56f0\u96be\u3002\u800c\u4e14\u5b9e\u73b0\u8981\u4e48\u53ea\u80fd\u652f\u6301\u540c\u6b65\u7684\u60c5\u51b5\uff0c\u8981\u4e48\u5f97\u4e3a\u5f02\u6b65\u91cd\u5199\u4e00\u5957\u3002\u4ee5"\u5728\u591a\u4e2a\u5f02\u6b65RPC\u5b8c\u6210\u540e\u8fd0\u884c\u4e00\u4e9b\u4ee3\u7801"\u4e3a\u4f8b\uff0c\u5b83\u7684\u540c\u6b65\u5b9e\u73b0\u4e00\u822c\u662f\u5f02\u6b65\u5730\u53d1\u8d77\u591a\u4e2aRPC\uff0c\u7136\u540e\u9010\u4e2a\u7b49\u5f85\u5404\u81ea\u5b8c\u6210\uff1b\u5b83\u7684\u5f02\u6b65\u5b9e\u73b0\u4e00\u822c\u662f\u7528\u4e00\u4e2a\u5e26\u8ba1\u6570\u5668\u7684\u56de\u8c03\uff0c\u6bcf\u5f53\u4e00\u4e2aRPC\u5b8c\u6210\u65f6\u8ba1\u6570\u5668\u51cf\u4e00\uff0c\u76f4\u52300\u65f6\u8c03\u7528\u56de\u8c03\u3002\u53ef\u4ee5\u770b\u5230\u5b83\u7684\u7f3a\u70b9\uff1a'}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u540c\u6b65\u548c\u5f02\u6b65\u4ee3\u7801\u4e0d\u4e00\u81f4\u3002\u7528\u6237\u65e0\u6cd5\u8f7b\u6613\u5730\u4ece\u4e00\u4e2a\u6a21\u5f0f\u8f6c\u4e3a\u53e6\u4e00\u79cd\u6a21\u5f0f\u3002\u4ece\u8bbe\u8ba1\u7684\u89d2\u5ea6\uff0c\u4e0d\u4e00\u81f4\u6697\u793a\u4e86\u6ca1\u6709\u6293\u4f4f\u672c\u8d28\u3002"}),"\n",(0,r.jsx)(e.li,{children:"\u5f80\u5f80\u4e0d\u80fd\u88ab\u53d6\u6d88\u3002\u6b63\u786e\u53ca\u65f6\u5730\u53d6\u6d88\u4e00\u4e2a\u64cd\u4f5c\u4e0d\u662f\u4e00\u4ef6\u6613\u4e8b\uff0c\u4f55\u51b5\u662f\u7ec4\u5408\u8bbf\u95ee\u3002\u4f46\u53d6\u6d88\u5bf9\u4e8e\u7ec8\u7ed3\u65e0\u610f\u4e49\u7684\u7b49\u5f85\u662f\u5f88\u5fc5\u8981\u7684\u3002"}),"\n",(0,r.jsx)(e.li,{children:'\u4e0d\u80fd\u7ee7\u7eed\u7ec4\u5408\u3002\u6bd4\u5982\u4f60\u5f88\u96be\u628a\u4e00\u4e2a\u4e0a\u8ff0\u5b9e\u73b0\u53d8\u6210\u201c\u66f4\u5927"\u7684\u8bbf\u95ee\u6a21\u5f0f\u7684\u4e00\u90e8\u5206\u3002\u6362\u4e2a\u573a\u666f\u8fd8\u5f97\u91cd\u5199\u4e00\u5957\u3002'}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6211\u4eec\u9700\u8981\u66f4\u597d\u7684\u62bd\u8c61\u3002\u5982\u679c\u6211\u4eec\u80fd\u4ee5\u4e0d\u540c\u7684\u65b9\u5f0f\u628a\u4e00\u4e9bChannel\u7ec4\u5408\u4e3a\u66f4\u5927\u7684Channel\uff0c\u5e76\u628a\u4e0d\u540c\u7684\u8bbf\u95ee\u6a21\u5f0f\u7f6e\u5165\u5176\u4e2d\uff0c\u90a3\u4e48\u7528\u6237\u53ef\u4ee5\u4fbf\u7528\u7edf\u4e00\u63a5\u53e3\u5b8c\u6210\u540c\u6b65\u3001\u5f02\u6b65\u3001\u53d6\u6d88\u7b49\u64cd\u4f5c\u3002\u8fd9\u79cdchannel\u5728krpc\u4e2d\u88ab\u79f0\u4e3a\u7ec4\u5408channel\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"ParallelChannel",children:"ParallelChannel"}),"\n",(0,r.jsx)(e.p,{children:"ParallelChannel (\u6709\u65f6\u88ab\u79f0\u4e3a\u201cpchan\u201d)\u540c\u65f6\u8bbf\u95ee\u5176\u5305\u542b\u7684sub channel\uff0c\u5e76\u5408\u5e76\u5b83\u4eec\u7684\u7ed3\u679c\u3002\u7528\u6237\u53ef\u901a\u8fc7CallMapper\u4fee\u6539\u8bf7\u6c42\uff0c\u901a\u8fc7ResponseMerger\u5408\u5e76\u7ed3\u679c\u3002ParallelChannel\u770b\u8d77\u6765\u5c31\u50cf\u662f\u4e00\u4e2aChannel\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u652f\u6301\u540c\u6b65\u548c\u5f02\u6b65\u8bbf\u95ee\u3002"}),"\n",(0,r.jsx)(e.li,{children:"\u53d1\u8d77\u5f02\u6b65\u64cd\u4f5c\u540e\u53ef\u4ee5\u7acb\u523b\u5220\u9664\u3002"}),"\n",(0,r.jsx)(e.li,{children:"\u53ef\u4ee5\u53d6\u6d88\u3002"}),"\n",(0,r.jsx)(e.li,{children:"\u652f\u6301\u8d85\u65f6\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u793a\u4f8b\u4ee3\u7801\u89c1",(0,r.jsx)(e.a,{href:"https://github.com/apache/krpc/tree/master/example/parallel_echo_c++/",children:"example/parallel_echo_c++"}),"\u3002"]}),"\n",(0,r.jsx)(e.p,{children:"\u4efb\u4f55krpc::ChannelBase\u7684\u5b50\u7c7b\u90fd\u53ef\u4ee5\u52a0\u5165ParallelChannel\uff0c\u5305\u62ecParallelChannel\u548c\u5176\u4ed6\u7ec4\u5408Channel\u3002\u7528\u6237\u53ef\u4ee5\u8bbe\u7f6eParallelChannelOptions.fail_limit\u6765\u63a7\u5236\u8bbf\u95ee\u7684\u6700\u5927\u5931\u8d25\u6b21\u6570\uff0c\u5f53\u5931\u8d25\u7684\u8bbf\u95ee\u8fbe\u5230\u8fd9\u4e2a\u6570\u76ee\u65f6\uff0cRPC\u4f1a\u7acb\u523b\u7ed3\u675f\u800c\u4e0d\u7b49\u5f85\u8d85\u65f6\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u4e00\u4e2asub channel\u53ef\u591a\u6b21\u52a0\u5165\u540c\u4e00\u4e2aParallelChannel\u3002\u5f53\u4f60\u9700\u8981\u5bf9\u540c\u4e00\u4e2a\u670d\u52a1\u53d1\u8d77\u591a\u6b21\u5f02\u6b65\u8bbf\u95ee\u5e76\u7b49\u5f85\u5b83\u4eec\u5b8c\u6210\u7684\u8bdd\uff0c\u8fd9\u5f88\u6709\u7528\u3002"}),"\n",(0,r.jsx)(e.p,{children:"ParallelChannel\u7684\u5185\u90e8\u7ed3\u6784\u5927\u81f4\u5982\u4e0b\uff1a"}),"\n","\n",(0,r.jsx)("img",{src:c()}),"\n",(0,r.jsx)(e.h3,{id:"\u63d2\u5165sub-channel",children:"\u63d2\u5165sub channel"}),"\n",(0,r.jsx)(e.p,{children:"\u53ef\u901a\u8fc7\u5982\u4e0b\u63a5\u53e3\u628asub channel\u63d2\u5165ParallelChannel\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"int AddChannel(krpc::ChannelBase* sub_channel,\n               ChannelOwnership ownership,\n               CallMapper* call_mapper,\n               ResponseMerger* response_merger);\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5f53ownership\u4e3akrpc::OWNS_CHANNEL\u65f6\uff0csub_channel\u4f1a\u5728ParallelChannel\u6790\u6784\u65f6\u88ab\u5220\u9664\u3002\u4e00\u4e2asub channel\u53ef\u80fd\u4f1a\u591a\u6b21\u52a0\u5165\u4e00\u4e2aParallelChannel\uff0c\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u6307\u660e\u4e86ownership\u4e3akrpc::OWNS_CHANNEL\uff0c\u90a3\u4e2asub channel\u4f1a\u5728ParallelChannel\u6790\u6784\u65f6\u88ab\u6700\u591a\u5220\u9664\u4e00\u6b21\u3002"}),"\n",(0,r.jsxs)(e.p,{children:["\u8bbf\u95eeParallelChannel\u65f6\u8c03\u7528AddChannel\u662f",(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u4e0d\u5b89\u5168"}),"\u7684\u3002"]}),"\n",(0,r.jsx)(e.h3,{id:"callmapper",children:"CallMapper"}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u4e8e\u628a\u5bf9ParallelChannel\u7684\u8c03\u7528\u8f6c\u5316\u4e3a\u5bf9sub channel\u7684\u8c03\u7528\u3002\u5982\u679ccall_mapper\u662fNULL\uff0csub channel\u7684\u8bf7\u6c42\u5c31\u662fParallelChannel\u7684\u8bf7\u6c42\uff0c\u800cresponse\u5219New()\u81eaParallelChannel\u7684response\u3002\u5982\u679ccall_mapper\u4e0d\u4e3aNULL\uff0c\u5219\u4f1a\u5728ParallelChannel\u6790\u6784\u65f6\u88ab\u5220\u9664\u3002call_mapper\u5185\u542b\u5f15\u7528\u8ba1\u6570\uff0c\u4e00\u4e2acall_mapper\u53ef\u4e0e\u591a\u4e2asub channel\u5173\u8054\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"class CallMapper {\npublic:\n    virtual ~CallMapper();\n \n    virtual SubCall Map(int channel_index/*starting from 0*/,\n                        int channel_count,\n                        const google::protobuf::MethodDescriptor* method,\n                        const google::protobuf::Message* request,\n                        google::protobuf::Message* response) = 0;\n};\n"})}),"\n",(0,r.jsx)(e.p,{children:"channel_index\uff1a\u8be5sub channel\u5728ParallelChannel\u4e2d\u7684\u4f4d\u7f6e\uff0c\u4ece0\u5f00\u59cb\u8ba1\u6570\u3002"}),"\n",(0,r.jsx)(e.p,{children:"channel_count\uff1aParallelChannel\u4e2dsub channel\u7684\u6570\u91cf\u3002"}),"\n",(0,r.jsx)(e.p,{children:"method/request/response\uff1aParallelChannel.CallMethod()\u7684\u53c2\u6570\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u8fd4\u56de\u7684SubCall\u88ab\u7528\u4e8e\u8bbf\u95ee\u5bf9\u5e94sub channel\uff0cSubCall\u6709\u4e24\u4e2a\u7279\u6b8a\u503c\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u8fd4\u56deSubCall::Bad()\u5219\u5bf9ParallelChannel\u7684\u8be5\u6b21\u8bbf\u95ee\u7acb\u523b\u5931\u8d25\uff0cController.ErrorCode()\u4e3aEREQUEST\u3002"}),"\n",(0,r.jsx)(e.li,{children:"\u8fd4\u56deSubCall::Skip()\u5219\u8df3\u8fc7\u5bf9\u8be5sub channel\u7684\u8bbf\u95ee\uff0c\u5982\u679c\u6240\u6709\u7684sub channel\u90fd\u88ab\u8df3\u8fc7\u4e86\uff0c\u8be5\u6b21\u8bbf\u95ee\u7acb\u523b\u5931\u8d25\uff0cController.ErrorCode()\u4e3aECANCELED\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u89c1\u7684Map()\u5b9e\u73b0\u6709\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5e7f\u64adrequest\u3002\u8fd9\u4e5f\u662fcall_mapper\u4e3aNULL\u65f6\u7684\u884c\u4e3a\uff1a"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"  class Broadcaster : public CallMapper {\n  public:\n      SubCall Map(int channel_index/*starting from 0*/,\n                  const google::protobuf::MethodDescriptor* method,\n                  const google::protobuf::Message* request,\n                  google::protobuf::Message* response) {\n          // method/request\u548cpchan\u4fdd\u6301\u4e00\u81f4.\n          // response\u662fnew\u51fa\u6765\u7684\uff0c\u6700\u540e\u7684flag\u544a\u8bc9pchan\u5728RPC\u7ed3\u675f\u540e\u5220\u9664Response\u3002\n          return SubCall(method, request, response->New(), DELETE_RESPONSE);\n      }\n  };\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4fee\u6539request\u4e2d\u7684\u5b57\u6bb5\u540e\u518d\u53d1\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"  class ModifyRequest : public CallMapper {\n  public:\n    SubCall Map(int channel_index/*starting from 0*/,\n                const google::protobuf::MethodDescriptor* method,\n                const google::protobuf::Message* request,\n                google::protobuf::Message* response) {\n        FooRequest* copied_req = krpc::Clone<FooRequest>(request);\n        copied_req->set_xxx(...);\n        // \u62f7\u8d1d\u5e76\u4fee\u6539request\uff0c\u6700\u540e\u7684flag\u544a\u8bc9pchan\u5728RPC\u7ed3\u675f\u540e\u5220\u9664Request\u548cResponse\u3002\n        return SubCall(method, copied_req, response->New(), DELETE_REQUEST | DELETE_RESPONSE);\n    }\n  };\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"request\u548cresponse\u5df2\u7ecf\u5305\u542b\u4e86sub request/response\uff0c\u76f4\u63a5\u53d6\u51fa\u6765\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"  class UseFieldAsSubRequest : public CallMapper {\n  public:\n    SubCall Map(int channel_index/*starting from 0*/,\n                const google::protobuf::MethodDescriptor* method,\n                const google::protobuf::Message* request,\n                google::protobuf::Message* response) {\n        if (channel_index >= request->sub_request_size()) {\n            // sub_request\u4e0d\u591f\uff0c\u8bf4\u660e\u5916\u9762\u51c6\u5907\u6570\u636e\u7684\u5730\u65b9\u548cpchan\u4e2dsub channel\u7684\u4e2a\u6570\u4e0d\u7b26.\n            // \u8fd4\u56deBad()\u8ba9\u8be5\u6b21\u8bbf\u95ee\u7acb\u523b\u5931\u8d25\n            return SubCall::Bad();\n        }\n        // \u53d6\u51fa\u5bf9\u5e94\u7684sub request\uff0c\u589e\u52a0\u4e00\u4e2asub response\uff0c\u6700\u540e\u7684flag\u4e3a0\u544a\u8bc9pchan\u4ec0\u4e48\u90fd\u4e0d\u7528\u5220\n        return SubCall(sub_method, request->sub_request(channel_index), response->add_sub_response(), 0);\n    }\n  };\n"})}),"\n",(0,r.jsx)(e.h3,{id:"responsemerger",children:"ResponseMerger"}),"\n",(0,r.jsx)(e.p,{children:"response_merger\u628asub channel\u7684response\u5408\u5e76\u5165\u603b\u7684response\uff0c\u5176\u4e3aNULL\u65f6\uff0c\u5219\u4f7f\u7528response->MergeFrom(*sub_response)\uff0cMergeFrom\u7684\u884c\u4e3a\u53ef\u6982\u62ec\u4e3a\u201c\u9664\u4e86\u5408\u5e76repeated\u5b57\u6bb5\uff0c\u5176\u4f59\u90fd\u662f\u8986\u76d6\u201d\u3002\u5982\u679c\u4f60\u9700\u8981\u66f4\u590d\u6742\u7684\u884c\u4e3a\uff0c\u5219\u9700\u5b9e\u73b0ResponseMerger\u3002response_merger\u662f\u4e00\u4e2a\u4e2a\u6267\u884c\u7684\uff0c\u6240\u4ee5\u4f60\u5e76\u4e0d\u9700\u8981\u8003\u8651\u591a\u4e2aMerge\u540c\u65f6\u8fd0\u884c\u7684\u60c5\u51b5\u3002response_merger\u5728ParallelChannel\u6790\u6784\u65f6\u88ab\u5220\u9664\u3002response_merger\u5185\u542b\u5f15\u7528\u8ba1\u6570\uff0c\u4e00\u4e2aresponse_merger\u53ef\u4e0e\u591a\u4e2asub channel\u5173\u8054\u3002"}),"\n",(0,r.jsx)(e.p,{children:"Result\u7684\u53d6\u503c\u6709\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"MERGED: \u6210\u529f\u5408\u5e76\u3002"}),"\n",(0,r.jsx)(e.li,{children:"FAIL: sub_response\u6ca1\u6709\u5408\u5e76\u6210\u529f\uff0c\u4f1a\u88ab\u8bb0\u4f5c\u4e00\u6b21\u5931\u8d25\u3002\u6bd4\u5982\u670910\u4e2asub channels\u4e14fail_limit\u4e3a4\uff0c\u53ea\u8981\u67094\u4e2a\u5408\u5e76\u7ed3\u679c\u8fd4\u56de\u4e86FAIL\uff0c\u8fd9\u6b21RPC\u5c31\u4f1a\u8fbe\u5230fail_limit\u5e76\u7acb\u523b\u7ed3\u675f\u3002"}),"\n",(0,r.jsx)(e.li,{children:"FAIL_ALL: \u4f7f\u672c\u6b21RPC\u76f4\u63a5\u7ed3\u675f\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"\u83b7\u5f97\u8bbf\u95eesub-channel\u65f6\u7684controller",children:"\u83b7\u5f97\u8bbf\u95eesub channel\u65f6\u7684controller"}),"\n",(0,r.jsx)(e.p,{children:"\u6709\u65f6\u8bbf\u95ee\u8005\u9700\u8981\u4e86\u89e3\u8bbf\u95eesub channel\u65f6\u7684\u7ec6\u8282\uff0c\u901a\u8fc7Controller.sub(i)\u53ef\u83b7\u5f97\u8bbf\u95eesub channel\u7684controller."}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"// Get the controllers for accessing sub channels in combo channels.\n// Ordinary channel:\n//   sub_count() is 0 and sub() is always NULL.\n// ParallelChannel/PartitionChannel:\n//   sub_count() is #sub-channels and sub(i) is the controller for\n//   accessing i-th sub channel inside ParallelChannel, if i is outside\n//    [0, sub_count() - 1], sub(i) is NULL.\n//   NOTE: You must test sub() against NULL, ALWAYS. Even if i is inside\n//   range, sub(i) can still be NULL:\n//   * the rpc call may fail and terminate before accessing the sub channel\n//   * the sub channel was skipped\n// SelectiveChannel/DynamicPartitionChannel:\n//   sub_count() is always 1 and sub(0) is the controller of successful\n//   or last call to sub channels.\nint sub_count() const;\nconst Controller* sub(int index) const;\n"})}),"\n",(0,r.jsx)(e.h2,{id:"selectivechannel",children:"SelectiveChannel"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.a,{href:"https://github.com/apache/krpc/blob/master/src/krpc/selective_channel.h",children:"SelectiveChannel"})," (\u6709\u65f6\u88ab\u79f0\u4e3a\u201cschan\u201d)\u6309\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u8bbf\u95ee\u5176\u5305\u542b\u7684Channel\uff0c\u76f8\u6bd4\u666e\u901aChannel\u5b83\u66f4\u52a0\u9ad8\u5c42\uff1a\u628a\u6d41\u91cf\u5206\u7ed9sub channel\uff0c\u800c\u4e0d\u662f\u5177\u4f53\u7684Server\u3002SelectiveChannel\u4e3b\u8981\u7528\u6765\u652f\u6301\u673a\u5668\u7ec4\u4e4b\u95f4\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5b83\u5177\u5907Channel\u7684\u4e3b\u8981\u5c5e\u6027\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u652f\u6301\u540c\u6b65\u548c\u5f02\u6b65\u8bbf\u95ee\u3002"}),"\n",(0,r.jsx)(e.li,{children:"\u53d1\u8d77\u5f02\u6b65\u64cd\u4f5c\u540e\u53ef\u4ee5\u7acb\u523b\u5220\u9664\u3002"}),"\n",(0,r.jsx)(e.li,{children:"\u53ef\u4ee5\u53d6\u6d88\u3002"}),"\n",(0,r.jsx)(e.li,{children:"\u652f\u6301\u8d85\u65f6\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u793a\u4f8b\u4ee3\u7801\u89c1",(0,r.jsx)(e.a,{href:"https://github.com/apache/krpc/tree/master/example/selective_echo_c++/",children:"example/selective_echo_c++"}),"\u3002"]}),"\n",(0,r.jsx)(e.p,{children:"\u4efb\u4f55krpc::ChannelBase\u7684\u5b50\u7c7b\u90fd\u53ef\u52a0\u5165SelectiveChannel\uff0c\u5305\u62ecSelectiveChannel\u548c\u5176\u4ed6\u7ec4\u5408Channel\u3002"}),"\n",(0,r.jsx)(e.p,{children:"SelectiveChannel\u7684\u91cd\u8bd5\u72ec\u7acb\u4e8e\u5176\u4e2d\u7684sub channel\uff0c\u5f53SelectiveChannel\u8bbf\u95ee\u67d0\u4e2asub channel\u5931\u8d25\u540e\uff08\u672c\u8eab\u53ef\u80fd\u91cd\u8bd5\uff09\uff0c\u5b83\u4f1a\u91cd\u8bd5\u53e6\u5916\u4e00\u4e2asub channel\u3002"}),"\n",(0,r.jsxs)(e.p,{children:["\u76ee\u524dSelectiveChannel\u8981\u6c42",(0,r.jsx)(e.strong,{children:"request\u5fc5\u987b\u5728RPC\u7ed3\u675f\u524d\u6709\u6548"}),"\uff0c\u5176\u4ed6channel\u6ca1\u6709\u8fd9\u4e2a\u8981\u6c42\u3002\u5982\u679c\u4f60\u4f7f\u7528SelectiveChannel\u53d1\u8d77\u5f02\u6b65\u64cd\u4f5c\uff0c\u786e\u4fddrequest\u5728done\u4e2d\u624d\u88ab\u5220\u9664\u3002"]}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528selectivechannel",children:"\u4f7f\u7528SelectiveChannel"}),"\n",(0,r.jsx)(e.p,{children:"SelectiveChannel\u7684\u521d\u59cb\u5316\u548c\u666e\u901aChannel\u57fa\u672c\u4e00\u6837\uff0c\u4f46Init\u4e0d\u9700\u8981\u6307\u5b9a\u547d\u540d\u670d\u52a1\uff0c\u56e0\u4e3aSelectiveChannel\u901a\u8fc7AddChannel\u52a8\u6001\u6dfb\u52a0sub channel\uff0c\u800c\u666e\u901aChannel\u901a\u8fc7\u547d\u540d\u670d\u52a1\u52a8\u6001\u7ba1\u7406server\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:'#include <krpc/selective_channel.h>\n...\nkrpc::SelectiveChannel schan;\nkrpc::ChannelOptions schan_options;\nschan_options.timeout_ms = ...;\nschan_options.backup_request_ms = ...;\nschan_options.max_retry = ...;\nif (schan.Init(load_balancer, &schan_options) != 0) {\n    LOG(ERROR) << "Fail to init SelectiveChannel";\n    return -1;\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u521d\u59cb\u5316\u5b8c\u6bd5\u540e\u901a\u8fc7AddChannel\u52a0\u5165sub channel\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:'if (schan.AddChannel(sub_channel, NULL/*ChannelHandle*/) != 0) {  // \u7b2c\u4e8c\u4e2a\u53c2\u6570ChannelHandle\u7528\u4e8e\u5220\u9664sub channel\uff0c\u4e0d\u7528\u5220\u9664\u53ef\u586bNULL\n    LOG(ERROR) << "Fail to add sub_channel";\n    return -1;\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u6ce8\u610f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u548cParallelChannel\u4e0d\u540c\uff0cSelectiveChannel\u7684AddChannel\u53ef\u5728\u4efb\u610f\u65f6\u523b\u8c03\u7528\uff0c\u5373\u4f7f\u8be5SelectiveChannel\u6b63\u5728\u88ab\u8bbf\u95ee\uff08\u4e0b\u4e00\u6b21\u8bbf\u95ee\u65f6\u751f\u6548\uff09"}),"\n",(0,r.jsx)(e.li,{children:"SelectiveChannel\u603b\u662fown sub channel\uff0c\u8fd9\u548cParallelChannel\u53ef\u9009\u62e9ownership\u662f\u4e0d\u540c\u7684\u3002"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679cAddChannel\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e0d\u4e3a\u7a7a\uff0c\u4f1a\u586b\u5165\u4e00\u4e2a\u7c7b\u578b\u4e3akrpc::SelectiveChannel::ChannelHandle\u7684\u503c\uff0c\u8fd9\u4e2ahandle\u53ef\u4f5c\u4e3aRemoveAndDestroyChannel\u7684\u53c2\u6570\u6765\u52a8\u6001\u5220\u9664\u4e00\u4e2achannel\u3002"}),"\n",(0,r.jsx)(e.li,{children:"SelectiveChannel\u4f1a\u7528\u81ea\u8eab\u7684\u8d85\u65f6\u8986\u76d6sub channel\u521d\u59cb\u5316\u65f6\u6307\u5b9a\u7684\u8d85\u65f6\u3002\u6bd4\u5982\u67d0\u4e2asub channel\u7684\u8d85\u65f6\u4e3a100ms\uff0cSelectiveChannel\u7684\u8d85\u65f6\u4e3a500ms\uff0c\u5b9e\u9645\u8bbf\u95ee\u65f6\u7684\u8d85\u65f6\u662f500ms\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u8bbf\u95eeSelectiveChannel\u7684\u65b9\u5f0f\u548c\u666e\u901aChannel\u662f\u4e00\u6837\u7684\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"\u4f8b\u5b50-\u5f80\u591a\u4e2a\u547d\u540d\u670d\u52a1\u5206\u6d41",children:"\u4f8b\u5b50: \u5f80\u591a\u4e2a\u547d\u540d\u670d\u52a1\u5206\u6d41"}),"\n",(0,r.jsx)(e.p,{children:"\u4e00\u4e9b\u573a\u666f\u4e2d\u6211\u4eec\u9700\u8981\u5411\u591a\u4e2a\u547d\u540d\u670d\u52a1\u4e0b\u7684\u673a\u5668\u5206\u6d41\uff0c\u539f\u56e0\u53ef\u80fd\u6709\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5b8c\u6210\u540c\u4e00\u4e2a\u68c0\u7d22\u529f\u80fd\u7684\u673a\u5668\u88ab\u6302\u8f7d\u5230\u4e86\u4e0d\u540c\u7684\u547d\u540d\u670d\u52a1\u4e0b\u3002"}),"\n",(0,r.jsx)(e.li,{children:"\u673a\u5668\u88ab\u62c6\u6210\u4e86\u591a\u4e2a\u7ec4\uff0c\u6d41\u91cf\u5148\u5206\u6d41\u7ed9\u4e00\u4e2a\u7ec4\uff0c\u518d\u5206\u6d41\u5230\u7ec4\u5185\u673a\u5668\u3002\u7ec4\u95f4\u7684\u5206\u6d41\u65b9\u5f0f\u548c\u7ec4\u5185\u6709\u6240\u4e0d\u540c\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u8fd9\u90fd\u53ef\u4ee5\u901a\u8fc7SelectiveChannel\u5b8c\u6210\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u4e0b\u9762\u7684\u4ee3\u7801\u521b\u5efa\u4e86\u4e00\u4e2aSelectiveChannel\uff0c\u5e76\u63d2\u5165\u4e09\u4e2a\u8bbf\u95ee\u4e0d\u540cbns\u7684\u666e\u901aChannel\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:'krpc::SelectiveChannel channel;\nkrpc::ChannelOptions schan_options;\nschan_options.timeout_ms = FLAGS_timeout_ms;\nschan_options.max_retry = FLAGS_max_retry;\nif (channel.Init("c_murmurhash", &schan_options) != 0) {\n    LOG(ERROR) << "Fail to init SelectiveChannel";\n    return -1;\n}\n \nfor (int i = 0; i < 3; ++i) {\n    krpc::Channel* sub_channel = new krpc::Channel;\n    if (sub_channel->Init(ns_node_name[i], "rr", NULL) != 0) {\n        LOG(ERROR) << "Fail to init sub channel " << i;\n        return -1;\n    }\n    if (channel.AddChannel(sub_channel, NULL/*handle for removal*/) != 0) {\n        LOG(ERROR) << "Fail to add sub_channel to channel";\n        return -1;\n    } \n}\n...\nXXXService_Stub stub(&channel);\nstub.FooMethod(&cntl, &request, &response, NULL);\n...\n'})}),"\n",(0,r.jsx)(e.h2,{id:"partitionchannel",children:"PartitionChannel"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.a,{href:"https://github.com/apache/krpc/blob/master/src/krpc/partition_channel.h",children:"PartitionChannel"}),"\u662f\u7279\u6b8a\u7684ParallelChannel\uff0c\u5b83\u4f1a\u6839\u636e\u547d\u540d\u670d\u52a1\u4e2d\u7684tag\u81ea\u52a8\u5efa\u7acb\u5bf9\u5e94\u5206\u5e93\u7684sub channel\u3002\u8fd9\u6837\u7528\u6237\u5c31\u53ef\u4ee5\u628a\u6240\u6709\u7684\u5206\u5e93\u673a\u5668\u6302\u5728\u4e00\u4e2a\u547d\u540d\u670d\u52a1\u5185\uff0c\u901a\u8fc7tag\u6765\u6307\u5b9a\u54ea\u53f0\u673a\u5668\u5bf9\u5e94\u54ea\u4e2a\u5206\u5e93\u3002\u793a\u4f8b\u4ee3\u7801\u89c1",(0,r.jsx)(e.a,{href:"https://github.com/apache/krpc/tree/master/example/partition_echo_c++/",children:"example/partition_echo_c++"}),"\u3002"]}),"\n",(0,r.jsxs)(e.p,{children:["ParititonChannel\u53ea\u80fd\u5904\u7406\u4e00\u79cd\u5206\u5e93\u65b9\u6cd5\uff0c\u5f53\u7528\u6237\u9700\u8981\u591a\u79cd\u5206\u5e93\u65b9\u6cd5\u5171\u5b58\uff0c\u6216\u4ece\u4e00\u4e2a\u5206\u5e93\u65b9\u6cd5\u5e73\u6ed1\u5730\u5207\u6362\u4e3a\u53e6\u4e00\u79cd\u5206\u5e93\u65b9\u6cd5\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528DynamicPartitionChannel\uff0c\u5b83\u4f1a\u6839\u636e\u4e0d\u540c\u7684\u5206\u5e93\u65b9\u5f0f\u52a8\u6001\u5730\u5efa\u7acb\u5bf9\u5e94\u7684sub PartitionChannel\uff0c\u5e76\u6839\u636e\u5bb9\u91cf\u628a\u8bf7\u6c42\u5206\u914d\u7ed9\u4e0d\u540c\u7684\u5206\u5e93\u3002\u793a\u4f8b\u4ee3\u7801\u89c1",(0,r.jsx)(e.a,{href:"https://github.com/apache/krpc/tree/master/example/dynamic_partition_echo_c++/",children:"example/dynamic_partition_echo_c++"}),"\u3002"]}),"\n",(0,r.jsxs)(e.p,{children:["\u5982\u679c\u5206\u5e93\u5728\u4e0d\u540c\u7684\u547d\u540d\u670d\u52a1\u5185\uff0c\u90a3\u4e48\u7528\u6237\u5f97\u81ea\u884c\u7528ParallelChannel\u7ec4\u88c5\uff0c\u5373\u6bcf\u4e2asub channel\u5bf9\u5e94\u4e00\u4e2a\u5206\u5e93\uff08\u4f7f\u7528\u4e0d\u540c\u7684\u547d\u540d\u670d\u52a1\uff09\u3002ParellelChannel\u7684\u4f7f\u7528\u65b9\u6cd5\u89c1",(0,r.jsx)(e.a,{href:"#ParallelChannel",children:"\u4e0a\u9762"}),"\u3002"]}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528partitionchannel",children:"\u4f7f\u7528PartitionChannel"}),"\n",(0,r.jsx)(e.p,{children:"\u9996\u5148\u5b9a\u5236PartitionParser\u3002\u8fd9\u4e2a\u4f8b\u5b50\u4e2dtag\u7684\u5f62\u5f0f\u662fN/M\uff0cN\u4ee3\u8868\u5206\u5e93\u7684index\uff0cM\u662f\u5206\u5e93\u7684\u4e2a\u6570\u3002\u6bd4\u59820/3\u4ee3\u8868\u4e00\u51713\u4e2a\u5206\u5e93\uff0c\u8fd9\u662f\u7b2c\u4e00\u4e2a\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:'#include <krpc/partition_channel.h>\n...\nclass MyPartitionParser : public krpc::PartitionParser {\npublic:\n    bool ParseFromTag(const std::string& tag, krpc::Partition* out) {\n        // "N/M" : #N partition of M partitions.\n        size_t pos = tag.find_first_of(\'/\');\n        if (pos == std::string::npos) {\n            LOG(ERROR) << "Invalid tag=" << tag;\n            return false;\n        }\n        char* endptr = NULL;\n        out->index = strtol(tag.c_str(), &endptr, 10);\n        if (endptr != tag.data() + pos) {\n            LOG(ERROR) << "Invalid index=" << kutil::StringPiece(tag.data(), pos);\n            return false;\n        }\n        out->num_partition_kinds = strtol(tag.c_str() + pos + 1, &endptr, 10);\n        if (endptr != tag.c_str() + tag.size()) {\n            LOG(ERROR) << "Invalid num=" << tag.data() + pos + 1;\n            return false;\n        }\n        return true;\n    }\n};\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u7136\u540e\u521d\u59cb\u5316PartitionChannel\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:'#include <krpc/partition_channel.h>\n...\nkrpc::PartitionChannel channel;\n \nkrpc::PartitionChannelOptions options;\noptions.protocol = ...;   // PartitionChannelOptions\u7ee7\u627f\u4e86ChannelOptions\uff0c\u540e\u8005\u6709\u7684\u524d\u8005\u4e5f\u6709\noptions.timeout_ms = ...; // \u540c\u4e0a\noptions.fail_limit = 1;   // PartitionChannel\u81ea\u5df1\u7684\u9009\u9879\uff0c\u610f\u601d\u540cParalellChannel\u4e2d\u7684fail_limit\u3002\u8fd9\u91cc\u4e3a1\u7684\u610f\u601d\u662f\u53ea\u8981\u67091\u4e2a\u5206\u5e93\u8bbf\u95ee\u5931\u8d25\uff0c\u8fd9\u6b21RPC\u5c31\u5931\u8d25\u4e86\u3002\n \nif (channel.Init(num_partition_kinds, new MyPartitionParser(),\n                 server_address, load_balancer, &options) != 0) {\n    LOG(ERROR) << "Fail to init PartitionChannel";\n    return -1;\n}\n// \u8bbf\u95ee\u65b9\u6cd5\u548c\u666e\u901aChannel\u662f\u4e00\u6837\u7684\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528dynamicpartitionchannel",children:"\u4f7f\u7528DynamicPartitionChannel"}),"\n",(0,r.jsx)(e.p,{children:"DynamicPartitionChannel\u7684\u4f7f\u7528\u65b9\u6cd5\u548cPartitionChannel\u57fa\u672c\u4e0a\u662f\u4e00\u6837\u7684\uff0c\u5148\u5b9a\u5236PartitionParser\u518d\u521d\u59cb\u5316\uff0c\u4f46Init\u65f6\u4e0d\u9700\u8981num_partition_kinds\uff0c\u56e0\u4e3aDynamicPartitionChannel\u4f1a\u4e3a\u4e0d\u540c\u7684\u5206\u5e93\u65b9\u6cd5\u52a8\u6001\u5efa\u7acb\u4e0d\u540c\u7684sub PartitionChannel\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u4e0b\u9762\u6f14\u793a\u4e00\u4e0b\u4f7f\u7528DynamicPartitionChannel\u5e73\u6ed1\u5730\u4ece3\u5e93\u53d8\u62104\u5e93\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u9996\u5148\u5206\u522b\u57288004, 8005, 8006\u7aef\u53e3\u542f\u52a8\u4e09\u4e2aserver\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"$ ./echo_server -server_num 3\nTRACE: 09-06 10:40:39:   * 0 server.cpp:159] EchoServer is serving on port=8004\nTRACE: 09-06 10:40:39:   * 0 server.cpp:159] EchoServer is serving on port=8005\nTRACE: 09-06 10:40:39:   * 0 server.cpp:159] EchoServer is serving on port=8006\nTRACE: 09-06 10:40:40:   * 0 server.cpp:192] S[0]=0 S[1]=0 S[2]=0 [total=0]\nTRACE: 09-06 10:40:41:   * 0 server.cpp:192] S[0]=0 S[1]=0 S[2]=0 [total=0]\nTRACE: 09-06 10:40:42:   * 0 server.cpp:192] S[0]=0 S[1]=0 S[2]=0 [total=0]\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u542f\u52a8\u540e\u6bcf\u4e2aServer\u6bcf\u79d2\u4f1a\u6253\u5370\u4e0a\u4e00\u79d2\u6536\u5230\u7684\u6d41\u91cf\uff0c\u76ee\u524d\u90fd\u662f0\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u672c\u5730\u542f\u52a8\u4f7f\u7528DynamicPartitionChannel\u7684Client\uff0c\u521d\u59cb\u5316\u4ee3\u7801\u5982\u4e0b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:'    ...\n    krpc::DynamicPartitionChannel channel;\n    krpc::PartitionChannelOptions options;\n    // \u8bbf\u95ee\u4efb\u4f55\u5206\u5e93\u5931\u8d25\u90fd\u8ba4\u4e3aRPC\u5931\u8d25\u3002\u8c03\u5927\u8fd9\u4e2a\u6570\u503c\u53ef\u4ee5\u4f7f\u8bbf\u95ee\u66f4\u5bbd\u677e\uff0c\u6bd4\u5982\u7b49\u4e8e2\u7684\u8bdd\u8868\u793a\u81f3\u5c11\u4e24\u4e2a\u5206\u5e93\u5931\u8d25\u624d\u7b97\u5931\u8d25\u3002\n    options.fail_limit = 1;\n    if (channel.Init(new MyPartitionParser(), "file://server_list", "rr", &options) != 0) {\n        LOG(ERROR) << "Fail to init channel";\n        return -1;\n    }\n    ...\n'})}),"\n",(0,r.jsx)(e.p,{children:'\u547d\u540d\u670d\u52a1"file://server_list"\u7684\u5185\u5bb9\u662f\uff1a'}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"0.0.0.0:8004  0/3  # \u8868\u793a3\u5206\u5e93\u4e2d\u7684\u7b2c\u4e00\u4e2a\u5206\u5e93\uff0c\u5176\u4ed6\u4f9d\u6b21\u7c7b\u63a8\n0.0.0.0:8004  1/3\n0.0.0.0:8004  2/3\n"})}),"\n",(0,r.jsx)(e.p,{children:"3\u5206\u5e93\u65b9\u6848\u76843\u4e2a\u5e93\u90fd\u57288004\u7aef\u53e3\u5bf9\u5e94\u7684server\u4e0a\u3002\u542f\u52a8Client\u540eClient\u53d1\u73b0\u4e868004\uff0c\u5e76\u5411\u5176\u53d1\u9001\u6d41\u91cf\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"$ ./echo_client            \nTRACE: 09-06 10:51:10:   * 0 src/krpc/policy/file_naming_service.cpp:83] Got 3 unique addresses from `server_list'\nTRACE: 09-06 10:51:10:   * 0 src/krpc/socket.cpp:779] Connected to 0.0.0.0:8004 via fd=3 SocketId=0 self_port=46544\nTRACE: 09-06 10:51:11:   * 0 client.cpp:226] Sending EchoRequest at qps=132472 latency=371\nTRACE: 09-06 10:51:12:   * 0 client.cpp:226] Sending EchoRequest at qps=132658 latency=370\nTRACE: 09-06 10:51:13:   * 0 client.cpp:226] Sending EchoRequest at qps=133208 latency=369\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u540c\u65f6Server\u7aef\u6536\u5230\u4e863\u500d\u7684\u6d41\u91cf\uff1a\u56e0\u4e3a\u8bbf\u95ee\u4e00\u6b21Client\u7aef\u8981\u8bbf\u95ee\u4e09\u6b218004\uff0c\u5206\u522b\u5bf9\u5e94\u6bcf\u4e2a\u5206\u5e93\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"TRACE: 09-06 10:51:11:   * 0 server.cpp:192] S[0]=398866 S[1]=0 S[2]=0 [total=398866]\nTRACE: 09-06 10:51:12:   * 0 server.cpp:192] S[0]=398117 S[1]=0 S[2]=0 [total=398117]\nTRACE: 09-06 10:51:13:   * 0 server.cpp:192] S[0]=398873 S[1]=0 S[2]=0 [total=398873]\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5f00\u59cb\u4fee\u6539\u5206\u5e93\uff0c\u5728server_list\u4e2d\u52a0\u51654\u5206\u5e93\u76848005\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"0.0.0.0:8004  0/3\n0.0.0.0:8004  1/3   \n0.0.0.0:8004  2/3 \n \n0.0.0.0:8005  0/4        \n0.0.0.0:8005  1/4        \n0.0.0.0:8005  2/4        \n0.0.0.0:8005  3/4\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u89c2\u5bdfClient\u548cServer\u7684\u8f93\u51fa\u53d8\u5316\u3002Client\u7aef\u53d1\u73b0\u4e86server_list\u7684\u53d8\u5316\u5e76\u91cd\u65b0\u8f7d\u5165\uff0c\u4f46qps\u5e76\u6ca1\u6709\u4ec0\u4e48\u53d8\u5316\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"TRACE: 09-06 10:57:10:   * 0 src/krpc/policy/file_naming_service.cpp:83] Got 7 unique addresses from `server_list'\nTRACE: 09-06 10:57:10:   * 0 src/krpc/socket.cpp:779] Connected to 0.0.0.0:8005 via fd=7 SocketId=768 self_port=39171\nTRACE: 09-06 10:57:11:   * 0 client.cpp:226] Sending EchoRequest at qps=135346 latency=363\nTRACE: 09-06 10:57:12:   * 0 client.cpp:226] Sending EchoRequest at qps=134201 latency=366\nTRACE: 09-06 10:57:13:   * 0 client.cpp:226] Sending EchoRequest at qps=137627 latency=356\nTRACE: 09-06 10:57:14:   * 0 client.cpp:226] Sending EchoRequest at qps=136775 latency=359\nTRACE: 09-06 10:57:15:   * 0 client.cpp:226] Sending EchoRequest at qps=139043 latency=353\n"})}),"\n",(0,r.jsx)(e.p,{children:"server\u7aef\u7684\u53d8\u5316\u6bd4\u8f83\u5927\u30028005\u6536\u5230\u4e86\u6d41\u91cf\uff0c\u5e76\u4e14\u548c8004\u7684\u6d41\u91cf\u6bd4\u4f8b\u5173\u7cfb\u7ea6\u4e3a4:3\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"TRACE: 09-06 10:57:09:   * 0 server.cpp:192] S[0]=398597 S[1]=0 S[2]=0 [total=398597]\nTRACE: 09-06 10:57:10:   * 0 server.cpp:192] S[0]=392839 S[1]=0 S[2]=0 [total=392839]\nTRACE: 09-06 10:57:11:   * 0 server.cpp:192] S[0]=334704 S[1]=83219 S[2]=0 [total=417923]\nTRACE: 09-06 10:57:12:   * 0 server.cpp:192] S[0]=206215 S[1]=273873 S[2]=0 [total=480088]\nTRACE: 09-06 10:57:13:   * 0 server.cpp:192] S[0]=204520 S[1]=270483 S[2]=0 [total=475003]\nTRACE: 09-06 10:57:14:   * 0 server.cpp:192] S[0]=207055 S[1]=273725 S[2]=0 [total=480780]\nTRACE: 09-06 10:57:15:   * 0 server.cpp:192] S[0]=208453 S[1]=276803 S[2]=0 [total=485256]\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u4e00\u6b21RPC\u8981\u8bbf\u95ee\u4e09\u6b218004\u6216\u56db\u6b218005\uff0c8004\u548c8005\u6d41\u91cf\u6bd4\u662f3:4\uff0c\u8bf4\u660eClient\u4ee51:1\u7684\u6bd4\u4f8b\u8bbf\u95ee\u4e863\u5206\u5e93\u548c4\u5206\u5e93\u3002\u8fd9\u4e2a\u6bd4\u4f8b\u5173\u7cfb\u53d6\u51b3\u4e8e\u5176\u5bb9\u91cf\u3002\u5bb9\u91cf\u7684\u8ba1\u7b97\u662f\u9012\u5f52\u7684\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u666e\u901aChannel\u7684\u5bb9\u91cf\u7b49\u4e8e\u5b83\u5176\u4e2d\u6240\u6709server\u7684\u5bb9\u91cf\u4e4b\u548c\u3002\u5982\u679c\u547d\u540d\u670d\u52a1\u6ca1\u6709\u914d\u7f6e\u6743\u503c\uff0c\u5355\u4e2aserver\u7684\u5bb9\u91cf\u4e3a1\u3002"}),"\n",(0,r.jsx)(e.li,{children:"ParallelChannel\u6216PartitionChannel\u7684\u5bb9\u91cf\u7b49\u4e8e\u5b83\u5176\u4e2dSub Channel\u5bb9\u91cf\u7684\u6700\u5c0f\u503c\u3002"}),"\n",(0,r.jsx)(e.li,{children:"SelectiveChannel\u7684\u5bb9\u91cf\u7b49\u4e8e\u5b83\u5176\u4e2dSub Channel\u7684\u5bb9\u91cf\u4e4b\u548c\u3002"}),"\n",(0,r.jsx)(e.li,{children:"DynamicPartitionChannel\u7684\u5bb9\u91cf\u7b49\u4e8e\u5b83\u5176\u4e2dSub PartitionChannel\u7684\u5bb9\u91cf\u4e4b\u548c\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u8fd9\u513f\u7684\u573a\u666f\u4e2d\uff0c3\u5206\u5e93\u548c4\u5206\u5e93\u7684\u5bb9\u91cf\u90fd\u662f1\uff0c\u56e0\u4e3a\u6240\u6709\u76843\u5e93\u90fd\u57288004\u4e00\u53f0server\u4e0a\uff0c\u6240\u6709\u76844\u5e93\u90fd\u57288005\u4e00\u53f0server\u4e0a\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u57284\u5206\u5e93\u65b9\u6848\u52a0\u5165\u52a0\u51658006\u7aef\u53e3\u7684server:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"0.0.0.0:8004  0/3\n0.0.0.0:8004  1/3   \n0.0.0.0:8004  2/3\n \n0.0.0.0:8005  0/4   \n0.0.0.0:8005  1/4   \n0.0.0.0:8005  2/4   \n0.0.0.0:8005  3/4    \n \n0.0.0.0:8006 0/4\n0.0.0.0:8006 1/4\n0.0.0.0:8006 2/4\n0.0.0.0:8006 3/4\n"})}),"\n",(0,r.jsx)(e.p,{children:"Client\u7684\u53d8\u5316\u4ecd\u65e7\u4e0d\u5927\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"TRACE: 09-06 11:11:51:   * 0 src/krpc/policy/file_naming_service.cpp:83] Got 11 unique addresses from `server_list'\nTRACE: 09-06 11:11:51:   * 0 src/krpc/socket.cpp:779] Connected to 0.0.0.0:8006 via fd=8 SocketId=1280 self_port=40759\nTRACE: 09-06 11:11:51:   * 0 client.cpp:226] Sending EchoRequest at qps=131799 latency=372\nTRACE: 09-06 11:11:52:   * 0 client.cpp:226] Sending EchoRequest at qps=136217 latency=361\nTRACE: 09-06 11:11:53:   * 0 client.cpp:226] Sending EchoRequest at qps=133531 latency=368\nTRACE: 09-06 11:11:54:   * 0 client.cpp:226] Sending EchoRequest at qps=136072 latency=361\n"})}),"\n",(0,r.jsx)(e.p,{children:"Server\u7aef\u53ef\u4ee5\u770b\u52308006\u6536\u5230\u4e86\u6d41\u91cf\u3002\u4e09\u53f0server\u7684\u6d41\u91cf\u6bd4\u4f8b\u7ea6\u4e3a3:4:4\u3002\u8fd9\u662f\u56e0\u4e3a3\u5206\u5e93\u7684\u5bb9\u91cf\u4ecd\u4e3a1\uff0c\u800c4\u5206\u5e93\u7531\u4e8e8006\u7684\u52a0\u5165\u53d8\u6210\u4e862\u30023\u5206\u5e93\u548c4\u5206\u5e93\u7684\u6d41\u91cf\u6bd4\u4f8b\u662f3:8\u30024\u5206\u5e93\u4e2d\u7684\u6bcf\u4e2a\u5206\u5e93\u57288005\u548c8006\u4e0a\u90fd\u6709\u5b9e\u4f8b\uff0c\u540c\u4e00\u4e2a\u5206\u5e93\u7684\u4e0d\u540c\u5b9e\u4f8b\u4f7f\u7528round robin\u5206\u6d41\uff0c\u6240\u4ee58005\u548c8006\u5e73\u644a\u4e86\u6d41\u91cf\u3002\u6700\u540e\u7684\u6548\u679c\u5c31\u662f3:4:4\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"TRACE: 09-06 11:11:51:   * 0 server.cpp:192] S[0]=199625 S[1]=263226 S[2]=0 [total=462851]\nTRACE: 09-06 11:11:52:   * 0 server.cpp:192] S[0]=143248 S[1]=190717 S[2]=159756 [total=493721]\nTRACE: 09-06 11:11:53:   * 0 server.cpp:192] S[0]=133003 S[1]=178328 S[2]=178325 [total=489656]\nTRACE: 09-06 11:11:54:   * 0 server.cpp:192] S[0]=135534 S[1]=180386 S[2]=180333 [total=496253]\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5c1d\u8bd5\u53bb\u63893\u5206\u5e93\u4e2d\u7684\u4e00\u4e2a\u5206\u5e93: (\u4f60\u53ef\u4ee5\u5728file://server_list\u4e2d\u4f7f\u7528#\u6ce8\u91ca\u4e00\u884c)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:" 0.0.0.0:8004  0/3\n 0.0.0.0:8004  1/3\n#0.0.0.0:8004  2/3\n \n 0.0.0.0:8005  0/4   \n 0.0.0.0:8005  1/4   \n 0.0.0.0:8005  2/4   \n 0.0.0.0:8005  3/4    \n \n 0.0.0.0:8006 0/4\n 0.0.0.0:8006 1/4\n 0.0.0.0:8006 2/4\n 0.0.0.0:8006 3/4\n"})}),"\n",(0,r.jsx)(e.p,{children:"Client\u7aef\u53d1\u73b0\u4e86\u8fd9\u70b9\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"TRACE: 09-06 11:17:47:   * 0 src/krpc/policy/file_naming_service.cpp:83] Got 10 unique addresses from `server_list'\nTRACE: 09-06 11:17:47:   * 0 client.cpp:226] Sending EchoRequest at qps=131653 latency=373\nTRACE: 09-06 11:17:48:   * 0 client.cpp:226] Sending EchoRequest at qps=120560 latency=407\nTRACE: 09-06 11:17:49:   * 0 client.cpp:226] Sending EchoRequest at qps=124100 latency=395\nTRACE: 09-06 11:17:50:   * 0 client.cpp:226] Sending EchoRequest at qps=123743 latency=397\n"})}),"\n",(0,r.jsx)(e.p,{children:"Server\u7aef\u66f4\u660e\u663e\uff0c8004\u5f88\u5feb\u6ca1\u6709\u4e86\u6d41\u91cf\u3002\u8fd9\u662f\u56e0\u4e3a\u53bb\u6389\u7684\u5206\u5e93\u5df2\u7ecf\u662f3\u5206\u5e93\u4e2d\u6700\u540e\u76842/3\u5206\u5e93\uff0c\u53bb\u6389\u540e3\u5206\u5e93\u7684\u5bb9\u91cf\u53d8\u4e3a\u4e860\uff0c\u5bfc\u81f48004\u5206\u4e0d\u5230\u4efb\u4f55\u6d41\u91cf\u4e86\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"TRACE: 09-06 11:17:47:   * 0 server.cpp:192] S[0]=130864 S[1]=174499 S[2]=174548 [total=479911]\nTRACE: 09-06 11:17:48:   * 0 server.cpp:192] S[0]=20063 S[1]=230027 S[2]=230098 [total=480188]\nTRACE: 09-06 11:17:49:   * 0 server.cpp:192] S[0]=0 S[1]=245961 S[2]=245888 [total=491849]\nTRACE: 09-06 11:17:50:   * 0 server.cpp:192] S[0]=0 S[1]=250198 S[2]=250150 [total=500348]\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u771f\u5b9e\u7684\u7ebf\u4e0a\u73af\u5883\u4e2d\uff0c\u6211\u4eec\u4f1a\u9010\u6e10\u5730\u589e\u52a04\u5206\u5e93\u7684server\uff0c\u540c\u65f6\u4e0b\u63893\u5206\u5e93\u4e2d\u7684server\u3002DynamicParititonChannel\u4f1a\u6309\u7167\u6bcf\u79cd\u5206\u5e93\u65b9\u5f0f\u7684\u5bb9\u91cf\u52a8\u6001\u5207\u5206\u6d41\u91cf\u3002\u5f53\u67d0\u4e2a\u65f6\u523b3\u5206\u5e93\u7684\u5bb9\u91cf\u53d8\u4e3a0\u65f6\uff0c\u6211\u4eec\u4fbf\u5e73\u6ed1\u5730\u628aServer\u4ece3\u5206\u5e93\u53d8\u4e3a\u4e864\u5206\u5e93\uff0c\u540c\u65f6\u5e76\u6ca1\u6709\u4fee\u6539Client\u7684\u4ee3\u7801\u3002"})]})}function u(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},28453:(n,e,l)=>{"use strict";l.d(e,{R:()=>c,x:()=>i});var r=l(96540);const s={},a=r.createContext(s);function c(n){const e=r.useContext(a);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function i(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:c(n.components),r.createElement(a.Provider,{value:e},n.children)}}}]);