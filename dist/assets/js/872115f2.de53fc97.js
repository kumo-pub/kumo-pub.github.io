"use strict";(self.webpackChunkkumo_website=self.webpackChunkkumo_website||[]).push([[54829],{99223:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>d,frontMatter:()=>s,metadata:()=>o,toc:()=>a});var i=t(74848),u=t(28453);const s={},c="\u6267\u884c\u961f\u5217",o={id:"cpp/krpc/execution_queue",title:"\u6267\u884c\u961f\u5217",description:"\u7c7b\u4f3c\u4e8ekylin\u7684ExecMan, ExecutionQueue\u63d0\u4f9b\u4e86\u5f02\u6b65\u4e32\u884c\u6267\u884c\u7684\u529f\u80fd\u3002ExecutionQueue\u7684\u76f8\u5173\u6280\u672f\u6700\u65e9\u4f7f\u7528\u5728RPC\u4e2d\u5b9e\u73b0\u591a\u7ebf\u7a0b\u5411\u540c\u4e00\u4e2afd\u5199\u6570\u636e. \u5728r31345\u4e4b\u540e\u52a0\u5165\u5230kthread\u3002 ExecutionQueue \u63d0\u4f9b\u4e86\u5982\u4e0b\u57fa\u672c\u529f\u80fd:",source:"@site/docs/cpp/krpc/execution_queue.mdx",sourceDirName:"cpp/krpc",slug:"/cpp/krpc/execution_queue",permalink:"/docs/next/cpp/krpc/execution_queue",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"\u7ebf\u7a0b\u6a21\u578b\u9009\u62e9",permalink:"/docs/next/cpp/krpc/kthread_or_not"},next:{title:"memcached\u5ba2\u6237\u7aef",permalink:"/docs/next/cpp/krpc/memcache_client"}},r={},a=[{value:"\u80cc\u666f",id:"\u80cc\u666f",level:2},{value:"ExecutionQueue Vs Mutex",id:"executionqueue-vs-mutex",level:2},{value:"\u4f7f\u7528\u65b9\u5f0f",id:"\u4f7f\u7528\u65b9\u5f0f",level:2},{value:"\u5b9e\u73b0\u6267\u884c\u51fd\u6570",id:"\u5b9e\u73b0\u6267\u884c\u51fd\u6570",level:3},{value:"\u542f\u52a8\u4e00\u4e2aExecutionQueue:",id:"\u542f\u52a8\u4e00\u4e2aexecutionqueue",level:3},{value:"\u505c\u6b62\u4e00\u4e2aExecutionQueue:",id:"\u505c\u6b62\u4e00\u4e2aexecutionqueue",level:3},{value:"\u63d0\u4ea4\u4efb\u52a1",id:"\u63d0\u4ea4\u4efb\u52a1",level:3},{value:"\u53d6\u6d88\u4e00\u4e2a\u5df2\u63d0\u4ea4\u4efb\u52a1",id:"\u53d6\u6d88\u4e00\u4e2a\u5df2\u63d0\u4ea4\u4efb\u52a1",level:3}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,u.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"\u6267\u884c\u961f\u5217",children:"\u6267\u884c\u961f\u5217"})}),"\n",(0,i.jsxs)(n.p,{children:["\u7c7b\u4f3c\u4e8ekylin\u7684ExecMan, ",(0,i.jsx)(n.a,{href:"https://github.com/apache/krpc/blob/master/src/kthread/execution_queue.h",children:"ExecutionQueue"}),"\u63d0\u4f9b\u4e86\u5f02\u6b65\u4e32\u884c\u6267\u884c\u7684\u529f\u80fd\u3002ExecutionQueue\u7684\u76f8\u5173\u6280\u672f\u6700\u65e9\u4f7f\u7528\u5728RPC\u4e2d\u5b9e\u73b0",(0,i.jsx)(n.a,{href:"/docs/next/cpp/krpc/io#%E5%8F%91%E6%B6%88%E6%81%AF",children:"\u591a\u7ebf\u7a0b\u5411\u540c\u4e00\u4e2afd\u5199\u6570\u636e"}),". \u5728r31345\u4e4b\u540e\u52a0\u5165\u5230kthread\u3002 ExecutionQueue \u63d0\u4f9b\u4e86\u5982\u4e0b\u57fa\u672c\u529f\u80fd:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5f02\u6b65\u6709\u5e8f\u6267\u884c: \u4efb\u52a1\u5728\u53e6\u5916\u4e00\u4e2a\u5355\u72ec\u7684\u7ebf\u7a0b\u4e2d\u6267\u884c, \u5e76\u4e14\u6267\u884c\u987a\u5e8f\u4e25\u683c\u548c\u63d0\u4ea4\u987a\u5e8f\u4e00\u81f4."}),"\n",(0,i.jsx)(n.li,{children:"Multi Producer: \u591a\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u540c\u65f6\u5411\u4e00\u4e2aExecutionQueue\u63d0\u4ea4\u4efb\u52a1"}),"\n",(0,i.jsx)(n.li,{children:"\u652f\u6301cancel\u4e00\u4e2a\u5df2\u7ecf\u63d0\u4ea4\u7684\u4efb\u52a1"}),"\n",(0,i.jsx)(n.li,{children:"\u652f\u6301stop"}),"\n",(0,i.jsx)(n.li,{children:"\u652f\u6301\u9ad8\u4f18\u4efb\u52a1\u63d2\u961f"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u548cExecMan\u7684\u4e3b\u8981\u533a\u522b:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["ExecutionQueue\u7684\u4efb\u52a1\u63d0\u4ea4\u63a5\u53e3\u662f",(0,i.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Non-blocking_algorithm#Wait-freedom",children:"wait-free"}),"\u7684, ExecMan\u4f9d\u8d56\u4e86lock, \u8fd9\u610f\u5473\u7740\u5f53\u673a\u5668\u6574\u4f53\u6bd4\u8f83\u7e41\u5fd9\u7684\u65f6\u5019\uff0c\u4f7f\u7528ExecutionQueue\u4e0d\u4f1a\u56e0\u4e3a\u67d0\u4e2a\u8fdb\u7a0b\u88ab\u7cfb\u7edf\u5f3a\u5236\u5207\u6362\u5bfc\u81f4\u6240\u6709\u7ebf\u7a0b\u90fd\u88ab\u963b\u585e\u3002"]}),"\n",(0,i.jsx)(n.li,{children:"ExecutionQueue\u652f\u6301\u6279\u91cf\u5904\u7406: \u6267\u884c\u7ebf\u7a0b\u53ef\u4ee5\u6279\u91cf\u5904\u7406\u63d0\u4ea4\u7684\u4efb\u52a1, \u83b7\u5f97\u66f4\u597d\u7684locality. ExecMan\u7684\u67d0\u4e2a\u7ebf\u7a0b\u5904\u7406\u5b8c\u67d0\u4e2aAsyncClient\u7684AsyncContext\u4e4b\u540e\u4e0b\u4e00\u4e2a\u4efb\u52a1\u5f88\u53ef\u80fd\u662f\u5c5e\u4e8e\u53e6\u5916\u4e00\u4e2aAsyncClient\u7684AsyncContex, \u8fd9\u65f6\u5019cpu cache\u4f1a\u5728\u4e0d\u540cAsyncClient\u4f9d\u8d56\u7684\u8d44\u6e90\u95f4\u8fdb\u884c\u4e0d\u505c\u7684\u5207\u6362\u3002"}),"\n",(0,i.jsx)(n.li,{children:"ExecutionQueue\u7684\u5904\u7406\u51fd\u6570\u4e0d\u4f1a\u88ab\u7ed1\u5b9a\u5230\u56fa\u5b9a\u7684\u7ebf\u7a0b\u4e2d\u6267\u884c, ExecMan\u4e2d\u662f\u6839\u636eAsyncClient hash\u5230\u56fa\u5b9a\u7684\u6267\u884c\u7ebf\u7a0b\uff0c\u4e0d\u540c\u7684ExecutionQueue\u4e4b\u95f4\u7684\u4efb\u52a1\u5904\u7406\u5b8c\u5168\u72ec\u7acb\uff0c\u5f53\u7ebf\u7a0b\u6570\u8db3\u591f\u591a\u7684\u60c5\u51b5\u4e0b\uff0c\u6240\u6709\u975e\u7a7a\u95f2\u7684ExecutionQueue\u90fd\u80fd\u540c\u65f6\u5f97\u5230\u8c03\u5ea6\u3002\u540c\u65f6\u4e5f\u610f\u5473\u7740\u5f53\u7ebf\u7a0b\u6570\u4e0d\u8db3\u7684\u65f6\u5019\uff0cExecutionQueue\u65e0\u6cd5\u4fdd\u8bc1\u516c\u5e73\u6027, \u5f53\u53d1\u751f\u8fd9\u79cd\u60c5\u51b5\u7684\u65f6\u5019\u9700\u8981\u52a8\u6001\u589e\u52a0kthread\u7684worker\u7ebf\u7a0b\u6765\u589e\u52a0\u6574\u4f53\u7684\u5904\u7406\u80fd\u529b."}),"\n",(0,i.jsx)(n.li,{children:"ExecutionQueue\u8fd0\u884c\u7ebf\u7a0b\u4e3akthread, \u53ef\u4ee5\u968f\u610f\u7684\u4f7f\u7528\u4e00\u4e9bkthread\u540c\u6b65\u539f\u8bed\u800c\u4e0d\u7528\u62c5\u5fc3\u963b\u585epthread\u7684\u6267\u884c. \u800c\u5728ExecMan\u91cc\u9762\u5f97\u5c3d\u91cf\u907f\u514d\u4f7f\u7528\u8f83\u9ad8\u6982\u7387\u4f1a\u5bfc\u81f4\u963b\u585e\u7684\u540c\u6b65\u539f\u8bed."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u80cc\u666f",children:"\u80cc\u666f"}),"\n",(0,i.jsxs)(n.p,{children:["\u5728\u591a\u6838\u5e76\u53d1\u7f16\u7a0b\u9886\u57df\uff0c ",(0,i.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Message_passing",children:"Message passing"}),"\u4f5c\u4e3a\u4e00\u79cd\u89e3\u51b3\u7ade\u4e89\u7684\u624b\u6bb5\u5f97\u5230\u4e86\u6bd4\u8f83\u5e7f\u6cdb\u7684\u5e94\u7528\uff0c\u5b83\u6309\u7167\u4e1a\u52a1\u4f9d\u8d56\u7684\u8d44\u6e90\u5c06\u903b\u8f91\u62c6\u5206\u6210\u82e5\u5e72\u4e2a\u72ec\u7acbactor\uff0c\u6bcf\u4e2aactor\u8d1f\u8d23\u5bf9\u5e94\u8d44\u6e90\u7684\u7ef4\u62a4\u5de5\u4f5c\uff0c\u5f53\u4e00\u4e2a\u6d41\u7a0b\u9700\u8981\u4fee\u6539\u67d0\u4e2a\u8d44\u6e90\u7684\u65f6\u5019\uff0c\n\u5c31\u8f6c\u5316\u4e3a\u4e00\u4e2a\u6d88\u606f\u53d1\u9001\u7ed9\u5bf9\u5e94actor\uff0c\u8fd9\u4e2aactor(\u901a\u5e38\u5728\u53e6\u5916\u7684\u4e0a\u4e0b\u6587\u4e2d)\u6839\u636e\u547d\u4ee4\u5185\u5bb9\u5bf9\u8fd9\u4e2a\u8d44\u6e90\u8fdb\u884c\u76f8\u5e94\u7684\u4fee\u6539\uff0c\u4e4b\u540e\u53ef\u4ee5\u9009\u62e9\u5524\u9192\u8c03\u7528\u8005(\u540c\u6b65)\u6216\u8005\u63d0\u4ea4\u5230\u4e0b\u4e00\u4e2aactor(\u5f02\u6b65)\u7684\u65b9\u5f0f\u8fdb\u884c\u540e\u7eed\u5904\u7406\u3002"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"http://web.mit.edu/6.005/www/fa14/classes/20-queues-locks/figures/producer-consumer.png",alt:"img"})}),"\n",(0,i.jsx)(n.h2,{id:"executionqueue-vs-mutex",children:"ExecutionQueue Vs Mutex"}),"\n",(0,i.jsx)(n.p,{children:"ExecutionQueue\u548cmutex\u90fd\u53ef\u4ee5\u7528\u6765\u5728\u591a\u7ebf\u7a0b\u573a\u666f\u4e2d\u6d88\u9664\u7ade\u4e89. \u76f8\u6bd4\u8f83\u4f7f\u7528mutex,\n\u4f7f\u7528ExecutionQueue\u6709\u7740\u5982\u4e0b\u51e0\u4e2a\u4f18\u70b9:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u89d2\u8272\u5212\u5206\u6bd4\u8f83\u6e05\u6670, \u6982\u5ff5\u7406\u89e3\u4e0a\u6bd4\u8f83\u7b80\u5355, \u5b9e\u73b0\u4e2d\u65e0\u9700\u8003\u8651\u9501\u5e26\u6765\u7684\u95ee\u9898(\u6bd4\u5982\u6b7b\u9501)"}),"\n",(0,i.jsx)(n.li,{children:"\u80fd\u4fdd\u8bc1\u4efb\u52a1\u7684\u6267\u884c\u987a\u5e8f\uff0cmutex\u7684\u5524\u9192\u987a\u5e8f\u4e0d\u80fd\u5f97\u5230\u4e25\u683c\u4fdd\u8bc1."}),"\n",(0,i.jsx)(n.li,{children:"\u6240\u6709\u7ebf\u7a0b\u5404\u53f8\u5176\u804c\uff0c\u90fd\u80fd\u5728\u505a\u6709\u7528\u7684\u4e8b\u60c5\uff0c\u4e0d\u5b58\u5728\u7b49\u5f85."}),"\n",(0,i.jsx)(n.li,{children:"\u5728\u7e41\u5fd9\u3001\u5361\u987f\u7684\u60c5\u51b5\u4e0b\u80fd\u66f4\u597d\u7684\u6279\u91cf\u6267\u884c\uff0c\u6574\u4f53\u4e0a\u83b7\u5f97\u8f83\u9ad8\u7684\u541e\u5410."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u4f46\u662f\u7f3a\u70b9\u4e5f\u540c\u6837\u660e\u663e:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u4e00\u4e2a\u6d41\u7a0b\u7684\u4ee3\u7801\u5f80\u5f80\u6563\u843d\u5728\u591a\u4e2a\u5730\u65b9\uff0c\u4ee3\u7801\u7406\u89e3\u548c\u7ef4\u62a4\u6210\u672c\u9ad8\u3002"}),"\n",(0,i.jsx)(n.li,{children:"\u4e3a\u4e86\u63d0\u9ad8\u5e76\u53d1\u5ea6\uff0c \u4e00\u4ef6\u4e8b\u60c5\u5f80\u5f80\u4f1a\u88ab\u62c6\u5206\u5230\u591a\u4e2aExecutionQueue\u8fdb\u884c\u6d41\u6c34\u7ebf\u5904\u7406\uff0c\u8fd9\u6837\u4f1a\u5bfc\u81f4\u5728\u591a\u6838\u4e4b\u95f4\u4e0d\u505c\u7684\u8fdb\u884c\u5207\u6362\uff0c\u4f1a\u4ed8\u51fa\u989d\u5916\u7684\u8c03\u5ea6\u4ee5\u53ca\u540c\u6b65cache\u7684\u5f00\u9500, \u5c24\u5176\u662f\u7ade\u4e89\u7684\u4e34\u754c\u533a\u975e\u5e38\u5c0f\u7684\u60c5\u51b5\u4e0b\uff0c \u8fd9\u4e9b\u5f00\u9500\u4e0d\u80fd\u5ffd\u7565."}),"\n",(0,i.jsx)(n.li,{children:"\u540c\u65f6\u539f\u5b50\u7684\u64cd\u4f5c\u591a\u4e2a\u8d44\u6e90\u5b9e\u73b0\u4f1a\u53d8\u5f97\u590d\u6742, \u4f7f\u7528mutex\u53ef\u4ee5\u540c\u65f6\u9501\u4f4f\u591a\u4e2amutex, \u7528\u4e86ExeuctionQueue\u5c31\u9700\u8981\u4f9d\u8d56\u989d\u5916\u7684dispatch queue\u4e86\u3002"}),"\n",(0,i.jsx)(n.li,{children:"\u7531\u4e8e\u6240\u6709\u64cd\u4f5c\u90fd\u662f\u5355\u7ebf\u7a0b\u7684\uff0c\u67d0\u4e2a\u4efb\u52a1\u8fd0\u884c\u6162\u4e86\u5c31\u4f1a\u963b\u585e\u540c\u4e00\u4e2aExecutionQueue\u7684\u5176\u4ed6\u64cd\u4f5c\u3002"}),"\n",(0,i.jsx)(n.li,{children:"\u5e76\u53d1\u63a7\u5236\u53d8\u5f97\u590d\u6742\uff0cExecutionQueue\u53ef\u80fd\u4f1a\u7531\u4e8e\u7f13\u5b58\u7684\u4efb\u52a1\u8fc7\u591a\u5360\u7528\u8fc7\u591a\u7684\u5185\u5b58\u3002"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u4e0d\u8003\u8651\u6027\u80fd\u548c\u590d\u6742\u5ea6\uff0c\u7406\u8bba\u4e0a\u4efb\u4f55\u7cfb\u7edf\u90fd\u53ef\u4ee5\u53ea\u4f7f\u7528mutex\u6216\u8005ExecutionQueue\u6765\u6d88\u9664\u7ade\u4e89.\n\u4f46\u662f\u590d\u6742\u7cfb\u7edf\u7684\u8bbe\u8ba1\u4e0a\uff0c\u5efa\u8bae\u6839\u636e\u4e0d\u540c\u7684\u573a\u666f\u7075\u6d3b\u51b3\u5b9a\u5982\u4f55\u4f7f\u7528\u8fd9\u4e24\u4e2a\u5de5\u5177:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5982\u679c\u4e34\u754c\u533a\u975e\u5e38\u5c0f\uff0c\u7ade\u4e89\u53c8\u4e0d\u662f\u5f88\u6fc0\u70c8\uff0c\u4f18\u5148\u9009\u62e9\u4f7f\u7528mutex, \u4e4b\u540e\u53ef\u4ee5\u7ed3\u5408",(0,i.jsx)(n.a,{href:"/docs/next/cpp/krpc/contention_profiler",children:"contention profiler"}),"\u6765\u5224\u65admutex\u662f\u5426\u6210\u4e3a\u74f6\u9888\u3002"]}),"\n",(0,i.jsx)(n.li,{children:"\u9700\u8981\u6709\u5e8f\u6267\u884c\uff0c\u6216\u8005\u65e0\u6cd5\u6d88\u9664\u7684\u6fc0\u70c8\u7ade\u4e89\u4f46\u662f\u53ef\u4ee5\u901a\u8fc7\u6279\u91cf\u6267\u884c\u6765\u63d0\u9ad8\u541e\u5410\uff0c \u53ef\u4ee5\u9009\u62e9\u4f7f\u7528ExecutionQueue\u3002"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u603b\u4e4b\uff0c\u591a\u7ebf\u7a0b\u7f16\u7a0b\u6ca1\u6709\u4e07\u80fd\u7684\u6a21\u578b\uff0c\u9700\u8981\u6839\u636e\u5177\u4f53\u7684\u573a\u666f\uff0c\u7ed3\u5408\u4e30\u5bcc\u7684profliling\u5de5\u5177\uff0c\u6700\u7ec8\u5728\u590d\u6742\u5ea6\u548c\u6027\u80fd\u4e4b\u95f4\u627e\u5230\u5408\u9002\u7684\u5e73\u8861\u3002"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u7279\u522b\u6307\u51fa\u4e00\u70b9"}),"\uff0cLinux\u4e2dmutex\u65e0\u7ade\u4e89\u7684lock/unlock\u53ea\u6709\u9700\u8981\u51e0\u6761\u539f\u5b50\u6307\u4ee4\uff0c\u5728\u7edd\u5927\u591a\u6570\u573a\u666f\u4e0b\u7684\u5f00\u9500\u90fd\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8ba1."]}),"\n",(0,i.jsx)(n.h2,{id:"\u4f7f\u7528\u65b9\u5f0f",children:"\u4f7f\u7528\u65b9\u5f0f"}),"\n",(0,i.jsx)(n.h3,{id:"\u5b9e\u73b0\u6267\u884c\u51fd\u6570",children:"\u5b9e\u73b0\u6267\u884c\u51fd\u6570"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"// Iterate over the given tasks\n//\n// Example:\n//\n// #include <kthread/execution_queue.h>\n//\n// int demo_execute(void* meta, TaskIterator<T>& iter) {\n//     if (iter.is_queue_stopped()) {\n//         // destroy meta and related resources\n//         return 0;\n//     }\n//     for (; iter; ++iter) {\n//         // do_something(meta, *iter)\n//         // or do_something(meta, iter->a_member_of_T)\n//     }\n//     return 0;\n// }\ntemplate <typename T>\nclass TaskIterator;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u542f\u52a8\u4e00\u4e2aexecutionqueue",children:"\u542f\u52a8\u4e00\u4e2aExecutionQueue:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"struct ExecutionQueueOptions {\n    ExecutionQueueOptions();\n\n    // Execute in resident pthread instead of kthread. default: false.\n    bool use_pthread;\n\n    // Attribute of the kthread which execute runs on. default: KTHREAD_ATTR_NORMAL\n    // Kthread will be used when executor = NULL and use_pthread == false.\n    kthread_attr_t kthread_attr;\n\n    // Executor that tasks run on. default: NULL\n    // Note that TaskOptions.in_place_if_possible = false will not work, if implementation of\n    // Executor is in-place(synchronous).\n    Executor * executor;\n};\n\n// Start a ExecutionQueue. If |options| is NULL, the queue will be created with\n// default options.\n// Returns 0 on success, errno otherwise\n// NOTE: type |T| can be non-POD but must be copy-constructible\ntemplate <typename T>\nint execution_queue_start(\n        ExecutionQueueId<T>* id,\n        const ExecutionQueueOptions* options,\n        int (*execute)(void* meta, TaskIterator<T>& iter),\n        void* meta);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u521b\u5efa\u7684\u8fd4\u56de\u503c\u662f\u4e00\u4e2a64\u4f4d\u7684id, \u76f8\u5f53\u4e8eExecutionQueue\u5b9e\u4f8b\u7684\u4e00\u4e2a",(0,i.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Weak_reference",children:"\u5f31\u5f15\u7528"}),", \u53ef\u4ee5wait-free\u7684\u5728O(1)\u65f6\u95f4\u5185\u5b9a\u4f4d\u4e00\u4e2aExecutionQueue, \u4f60\u53ef\u4ee5\u5230\u5904\u62f7\u8d1d\u8fd9\u4e2aid\uff0c \u751a\u81f3\u53ef\u4ee5\u653e\u5728RPC\u4e2d\uff0c\u4f5c\u4e3a\u8fdc\u7aef\u8d44\u6e90\u7684\u5b9a\u4f4d\u5de5\u5177\u3002\n\u4f60\u5fc5\u987b\u4fdd\u8bc1meta\u7684\u751f\u547d\u5468\u671f\uff0c\u5728\u5bf9\u5e94\u7684ExecutionQueue\u771f\u6b63\u505c\u6b62\u524d\u4e0d\u4f1a\u91ca\u653e."]}),"\n",(0,i.jsx)(n.h3,{id:"\u505c\u6b62\u4e00\u4e2aexecutionqueue",children:"\u505c\u6b62\u4e00\u4e2aExecutionQueue:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"// Stop the ExecutionQueue.\n// After this function is called:\n//  - All the following calls to execution_queue_execute would fail immediately.\n//  - The executor will call |execute| with TaskIterator::is_queue_stopped() being\n//    true exactly once when all the pending tasks have been executed, and after\n//    this point it's ok to release the resource referenced by |meta|.\n// Returns 0 on success, errno othrwise\ntemplate <typename T>\nint execution_queue_stop(ExecutionQueueId<T> id);\n \n// Wait until the the stop task (Iterator::is_queue_stopped() returns true) has\n// been executed\ntemplate <typename T>\nint execution_queue_join(ExecutionQueueId<T> id);\n"})}),"\n",(0,i.jsx)(n.p,{children:"stop\u548cjoin\u90fd\u53ef\u4ee5\u591a\u6b21\u8c03\u7528\uff0c \u90fd\u4f1a\u6709\u5408\u7406\u7684\u884c\u4e3a\u3002stop\u53ef\u4ee5\u968f\u65f6\u8c03\u7528\u800c\u4e0d\u7528\u5f53\u5fc3\u7ebf\u7a0b\u5b89\u5168\u6027\u95ee\u9898\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u548cfd\u7684close\u7c7b\u4f3c\uff0c\u5982\u679cstop\u4e0d\u88ab\u8c03\u7528, \u76f8\u5e94\u7684\u8d44\u6e90\u4f1a\u6c38\u4e45\u6cc4\u9732\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u5b89\u5168\u91ca\u653emeta\u7684\u65f6\u673a: \u53ef\u4ee5\u5728execute\u51fd\u6570\u4e2d\u6536\u5230iter.is_queue_stopped()==true\u7684\u4efb\u52a1\u7684\u65f6\u5019\u91ca\u653e\uff0c\u4e5f\u53ef\u4ee5\u7b49\u5230join\u8fd4\u56de\u4e4b\u540e\u91ca\u653e. \u6ce8\u610f\u4e0d\u8981double-free"}),"\n",(0,i.jsx)(n.h3,{id:"\u63d0\u4ea4\u4efb\u52a1",children:"\u63d0\u4ea4\u4efb\u52a1"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"struct TaskOptions {\n    TaskOptions();\n    TaskOptions(bool high_priority, bool in_place_if_possible);\n \n    // Executor would execute high-priority tasks in the FIFO order but before\n    // all pending normal-priority tasks.\n    // NOTE: We don't guarantee any kind of real-time as there might be tasks still\n    // in process which are uninterruptible.\n    //\n    // Default: false\n    bool high_priority;\n \n    // If |in_place_if_possible| is true, execution_queue_execute would call\n    // execute immediately instead of starting a kthread if possible\n    //\n    // Note: Running callbacks in place might cause the dead lock issue, you\n    // should be very careful turning this flag on.\n    //\n    // Default: false\n    bool in_place_if_possible;\n};\n \nconst static TaskOptions TASK_OPTIONS_NORMAL = TaskOptions(/*high_priority=*/ false, /*in_place_if_possible=*/ false);\nconst static TaskOptions TASK_OPTIONS_URGENT = TaskOptions(/*high_priority=*/ true, /*in_place_if_possible=*/ false);\nconst static TaskOptions TASK_OPTIONS_INPLACE = TaskOptions(/*high_priority=*/ false, /*in_place_if_possible=*/ true);\n \n// Thread-safe and Wait-free.\n// Execute a task with defaut TaskOptions (normal task);\ntemplate <typename T>\nint execution_queue_execute(ExecutionQueueId<T> id,\n                            typename kutil::add_const_reference<T>::type task);\n \n// Thread-safe and Wait-free.\n// Execute a task with options. e.g\n// kthread::execution_queue_execute(queue, task, &kthread::TASK_OPTIONS_URGENT)\n// If |options| is NULL, we will use default options (normal task)\n// If |handle| is not NULL, we will assign it with the handler of this task.\ntemplate <typename T>\nint execution_queue_execute(ExecutionQueueId<T> id,\n                            typename kutil::add_const_reference<T>::type task,\n                            const TaskOptions* options);\ntemplate <typename T>\nint execution_queue_execute(ExecutionQueueId<T> id,\n                            typename kutil::add_const_reference<T>::type task,\n                            const TaskOptions* options,\n                            TaskHandle* handle);\n                            \ntemplate <typename T>\nint execution_queue_execute(ExecutionQueueId<T> id,\n                            T&& task);\n\ntemplate <typename T>\nint execution_queue_execute(ExecutionQueueId<T> id,\n                            T&& task,\n                            const TaskOptions* options);\n\ntemplate <typename T>\nint execution_queue_execute(ExecutionQueueId<T> id,\n                            T&& task,\n                            const TaskOptions* options,\n                            TaskHandle* handle);\n                            \n"})}),"\n",(0,i.jsxs)(n.p,{children:["high_priority\u7684task\u4e4b\u95f4\u7684\u6267\u884c\u987a\u5e8f\u4e5f\u4f1a",(0,i.jsx)(n.strong,{children:"\u4e25\u683c\u6309\u7167\u63d0\u4ea4\u987a\u5e8f"}),", \u8fd9\u70b9\u548cExecMan\u4e0d\u540c, ExecMan\u7684QueueExecEmergent\u7684AsyncContex\u6267\u884c\u987a\u5e8f\u662fundefined. \u4f46\u662f\u8fd9\u4e5f\u610f\u5473\u7740\u4f60\u6ca1\u6709\u529e\u6cd5\u5c06\u4efb\u4f55\u4efb\u52a1\u63d2\u961f\u5230\u4e00\u4e2ahigh priority\u7684\u4efb\u52a1\u4e4b\u524d\u6267\u884c."]}),"\n",(0,i.jsx)(n.p,{children:"\u5f00\u542finplace_if_possible, \u5728\u65e0\u7ade\u4e89\u7684\u573a\u666f\u4e2d\u53ef\u4ee5\u7701\u53bb\u4e00\u6b21\u7ebf\u7a0b\u8c03\u5ea6\u548ccache\u540c\u6b65\u7684\u5f00\u9500. \u4f46\u662f\u53ef\u80fd\u4f1a\u9020\u6210\u6b7b\u9501\u6216\u8005\u9012\u5f52\u5c42\u6570\u8fc7\u591a(\u6bd4\u5982\u4e0d\u505c\u7684ping-pong)\u7684\u95ee\u9898\uff0c\u5f00\u542f\u524d\u8bf7\u786e\u5b9a\u4f60\u7684\u4ee3\u7801\u4e2d\u4e0d\u5b58\u5728\u8fd9\u4e9b\u95ee\u9898\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"\u53d6\u6d88\u4e00\u4e2a\u5df2\u63d0\u4ea4\u4efb\u52a1",children:"\u53d6\u6d88\u4e00\u4e2a\u5df2\u63d0\u4ea4\u4efb\u52a1"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"/// [Thread safe and ABA free] Cancel the corresponding task.\n// Returns:\n//  -1: The task was executed or h is an invalid handle\n//  0: Success\n//  1: The task is executing\nint execution_queue_cancel(const TaskHandle& h);\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u8fd4\u56de\u975e0\u4ec5\u4ec5\u610f\u5473\u7740ExecutionQueue\u5df2\u7ecf\u5c06\u5bf9\u5e94\u7684task\u9012\u7ed9\u8fc7execute, \u771f\u5b9e\u7684\u903b\u8f91\u4e2d\u53ef\u80fd\u5c06\u8fd9\u4e2atask\u7f13\u5b58\u5728\u53e6\u5916\u7684\u5bb9\u5668\u4e2d\uff0c\u6240\u4ee5\u8fd9\u5e76\u4e0d\u610f\u5473\u7740\u903b\u8f91\u4e0a\u7684task\u5df2\u7ecf\u7ed3\u675f\uff0c\u4f60\u9700\u8981\u5728\u81ea\u5df1\u7684\u4e1a\u52a1\u4e0a\u4fdd\u8bc1\u8fd9\u4e00\u70b9."})]})}function d(e={}){const{wrapper:n}={...(0,u.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>o});var i=t(96540);const u={},s=i.createContext(u);function c(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(u):e.components||u:c(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);