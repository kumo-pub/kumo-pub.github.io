(self.webpackChunkkumo_website=self.webpackChunkkumo_website||[]).push([[2664],{57625:(e,r,n)=>{e.exports={src:{srcSet:n.p+"assets/ideal-img/echo_cpu_profiling.a5b7816.640.png 640w,"+n.p+"assets/ideal-img/echo_cpu_profiling.639887f.1030.png 1030w",images:[{path:n.p+"assets/ideal-img/echo_cpu_profiling.a5b7816.640.png",width:640,height:321},{path:n.p+"assets/ideal-img/echo_cpu_profiling.639887f.1030.png",width:1030,height:517}],src:n.p+"assets/ideal-img/echo_cpu_profiling.a5b7816.640.png",toString:function(){return n.p+"assets/ideal-img/echo_cpu_profiling.a5b7816.640.png"},placeholder:void 0,width:640,height:321},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAcklEQVR4nGWOWQ7DMAhEff/Lpb/e4jN4qVfZEw1fqToSAoYHQl3XB/6+YYyB1hree1hrJZxzCCFIVrV+sdbCOQe1VrTW0HoTr/eOMYZ4Ci9xkHNGKUUA1iklxBj/QUK8sPeWnjHn/AV5hduE+QrFhTkXHsjXwFPSjkPCAAAAAElFTkSuQmCC"}},31138:(e,r,n)=>{"use strict";n.r(r),n.d(r,{assets:()=>h,contentTitle:()=>i,default:()=>f,frontMatter:()=>p,metadata:()=>t,toc:()=>d});var l=n(74848),o=n(28453),c=n(57625),s=n.n(c);const p={},i="CPU\u4f7f\u7528\u5206\u6790",t={id:"cpp/krpc/cpu_profiler",title:"CPU\u4f7f\u7528\u5206\u6790",description:"krpc\u53ef\u4ee5\u5206\u6790\u7a0b\u5e8f\u4e2d\u7684\u70ed\u70b9\u51fd\u6570\u3002",source:"@site/versioned_docs/version-1.1.1/cpp/krpc/cpu_profiler.mdx",sourceDirName:"cpp/krpc",slug:"/cpp/krpc/cpu_profiler",permalink:"/docs/cpp/krpc/cpu_profiler",draft:!1,unlisted:!1,tags:[],version:"1.1.1",frontMatter:{},sidebar:"docs",previous:{title:"Thrift\u670d\u52a1",permalink:"/docs/cpp/krpc/thrift"},next:{title:"\u5806\u6808\u5206\u6790",permalink:"/docs/cpp/krpc/heap_profiler"}},h={},d=[{value:"\u5f00\u542f\u65b9\u6cd5",id:"\u5f00\u542f\u65b9\u6cd5",level:2},{value:"\u67e5\u770b\u65b9\u6cd5",id:"\u67e5\u770b\u65b9\u6cd5",level:2},{value:"\u63a7\u5236\u91c7\u6837\u9891\u7387",id:"\u63a7\u5236\u91c7\u6837\u9891\u7387",level:2},{value:"\u63a7\u5236\u91c7\u6837\u65f6\u95f4",id:"\u63a7\u5236\u91c7\u6837\u65f6\u95f4",level:2},{value:"\u56fe\u793a",id:"\u56fe\u793a",level:2},{value:"MacOS\u7684\u989d\u5916\u914d\u7f6e",id:"macos\u7684\u989d\u5916\u914d\u7f6e",level:2},{value:"\u706b\u7130\u56fe",id:"\u706b\u7130\u56fe",level:2}];function a(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(r.header,{children:(0,l.jsx)(r.h1,{id:"cpu\u4f7f\u7528\u5206\u6790",children:"CPU\u4f7f\u7528\u5206\u6790"})}),"\n",(0,l.jsx)(r.p,{children:"krpc\u53ef\u4ee5\u5206\u6790\u7a0b\u5e8f\u4e2d\u7684\u70ed\u70b9\u51fd\u6570\u3002"}),"\n",(0,l.jsx)(r.h2,{id:"\u5f00\u542f\u65b9\u6cd5",children:"\u5f00\u542f\u65b9\u6cd5"}),"\n",(0,l.jsxs)(r.ol,{children:["\n",(0,l.jsxs)(r.li,{children:["\u94fe\u63a5",(0,l.jsx)(r.code,{children:"libtcmalloc_and_profiler.a"}),"\n",(0,l.jsxs)(r.ol,{children:["\n",(0,l.jsxs)(r.li,{children:["\u8fd9\u4e48\u5199\u4e5f\u5f00\u542f\u4e86tcmalloc\uff0c\u4e0d\u5efa\u8bae\u5355\u72ec\u94fe\u63a5cpu profiler\u800c\u4e0d\u94fe\u63a5tcmalloc\uff0c\u53ef\u80fd\u8d8a\u754c\u8bbf\u95ee\u5bfc\u81f4",(0,l.jsx)(r.a,{href:"https://github.com/gperftools/gperftools/blob/master/README#L226",children:"crash"}),".\u53ef\u80fd\u7531\u4e8etcmalloc\u4e0d\u53ca\u65f6\u5f52\u8fd8\u5185\u5b58\uff0c\u8d8a\u754c\u8bbf\u95ee\u4e0d\u4f1acrash\u3002"]}),"\n",(0,l.jsxs)(r.li,{children:["\u5982\u679ctcmalloc\u4f7f\u7528frame pointer\u800c\u4e0d\u662flibunwind\u56de\u6eaf\u6808\uff0c\u8bf7\u786e\u4fdd\u5728CXXFLAGS\u6216CFLAGS\u4e2d\u52a0\u4e0a",(0,l.jsx)(r.code,{children:"-fno-omit-frame-pointer"}),"\uff0c\u5426\u5219\u51fd\u6570\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u4f1a\u4e22\u5931\uff0c\u6700\u540e\u4ea7\u751f\u7684\u56fe\u7247\u4e2d\u90fd\u662f\u5f7c\u6b64\u72ec\u7acb\u7684\u51fd\u6570\u65b9\u6846\u3002"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(r.li,{children:"\u5b9a\u4e49\u5b8fKRPC_ENABLE_CPU_PROFILER, \u4e00\u822c\u52a0\u5165\u7f16\u8bd1\u53c2\u6570-DKRPC_ENABLE_CPU_PROFILER\u3002\u6ce8\u610f\uff1aKRPC_ENABLE_CPU_PROFILER\u5b8f\u9700\u8981\u5b9a\u4e49\u5728\u5f15\u7528\u5230krpc\u5934\u6587\u4ef6(channel.h\u6216server.h)\u7684\u4ee3\u7801\u91cc\u3002\u6bd4\u5982A\u6a21\u5757\u5f15\u7528B\u6a21\u5757\uff0cB\u6a21\u5757\u5728\u5b9e\u73b0\u4e2d\u5f15\u7528krpc\u5934\u6587\u4ef6\uff0c\u5fc5\u987b\u5728B\u6a21\u5757\u7684\u7f16\u8bd1\u53c2\u6570\u52a0\u4e0aKRPC_ENABLE_CPU_PROFILER\u5b8f\uff0c\u5728A\u6a21\u5757\u52a0\u662f\u6ca1\u7528\u7684\u3002"}),"\n",(0,l.jsxs)(r.li,{children:["\u5982\u679c\u53ea\u662fkrpc client\u6216\u6ca1\u6709\u4f7f\u7528krpc\uff0c\u770b",(0,l.jsx)(r.a,{href:"/docs/cpp/krpc/dummy_server",children:"\u8fd9\u91cc"}),"\u3002"]}),"\n"]}),"\n",(0,l.jsx)(r.p,{children:"\u6ce8\u610f\u8981\u5173\u95edServer\u7aef\u7684\u8ba4\u8bc1\uff0c\u5426\u5219\u53ef\u80fd\u4f1a\u770b\u5230\u8fd9\u4e2a\uff1a"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{children:"$ tools/pprof --text localhost:9002/pprof/profile\nUse of uninitialized value in substitution (s///) at tools/pprof line 2703.\nhttp://localhost:9002/profile/symbol doesn't exist\n"})}),"\n",(0,l.jsx)(r.p,{children:"server\u7aef\u53ef\u80fd\u4f1a\u6709\u8fd9\u6837\u7684\u65e5\u5fd7\uff1a"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{children:"FATAL: 12-26 10:01:25:   * 0 [src/krpc/policy/giano_authenticator.cpp:65][4294969345] Giano fails to verify credentical, 70003\nWARNING: 12-26 10:01:25:   * 0 [src/krpc/input_messenger.cpp:132][4294969345] Authentication failed, remote side(127.0.0.1:22989) of sockfd=5, close it\n"})}),"\n",(0,l.jsx)(r.h2,{id:"\u67e5\u770b\u65b9\u6cd5",children:"\u67e5\u770b\u65b9\u6cd5"}),"\n",(0,l.jsxs)(r.ol,{children:["\n",(0,l.jsx)(r.li,{children:"\u901a\u8fc7builtin service\u7684 /hotspots/cpu \u9875\u9762\u67e5\u770b"}),"\n",(0,l.jsx)(r.li,{children:"\u901a\u8fc7pprof \u5de5\u5177\u67e5\u770b\uff0c\u5982 tools/pprof --text localhost:9002/pprof/profile"}),"\n"]}),"\n",(0,l.jsx)(r.h2,{id:"\u63a7\u5236\u91c7\u6837\u9891\u7387",children:"\u63a7\u5236\u91c7\u6837\u9891\u7387"}),"\n",(0,l.jsx)(r.p,{children:"\u542f\u52a8\u524d\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\uff1aexport CPUPROFILE_FREQUENCY=xxx"}),"\n",(0,l.jsx)(r.p,{children:"\u9ed8\u8ba4\u503c\u4e3a: 100"}),"\n",(0,l.jsx)(r.h2,{id:"\u63a7\u5236\u91c7\u6837\u65f6\u95f4",children:"\u63a7\u5236\u91c7\u6837\u65f6\u95f4"}),"\n",(0,l.jsx)(r.p,{children:"url\u52a0\u4e0a?seconds=\u79d2\u6570\uff0c\u5982/hotspots/cpu?seconds=5"}),"\n",(0,l.jsx)(r.h2,{id:"\u56fe\u793a",children:"\u56fe\u793a"}),"\n",(0,l.jsx)(r.p,{children:"\u4e0b\u56fe\u662f\u4e00\u6b21\u8fd0\u884ccpu profiler\u540e\u7684\u7ed3\u679c\uff1a"}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsx)(r.li,{children:"\u5de6\u4e0a\u89d2\u662f\u603b\u4f53\u4fe1\u606f\uff0c\u5305\u62ec\u65f6\u95f4\uff0c\u7a0b\u5e8f\u540d\uff0c\u603b\u91c7\u6837\u6570\u7b49\u7b49\u3002"}),"\n",(0,l.jsx)(r.li,{children:"View\u6846\u4e2d\u53ef\u4ee5\u9009\u62e9\u67e5\u770b\u4e4b\u524d\u8fd0\u884c\u8fc7\u7684profile\u7ed3\u679c\uff0cDiff\u6846\u4e2d\u53ef\u9009\u62e9\u67e5\u770b\u548c\u4e4b\u524d\u7684\u7ed3\u679c\u7684\u53d8\u5316\u91cf\uff0c\u91cd\u542f\u540e\u6e05\u7a7a\u3002"}),"\n",(0,l.jsx)(r.li,{children:"\u4ee3\u8868\u51fd\u6570\u8c03\u7528\u7684\u65b9\u6846\u4e2d\u7684\u5b57\u6bb5\u4ece\u4e0a\u5230\u4e0b\u4f9d\u6b21\u4e3a\uff1a\u51fd\u6570\u540d\uff0c\u8fd9\u4e2a\u51fd\u6570\u672c\u8eab\uff08\u9664\u53bb\u6240\u6709\u5b50\u51fd\u6570\uff09\u5360\u7684\u91c7\u6837\u6570\u548c\u6bd4\u4f8b\uff0c\u8fd9\u4e2a\u51fd\u6570\u53ca\u8c03\u7528\u7684\u6240\u6709\u5b50\u51fd\u6570\u7d2f\u8ba1\u7684\u91c7\u6837\u6570\u548c\u6bd4\u4f8b\u3002\u91c7\u6837\u6570\u8d8a\u5927\u6846\u8d8a\u5927\u3002"}),"\n",(0,l.jsx)(r.li,{children:"\u65b9\u6846\u4e4b\u95f4\u8fde\u7ebf\u4e0a\u7684\u6570\u5b57\u8868\u793a\u88ab\u91c7\u6837\u5230\u7684\u4e0a\u5c42\u51fd\u6570\u5bf9\u4e0b\u5c42\u51fd\u6570\u7684\u8c03\u7528\u6570\uff0c\u6570\u5b57\u8d8a\u5927\u7ebf\u8d8a\u7c97\u3002"}),"\n"]}),"\n",(0,l.jsx)(r.p,{children:"\u70ed\u70b9\u5206\u6790\u4e00\u822c\u5f00\u59cb\u4e8e\u627e\u5230\u6700\u5927\u7684\u6846\u6700\u7c97\u7684\u7ebf\u8003\u5bdf\u5176\u6765\u6e90\u53ca\u53bb\u5411\u3002"}),"\n",(0,l.jsx)(r.p,{children:"cpu profiler\u7684\u539f\u7406\u662f\u5728\u5b9a\u671f\u88ab\u8c03\u7528\u7684SIGPROF handler\u4e2d\u91c7\u6837\u6240\u5728\u7ebf\u7a0b\u7684\u6808\uff0c\u7531\u4e8ehandler\uff08\u5728linux 2.6\u540e\uff09\u4f1a\u88ab\u968f\u673a\u5730\u6446\u653e\u4e8e\u6d3b\u8dc3\u7ebf\u7a0b\u7684\u6808\u4e0a\u8fd0\u884c\uff0ccpu profiler\u5728\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540e\u80fd\u4ee5\u5f88\u5927\u7684\u6982\u7387\u91c7\u96c6\u5230\u6240\u6709\u6d3b\u8dc3\u7ebf\u7a0b\u4e2d\u7684\u6d3b\u8dc3\u51fd\u6570\uff0c\u6700\u540e\u6839\u636e\u6808\u4ee3\u8868\u7684\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u6c47\u603b\u4e3a\u8c03\u7528\u56fe\uff0c\u5e76\u628a\u5730\u5740\u8f6c\u6362\u6210\u7b26\u53f7\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u770b\u5230\u7684\u7ed3\u679c\u56fe\u4e86\u3002\u91c7\u96c6\u9891\u7387\u7531\u73af\u5883\u53d8\u91cfCPUPROFILE_FREQUENCY\u63a7\u5236\uff0c\u9ed8\u8ba4100\uff0c\u5373\u6bcf\u79d2\u949f100\u6b21\u6216\u6bcf10ms\u4e00\u6b21\u3002\u5728\u5b9e\u8df5\u4e2dcpu profiler\u5bf9\u539f\u7a0b\u5e8f\u7684\u5f71\u54cd\u4e0d\u660e\u663e\u3002"}),"\n","\n",(0,l.jsx)("img",{src:s()}),"\n",(0,l.jsxs)(r.p,{children:["\u5728Linux\u4e0b\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528",(0,l.jsx)(r.a,{href:"https://github.com/apache/krpc/blob/master/tools/pprof",children:"pprof"}),"\u6216gperftools\u4e2d\u7684pprof\u8fdb\u884cprofiling\u3002"]}),"\n",(0,l.jsxs)(r.p,{children:["\u6bd4\u5982",(0,l.jsx)(r.code,{children:"pprof --text localhost:9002 --seconds=5"}),"\u7684\u610f\u601d\u662f\u7edf\u8ba1\u8fd0\u884c\u5728\u672c\u673a9002\u7aef\u53e3\u7684server\u7684cpu\u60c5\u51b5\uff0c\u65f6\u957f5\u79d2\u3002\u4e00\u6b21\u8fd0\u884c\u7684\u4f8b\u5b50\u5982\u4e0b\uff1a"]}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{children:"$ tools/pprof --text 0.0.0.0:9002 --seconds=5\nGathering CPU profile from http://0.0.0.0:9002/pprof/profile?seconds=5 for 5 seconds to\n  /home/gejun/pprof/echo_server.1419501210.0.0.0.0\nBe patient...\nWrote profile to /home/gejun/pprof/echo_server.1419501210.0.0.0.0\nRemoving funlockfile from all stack traces.\nTotal: 2946 samples\n    1161  39.4%  39.4%     1161  39.4% syscall\n     248   8.4%  47.8%      248   8.4% kthread::TaskControl::steal_task\n     227   7.7%  55.5%      227   7.7% writev\n      87   3.0%  58.5%       88   3.0% ::cpp_alloc\n      74   2.5%  61.0%       74   2.5% __read_nocancel\n      46   1.6%  62.6%       48   1.6% tc_delete\n      42   1.4%  64.0%       42   1.4% krpc::Socket::Address\n      41   1.4%  65.4%       41   1.4% epoll_wait\n      35   1.2%  66.6%       35   1.2% memcpy\n      33   1.1%  67.7%       33   1.1% __pthread_getspecific\n      33   1.1%  68.8%       33   1.1% krpc::Socket::Write\n      33   1.1%  69.9%       33   1.1% epoll_ctl\n      28   1.0%  70.9%       42   1.4% krpc::policy::ProcessRpcRequest\n      27   0.9%  71.8%       27   0.9% kutil::IOBuf::_push_back_ref\n      27   0.9%  72.7%       27   0.9% kthread::TaskGroup::ending_sched\n"})}),"\n",(0,l.jsx)(r.p,{children:"\u7701\u7565\u2013text\u8fdb\u5165\u4ea4\u4e92\u6a21\u5f0f\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{children:"$ tools/pprof localhost:9002 --seconds=5       \nGathering CPU profile from http://0.0.0.0:9002/pprof/profile?seconds=5 for 5 seconds to\n  /home/gejun/pprof/echo_server.1419501236.0.0.0.0\nBe patient...\nWrote profile to /home/gejun/pprof/echo_server.1419501236.0.0.0.0\nRemoving funlockfile from all stack traces.\nWelcome to pprof!  For help, type 'help'.\n(pprof) top\nTotal: 2954 samples\n    1099  37.2%  37.2%     1099  37.2% syscall\n     253   8.6%  45.8%      253   8.6% kthread::TaskControl::steal_task\n     240   8.1%  53.9%      240   8.1% writev\n      90   3.0%  56.9%       90   3.0% ::cpp_alloc\n      67   2.3%  59.2%       67   2.3% __read_nocancel\n      47   1.6%  60.8%       47   1.6% kutil::IOBuf::_push_back_ref\n      42   1.4%  62.2%       56   1.9% krpc::policy::ProcessRpcRequest\n      41   1.4%  63.6%       41   1.4% epoll_wait\n      38   1.3%  64.9%       38   1.3% epoll_ctl\n      37   1.3%  66.1%       37   1.3% memcpy\n      35   1.2%  67.3%       35   1.2% krpc::Socket::Address\n"})}),"\n",(0,l.jsx)(r.h2,{id:"macos\u7684\u989d\u5916\u914d\u7f6e",children:"MacOS\u7684\u989d\u5916\u914d\u7f6e"}),"\n",(0,l.jsx)(r.p,{children:"\u5728MacOS\u4e0b\uff0cgperftools\u4e2d\u7684perl pprof\u811a\u672c\u65e0\u6cd5\u5c06\u51fd\u6570\u5730\u5740\u8f6c\u53d8\u6210\u51fd\u6570\u540d\uff0c\u89e3\u51b3\u529e\u6cd5\u662f\uff1a"}),"\n",(0,l.jsxs)(r.ol,{children:["\n",(0,l.jsxs)(r.li,{children:["\u5b89\u88c5",(0,l.jsx)(r.a,{href:"https://github.com/google/pprof",children:"standalone pprof"}),"\uff0c\u5e76\u628a\u4e0b\u8f7d\u7684pprof\u4e8c\u8fdb\u5236\u6587\u4ef6\u8def\u5f84\u5199\u5165\u73af\u5883\u53d8\u91cfGOOGLE_PPROF_BINARY_PATH\u4e2d"]}),"\n",(0,l.jsxs)(r.li,{children:["\u5b89\u88c5llvm-symbolizer\uff08\u5c06\u51fd\u6570\u7b26\u53f7\u8f6c\u5316\u4e3a\u51fd\u6570\u540d\uff09\uff0c\u76f4\u63a5\u7528brew\u5b89\u88c5\u5373\u53ef\uff1a",(0,l.jsx)(r.code,{children:"brew install llvm"})]}),"\n"]}),"\n",(0,l.jsx)(r.h2,{id:"\u706b\u7130\u56fe",children:"\u706b\u7130\u56fe"}),"\n",(0,l.jsxs)(r.p,{children:["\u82e5\u9700\u8981\u7ed3\u679c\u4ee5\u706b\u7130\u56fe\u7684\u65b9\u5f0f\u5c55\u793a\uff0c\u8bf7\u4e0b\u8f7d\u5e76\u5b89\u88c5",(0,l.jsx)(r.a,{href:"https://github.com/brendangregg/FlameGraph",children:"FlameGraph"}),"\u5de5\u5177\uff0c\u5c06\u73af\u5883\u53d8\u91cfFLAMEGRAPH_PL_PATH\u6b63\u786e\u8bbe\u7f6e\u5230\u672c\u5730\u7684/path/to/flamegraph.pl\u540e\u542f\u52a8server\u5373\u53ef\u3002"]})]})}function f(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,l.jsx)(r,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},28453:(e,r,n)=>{"use strict";n.d(r,{R:()=>s,x:()=>p});var l=n(96540);const o={},c=l.createContext(o);function s(e){const r=l.useContext(c);return l.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function p(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),l.createElement(c.Provider,{value:r},e.children)}}}]);