(self.webpackChunkkumo_website=self.webpackChunkkumo_website||[]).push([[14464],{29253:(e,t,n)=>{e.exports={src:{srcSet:n.p+"assets/ideal-img/302.cc8caff.640.png 640w,"+n.p+"assets/ideal-img/302.6dc095f.945.png 945w",images:[{path:n.p+"assets/ideal-img/302.cc8caff.640.png",width:640,height:48},{path:n.p+"assets/ideal-img/302.6dc095f.945.png",width:945,height:71}],src:n.p+"assets/ideal-img/302.cc8caff.640.png",toString:function(){return n.p+"assets/ideal-img/302.cc8caff.640.png"},placeholder:void 0,width:640,height:48},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAABCAYAAADn9T9+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAALUlEQVR4nAXBAQ4AEAwAMf9/KlmYmYzgtKk0w+Iw98PiIuqoKM0X0ie5GnUEHxYqJn4w+rawAAAAAElFTkSuQmCC"}},89363:(e,t,n)=>{e.exports={src:{srcSet:n.p+"assets/ideal-img/restful_1.dd05b2b.640.png 640w,"+n.p+"assets/ideal-img/restful_1.deb7783.675.png 675w",images:[{path:n.p+"assets/ideal-img/restful_1.dd05b2b.640.png",width:640,height:58},{path:n.p+"assets/ideal-img/restful_1.deb7783.675.png",width:675,height:61}],src:n.p+"assets/ideal-img/restful_1.dd05b2b.640.png",toString:function(){return n.p+"assets/ideal-img/restful_1.dd05b2b.640.png"},placeholder:void 0,width:640,height:58},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAABCAYAAADn9T9+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAALUlEQVR4nGN49/7d/ytXrvxfsGDB/7lz5/7fuXPn/8+fP///9OkTHH/58uU/ALtZI1f8oocmAAAAAElFTkSuQmCC"}},93752:(e,t,n)=>{e.exports={src:{srcSet:n.p+"assets/ideal-img/restful_2.c60f2ee.582.png 582w",images:[{path:n.p+"assets/ideal-img/restful_2.c60f2ee.582.png",width:582,height:66}],src:n.p+"assets/ideal-img/restful_2.c60f2ee.582.png",toString:function(){return n.p+"assets/ideal-img/restful_2.c60f2ee.582.png"},placeholder:void 0,width:582,height:66},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAABCAYAAADn9T9+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAL0lEQVR4nB3FoQ0AMAgAwe6/CRDGKR6JhmC/Sc/cqSoyE3fHVBERIi7dzcz8d5cHvO8jR1ISlxIAAAAASUVORK5CYII="}},14881:(e,t,n)=>{e.exports={src:{srcSet:n.p+"assets/ideal-img/restful_3.8384145.488.png 488w",images:[{path:n.p+"assets/ideal-img/restful_3.8384145.488.png",width:488,height:419}],src:n.p+"assets/ideal-img/restful_3.8384145.488.png",toString:function(){return n.p+"assets/ideal-img/restful_3.8384145.488.png"},placeholder:void 0,width:488,height:419},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAJCAYAAAALpr0TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvElEQVR4nIWPS0/DMBCE/f//XUMP9EYFJHL9jmMnDrU/5CDgwmOlOax2ZmdGPF4unE4DwzDwcD4T4wIN7vdKrd8QwQf0GHBywTqLlhb57DG3gNaaaZrw3iOMMZRS+G/E6zjSySEEQpjZ97fj0Fr7Qo8ilFZIecNaS0qJVuvPH10n5ETrsr+stVLIF4NT8QjtzEex2SW8d2hjiDH21p40r6zLzrZtrOtGjoUtl2PPOVHKjni6Xg/FZ4HfrN8BouBcd0Ko0hAAAAAASUVORK5CYII="}},91456:(e,t,n)=>{"use strict";n.r(t),n.d(t,{assets:()=>g,contentTitle:()=>x,default:()=>m,frontMatter:()=>u,metadata:()=>j,toc:()=>v});var r=n(74848),s=n(28453),c=n(89363),i=n.n(c),l=n(93752),d=n.n(l),h=n(14881),p=n.n(h),o=n(29253),a=n.n(o);const u={},x="http\u670d\u52a1",j={id:"cpp/krpc/http_service",title:"http\u670d\u52a1",description:"\u8fd9\u91cc\u6307\u6211\u4eec\u901a\u5e38\u8bf4\u7684http/h2\u670d\u52a1\uff0c\u800c\u4e0d\u662f\u53ef\u901a\u8fc7http/h2\u8bbf\u95ee\u7684pb\u670d\u52a1\u3002",source:"@site/versioned_docs/version-1.1.1/cpp/krpc/http_service.mdx",sourceDirName:"cpp/krpc",slug:"/cpp/krpc/http_service",permalink:"/docs/cpp/krpc/http_service",draft:!1,unlisted:!1,tags:[],version:"1.1.1",frontMatter:{},sidebar:"docs",previous:{title:"\u670d\u52a1\u5f00\u53d1",permalink:"/docs/cpp/krpc/server"},next:{title:"Thrift\u670d\u52a1",permalink:"/docs/cpp/krpc/thrift"}},g={},v=[{value:"\u5173\u4e8eh2",id:"\u5173\u4e8eh2",level:2},{value:"URL\u7c7b\u578b",id:"url\u7c7b\u578b",level:2},{value:"\u524d\u7f00\u4e3a/ServiceName/MethodName",id:"\u524d\u7f00\u4e3aservicenamemethodname",level:3},{value:"\u524d\u7f00\u4e3a/ServiceName",id:"\u524d\u7f00\u4e3aservicename",level:3},{value:"Restful URL",id:"restful-url",level:3},{value:"HTTP\u53c2\u6570",id:"http\u53c2\u6570",level:2},{value:"HTTP headers",id:"http-headers",level:3},{value:"Content-Type",id:"content-type",level:3},{value:"Status Code",id:"status-code",level:3},{value:"Query String",id:"query-string",level:3},{value:"\u8c03\u8bd5",id:"\u8c03\u8bd5",level:2},{value:"\u538b\u7f29response body",id:"\u538b\u7f29response-body",level:2},{value:"\u89e3\u538brequest body",id:"\u89e3\u538brequest-body",level:2},{value:"\u5904\u7406https\u8bf7\u6c42",id:"\u5904\u7406https\u8bf7\u6c42",level:2},{value:"\u6027\u80fd",id:"\u6027\u80fd",level:2},{value:"\u6301\u7eed\u53d1\u9001",id:"\u6301\u7eed\u53d1\u9001",level:2},{value:"\u6301\u7eed\u63a5\u6536",id:"\u6301\u7eed\u63a5\u6536",level:2},{value:"FAQ",id:"faq",level:2},{value:"Q: krpc\u524d\u7684nginx\u62a5\u4e86final fail",id:"q-krpc\u524d\u7684nginx\u62a5\u4e86final-fail",level:3},{value:"Q: krpc\u652f\u6301http chunked\u65b9\u5f0f\u4f20\u8f93\u5417",id:"q-krpc\u652f\u6301http-chunked\u65b9\u5f0f\u4f20\u8f93\u5417",level:3},{value:"Q: HTTP\u8bf7\u6c42\u7684query string\u4e2d\u542b\u6709BASE64\u7f16\u7801\u8fc7\u7684value\uff0c\u4e3a\u4ec0\u4e48\u6709\u65f6\u5019\u65e0\u6cd5\u6b63\u5e38\u89e3\u6790",id:"q-http\u8bf7\u6c42\u7684query-string\u4e2d\u542b\u6709base64\u7f16\u7801\u8fc7\u7684value\u4e3a\u4ec0\u4e48\u6709\u65f6\u5019\u65e0\u6cd5\u6b63\u5e38\u89e3\u6790",level:3}];function A(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"http\u670d\u52a1",children:"http\u670d\u52a1"})}),"\n",(0,r.jsx)(t.p,{children:"\u8fd9\u91cc\u6307\u6211\u4eec\u901a\u5e38\u8bf4\u7684http/h2\u670d\u52a1\uff0c\u800c\u4e0d\u662f\u53ef\u901a\u8fc7http/h2\u8bbf\u95ee\u7684pb\u670d\u52a1\u3002"}),"\n",(0,r.jsx)(t.p,{children:"\u867d\u7136\u7528\u4e0d\u5230pb\u6d88\u606f\uff0c\u4f46krpc\u4e2d\u7684http/h2\u670d\u52a1\u63a5\u53e3\u4e5f\u5f97\u5b9a\u4e49\u5728proto\u6587\u4ef6\u4e2d\uff0c\u53ea\u662frequest\u548cresponse\u90fd\u662f\u7a7a\u7684\u7ed3\u6784\u4f53\u3002\u8fd9\u786e\u4fdd\u4e86\u6240\u6709\u7684\u670d\u52a1\u58f0\u660e\u96c6\u4e2d\u5728proto\u6587\u4ef6\u4e2d\uff0c\u800c\u4e0d\u662f\u6563\u5217\u5728proto\u6587\u4ef6\u3001\u7a0b\u5e8f\u3001\u914d\u7f6e\u7b49\u591a\u4e2a\u5730\u65b9\u3002"}),"\n",(0,r.jsxs)(t.p,{children:["#\u793a\u4f8b\n",(0,r.jsx)(t.a,{href:"https://github.com/apache/krpc/blob/master/example/http_c++/http_server.cpp",children:"http_server.cpp"}),"\u3002"]}),"\n",(0,r.jsx)(t.h2,{id:"\u5173\u4e8eh2",children:"\u5173\u4e8eh2"}),"\n",(0,r.jsx)(t.p,{children:'krpc\u628aHTTP/2\u534f\u8bae\u7edf\u79f0\u4e3a"h2"\uff0c\u4e0d\u8bba\u662f\u5426\u52a0\u5bc6\u3002\u7136\u800c\u672a\u5f00\u542fssl\u7684HTTP/2\u8fde\u63a5\u5728/connections\u4e2d\u4f1a\u6309\u5b98\u65b9\u540d\u79f0h2c\u663e\u793a\uff0c\u800c\u5f00\u542fssl\u7684\u4f1a\u663e\u793a\u4e3ah2\u3002'}),"\n",(0,r.jsx)(t.p,{children:"krpc\u4e2dhttp\u548ch2\u7684\u7f16\u7a0b\u63a5\u53e3\u57fa\u672c\u6ca1\u6709\u533a\u522b\u3002\u9664\u975e\u7279\u6b8a\u8bf4\u660e\uff0c\u6240\u6709\u63d0\u5230\u7684http\u7279\u6027\u90fd\u540c\u65f6\u5bf9h2\u6709\u6548\u3002"}),"\n",(0,r.jsx)(t.h2,{id:"url\u7c7b\u578b",children:"URL\u7c7b\u578b"}),"\n",(0,r.jsx)(t.h3,{id:"\u524d\u7f00\u4e3aservicenamemethodname",children:"\u524d\u7f00\u4e3a/ServiceName/MethodName"}),"\n",(0,r.jsx)(t.p,{children:"\u5b9a\u4e49\u4e00\u4e2aservice\u540d\u4e3aServiceName(\u4e0d\u5305\u542bpackage\u540d), method\u540d\u4e3aMethodName\u7684pb\u670d\u52a1\uff0c\u4e14\u8ba9request\u548cresponse\u5b9a\u4e49\u4e3a\u7a7a\uff0c\u5219\u8be5\u670d\u52a1\u9ed8\u8ba4\u5728/ServiceName/MethodName\u4e0a\u63d0\u4f9bhttp/h2\u670d\u52a1\u3002"}),"\n",(0,r.jsx)(t.p,{children:"request\u548cresponse\u53ef\u4e3a\u7a7a\u662f\u56e0\u4e3a\u6570\u636e\u90fd\u5728Controller\u4e2d\uff1a"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"http/h2 request\u7684header\u5728Controller.http_request()\u4e2d\uff0cbody\u5728Controller.request_attachment()\u4e2d\u3002"}),"\n",(0,r.jsx)(t.li,{children:"http/h2 response\u7684header\u5728Controller.http_response()\u4e2d\uff0cbody\u5728Controller.response_attachment()\u4e2d\u3002"}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"\u5b9e\u73b0\u6b65\u9aa4\u5982\u4e0b\uff1a"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"\u586b\u5199proto\u6587\u4ef6\u3002"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-protobuf",children:"option cc_generic_services = true;\n \nmessage HttpRequest { };\nmessage HttpResponse { };\n \nservice HttpService {\n      rpc Echo(HttpRequest) returns (HttpResponse);\n};\n"})}),"\n",(0,r.jsxs)(t.ol,{start:"2",children:["\n",(0,r.jsx)(t.li,{children:"\u5b9e\u73b0Service\u63a5\u53e3\u3002\u548cpb\u670d\u52a1\u4e00\u6837\uff0c\u4e5f\u662f\u7ee7\u627f\u5b9a\u4e49\u5728.pb.h\u4e2d\u7684service\u57fa\u7c7b\u3002"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:"class HttpServiceImpl : public HttpService {\npublic:\n    ...\n    virtual void Echo(google::protobuf::RpcController* cntl_base,\n                      const HttpRequest* /*request*/,\n                      HttpResponse* /*response*/,\n                      google::protobuf::Closure* done) {\n        krpc::ClosureGuard done_guard(done);\n        krpc::Controller* cntl = static_cast<krpc::Controller*>(cntl_base);\n \n        // body\u662f\u7eaf\u6587\u672c\n        cntl->http_response().set_content_type(\"text/plain\");\n       \n        // \u628a\u8bf7\u6c42\u7684query-string\u548cbody\u6253\u5370\u7ed3\u679c\u4f5c\u4e3a\u56de\u590d\u5185\u5bb9\u3002\n        kutil::IOBufBuilder os;\n        os << \"queries:\";\n        for (krpc::URI::QueryIterator it = cntl->http_request().uri().QueryBegin();\n                it != cntl->http_request().uri().QueryEnd(); ++it) {\n            os << ' ' << it->first << '=' << it->second;\n        }\n        os << \"\\nbody: \" << cntl->request_attachment() << '\\n';\n        os.move_to(cntl->response_attachment());\n    }\n};\n"})}),"\n",(0,r.jsxs)(t.ol,{start:"3",children:["\n",(0,r.jsx)(t.li,{children:"\u628a\u5b9e\u73b0\u597d\u7684\u670d\u52a1\u63d2\u5165Server\u540e\u53ef\u901a\u8fc7\u5982\u4e0bURL\u8bbf\u95ee\uff0c/HttpService/Echo\u540e\u7684\u90e8\u5206\u5728 cntl->http_request().unresolved_path()\u4e2d\u3002"}),"\n"]}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"URL"}),(0,r.jsx)(t.th,{children:"\u8bbf\u95ee\u65b9\u6cd5"}),(0,r.jsx)(t.th,{children:"cntl->http_request().uri().path()"}),(0,r.jsx)(t.th,{children:"cntl->http_request().unresolved_path()"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"/HttpService/Echo"}),(0,r.jsx)(t.td,{children:"HttpService.Echo"}),(0,r.jsx)(t.td,{children:'"/HttpService/Echo"'}),(0,r.jsx)(t.td,{children:'""'})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"/HttpService/Echo/Foo"}),(0,r.jsx)(t.td,{children:"HttpService.Echo"}),(0,r.jsx)(t.td,{children:'"/HttpService/Echo/Foo"'}),(0,r.jsx)(t.td,{children:'"Foo"'})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"/HttpService/Echo/Foo/Bar"}),(0,r.jsx)(t.td,{children:"HttpService.Echo"}),(0,r.jsx)(t.td,{children:'"/HttpService/Echo/Foo/Bar"'}),(0,r.jsx)(t.td,{children:'"Foo/Bar"'})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"/HttpService//Echo///Foo//"}),(0,r.jsx)(t.td,{children:"HttpService.Echo"}),(0,r.jsx)(t.td,{children:'"/HttpService//Echo///Foo//"'}),(0,r.jsx)(t.td,{children:'"Foo"'})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"/HttpService"}),(0,r.jsx)(t.td,{children:"\u8bbf\u95ee\u9519\u8bef"}),(0,r.jsx)(t.td,{}),(0,r.jsx)(t.td,{})]})]})]}),"\n",(0,r.jsx)(t.h3,{id:"\u524d\u7f00\u4e3aservicename",children:"\u524d\u7f00\u4e3a/ServiceName"}),"\n",(0,r.jsx)(t.p,{children:"\u8d44\u6e90\u7c7b\u7684http/h2\u670d\u52a1\u53ef\u80fd\u9700\u8981\u8fd9\u6837\u7684URL\uff0cServiceName\u540e\u5747\u4e3a\u52a8\u6001\u5185\u5bb9\u3002\u6bd4\u5982/FileService/foobar.txt\u4ee3\u8868./foobar.txt\uff0c/FileService/app/data/boot.cfg\u4ee3\u8868./app/data/boot.cfg\u3002"}),"\n",(0,r.jsx)(t.p,{children:"\u5b9e\u73b0\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"proto\u6587\u4ef6\u4e2d\u5e94\u4ee5FileService\u4e3a\u670d\u52a1\u540d\uff0c\u4ee5default_method\u4e3a\u65b9\u6cd5\u540d\u3002"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-protobuf",children:"option cc_generic_services = true;\n\nmessage HttpRequest { };\nmessage HttpResponse { };\n\nservice FileService {\n      rpc default_method(HttpRequest) returns (HttpResponse);\n}\n"})}),"\n",(0,r.jsxs)(t.ol,{start:"2",children:["\n",(0,r.jsx)(t.li,{children:"\u5b9e\u73b0Service\u3002"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:'class FileServiceImpl: public FileService {\npublic:\n    ...\n    virtual void default_method(google::protobuf::RpcController* cntl_base,\n                                const HttpRequest* /*request*/,\n                                HttpResponse* /*response*/,\n                                google::protobuf::Closure* done) {\n        krpc::ClosureGuard done_guard(done);\n        krpc::Controller* cntl = static_cast<krpc::Controller*>(cntl_base);\n        cntl->response_attachment().append("Getting file: ");\n        cntl->response_attachment().append(cntl->http_request().unresolved_path());\n    }\n};\n'})}),"\n",(0,r.jsxs)(t.ol,{start:"3",children:["\n",(0,r.jsx)(t.li,{children:"\u5b9e\u73b0\u5b8c\u6bd5\u63d2\u5165Server\u540e\u53ef\u901a\u8fc7\u5982\u4e0bURL\u8bbf\u95ee\uff0c/FileService\u4e4b\u540e\u7684\u8def\u5f84\u5728cntl->http_request().unresolved_path()\u4e2di\u3002"}),"\n"]}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"URL"}),(0,r.jsx)(t.th,{children:"\u8bbf\u95ee\u65b9\u6cd5"}),(0,r.jsx)(t.th,{children:"cntl->http_request().uri().path()"}),(0,r.jsx)(t.th,{children:"cntl->http_request().unresolved_path()"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"/FileService"}),(0,r.jsx)(t.td,{children:"FileService.default_method"}),(0,r.jsx)(t.td,{children:'"/FileService"'}),(0,r.jsx)(t.td,{children:'""'})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"/FileService/123.txt"}),(0,r.jsx)(t.td,{children:"FileService.default_method"}),(0,r.jsx)(t.td,{children:'"/FileService/123.txt"'}),(0,r.jsx)(t.td,{children:'"123.txt"'})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"/FileService/mydir/123.txt"}),(0,r.jsx)(t.td,{children:"FileService.default_method"}),(0,r.jsx)(t.td,{children:'"/FileService/mydir/123.txt"'}),(0,r.jsx)(t.td,{children:'"mydir/123.txt"'})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"/FileService//mydir///123.txt//"}),(0,r.jsx)(t.td,{children:"FileService.default_method"}),(0,r.jsx)(t.td,{children:'"/FileService//mydir///123.txt//"'}),(0,r.jsx)(t.td,{children:'"mydir/123.txt"'})]})]})]}),"\n",(0,r.jsx)(t.h3,{id:"restful-url",children:"Restful URL"}),"\n",(0,r.jsx)(t.p,{children:"krpc\u652f\u6301\u4e3aservice\u4e2d\u7684\u6bcf\u4e2a\u65b9\u6cd5\u6307\u5b9a\u4e00\u4e2aURL\u3002API\u5982\u4e0b\uff1a"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:'// \u5982\u679crestful_mappings\u4e0d\u4e3a\u7a7a, service\u4e2d\u7684\u65b9\u6cd5\u53ef\u901a\u8fc7\u6307\u5b9a\u7684URL\u88abhttp/h2\u534f\u8bae\u8bbf\u95ee\uff0c\u800c\u4e0d\u662f/ServiceName/MethodName.\n// \u6620\u5c04\u683c\u5f0f\uff1a"PATH1 => NAME1, PATH2 => NAME2 ..."\n// PATHs\u662f\u6709\u6548\u7684\u8def\u5f84, NAMEs\u662fservice\u4e2d\u7684\u65b9\u6cd5\u540d.\nint AddService(google::protobuf::Service* service,\n               ServiceOwnership ownership,\n               kutil::StringPiece restful_mappings);\n'})}),"\n",(0,r.jsxs)(t.p,{children:["\u4e0b\u9762\u7684QueueService\u5305\u542b\u591a\u4e2a\u65b9\u6cd5\u3002\u5982\u679c\u6211\u4eec\u50cf\u4e4b\u524d\u90a3\u6837\u628a\u5b83\u63d2\u5165server\uff0c\u90a3\u4e48\u53ea\u80fd\u901a\u8fc7",(0,r.jsx)(t.code,{children:"/QueueService/start, /QueueService/stop"}),"\u7b49url\u6765\u8bbf\u95ee\u3002"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-protobuf",children:"service QueueService {\n    rpc start(HttpRequest) returns (HttpResponse);\n    rpc stop(HttpRequest) returns (HttpResponse);\n    rpc get_stats(HttpRequest) returns (HttpResponse);\n    rpc download_data(HttpRequest) returns (HttpResponse);\n};\n"})}),"\n",(0,r.jsx)(t.p,{children:"\u800c\u5728\u8c03\u7528AddService\u65f6\u6307\u5b9a\u7b2c\u4e09\u4e2a\u53c2\u6570(restful_mappings)\u5c31\u80fd\u5b9a\u5236URL\u4e86\uff0c\u5982\u4e0b\u6240\u793a\uff1a"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:'if (server.AddService(&queue_svc,\n                      krpc::SERVER_DOESNT_OWN_SERVICE,\n                      "/v1/queue/start   => start,"\n                      "/v1/queue/stop    => stop,"\n                      "/v1/queue/stats/* => get_stats") != 0) {\n    LOG(ERROR) << "Fail to add queue_svc";\n    return -1;\n}\n \n// \u661f\u53f7\u53ef\u51fa\u73b0\u5728\u4e2d\u95f4\nif (server.AddService(&queue_svc,\n                      krpc::SERVER_DOESNT_OWN_SERVICE,\n                      "/v1/*/start   => start,"\n                      "/v1/*/stop    => stop,"\n                      "*.data        => download_data") != 0) {\n    LOG(ERROR) << "Fail to add queue_svc";\n    return -1;\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:'\u4e0a\u9762\u4ee3\u7801\u4e2dAddService\u7684\u7b2c\u4e09\u4e2a\u53c2\u6570\u5206\u4e86\u4e09\u884c\uff0c\u4f46\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\u3002\u8fd9\u4e2a\u5b57\u7b26\u4e32\u5305\u542b\u4ee5\u9017\u53f7(,)\u5206\u9694\u7684\u4e09\u4e2a\u6620\u5c04\u5173\u7cfb\uff0c\u6bcf\u4e2a\u6620\u5c04\u544a\u8bc9krpc\uff1a\u5728\u9047\u5230\u7bad\u5934\u5de6\u4fa7\u7684URL\u65f6\u8c03\u7528\u53f3\u4fa7\u7684\u65b9\u6cd5\u3002"/v1/queue/stats/*"\u4e2d\u7684\u661f\u53f7\u53ef\u5339\u914d\u4efb\u610f\u5b57\u4e32\u3002'}),"\n",(0,r.jsx)(t.p,{children:"\u5173\u4e8e\u6620\u5c04\u89c4\u5219\uff1a"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u591a\u4e2a\u8def\u5f84\u53ef\u6620\u5c04\u81f3\u540c\u4e00\u4e2a\u65b9\u6cd5\u3002"}),"\n",(0,r.jsx)(t.li,{children:"service\u4e0d\u8981\u6c42\u662f\u7eafhttp/h2\uff0cpb service\u4e5f\u652f\u6301\u3002"}),"\n",(0,r.jsx)(t.li,{children:"\u6ca1\u6709\u51fa\u73b0\u5728\u6620\u5c04\u4e2d\u7684\u65b9\u6cd5\u4ecd\u65e7\u901a\u8fc7/ServiceName/MethodName\u8bbf\u95ee\u3002\u51fa\u73b0\u5728\u6620\u5c04\u4e2d\u7684\u65b9\u6cd5\u4e0d\u518d\u80fd\u901a\u8fc7/ServiceName/MethodName\u8bbf\u95ee\u3002"}),"\n",(0,r.jsx)(t.li,{children:"==> ===> ...\u90fd\u662f\u53ef\u4ee5\u7684\u3002\u5f00\u5934\u7ed3\u5c3e\u7684\u7a7a\u683c\uff0c\u989d\u5916\u7684\u659c\u6760(/)\uff0c\u6700\u540e\u591a\u4f59\u7684\u9017\u53f7\uff0c\u90fd\u4e0d\u8981\u7d27\u3002"}),"\n",(0,r.jsx)(t.li,{children:"PATH\u548cPATH/*\u4e24\u8005\u53ef\u4ee5\u5171\u5b58\u3002"}),"\n",(0,r.jsx)(t.li,{children:"\u652f\u6301\u540e\u7f00\u5339\u914d: \u661f\u53f7\u540e\u53ef\u4ee5\u6709\u66f4\u591a\u5b57\u7b26\u3002"}),"\n",(0,r.jsx)(t.li,{children:"\u4e00\u4e2a\u8def\u5f84\u4e2d\u53ea\u80fd\u51fa\u73b0\u4e00\u4e2a\u661f\u53f7\u3002"}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"cntl.http_request().unresolved_path()"})," \u5bf9\u5e94\u661f\u53f7(*)\u5339\u914d\u7684\u90e8\u5206\uff0c\u4fdd\u8bc1normalized\uff1a\u5f00\u5934\u7ed3\u5c3e\u90fd\u4e0d\u5305\u542b\u659c\u6760(/)\uff0c\u4e2d\u95f4\u659c\u6760\u4e0d\u91cd\u590d\u3002\u6bd4\u5982\uff1a"]}),"\n","\n",(0,r.jsx)("img",{src:i()}),"\n",(0,r.jsx)(t.p,{children:"\u6216"}),"\n",(0,r.jsx)("img",{src:d()}),"\n",(0,r.jsxs)(t.p,{children:["unresolved_path\u90fd\u662f",(0,r.jsx)(t.code,{children:'"foo/bar"'}),"\uff0c\u5de6\u53f3\u3001\u4e2d\u95f4\u591a\u4f59\u7684\u659c\u6760\u88ab\u79fb\u9664\u4e86\u3002"]}),"\n",(0,r.jsxs)(t.p,{children:["\u6ce8\u610f\uff1a",(0,r.jsx)(t.code,{children:"cntl.http_request().uri().path()"}),"\u4e0d\u4fdd\u8bc1normalized\uff0c\u8fd9\u4e24\u4e2a\u4f8b\u5b50\u4e2d\u5206\u522b\u4e3a",(0,r.jsx)(t.code,{children:'"//v1//queue//stats//foo///bar//////"'}),"\u548c",(0,r.jsx)(t.code,{children:'"//vars///foo////bar/////"'})]}),"\n",(0,r.jsx)(t.p,{children:"/status\u9875\u9762\u4e0a\u7684\u65b9\u6cd5\u540d\u540e\u4f1a\u52a0\u4e0a\u6240\u6709\u76f8\u5173\u7684URL\uff0c\u5f62\u5f0f\u662f\uff1a@URL1 @URL2 ..."}),"\n",(0,r.jsx)("img",{src:p()}),"\n",(0,r.jsx)(t.h2,{id:"http\u53c2\u6570",children:"HTTP\u53c2\u6570"}),"\n",(0,r.jsx)(t.h3,{id:"http-headers",children:"HTTP headers"}),"\n",(0,r.jsx)(t.p,{children:"http header\u662f\u4e00\u7cfb\u5217key/value\u5bf9\uff0c\u6709\u4e9b\u7531HTTP\u534f\u8bae\u89c4\u5b9a\u6709\u7279\u6b8a\u542b\u4e49\uff0c\u5176\u4f59\u5219\u7531\u7528\u6237\u81ea\u7531\u8bbe\u5b9a\u3002"}),"\n",(0,r.jsx)(t.p,{children:"query string\u4e5f\u662fkey/value\u5bf9\uff0chttp headers\u4e0equery string\u7684\u533a\u522b:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u867d\u7136http headers\u7531\u534f\u8bae\u51c6\u786e\u5b9a\u4e49\u64cd\u4f5c\u65b9\u5f0f\uff0c\u4f46\u7531\u4e8e\u4e5f\u4e0d\u6613\u5728\u5730\u5740\u680f\u4e2d\u88ab\u4fee\u6539\uff0c\u5e38\u7528\u4e8e\u4f20\u9012\u6846\u67b6\u6216\u534f\u8bae\u5c42\u9762\u7684\u53c2\u6570\u3002"}),"\n",(0,r.jsxs)(t.li,{children:["query string\u662fURL\u7684\u4e00\u90e8\u5206\uff0c",(0,r.jsx)(t.strong,{children:"\u5e38\u89c1"}),"\u5f62\u5f0f\u662fkey1=value1&key2=value2&\u2026\uff0c\u6613\u4e8e\u9605\u8bfb\u548c\u4fee\u6539\uff0c\u5e38\u7528\u4e8e\u4f20\u9012\u5e94\u7528\u5c42\u53c2\u6570\u3002\u4f46query string\u7684\u5177\u4f53\u683c\u5f0f\u5e76\u4e0d\u662fHTTP\u89c4\u8303\u7684\u4e00\u90e8\u5206\uff0c\u53ea\u662f\u7ea6\u5b9a\u6210\u4fd7\u3002"]}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:'// \u83b7\u5f97header\u4e2d"User-Agent"\u7684\u503c\uff0c\u5927\u5c0f\u5199\u4e0d\u654f\u611f\u3002\nconst std::string* user_agent_str = cntl->http_request().GetHeader("User-Agent");\nif (user_agent_str != NULL) {  // has the header\n    LOG(TRACE) << "User-Agent is " << *user_agent_str;\n}\n...\n \n// \u5728header\u4e2d\u589e\u52a0"Accept-encoding: gzip"\uff0c\u5927\u5c0f\u5199\u4e0d\u654f\u611f\u3002\ncntl->http_response().SetHeader("Accept-encoding", "gzip");\n// \u8986\u76d6\u4e3a"Accept-encoding: deflate"\ncntl->http_response().SetHeader("Accept-encoding", "deflate");\n// \u589e\u52a0\u4e00\u4e2avalue\uff0c\u9017\u53f7\u5206\u9694\uff0c\u53d8\u4e3a"Accept-encoding: deflate,gzip"\ncntl->http_response().AppendHeader("Accept-encoding", "gzip");\n'})}),"\n",(0,r.jsx)(t.h3,{id:"content-type",children:"Content-Type"}),"\n",(0,r.jsx)(t.p,{children:'Content-type\u8bb0\u5f55body\u7684\u7c7b\u578b\uff0c\u662f\u4e00\u4e2a\u4f7f\u7528\u9891\u7387\u8f83\u9ad8\u7684header\u3002\u5b83\u5728krpc\u4e2d\u88ab\u7279\u6b8a\u5904\u7406\uff0c\u9700\u8981\u901a\u8fc7cntl->http_request().content_type()\u6765\u8bbf\u95ee\uff0ccntl->GetHeader("Content-Type")\u662f\u83b7\u53d6\u4e0d\u5230\u7684\u3002'}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:'// Get Content-Type\nif (cntl->http_request().content_type() == "application/json") {\n    ...\n}\n...\n// Set Content-Type\ncntl->http_response().set_content_type("text/html");\n'})}),"\n",(0,r.jsx)(t.p,{children:"\u5982\u679cRPC\u5931\u8d25(Controller\u88abSetFailed), Content-Type\u4f1a\u6846\u67b6\u5f3a\u5236\u8bbe\u4e3atext/plain\uff0c\u800cresponse body\u8bbe\u4e3aController::ErrorText()\u3002"}),"\n",(0,r.jsx)(t.h3,{id:"status-code",children:"Status Code"}),"\n",(0,r.jsxs)(t.p,{children:["status code\u662fhttp response\u7279\u6709\u7684\u5b57\u6bb5\uff0c\u6807\u8bb0http\u8bf7\u6c42\u7684\u5b8c\u6210\u60c5\u51b5\u3002\u53ef\u80fd\u7684\u503c\u5b9a\u4e49\u5728",(0,r.jsx)(t.a,{href:"https://github.com/apache/krpc/blob/master/src/krpc/http_status_code.h",children:"http_status_code.h"}),"\u4e2d\u3002"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:'// Get Status Code\nif (cntl->http_response().status_code() == krpc::HTTP_STATUS_NOT_FOUND) {\n    LOG(FATAL) << "FAILED: " << controller.http_response().reason_phrase();\n}\n...\n// Set Status code\ncntl->http_response().set_status_code(krpc::HTTP_STATUS_INTERNAL_SERVER_ERROR);\ncntl->http_response().set_status_code(krpc::HTTP_STATUS_INTERNAL_SERVER_ERROR, "My explanation of the error...");\n'})}),"\n",(0,r.jsx)(t.p,{children:"\u6bd4\u5982\uff0c\u4ee5\u4e0b\u4ee3\u7801\u4ee5302\u9519\u8bef\u5b9e\u73b0\u91cd\u5b9a\u5411\uff1a"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:'cntl->http_response().set_status_code(krpc::HTTP_STATUS_FOUND);\ncntl->http_response().SetHeader("Location", "http://bj.bs.bae.baidu.com/family/image001(4979).jpg");\n'})}),"\n",(0,r.jsx)("img",{src:a()}),"\n",(0,r.jsx)(t.h3,{id:"query-string",children:"Query String"}),"\n",(0,r.jsxs)(t.p,{children:["\u5982\u4e0a\u9762\u7684",(0,r.jsx)(t.a,{href:"#http-headers",children:"HTTP headers"}),"\u4e2d\u63d0\u5230\u7684\u90a3\u6837\uff0c\u6211\u4eec\u6309\u7ea6\u5b9a\u6210\u4fd7\u7684\u65b9\u5f0f\u6765\u7406\u89e3query string\uff0c\u5373key1=value1&key2=value2&...\u3002\u53ea\u6709key\u800c\u6ca1\u6709value\u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u4ecd\u7136\u4f1a\u88abGetQuery\u67e5\u8be2\u5230\uff0c\u53ea\u662f\u503c\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff0c\u8fd9\u5e38\u88ab\u7528\u505abool\u578b\u7684\u5f00\u5173\u3002\u63a5\u53e3\u5b9a\u4e49\u5728",(0,r.jsx)(t.a,{href:"https://github.com/apache/krpc/blob/master/src/krpc/uri.h",children:"uri.h"}),"\u3002"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:'const std::string* time_value = cntl->http_request().uri().GetQuery("time");\nif (time_value != NULL) {  // the query string is present\n    LOG(TRACE) << "time = " << *time_value;\n}\n\n...\ncntl->http_request().uri().SetQuery("time", "2015/1/2");\n'})}),"\n",(0,r.jsx)(t.h2,{id:"\u8c03\u8bd5",children:"\u8c03\u8bd5"}),"\n",(0,r.jsxs)(t.p,{children:["\u6253\u5f00",(0,r.jsx)(t.a,{href:"http://krpc.baidu.com:8765/flags/http_verbose",children:"-http_verbose"}),"\u5373\u53ef\u770b\u5230\u6240\u6709\u7684http/h2 request\u548cresponse\uff0c\u6ce8\u610f\u8fd9\u5e94\u8be5\u53ea\u7528\u4e8e\u7ebf\u4e0b\u8c03\u8bd5\uff0c\u800c\u4e0d\u662f\u7ebf\u4e0a\u7a0b\u5e8f\u3002"]}),"\n",(0,r.jsx)(t.h2,{id:"\u538b\u7f29response-body",children:"\u538b\u7f29response body"}),"\n",(0,r.jsx)(t.p,{children:"http\u670d\u52a1\u5e38\u5bf9http body\u8fdb\u884c\u538b\u7f29\uff0c\u53ef\u4ee5\u6709\u6548\u51cf\u5c11\u7f51\u9875\u7684\u4f20\u8f93\u65f6\u95f4\uff0c\u52a0\u5feb\u9875\u9762\u7684\u5c55\u73b0\u901f\u5ea6\u3002"}),"\n",(0,r.jsxs)(t.p,{children:["\u8bbe\u7f6eController::set_response_compress_type(krpc::COMPRESS_TYPE_GZIP)\u540e\u5c06",(0,r.jsx)(t.strong,{children:"\u5c1d\u8bd5"}),"\u7528gzip\u538b\u7f29http body\u3002\u201c\u5c1d\u8bd5\u201c\u6307\u7684\u662f\u538b\u7f29\u6709\u53ef\u80fd\u4e0d\u53d1\u751f\uff0c\u6761\u4ef6\u6709\uff1a"]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:"\u8bf7\u6c42\u4e2d\u6ca1\u6709\u8bbe\u7f6eAccept-encoding\u6216\u4e0d\u5305\u542bgzip\u3002\u6bd4\u5982curl\u4e0d\u52a0--compressed\u65f6\u662f\u4e0d\u652f\u6301\u538b\u7f29\u7684\uff0c\u8fd9\u65f6server\u603b\u662f\u4f1a\u8fd4\u56de\u4e0d\u538b\u7f29\u7684\u7ed3\u679c\u3002"}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:"body\u5c3a\u5bf8\u5c0f\u4e8e-http_body_compress_threshold\u6307\u5b9a\u7684\u5b57\u8282\u6570\uff0c\u9ed8\u8ba4\u662f512\u3002gzip\u5e76\u4e0d\u662f\u4e00\u4e2a\u5f88\u5feb\u7684\u538b\u7f29\u7b97\u6cd5\uff0c\u5f53body\u8f83\u5c0f\u65f6\uff0c\u538b\u7f29\u589e\u52a0\u7684\u5ef6\u65f6\u53ef\u80fd\u6bd4\u7f51\u7edc\u4f20\u8f93\u7701\u4e0b\u7684\u8fd8\u591a\u3002\u5f53\u5305\u8f83\u5c0f\u65f6\u4e0d\u505a\u538b\u7f29\u53ef\u80fd\u662f\u4e2a\u66f4\u597d\u7684\u9009\u9879\u3002"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Name"}),(0,r.jsx)(t.th,{children:"Value"}),(0,r.jsx)(t.th,{children:"Description"}),(0,r.jsx)(t.th,{children:"Defined At"})]})}),(0,r.jsx)(t.tbody,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"http_body_compress_threshold"}),(0,r.jsx)(t.td,{children:"512"}),(0,r.jsx)(t.td,{children:"Not compress http body when it's less than so many bytes."}),(0,r.jsx)(t.td,{children:"src/krpc/policy/http_rpc_protocol.cpp"})]})})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"\u89e3\u538brequest-body",children:"\u89e3\u538brequest body"}),"\n",(0,r.jsx)(t.p,{children:"\u51fa\u4e8e\u901a\u7528\u6027\u8003\u8651\u4e14\u89e3\u538b\u4ee3\u7801\u4e0d\u590d\u6742\uff0ckrpc\u4e0d\u4f1a\u81ea\u52a8\u89e3\u538brequest body\uff0c\u7528\u6237\u53ef\u4ee5\u81ea\u5df1\u505a\uff0c\u65b9\u6cd5\u5982\u4e0b\uff1a"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:'#include <krpc/policy/gzip_compress.h>\n...\nconst std::string* encoding = cntl->http_request().GetHeader("Content-Encoding");\nif (encoding != NULL && *encoding == "gzip") {\n    kutil::IOBuf uncompressed;\n    if (!krpc::policy::GzipDecompress(cntl->request_attachment(), &uncompressed)) {\n        LOG(ERROR) << "Fail to un-gzip request body";\n        return;\n    }\n    cntl->request_attachment().swap(uncompressed);\n}\n// cntl->request_attachment()\u4e2d\u5df2\u7ecf\u662f\u89e3\u538b\u540e\u7684\u6570\u636e\u4e86\n'})}),"\n",(0,r.jsx)(t.h2,{id:"\u5904\u7406https\u8bf7\u6c42",children:"\u5904\u7406https\u8bf7\u6c42"}),"\n",(0,r.jsxs)(t.p,{children:["https\u662fhttp over SSL\u7684\u7b80\u79f0\uff0cSSL\u5e76\u4e0d\u662fhttp\u7279\u6709\u7684\uff0c\u800c\u662f\u5bf9\u6240\u6709\u534f\u8bae\u90fd\u6709\u6548\u3002\u5f00\u542f\u670d\u52a1\u7aefSSL\u7684\u4e00\u822c\u6027\u65b9\u6cd5\u89c1",(0,r.jsx)(t.a,{href:"/docs/cpp/krpc/server#%E5%BC%80%E5%90%AFssl",children:"\u8fd9\u91cc"}),"\u3002"]}),"\n",(0,r.jsx)(t.h2,{id:"\u6027\u80fd",children:"\u6027\u80fd"}),"\n",(0,r.jsx)(t.p,{children:"\u6ca1\u6709\u6781\u7aef\u6027\u80fd\u8981\u6c42\u7684\u4ea7\u54c1\u90fd\u6709\u4f7f\u7528HTTP\u534f\u8bae\u7684\u503e\u5411\uff0c\u7279\u522b\u662f\u79fb\u52a8\u4ea7\u54c1\uff0c\u6240\u4ee5\u6211\u4eec\u5f88\u91cd\u89c6HTTP\u7684\u5b9e\u73b0\u8d28\u91cf\uff0c\u5177\u4f53\u6765\u8bf4\uff1a"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["\u4f7f\u7528\u4e86node.js\u7684",(0,r.jsx)(t.a,{href:"https://github.com/apache/krpc/blob/master/src/krpc/details/http_parser.h",children:"http parser"}),"\u89e3\u6790http\u6d88\u606f\uff0c\u8fd9\u662f\u4e00\u4e2a\u8f7b\u91cf\u3001\u4f18\u79c0\u3001\u88ab\u5e7f\u6cdb\u4f7f\u7528\u7684\u5b9e\u73b0\u3002"]}),"\n",(0,r.jsxs)(t.li,{children:["\u4f7f\u7528",(0,r.jsx)(t.a,{href:"https://github.com/miloyip/rapidjson",children:"rapidjson"}),"\u89e3\u6790json\uff0c\u8fd9\u662f\u4e00\u4e2a\u4e3b\u6253\u6027\u80fd\u7684json\u5e93\u3002"]}),"\n",(0,r.jsx)(t.li,{children:"\u5728\u6700\u5dee\u60c5\u51b5\u4e0b\u89e3\u6790http\u8bf7\u6c42\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e5f\u662fO(N)\uff0c\u5176\u4e2dN\u662f\u8bf7\u6c42\u7684\u5b57\u8282\u6570\u3002\u53cd\u8fc7\u6765\u8bf4\uff0c\u5982\u679c\u89e3\u6790\u4ee3\u7801\u8981\u6c42http\u8bf7\u6c42\u662f\u5b8c\u6574\u7684\uff0c\u90a3\u4e48\u5b83\u53ef\u80fd\u4f1a\u82b1\u8d39O(N^2)\u7684\u65f6\u95f4\u3002HTTP\u8bf7\u6c42\u666e\u904d\u8f83\u5927\uff0c\u8fd9\u4e00\u70b9\u610f\u4e49\u8fd8\u662f\u6bd4\u8f83\u5927\u7684\u3002"}),"\n",(0,r.jsxs)(t.li,{children:["\u6765\u81ea\u4e0d\u540cclient\u7684http\u6d88\u606f\u662f\u9ad8\u5ea6\u5e76\u53d1\u7684\uff0c\u5373\u4f7f\u76f8\u5f53\u590d\u6742\u7684http\u6d88\u606f\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u5bf9\u5176\u4ed6\u5ba2\u6237\u7aef\u7684\u54cd\u5e94\u3002\u5176\u4ed6rpc\u548c",(0,r.jsx)(t.a,{href:"/docs/cpp/krpc/threading_overview#%E5%8D%95%E7%BA%BF%E7%A8%8Breactor",children:"\u57fa\u4e8e\u5355\u7ebf\u7a0breactor"}),"\u7684\u5404\u7c7bhttp server\u5f80\u5f80\u96be\u4ee5\u505a\u5230\u8fd9\u4e00\u70b9\u3002"]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"\u6301\u7eed\u53d1\u9001",children:"\u6301\u7eed\u53d1\u9001"}),"\n",(0,r.jsx)(t.p,{children:"krpc server\u652f\u6301\u53d1\u9001\u8d85\u5927\u6216\u65e0\u9650\u957f\u7684body\u3002\u65b9\u6cd5\u5982\u4e0b:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"\u8c03\u7528Controller::CreateProgressiveAttachment()\u521b\u5efa\u53ef\u6301\u7eed\u53d1\u9001\u7684body\u3002\u8fd4\u56de\u7684ProgressiveAttachment\u5bf9\u8c61\u9700\u8981\u7528intrusive_ptr\u7ba1\u7406\u3002"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-c++",children:"#include <krpc/progressive_attachment.h>\n...\nkutil::intrusive_ptr<krpc::ProgressiveAttachment> pa = cntl->CreateProgressiveAttachment();\n"})}),"\n",(0,r.jsxs)(t.ol,{start:"2",children:["\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:"\u8c03\u7528ProgressiveAttachment::Write()\u53d1\u9001\u6570\u636e\u3002"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u5982\u679c\u5199\u5165\u53d1\u751f\u5728server-side done\u8c03\u7528\u524d\uff0c\u53d1\u9001\u7684\u6570\u636e\u5c06\u4f1a\u88ab\u7f13\u5b58\u76f4\u5230\u56de\u8c03\u7ed3\u675f\u540e\u624d\u4f1a\u5f00\u59cb\u53d1\u9001\u3002"}),"\n",(0,r.jsx)(t.li,{children:"\u5982\u679c\u5199\u5165\u53d1\u751f\u5728server-side done\u8c03\u7528\u540e\uff0c\u53d1\u9001\u7684\u6570\u636e\u5c06\u7acb\u523b\u4ee5chunked mode\u5199\u51fa\u3002"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["\u53d1\u9001\u5b8c\u6bd5\u540e\u786e\u4fdd\u6240\u6709\u7684",(0,r.jsx)(t.code,{children:"kutil::intrusive_ptr<krpc::ProgressiveAttachment>"}),"\u90fd\u6790\u6784\u4ee5\u91ca\u653e\u8d44\u6e90\u3002"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["\u53e6\u5916\uff0c\u5229\u7528\u8be5\u7279\u6027\u53ef\u4ee5\u8f7b\u677e\u5b9e\u73b0Server-Sent Events(SSE)\u670d\u52a1\uff0c\u4ece\u800c\u4f7f\u5ba2\u6237\u7aef\u80fd\u591f\u901a\u8fc7 HTTP \u8fde\u63a5\u4ece\u670d\u52a1\u5668\u81ea\u52a8\u63a5\u6536\u66f4\u65b0\u3002\u975e\u5e38\u9002\u5408\u6784\u5efa\u8bf8\u5982chatGPT\u8fd9\u7c7b\u5b9e\u65f6\u5e94\u7528\u7a0b\u5e8f\uff0c\u5e94\u7528\u4f8b\u5b50\u8be6\u89c1",(0,r.jsx)(t.a,{href:"https://github.com/apache/krpc/blob/master/example/http_c++/http_server.cpp",children:"http_server.cpp"}),"\u4e2d\u7684HttpSSEServiceImpl\u3002"]}),"\n",(0,r.jsx)(t.h2,{id:"\u6301\u7eed\u63a5\u6536",children:"\u6301\u7eed\u63a5\u6536"}),"\n",(0,r.jsx)(t.p,{children:"\u76ee\u524dkrpc server\u4e0d\u652f\u6301\u5728\u6536\u9f50http\u8bf7\u6c42\u7684header\u90e8\u5206\u540e\u5c31\u8c03\u7528\u670d\u52a1\u56de\u8c03\uff0c\u5373krpc server\u4e0d\u9002\u5408\u63a5\u6536\u8d85\u957f\u6216\u65e0\u9650\u957f\u7684body\u3002"}),"\n",(0,r.jsx)(t.h2,{id:"faq",children:"FAQ"}),"\n",(0,r.jsx)(t.h3,{id:"q-krpc\u524d\u7684nginx\u62a5\u4e86final-fail",children:"Q: krpc\u524d\u7684nginx\u62a5\u4e86final fail"}),"\n",(0,r.jsx)(t.p,{children:"\u8fd9\u4e2a\u9519\u8bef\u5728\u4e8ekrpc server\u76f4\u63a5\u5173\u95ed\u4e86http\u8fde\u63a5\u800c\u6ca1\u6709\u53d1\u9001\u4efb\u4f55\u56de\u590d\u3002"}),"\n",(0,r.jsx)(t.p,{children:"krpc server\u4e00\u4e2a\u7aef\u53e3\u652f\u6301\u591a\u79cd\u534f\u8bae\uff0c\u5f53\u5b83\u65e0\u6cd5\u89e3\u6790\u67d0\u4e2ahttp\u8bf7\u6c42\u65f6\u65e0\u6cd5\u8bf4\u8fd9\u4e2a\u8bf7\u6c42\u4e00\u5b9a\u662fHTTP\u3002server\u4f1a\u5bf9\u4e00\u4e9b\u57fa\u672c\u53ef\u786e\u8ba4\u662fHTTP\u7684\u8bf7\u6c42\u8fd4\u56deHTTP 400\u9519\u8bef\u5e76\u5173\u95ed\u8fde\u63a5\uff0c\u4f46\u5982\u679c\u662fHTTP method\u9519\u8bef(\u5728http\u5305\u5f00\u5934)\u6216\u4e25\u91cd\u7684\u683c\u5f0f\u9519\u8bef\uff08\u53ef\u80fd\u7531HTTP client\u7684bug\u5bfc\u81f4\uff09\uff0cserver\u4ecd\u4f1a\u76f4\u63a5\u65ad\u5f00\u8fde\u63a5\uff0c\u5bfc\u81f4nginx\u7684final fail\u3002"}),"\n",(0,r.jsx)(t.p,{children:"\u89e3\u51b3\u65b9\u6848: \u5728\u4f7f\u7528Nginx\u8f6c\u53d1\u6d41\u91cf\u65f6\uff0c\u901a\u8fc7\u6307\u5b9a$HTTP_method\u53ea\u653e\u884c\u5141\u8bb8\u7684\u65b9\u6cd5\u6216\u8005\u5e72\u8106\u8bbe\u7f6eproxy_method\u4e3a\u6307\u5b9a\u65b9\u6cd5\u3002"}),"\n",(0,r.jsx)(t.h3,{id:"q-krpc\u652f\u6301http-chunked\u65b9\u5f0f\u4f20\u8f93\u5417",children:"Q: krpc\u652f\u6301http chunked\u65b9\u5f0f\u4f20\u8f93\u5417"}),"\n",(0,r.jsx)(t.p,{children:"\u652f\u6301\u3002"}),"\n",(0,r.jsx)(t.h3,{id:"q-http\u8bf7\u6c42\u7684query-string\u4e2d\u542b\u6709base64\u7f16\u7801\u8fc7\u7684value\u4e3a\u4ec0\u4e48\u6709\u65f6\u5019\u65e0\u6cd5\u6b63\u5e38\u89e3\u6790",children:"Q: HTTP\u8bf7\u6c42\u7684query string\u4e2d\u542b\u6709BASE64\u7f16\u7801\u8fc7\u7684value\uff0c\u4e3a\u4ec0\u4e48\u6709\u65f6\u5019\u65e0\u6cd5\u6b63\u5e38\u89e3\u6790"}),"\n",(0,r.jsxs)(t.p,{children:["\u6839\u636e",(0,r.jsx)(t.a,{href:"http://tools.ietf.org/html/rfc3986#section-2.2",children:"HTTP\u534f\u8bae"}),"\u4e2d\u7684\u8981\u6c42\uff0c\u4ee5\u4e0b\u5b57\u7b26\u5e94\u8be5\u4f7f\u7528%\u7f16\u7801"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'       reserved    = gen-delims / sub-delims\n\n       gen-delims  = ":" / "/" / "?" / "#" / "[" / "]" / "@"\n\n       sub-delims  = "!" / "$" / "&" / "\'" / "(" / ")"\n                   / "*" / "+" / "," / ";" / "="\n'})}),"\n",(0,r.jsx)(t.p,{children:'\u4f46Base64 \u7f16\u7801\u540e\u7684\u5b57\u7b26\u4e32\u4e2d\uff0c\u4f1a\u4ee5"="\u6216\u8005"=="\u4f5c\u4e3a\u7ed3\u5c3e\uff0c\u6bd4\u5982: ?wi=NDgwMDB8dGVzdA==&anothorkey=anothervalue\u3002\u8fd9\u4e2a\u5b57\u6bb5\u53ef\u80fd\u4f1a\u88ab\u6b63\u786e\u89e3\u6790\uff0c\u4e5f\u53ef\u80fd\u4e0d\u4f1a\uff0c\u53d6\u51b3\u4e8e\u5177\u4f53\u5b9e\u73b0\uff0c\u539f\u5219\u4e0a\u4e0d\u5e94\u505a\u4efb\u4f55\u5047\u8bbe.'}),"\n",(0,r.jsxs)(t.p,{children:['\u4e00\u4e2a\u89e3\u51b3\u65b9\u6cd5\u662f\u5220\u9664\u672b\u5c3e\u7684"=", \u4e0d\u5f71\u54cdBase64\u7684',(0,r.jsx)(t.a,{href:"http://en.wikipedia.org/wiki/Base64#Padding",children:"\u6b63\u5e38\u89e3\u7801"}),"; \u7b2c\u4e8c\u4e2a\u65b9\u6cd5\u662f\u5728\u5bf9\u8fd9\u4e2aURI\u505a",(0,r.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Percent-encoding",children:"percent encoding"}),"\uff0c\u89e3\u7801\u65f6\u5148\u505apercent decoding\u518d\u7528Base64."]})]})}function m(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(A,{...e})}):A(e)}},28453:(e,t,n)=>{"use strict";n.d(t,{R:()=>i,x:()=>l});var r=n(96540);const s={},c=r.createContext(s);function i(e){const t=r.useContext(c);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(c.Provider,{value:t},e.children)}}}]);