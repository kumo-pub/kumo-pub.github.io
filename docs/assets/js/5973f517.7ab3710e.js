"use strict";(self.webpackChunkkumo_website=self.webpackChunkkumo_website||[]).push([[30952],{93316:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>l,contentTitle:()=>h,default:()=>a,frontMatter:()=>s,metadata:()=>c,toc:()=>d});var n=t(74848),i=t(28453);const s={},h="Thrift\u670d\u52a1",c={id:"cpp/krpc/thrift",title:"Thrift\u670d\u52a1",description:"thrift\u662f\u5e94\u7528\u8f83\u5e7f\u7684RPC\u6846\u67b6\uff0c\u6700\u521d\u7531Facebook\u53d1\u5e03\uff0c\u540e\u4ea4\u7531Apache\u7ef4\u62a4\u3002\u4e3a\u4e86\u548cthrift\u670d\u52a1\u4e92\u901a\uff0c",source:"@site/docs/cpp/krpc/thrift.mdx",sourceDirName:"cpp/krpc",slug:"/cpp/krpc/thrift",permalink:"/docs/next/cpp/krpc/thrift",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedBy:"Jeff lothar",lastUpdatedAt:1748081772e3,frontMatter:{},sidebar:"docs",previous:{title:"http\u670d\u52a1",permalink:"/docs/next/cpp/krpc/http_service"},next:{title:"CPU\u4f7f\u7528\u5206\u6790",permalink:"/docs/next/cpp/krpc/cpu_profiler"}},l={},d=[{value:"\u7f16\u8bd1",id:"\u7f16\u8bd1",level:2},{value:"Client\u7aef\u8bbf\u95eethrift server",id:"client\u7aef\u8bbf\u95eethrift-server",level:2},{value:"Server\u7aef\u5904\u7406thrift\u8bf7\u6c42",id:"server\u7aef\u5904\u7406thrift\u8bf7\u6c42",level:2},{value:"\u7b80\u5355\u7684\u548c\u539f\u751fthrift\u6027\u80fd\u5bf9\u6bd4\u5b9e\u9a8c",id:"\u7b80\u5355\u7684\u548c\u539f\u751fthrift\u6027\u80fd\u5bf9\u6bd4\u5b9e\u9a8c",level:2},{value:"server\u7aef\u8fd4\u56declient\u53d1\u9001\u7684&quot;hello&quot;\u5b57\u7b26\u4e32",id:"server\u7aef\u8fd4\u56declient\u53d1\u9001\u7684hello\u5b57\u7b26\u4e32",level:3},{value:"server\u7aef\u8fd4\u56de&quot;hello&quot; * 1000 \u5b57\u7b26\u4e32",id:"server\u7aef\u8fd4\u56dehello--1000-\u5b57\u7b26\u4e32",level:3},{value:"server\u7aef\u505a\u6bd4\u8f83\u590d\u6742\u7684\u6570\u5b66\u8ba1\u7b97\u5e76\u8fd4\u56de&quot;hello&quot; * 1000 \u5b57\u7b26\u4e32",id:"server\u7aef\u505a\u6bd4\u8f83\u590d\u6742\u7684\u6570\u5b66\u8ba1\u7b97\u5e76\u8fd4\u56dehello--1000-\u5b57\u7b26\u4e32",level:3}];function o(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.header,{children:(0,n.jsx)(r.h1,{id:"thrift\u670d\u52a1",children:"Thrift\u670d\u52a1"})}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.a,{href:"https://thrift.apache.org/",children:"thrift"}),"\u662f\u5e94\u7528\u8f83\u5e7f\u7684RPC\u6846\u67b6\uff0c\u6700\u521d\u7531Facebook\u53d1\u5e03\uff0c\u540e\u4ea4\u7531Apache\u7ef4\u62a4\u3002\u4e3a\u4e86\u548cthrift\u670d\u52a1\u4e92\u901a\uff0c\n\u540c\u65f6\u89e3\u51b3thrift\u539f\u751f\u65b9\u6848\u5728\u591a\u7ebf\u7a0b\u5b89\u5168\u3001\u6613\u7528\u6027\u3001\u5e76\u53d1\u80fd\u529b\u7b49\u65b9\u9762\u7684\u4e00\u7cfb\u5217\u95ee\u9898\uff0ckrpc\u5b9e\u73b0\u5e76\u652f\u6301thrift\u5728NonBlocking\u6a21\u5f0f\u4e0b\u7684\u534f\u8bae\n(FramedProtocol), \u4e0b\u6587\u5747\u76f4\u63a5\u79f0\u4e3athrift\u534f\u8bae\u3002"]}),"\n",(0,n.jsxs)(r.p,{children:["\u793a\u4f8b\u7a0b\u5e8f\uff1a",(0,n.jsx)(r.a,{href:"https://github.com/apache/krpc/tree/master/example/thrift_extension_c++/",children:"example/thrift_extension_c++"})]}),"\n",(0,n.jsx)(r.p,{children:"\u76f8\u6bd4\u4f7f\u7528\u539f\u751f\u65b9\u6848\u7684\u4f18\u52bf\u6709\uff1a"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"\u7ebf\u7a0b\u5b89\u5168\u3002\u7528\u6237\u4e0d\u9700\u8981\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u5efa\u7acb\u72ec\u7acb\u7684client."}),"\n",(0,n.jsx)(r.li,{children:"\u652f\u6301\u540c\u6b65\u3001\u5f02\u6b65\u3001\u6279\u91cf\u540c\u6b65\u3001\u6279\u91cf\u5f02\u6b65\u7b49\u8bbf\u95ee\u65b9\u5f0f\uff0c\u80fd\u4f7f\u7528ParallelChannel\u7b49\u7ec4\u5408\u8bbf\u95ee\u65b9\u5f0f."}),"\n",(0,n.jsx)(r.li,{children:"\u652f\u6301\u591a\u79cd\u8fde\u63a5\u65b9\u5f0f(\u8fde\u63a5\u6c60, \u77ed\u8fde\u63a5), \u652f\u6301\u8d85\u65f6\u3001backup request\u3001\u53d6\u6d88\u3001tracing\u3001\u5185\u7f6e\u670d\u52a1\u7b49\u4e00\u7cfb\u5217RPC\u57fa\u672c\u798f\u5229."}),"\n",(0,n.jsx)(r.li,{children:"\u6027\u80fd\u66f4\u597d."}),"\n"]}),"\n",(0,n.jsx)(r.h2,{id:"\u7f16\u8bd1",children:"\u7f16\u8bd1"}),"\n",(0,n.jsx)(r.p,{children:"\u4e3a\u4e86\u590d\u7528\u89e3\u6790\u4ee3\u7801\uff0ckrpc\u5bf9thrift\u7684\u652f\u6301\u4ecd\u9700\u8981\u4f9d\u8d56thrift\u5e93\u4ee5\u53cathrift\u751f\u6210\u7684\u4ee3\u7801\uff0cthrift\u683c\u5f0f\u600e\u4e48\u5199\uff0c\u4ee3\u7801\u600e\u4e48\u751f\u6210\uff0c\u600e\u4e48\u7f16\u8bd1\u7b49\n\u95ee\u9898\u8bf7\u53c2\u8003thrift\u5b98\u65b9\u6587\u6863\u3002"}),"\n",(0,n.jsx)(r.p,{children:"krpc\u9ed8\u8ba4\u4e0d\u542f\u7528thrift\u652f\u6301\u4e5f\u4e0d\u9700\u8981thrift\u4f9d\u8d56\u3002\u4f46\u5982\u679c\u9700\u7528thrift\u534f\u8bae, \u914d\u7f6ekrpc\u73af\u5883\u7684\u65f6\u5019\u9700\u52a0\u4e0a--with-thrift\u6216-DWITH_THRIFT=ON."}),"\n",(0,n.jsxs)(r.p,{children:["Linux\u4e0b\u5b89\u88c5thrift\u4f9d\u8d56\n\u5148\u53c2\u8003",(0,n.jsx)(r.a,{href:"https://thrift.apache.org/docs/install/debian",children:"\u5b98\u65b9wiki"}),"\u5b89\u88c5\u597d\u5fc5\u5907\u7684\u4f9d\u8d56\u548c\u5de5\u5177\uff0c\u7136\u540e\u4ece",(0,n.jsx)(r.a,{href:"https://thrift.apache.org/download",children:"\u5b98\u7f51"}),"\u4e0b\u8f7dthrift\u6e90\u4ee3\u7801\uff0c\u89e3\u538b\u7f16\u8bd1\u3002"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"wget https://downloads.apache.org/thrift/0.18.1/thrift-0.18.1.tar.gz\ntar -xf thrift-0.18.1.tar.gz\ncd thrift-0.18.1/\n./bootstrap.sh\n./configure --prefix=/usr --with-ruby=no --with-python=no --with-java=no --with-go=no --with-perl=no --with-php=no --with-csharp=no --with-erlang=no --with-lua=no --with-nodejs=no --with-rs=no --with-py3=no CXXFLAGS='-Wno-error'\nmake CPPFLAGS=-DFORCE_BOOST_SMART_PTR -j 4 -s\nsudo make install\n"})}),"\n",(0,n.jsx)(r.p,{children:"\u914d\u7f6ekrpc\u652f\u6301thrift\u534f\u8bae\u540emake\u3002\u7f16\u8bd1\u5b8c\u6210\u540e\u4f1a\u751f\u6210libkrpc.a, \u5176\u4e2d\u5305\u542b\u4e86\u652f\u6301thrift\u534f\u8bae\u7684\u6269\u5c55\u4ee3\u7801, \u50cf\u6b63\u5e38\u4f7f\u7528krpc\u7684\u4ee3\u7801\u4e00\u6837\u94fe\u63a5\u5373\u53ef\u3002"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"# Ubuntu\nsh config_krpc.sh --headers=/usr/include --libs=/usr/lib --with-thrift\n# Fedora/CentOS\nsh config_krpc.sh --headers=/usr/include --libs=/usr/lib64 --with-thrift\n# Or use cmake\nmkdir build && cd build && cmake ../ -DWITH_THRIFT=1\n"})}),"\n",(0,n.jsxs)(r.p,{children:["\u66f4\u591a\u7f16\u8bd1\u9009\u9879\u8bf7\u9605\u8bfb",(0,n.jsx)(r.a,{href:"/docs/next/cpp/krpc/getting_started",children:"Getting Started"}),"\u3002"]}),"\n",(0,n.jsx)(r.h2,{id:"client\u7aef\u8bbf\u95eethrift-server",children:"Client\u7aef\u8bbf\u95eethrift server"}),"\n",(0,n.jsx)(r.p,{children:"\u57fa\u672c\u6b65\u9aa4\uff1a"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"\u521b\u5efa\u4e00\u4e2a\u534f\u8bae\u8bbe\u7f6e\u4e3akrpc::PROTOCOL_THRIFT\u7684Channel"}),"\n",(0,n.jsx)(r.li,{children:"\u521b\u5efakrpc::ThriftStub"}),"\n",(0,n.jsx)(r.li,{children:"\u4f7f\u7528\u539f\u751fRequest\u548c\u539f\u751fResponse>\u53d1\u8d77\u8bbf\u95ee"}),"\n"]}),"\n",(0,n.jsx)(r.p,{children:"\u793a\u4f8b\u4ee3\u7801\u5982\u4e0b\uff1a"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-c++",children:'#include <krpc/channel.h>\n#include <krpc/thrift_message.h>                   // \u5b9a\u4e49\u4e86ThriftStub\n...\n\nDEFINE_string(server, "0.0.0.0:8019", "IP Address of thrift server");\nDEFINE_string(load_balancer, "", "The algorithm for load balancing");\n...\n  \nkrpc::ChannelOptions options;\noptions.protocol = krpc::PROTOCOL_THRIFT;\nkrpc::Channel thrift_channel;\nif (thrift_channel.Init(Flags_server.c_str(), FLAGS_load_balancer.c_str(), &options) != 0) {\n   LOG(ERROR) << "Fail to initialize thrift channel";\n   return -1;\n}\n\nkrpc::ThriftStub stub(&thrift_channel);\n...\n\n// example::[EchoRequest/EchoResponse]\u662fthrift\u751f\u6210\u7684\u6d88\u606f\nexample::EchoRequest req;\nexample::EchoResponse res;\nreq.data = "hello";\n\nstub.CallMethod("Echo", &cntl, &req, &res, NULL);\n\nif (cntl.Failed()) {\n    LOG(ERROR) << "Fail to send thrift request, " << cntl.ErrorText();\n    return -1;\n} \n'})}),"\n",(0,n.jsx)(r.h2,{id:"server\u7aef\u5904\u7406thrift\u8bf7\u6c42",children:"Server\u7aef\u5904\u7406thrift\u8bf7\u6c42"}),"\n",(0,n.jsx)(r.p,{children:"\u7528\u6237\u901a\u8fc7\u7ee7\u627fkrpc::ThriftService\u5b9e\u73b0\u5904\u7406\u903b\u8f91\uff0c\u65e2\u53ef\u4ee5\u8c03\u7528thrift\u751f\u6210\u7684handler\u4ee5\u76f4\u63a5\u590d\u7528\u539f\u6709\u7684\u51fd\u6570\u5165\u53e3\uff0c\u4e5f\u53ef\u4ee5\u50cfprotobuf\u670d\u52a1\u90a3\u6837\u76f4\u63a5\u8bfb\u53d6request\u548c\u8bbe\u7f6eresponse\u3002"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-c++",children:'class EchoServiceImpl : public krpc::ThriftService {\npublic:\n    void ProcessThriftFramedRequest(krpc::Controller* cntl,\n                                    krpc::ThriftFramedMessage* req,\n                                    krpc::ThriftFramedMessage* res,\n                                    google::protobuf::Closure* done) override {\n        // Dispatch calls to different methods\n        if (cntl->thrift_method_name() == "Echo") {\n            return Echo(cntl, req->Cast<example::EchoRequest>(),\n                        res->Cast<example::EchoResponse>(), done);\n        } else {\n            cntl->SetFailed(krpc::ENOMETHOD, "Fail to find method=%s",\n                            cntl->thrift_method_name().c_str());\n            done->Run();\n        }\n    }\n\n    void Echo(krpc::Controller* cntl,\n              const example::EchoRequest* req,\n              example::EchoResponse* res,\n              google::protobuf::Closure* done) {\n        // This object helps you to call done->Run() in RAII style. If you need\n        // to process the request asynchronously, pass done_guard.release().\n        krpc::ClosureGuard done_guard(done);\n\n        res->data = req->data + " (processed)";\n    }\n};\n'})}),"\n",(0,n.jsx)(r.p,{children:"\u5b9e\u73b0\u597dthrift service\u540e\uff0c\u8bbe\u7f6e\u5230ServerOptions.thrift_service\u5e76\u542f\u52a8\u670d\u52a1"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-c++",children:'    krpc::Server server;\n    krpc::ServerOptions options;\n    options.thrift_service = new EchoServiceImpl;\n    options.idle_timeout_sec = FLAGS_idle_timeout_s;\n    options.max_concurrency = FLAGS_max_concurrency;\n\n    // Start the server.\n    if (server.Start(FLAGS_port, &options) != 0) {\n        LOG(ERROR) << "Fail to start EchoServer";\n        return -1;\n    }\n'})}),"\n",(0,n.jsx)(r.h2,{id:"\u7b80\u5355\u7684\u548c\u539f\u751fthrift\u6027\u80fd\u5bf9\u6bd4\u5b9e\u9a8c",children:"\u7b80\u5355\u7684\u548c\u539f\u751fthrift\u6027\u80fd\u5bf9\u6bd4\u5b9e\u9a8c"}),"\n",(0,n.jsx)(r.p,{children:"\u6d4b\u8bd5\u73af\u5883: 48\u6838  2.30GHz"}),"\n",(0,n.jsx)(r.h3,{id:"server\u7aef\u8fd4\u56declient\u53d1\u9001\u7684hello\u5b57\u7b26\u4e32",children:'server\u7aef\u8fd4\u56declient\u53d1\u9001\u7684"hello"\u5b57\u7b26\u4e32'}),"\n",(0,n.jsxs)(r.table,{children:[(0,n.jsx)(r.thead,{children:(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.th,{children:"\u6846\u67b6"}),(0,n.jsx)(r.th,{children:"\u7ebf\u7a0b\u6570"}),(0,n.jsx)(r.th,{children:"QPS"}),(0,n.jsx)(r.th,{children:"\u5e73\u54cd"}),(0,n.jsx)(r.th,{children:"cpu\u5229\u7528\u7387"})]})}),(0,n.jsxs)(r.tbody,{children:[(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:"native thrift"}),(0,n.jsx)(r.td,{children:"60"}),(0,n.jsx)(r.td,{children:"6.9w"}),(0,n.jsx)(r.td,{children:"0.9ms"}),(0,n.jsx)(r.td,{children:"2.8%"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:"krpc thrift"}),(0,n.jsx)(r.td,{children:"60"}),(0,n.jsx)(r.td,{children:"30w"}),(0,n.jsx)(r.td,{children:"0.2ms"}),(0,n.jsx)(r.td,{children:"18%"})]})]})]}),"\n",(0,n.jsx)(r.h3,{id:"server\u7aef\u8fd4\u56dehello--1000-\u5b57\u7b26\u4e32",children:'server\u7aef\u8fd4\u56de"hello" * 1000 \u5b57\u7b26\u4e32'}),"\n",(0,n.jsxs)(r.table,{children:[(0,n.jsx)(r.thead,{children:(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.th,{children:"\u6846\u67b6"}),(0,n.jsx)(r.th,{children:"\u7ebf\u7a0b\u6570"}),(0,n.jsx)(r.th,{children:"QPS"}),(0,n.jsx)(r.th,{children:"\u5e73\u54cd"}),(0,n.jsx)(r.th,{children:"cpu\u5229\u7528\u7387"})]})}),(0,n.jsxs)(r.tbody,{children:[(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:"native thrift"}),(0,n.jsx)(r.td,{children:"60"}),(0,n.jsx)(r.td,{children:"5.2w"}),(0,n.jsx)(r.td,{children:"1.1ms"}),(0,n.jsx)(r.td,{children:"4.5%"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:"krpc thrift"}),(0,n.jsx)(r.td,{children:"60"}),(0,n.jsx)(r.td,{children:"19.5w"}),(0,n.jsx)(r.td,{children:"0.3ms"}),(0,n.jsx)(r.td,{children:"22%"})]})]})]}),"\n",(0,n.jsx)(r.h3,{id:"server\u7aef\u505a\u6bd4\u8f83\u590d\u6742\u7684\u6570\u5b66\u8ba1\u7b97\u5e76\u8fd4\u56dehello--1000-\u5b57\u7b26\u4e32",children:'server\u7aef\u505a\u6bd4\u8f83\u590d\u6742\u7684\u6570\u5b66\u8ba1\u7b97\u5e76\u8fd4\u56de"hello" * 1000 \u5b57\u7b26\u4e32'}),"\n",(0,n.jsxs)(r.table,{children:[(0,n.jsx)(r.thead,{children:(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.th,{children:"\u6846\u67b6"}),(0,n.jsx)(r.th,{children:"\u7ebf\u7a0b\u6570"}),(0,n.jsx)(r.th,{children:"QPS"}),(0,n.jsx)(r.th,{children:"\u5e73\u54cd"}),(0,n.jsx)(r.th,{children:"cpu\u5229\u7528\u7387"})]})}),(0,n.jsxs)(r.tbody,{children:[(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:"native thrift"}),(0,n.jsx)(r.td,{children:"60"}),(0,n.jsx)(r.td,{children:"1.7w"}),(0,n.jsx)(r.td,{children:"3.5ms"}),(0,n.jsx)(r.td,{children:"76%"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:"krpc thrift"}),(0,n.jsx)(r.td,{children:"60"}),(0,n.jsx)(r.td,{children:"2.1w"}),(0,n.jsx)(r.td,{children:"2.9ms"}),(0,n.jsx)(r.td,{children:"93%"})]})]})]})]})}function a(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(o,{...e})}):o(e)}},28453:(e,r,t)=>{t.d(r,{R:()=>h,x:()=>c});var n=t(96540);const i={},s=n.createContext(i);function h(e){const r=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:h(e.components),n.createElement(s.Provider,{value:r},e.children)}}}]);