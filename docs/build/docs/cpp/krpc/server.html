<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-1.1.1 docs-doc-page docs-doc-id-cpp/krpc/server" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">æœåŠ¡å¼€å‘ | Kumo AI</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kumo-pub.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kumo-pub.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kumo-pub.github.io/docs/cpp/krpc/server"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="1.1.1"><meta data-rh="true" name="docusaurus_tag" content="docs-default-1.1.1"><meta data-rh="true" name="docsearch:version" content="1.1.1"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-1.1.1"><meta data-rh="true" property="og:title" content="æœåŠ¡å¼€å‘ | Kumo AI"><meta data-rh="true" name="description" content="ç¤ºä¾‹ç¨‹åº"><meta data-rh="true" property="og:description" content="ç¤ºä¾‹ç¨‹åº"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://kumo-pub.github.io/docs/cpp/krpc/server"><link data-rh="true" rel="alternate" href="https://kumo-pub.github.io/docs/cpp/krpc/server" hreflang="en"><link data-rh="true" rel="alternate" href="https://kumo-pub.github.io/docs/cpp/krpc/server" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kumo AI RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kumo AI Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Kumo AI JSON Feed">


<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E5CR2Q1NRE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-E5CR2Q1NRE",{})</script>


<link rel="alternate" type="application/rss+xml" href="/changelog/rss.xml" title="Docusaurus changelog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/changelog/atom.xml" title="Docusaurus changelog Atom Feed">
<link rel="alternate" type="application/json" href="/changelog/feed.json" title="Docusaurus changelog JSON Feed">



<link rel="icon" href="/img/docusaurus.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/docusaurus.png">
<link rel="mask-icon" href="/img/docusaurus.png" color="rgb(62, 204, 94)">
<meta name="msapplication-TileImage" content="/img/docusaurus.png">
<meta name="msapplication-TileColor" content="#000">



<link rel="alternate" type="application/rss+xml" href="/tests/blog/rss.xml" title="Docusaurus Tests Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tests/blog/atom.xml" title="Docusaurus Tests Blog Atom Feed">
<link rel="alternate" type="application/json" href="/tests/blog/feed.json" title="Docusaurus Tests Blog JSON Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Kumo AI" href="/opensearch.xml">

<link rel="stylesheet" href="/katex/katex.min.css"><link rel="stylesheet" href="/assets/css/styles.21fbef88.css">
<script src="/assets/js/runtime~main.cf79a945.js" defer="defer"></script>
<script src="/assets/js/main.4244a726.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme-b4f")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss-b4f")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">ğŸ‰ï¸ <b><a target="_blank" href="https://docusaurus.io/blog/releases/1.1">Kumo v1.1</a> is out!</b> ğŸ¥³ï¸</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/kumo_logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE" height="48" width="128"><img src="/img/kumo_logo_white.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="48" width="128"></div><b class="navbar__title text--truncate">ä¸»é¡µ</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/docs/category/kmsearch">API</a><a class="navbar__item navbar__link" href="/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/changelog">å‘å¸ƒ</a><a class="navbar__item navbar__link" href="/showcase">åº”ç”¨æ¡ˆä¾‹</a><a class="navbar__item navbar__link" href="/community/support">æ”¯æŒä¸èµ„æº</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/cpp/krpc/server">1.1.1</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/cpp/krpc/server">nightly ğŸš§</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/cpp/krpc/server">1.1.1</a></li><li><hr class="dropdown-separator"></li><li class="dropdown-archived-versions"><b>Archived versions</b></li><li><a href="https://docusaurus-archive-october-2023.netlify.app/docs/2.3.1" target="_blank" rel="noopener noreferrer" class="dropdown__link">1.0.1<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://v1.docusaurus.io" target="_blank" rel="noopener noreferrer" class="dropdown__link">1.x.x<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><hr class="dropdown-separator"></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/cpp/krpc/server" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://github.com/facebook/docusaurus/issues/3526" target="_blank" rel="noopener noreferrer" class="dropdown__link">Help Us Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/kumo_logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE" height="48" width="128"><img src="/img/kumo_logo_white.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="48" width="128"><b>ä¸»é¡µ</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs">æ¦‚è¿°</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/åŸºç¡€å‡†å¤‡">åŸºç¡€å‡†å¤‡</a><button aria-label="Collapse sidebar category &#x27;åŸºç¡€å‡†å¤‡&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/env_prepare_be">åç«¯å¼€å‘ç¯å¢ƒ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/env_prepare_fe">å‰ç«¯å¼€å‘ç¯å¢ƒ</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/æŒç»­é›†æˆ----kmpkg">æŒç»­é›†æˆ -- kmpkg</a><button aria-label="Expand sidebar category &#x27;æŒç»­é›†æˆ -- kmpkg&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/cå¼€å‘">c++å¼€å‘</a><button aria-label="Collapse sidebar category &#x27;c++å¼€å‘&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/overview">æ¦‚è¿°</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/è§„èŒƒé”™è¯¯ä¸é”™è¯¯è¿”å›å€¼">è§„èŒƒé”™è¯¯ä¸é”™è¯¯è¿”å›å€¼</a><button aria-label="Expand sidebar category &#x27;è§„èŒƒé”™è¯¯ä¸é”™è¯¯è¿”å›å€¼&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/æ€§èƒ½æµ‹è¯•ä¸å•å…ƒæµ‹è¯•">æ€§èƒ½æµ‹è¯•ä¸å•å…ƒæµ‹è¯•</a><button aria-label="Expand sidebar category &#x27;æ€§èƒ½æµ‹è¯•ä¸å•å…ƒæµ‹è¯•&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/base/time">æ—¶é—´ä¸æ—¥å†</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/å‘½ä»¤è¡Œä¸é…ç½®">å‘½ä»¤è¡Œä¸é…ç½®</a><button aria-label="Expand sidebar category &#x27;å‘½ä»¤è¡Œä¸é…ç½®&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/hashå®¹å™¨">hashå®¹å™¨</a><button aria-label="Expand sidebar category &#x27;hashå®¹å™¨&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/å­—ç¬¦ä¸å­—ç¬¦ä¸²">å­—ç¬¦ä¸å­—ç¬¦ä¸²</a><button aria-label="Expand sidebar category &#x27;å­—ç¬¦ä¸å­—ç¬¦ä¸²&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/æ ¼å¼ä¸è§£æ">æ ¼å¼ä¸è§£æ</a><button aria-label="Expand sidebar category &#x27;æ ¼å¼ä¸è§£æ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿ">æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿ</a><button aria-label="Expand sidebar category &#x27;æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/å­—ç¬¦ç¼–ç ">å­—ç¬¦ç¼–ç </a><button aria-label="Expand sidebar category &#x27;å­—ç¬¦ç¼–ç &#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/å¤šæ ¸ç¼–ç¨‹">å¤šæ ¸ç¼–ç¨‹</a><button aria-label="Expand sidebar category &#x27;å¤šæ ¸ç¼–ç¨‹&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/logæ—¥å¿—åº“">logæ—¥å¿—åº“</a><button aria-label="Expand sidebar category &#x27;logæ—¥å¿—åº“&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/ç›‘æ§ä¸ä¸ŠæŠ¥">ç›‘æ§ä¸ä¸ŠæŠ¥</a><button aria-label="Expand sidebar category &#x27;ç›‘æ§ä¸ä¸ŠæŠ¥&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/krpcæ•™ç¨‹">krpcæ•™ç¨‹</a><button aria-label="Collapse sidebar category &#x27;krpcæ•™ç¨‹&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/getting_started">ä½¿ç”¨krpc</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/cpp/krpc/server">æœåŠ¡å¼€å‘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/http_service">httpæœåŠ¡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/thrift">ThriftæœåŠ¡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/cpu_profiler">CPUä½¿ç”¨åˆ†æ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/heap_profiler">å †æ ˆåˆ†æ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/contention_profiler">ç«æ€åˆ†æ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/dummy_server">server dummy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/rpcz">rpcè¿½è¸ª</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/thread_local">thread local</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/json2pb">jsonå’Œprotobufè½¬æ¢</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/threading_overview">å¸¸è§çº¿ç¨‹æ¨¡å‹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/atomic_instructions">atomicä½¿ç”¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/flags">flagsä½¿ç”¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/io">IOè¯¦è§£</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/streaming_rpc">æµå¼rpc</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/endpoint">EndPointå·¥å…·ç±»</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/kumo_std">kumoæ ‡å‡†åè®®</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/client">å®¢æˆ·ç«¯æœåŠ¡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/circuit_breaker">ç†”æ–­åŠŸèƒ½</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/connections">connectionsæœåŠ¡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/lalb">lalbè°ƒåº¦</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/consistent_hashing">ä¸€è‡´æ€§hash</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/http_client">httpå®¢æˆ·ç«¯</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/http_derivatives">httpå»¶å±•é˜…è¯»</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/combo_channel">æœåŠ¡æ²»ç†</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/memcache_client">memcachedå®¢æˆ·ç«¯</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/redis_client">redisæ”¯æŒ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/auto_concurrency_limiter">è‡ªé€‚åº”é™æµ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cpp/krpc/server_debugging">rpcè°ƒè¯•</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/æœç´ åŸºç¡€å¼€å‘">æœç´ åŸºç¡€å¼€å‘</a><button aria-label="Expand sidebar category &#x27;æœç´ åŸºç¡€å¼€å‘&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/æœç´¢åº”ç”¨å¼€å‘">æœç´¢åº”ç”¨å¼€å‘</a><button aria-label="Expand sidebar category &#x27;æœç´¢åº”ç”¨å¼€å‘&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/å‘é‡æ•°æ®åº“æ•™ç¨‹">å‘é‡æ•°æ®åº“æ•™ç¨‹</a><button aria-label="Expand sidebar category &#x27;å‘é‡æ•°æ®åº“æ•™ç¨‹&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/æœç´¢ç»Ÿä¸€æ‰§è¡Œå¼•æ“">æœç´¢ç»Ÿä¸€æ‰§è¡Œå¼•æ“</a><button aria-label="Expand sidebar category &#x27;æœç´¢ç»Ÿä¸€æ‰§è¡Œå¼•æ“&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/æœç´¢-ui">æœç´¢ UI</a><button aria-label="Expand sidebar category &#x27;æœç´¢ UI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/cå¼€å‘"><span itemprop="name">c++å¼€å‘</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/krpcæ•™ç¨‹"><span itemprop="name">krpcæ•™ç¨‹</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">æœåŠ¡å¼€å‘</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 1.1.1</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>æœåŠ¡å¼€å‘</h1></header>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ç¤ºä¾‹ç¨‹åº">ç¤ºä¾‹ç¨‹åº<a href="#ç¤ºä¾‹ç¨‹åº" class="hash-link" aria-label="Direct link to ç¤ºä¾‹ç¨‹åº" title="Direct link to ç¤ºä¾‹ç¨‹åº">â€‹</a></h2>
<p>Echoçš„<a href="https://github.com/apache/krpc/blob/master/example/echo_c++/server.cpp" target="_blank" rel="noopener noreferrer">serverç«¯ä»£ç </a>ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å¡«å†™protoæ–‡ä»¶">å¡«å†™protoæ–‡ä»¶<a href="#å¡«å†™protoæ–‡ä»¶" class="hash-link" aria-label="Direct link to å¡«å†™protoæ–‡ä»¶" title="Direct link to å¡«å†™protoæ–‡ä»¶">â€‹</a></h2>
<p>è¯·æ±‚ã€å›å¤ã€æœåŠ¡çš„æ¥å£å‡å®šä¹‰åœ¨protoæ–‡ä»¶ä¸­ã€‚</p>
<div class="language-C++ language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># å‘Šè¯‰protocè¦ç”ŸæˆC++ ServiceåŸºç±»ï¼Œå¦‚æœæ˜¯javaæˆ–pythonï¼Œåˆ™åº”åˆ†åˆ«ä¿®æ”¹ä¸ºjava_generic_serviceså’Œpy_generic_services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option cc_generic_services = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message EchoRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      required string message = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message EchoResponse {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      required string message = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service EchoService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rpc Echo(EchoRequest) returns (EchoResponse);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>protobufçš„æ›´å¤šç”¨æ³•è¯·é˜…è¯»<a href="https://developers.google.com/protocol-buffers/docs/proto#options" target="_blank" rel="noopener noreferrer">protobufå®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å®ç°ç”Ÿæˆçš„serviceæ¥å£">å®ç°ç”Ÿæˆçš„Serviceæ¥å£<a href="#å®ç°ç”Ÿæˆçš„serviceæ¥å£" class="hash-link" aria-label="Direct link to å®ç°ç”Ÿæˆçš„Serviceæ¥å£" title="Direct link to å®ç°ç”Ÿæˆçš„Serviceæ¥å£">â€‹</a></h2>
<p>protocè¿è¡Œåä¼šç”Ÿæˆecho.pb.ccå’Œecho.pb.hæ–‡ä»¶ï¼Œä½ å¾—include echo.pb.hï¼Œå®ç°å…¶ä¸­çš„EchoServiceåŸºç±»ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;echo.pb.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyEchoService : public EchoService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void Echo(::google::protobuf::RpcController* cntl_base,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              const ::example::EchoRequest* request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ::example::EchoResponse* response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ::google::protobuf::Closure* done) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™ä¸ªå¯¹è±¡ç¡®ä¿åœ¨returnæ—¶è‡ªåŠ¨è°ƒç”¨done-&gt;Run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        krpc::ClosureGuard done_guard(done);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        krpc::Controller* cntl = static_cast&lt;krpc::Controller*&gt;(cntl_base);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¡«å†™response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response-&gt;set_message(request-&gt;message());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Serviceåœ¨æ’å…¥<a href="https://github.com/apache/krpc/blob/master/src/krpc/server.h" target="_blank" rel="noopener noreferrer">krpc.Server</a>åæ‰å¯èƒ½æä¾›æœåŠ¡ã€‚</p>
<p>å½“å®¢æˆ·ç«¯å‘æ¥è¯·æ±‚æ—¶ï¼ŒEcho()ä¼šè¢«è°ƒç”¨ã€‚å‚æ•°çš„å«ä¹‰åˆ†åˆ«æ˜¯ï¼š</p>
<p><strong>controller</strong></p>
<p>åœ¨krpcä¸­å¯ä»¥é™æ€è½¬ä¸ºkrpc::Controllerï¼ˆå‰ææ˜¯ä»£ç è¿è¡Œkrpc.Serverä¸­ï¼‰ï¼ŒåŒ…å«äº†æ‰€æœ‰requestå’Œresponseä¹‹å¤–çš„å‚æ•°é›†åˆï¼Œå…·ä½“æ¥å£æŸ¥é˜…<a href="https://github.com/apache/krpc/blob/master/src/krpc/controller.h" target="_blank" rel="noopener noreferrer">controller.h</a></p>
<p><strong>request</strong></p>
<p>è¯·æ±‚ï¼Œåªè¯»çš„ï¼Œæ¥è‡ªclientç«¯çš„æ•°æ®åŒ…ã€‚</p>
<p><strong>response</strong></p>
<p>å›å¤ã€‚éœ€è¦ç”¨æˆ·å¡«å……ï¼Œå¦‚æœå­˜åœ¨<strong>required</strong>å­—æ®µæ²¡æœ‰è¢«è®¾ç½®ï¼Œè¯¥æ¬¡è°ƒç”¨ä¼šå¤±è´¥ã€‚</p>
<p><strong>done</strong></p>
<p>doneç”±æ¡†æ¶åˆ›å»ºï¼Œé€’ç»™æœåŠ¡å›è°ƒï¼ŒåŒ…å«äº†è°ƒç”¨æœåŠ¡å›è°ƒåçš„åç»­åŠ¨ä½œï¼ŒåŒ…æ‹¬æ£€æŸ¥responseæ­£ç¡®æ€§ï¼Œåºåˆ—åŒ–ï¼Œæ‰“åŒ…ï¼Œå‘é€ç­‰é€»è¾‘ã€‚</p>
<p><strong>ä¸ç®¡æˆåŠŸå¤±è´¥ï¼Œdone-&gt;Run()å¿…é¡»åœ¨è¯·æ±‚å¤„ç†å®Œæˆåè¢«ç”¨æˆ·è°ƒç”¨ä¸€æ¬¡ã€‚</strong></p>
<p>ä¸ºä»€ä¹ˆæ¡†æ¶ä¸è‡ªå·±è°ƒç”¨done-&gt;Run()ï¼Ÿè¿™æ˜¯ä¸ºäº†å…è®¸ç”¨æˆ·æŠŠdoneä¿å­˜ä¸‹æ¥ï¼Œåœ¨æœåŠ¡å›è°ƒä¹‹åçš„æŸäº‹ä»¶å‘ç”Ÿæ—¶å†è°ƒç”¨ï¼Œå³å®ç°<strong>å¼‚æ­¥Service</strong>ã€‚</p>
<p>å¼ºçƒˆå»ºè®®ä½¿ç”¨<strong>ClosureGuard</strong>ç¡®ä¿done-&gt;Run()è¢«è°ƒç”¨ï¼Œå³åœ¨æœåŠ¡å›è°ƒå¼€å¤´çš„é‚£å¥ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">krpc::ClosureGuard done_guard(done);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ä¸ç®¡åœ¨ä¸­é—´è¿˜æ˜¯æœ«å°¾è„±ç¦»æœåŠ¡å›è°ƒï¼Œéƒ½ä¼šä½¿done_guardææ„ï¼Œå…¶ä¸­ä¼šè°ƒç”¨done-&gt;Run()ã€‚è¿™ä¸ªæœºåˆ¶ç§°ä¸º<a href="https://en.wikipedia.org/wiki/Resource_Acquisition_Is_Initialization" target="_blank" rel="noopener noreferrer">RAII</a>ã€‚æ²¡æœ‰è¿™ä¸ªçš„è¯ä½ å¾—åœ¨æ¯æ¬¡returnå‰éƒ½åŠ ä¸Šdone-&gt;Run()ï¼Œ<strong>ææ˜“å¿˜è®°</strong>ã€‚</p>
<p>åœ¨å¼‚æ­¥Serviceä¸­ï¼Œé€€å‡ºæœåŠ¡å›è°ƒæ—¶è¯·æ±‚æœªå¤„ç†å®Œæˆï¼Œdone-&gt;Run()ä¸åº”è¢«è°ƒç”¨ï¼Œdoneåº”è¢«ä¿å­˜ä¸‹æ¥ä¾›ä»¥åè°ƒç”¨ï¼Œä¹çœ‹èµ·æ¥ï¼Œè¿™é‡Œå¹¶ä¸éœ€è¦ç”¨ClosureGuardã€‚ä½†åœ¨å®è·µä¸­ï¼Œå¼‚æ­¥Serviceç…§æ ·ä¼šå› å„ç§åŸå› è·³å‡ºå›è°ƒï¼Œå¦‚æœä¸ä½¿ç”¨ClosureGuardï¼Œä¸€äº›åˆ†æ”¯å¾ˆå¯èƒ½ä¼šåœ¨returnå‰å¿˜è®°done-&gt;Run()ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå»ºè®®åœ¨å¼‚æ­¥serviceä¸­ä½¿ç”¨done_guardï¼Œä¸åŒæ­¥Serviceä¸åŒçš„æ˜¯ï¼Œä¸ºäº†é¿å…æ­£å¸¸è„±ç¦»å‡½æ•°æ—¶done-&gt;Run()ä¹Ÿè¢«è°ƒç”¨ï¼Œä½ å¯ä»¥è°ƒç”¨done_guard.release()æ¥é‡Šæ”¾å…¶ä¸­çš„doneã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼ŒåŒæ­¥Serviceå’Œå¼‚æ­¥Serviceåˆ†åˆ«æŒ‰å¦‚ä¸‹ä»£ç å¤„ç†doneï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class MyFooService: public FooService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åŒæ­¥æœåŠ¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void SyncFoo(::google::protobuf::RpcController* cntl_base,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 const ::example::EchoRequest* request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ::example::EchoResponse* response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ::google::protobuf::Closure* done) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         krpc::ClosureGuard done_guard(done);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¼‚æ­¥æœåŠ¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void AsyncFoo(::google::protobuf::RpcController* cntl_base,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  const ::example::EchoRequest* request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ::example::EchoResponse* response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ::google::protobuf::Closure* done) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         krpc::ClosureGuard done_guard(done);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         done_guard.release();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ClosureGuardçš„æ¥å£å¦‚ä¸‹ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// RAII: Call Run() of the closure on destruction.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ClosureGuard {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClosureGuard();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Constructed with a closure which will be Run() inside dtor.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    explicit ClosureGuard(google::protobuf::Closure* done);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Call Run() of internal closure if it&#x27;s not NULL.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ~ClosureGuard();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Call Run() of internal closure if it&#x27;s not NULL and set it to `done&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void reset(google::protobuf::Closure* done);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Set internal closure to NULL and return the one before set.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    google::protobuf::Closure* release();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="æ ‡è®°å½“å‰è°ƒç”¨ä¸ºå¤±è´¥">æ ‡è®°å½“å‰è°ƒç”¨ä¸ºå¤±è´¥<a href="#æ ‡è®°å½“å‰è°ƒç”¨ä¸ºå¤±è´¥" class="hash-link" aria-label="Direct link to æ ‡è®°å½“å‰è°ƒç”¨ä¸ºå¤±è´¥" title="Direct link to æ ‡è®°å½“å‰è°ƒç”¨ä¸ºå¤±è´¥">â€‹</a></h3>
<p>è°ƒç”¨Controller.SetFailed()å¯ä»¥æŠŠå½“å‰è°ƒç”¨è®¾ç½®ä¸ºå¤±è´¥ï¼Œå½“å‘é€è¿‡ç¨‹å‡ºç°é”™è¯¯æ—¶ï¼Œæ¡†æ¶ä¹Ÿä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚ç”¨æˆ·ä¸€èˆ¬æ˜¯åœ¨æœåŠ¡çš„CallMethodé‡Œè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œæ¯”å¦‚æŸä¸ªå¤„ç†ç¯èŠ‚å‡ºé”™ï¼ŒSetFailed()åç¡®è®¤done-&gt;Run()è¢«è°ƒç”¨äº†å°±å¯ä»¥è·³å‡ºå‡½æ•°äº†(è‹¥ä½¿ç”¨äº†ClosureGuardï¼Œè·³å‡ºå‡½æ•°æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨doneï¼Œä¸ç”¨æ‰‹åŠ¨)ã€‚Serverç«¯çš„doneçš„é€»è¾‘ä¸»è¦æ˜¯å‘é€responseå›clientï¼Œå½“å…¶å‘ç°ç”¨æˆ·è°ƒç”¨äº†SetFailed()åï¼Œä¼šæŠŠé”™è¯¯ä¿¡æ¯é€å›clientã€‚clientæ”¶åˆ°åï¼Œå®ƒçš„Controller::Failed()ä¼šä¸ºtrueï¼ˆæˆåŠŸæ—¶ä¸ºfalseï¼‰ï¼ŒController::ErrorCode()å’ŒController::ErrorText()åˆ™åˆ†åˆ«æ˜¯é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯ã€‚</p>
<p>ç”¨æˆ·å¯ä»¥ä¸ºhttpè®¿é—®è®¾ç½®<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank" rel="noopener noreferrer">status-code</a>ï¼Œåœ¨serverç«¯ä¸€èˆ¬æ˜¯è°ƒç”¨<code>controller.http_response().set_status_code()</code>ï¼Œæ ‡å‡†çš„status-codeå®šä¹‰åœ¨<a href="https://github.com/apache/krpc/blob/master/src/krpc/http_status_code.h" target="_blank" rel="noopener noreferrer">http_status_code.h</a>ä¸­ã€‚Controller.SetFailedä¹Ÿä¼šè®¾ç½®status-codeï¼Œå€¼æ˜¯ä¸é”™è¯¯ç å«ä¹‰æœ€æ¥è¿‘çš„status-codeï¼Œæ²¡æœ‰ç›¸å…³çš„åˆ™å¡«500é”™è¯¯(krpc::HTTP_STATUS_INTERNAL_SERVER_ERROR)ã€‚å¦‚æœä½ è¦è¦†ç›–status_codeï¼Œè®¾ç½®ä»£ç ä¸€å®šè¦æ”¾åœ¨SetFailed()åï¼Œè€Œä¸æ˜¯ä¹‹å‰ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è·å–clientçš„åœ°å€">è·å–Clientçš„åœ°å€<a href="#è·å–clientçš„åœ°å€" class="hash-link" aria-label="Direct link to è·å–Clientçš„åœ°å€" title="Direct link to è·å–Clientçš„åœ°å€">â€‹</a></h3>
<p><code>controller-&gt;remote_side()</code>å¯è·å¾—å‘é€è¯¥è¯·æ±‚çš„clientåœ°å€å’Œç«¯å£ï¼Œç±»å‹æ˜¯kutil::EndPointã€‚å¦‚æœclientæ˜¯nginxï¼Œremote_side()æ˜¯nginxçš„åœ°å€ã€‚è¦è·å–çœŸå®clientçš„åœ°å€ï¼Œå¯ä»¥åœ¨nginxé‡Œè®¾ç½®<code>proxy_header ClientIp $remote_addr;</code>, åœ¨rpcä¸­é€šè¿‡<code>controller-&gt;http_request().GetHeader(&quot;ClientIp&quot;)</code>è·å¾—å¯¹åº”çš„å€¼ã€‚</p>
<p>æ‰“å°æ–¹å¼ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOG(INFO) &lt;&lt; &quot;remote_side=&quot; &lt;&lt; cntl-&gt;remote_side(); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;remote_side=%s\n&quot;, kutil::endpoint2str(cntl-&gt;remote_side()).c_str());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è·å–serverçš„åœ°å€">è·å–Serverçš„åœ°å€<a href="#è·å–serverçš„åœ°å€" class="hash-link" aria-label="Direct link to è·å–Serverçš„åœ°å€" title="Direct link to è·å–Serverçš„åœ°å€">â€‹</a></h3>
<p>controller-&gt;local_side()è·å¾—serverç«¯çš„åœ°å€ï¼Œç±»å‹æ˜¯kutil::EndPointã€‚</p>
<p>æ‰“å°æ–¹å¼ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOG(INFO) &lt;&lt; &quot;local_side=&quot; &lt;&lt; cntl-&gt;local_side(); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;local_side=%s\n&quot;, kutil::endpoint2str(cntl-&gt;local_side()).c_str());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å¼‚æ­¥service">å¼‚æ­¥Service<a href="#å¼‚æ­¥service" class="hash-link" aria-label="Direct link to å¼‚æ­¥Service" title="Direct link to å¼‚æ­¥Service">â€‹</a></h3>
<p>å³done-&gt;Run()åœ¨Serviceå›è°ƒä¹‹å¤–è¢«è°ƒç”¨ã€‚</p>
<p>æœ‰äº›serverä»¥ç­‰å¾…åç«¯æœåŠ¡è¿”å›ç»“æœä¸ºä¸»ï¼Œä¸”å¤„ç†æ—¶é—´ç‰¹åˆ«é•¿ï¼Œä¸ºäº†åŠæ—¶åœ°é‡Šæ”¾å‡ºçº¿ç¨‹èµ„æºï¼Œæ›´å¥½çš„åŠæ³•æ˜¯æŠŠdoneæ³¨å†Œåˆ°è¢«ç­‰å¾…äº‹ä»¶çš„å›è°ƒä¸­ï¼Œç­‰åˆ°äº‹ä»¶å‘ç”Ÿåå†è°ƒç”¨done-&gt;Run()ã€‚</p>
<p>å¼‚æ­¥serviceçš„æœ€åä¸€è¡Œä¸€èˆ¬æ˜¯done_guard.release()ä»¥  ç¡®ä¿æ­£å¸¸é€€å‡ºCallMethodæ—¶ä¸ä¼šè°ƒç”¨done-&gt;Run()ã€‚ä¾‹å­è¯·çœ‹<a href="https://github.com/apache/krpc/tree/master/example/session_data_and_thread_local/" target="_blank" rel="noopener noreferrer">example/session_data_and_thread_local</a>ã€‚</p>
<p>Serviceå’ŒChanneléƒ½å¯ä»¥ä½¿ç”¨doneæ¥è¡¨è¾¾åç»­çš„æ“ä½œï¼Œä½†å®ƒä»¬æ˜¯<strong>å®Œå…¨ä¸åŒ</strong>çš„ï¼Œè¯·å‹¿æ··æ·†ï¼š</p>
<ul>
<li>Serviceçš„doneç”±æ¡†æ¶åˆ›å»ºï¼Œç”¨æˆ·å¤„ç†è¯·æ±‚åè°ƒç”¨doneæŠŠresponseå‘å›ç»™clientã€‚</li>
<li>Channelçš„doneç”±ç”¨æˆ·åˆ›å»ºï¼Œå¾…RPCç»“æŸåè¢«æ¡†æ¶è°ƒç”¨ä»¥æ‰§è¡Œç”¨æˆ·çš„åç»­ä»£ç ã€‚</li>
</ul>
<p>åœ¨ä¸€ä¸ªä¼šè®¿é—®ä¸‹æ¸¸æœåŠ¡çš„å¼‚æ­¥æœåŠ¡ä¸­ä¼šåŒæ—¶æ¥è§¦ä¸¤è€…ï¼Œå®¹æ˜“ææ··ï¼Œè¯·æ³¨æ„åŒºåˆ†ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="åŠ å…¥service">åŠ å…¥Service<a href="#åŠ å…¥service" class="hash-link" aria-label="Direct link to åŠ å…¥Service" title="Direct link to åŠ å…¥Service">â€‹</a></h2>
<p>é»˜è®¤æ„é€ åçš„Serverä¸åŒ…å«ä»»ä½•æœåŠ¡ï¼Œä¹Ÿä¸ä¼šå¯¹å¤–æä¾›æœåŠ¡ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p>é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ’å…¥ä½ çš„Serviceå®ä¾‹ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int AddService(google::protobuf::Service* service, ServiceOwnership ownership);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>è‹¥ownershipå‚æ•°ä¸ºSERVER_OWNS_SERVICEï¼ŒServeråœ¨ææ„æ—¶ä¼šä¸€å¹¶åˆ é™¤Serviceï¼Œå¦åˆ™åº”è®¾ä¸ºSERVER_DOESNT_OWN_SERVICEã€‚</p>
<p>æ’å…¥MyEchoServiceä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Server server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyEchoService my_echo_service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (server.AddService(&amp;my_echo_service, krpc::SERVER_DOESNT_OWN_SERVICE) != 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG(FATAL) &lt;&lt; &quot;Fail to add my_echo_service&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Serverå¯åŠ¨åä½ æ— æ³• å†ä¿®æ”¹å…¶ä¸­çš„Serviceã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å¯åŠ¨">å¯åŠ¨<a href="#å¯åŠ¨" class="hash-link" aria-label="Direct link to å¯åŠ¨" title="Direct link to å¯åŠ¨">â€‹</a></h2>
<p>è°ƒç”¨ä»¥ä¸‹<a href="https://github.com/apache/krpc/blob/master/src/krpc/server.h" target="_blank" rel="noopener noreferrer">Server</a>çš„æ¥å£å¯åŠ¨æœåŠ¡ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int Start(const char* ip_and_port_str, const ServerOptions* opt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int Start(EndPoint ip_and_port, const ServerOptions* opt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int Start(int port, const ServerOptions* opt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int Start(const char *ip_str, PortRange port_range, const ServerOptions *opt);  // r32009åå¢åŠ </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>åˆæ³•çš„<code>ip_and_port_str</code>ï¼š</p>
<ul>
<li>127.0.0.1:80    # IPV4</li>
<li>[::1]:8080      # IPV6</li>
<li>unix<!-- -->:path<!-- -->.sock  # Unix domain socket</li>
</ul>
<p>å…³äºIPV6å’ŒUnix domain socketçš„ä½¿ç”¨ï¼Œè¯¦è§ <a href="/docs/cpp/krpc/endpoint">EndPoint</a>ã€‚</p>
<p><code>options</code>ä¸ºNULLæ—¶æ‰€æœ‰å‚æ•°å–é»˜è®¤å€¼ï¼Œå¦‚æœä½ è¦ä½¿ç”¨éé»˜è®¤å€¼ï¼Œè¿™ä¹ˆåšå°±è¡Œäº†ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">krpc::ServerOptions options;  // åŒ…å«äº†é»˜è®¤å€¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.xxx = yyy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.Start(..., &amp;options);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ç›‘å¬å¤šä¸ªç«¯å£">ç›‘å¬å¤šä¸ªç«¯å£<a href="#ç›‘å¬å¤šä¸ªç«¯å£" class="hash-link" aria-label="Direct link to ç›‘å¬å¤šä¸ªç«¯å£" title="Direct link to ç›‘å¬å¤šä¸ªç«¯å£">â€‹</a></h3>
<p>ä¸€ä¸ªserveråªèƒ½ç›‘å¬ä¸€ä¸ªç«¯å£ï¼ˆä¸è€ƒè™‘ServerOptions.internal_portï¼‰ï¼Œéœ€è¦ç›‘å¬N ä¸ªç«¯å£å°±èµ·Nä¸ªServerã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å¤šè¿›ç¨‹ç›‘å¬ä¸€ä¸ªç«¯å£">å¤šè¿›ç¨‹ç›‘å¬ä¸€ä¸ªç«¯å£<a href="#å¤šè¿›ç¨‹ç›‘å¬ä¸€ä¸ªç«¯å£" class="hash-link" aria-label="Direct link to å¤šè¿›ç¨‹ç›‘å¬ä¸€ä¸ªç«¯å£" title="Direct link to å¤šè¿›ç¨‹ç›‘å¬ä¸€ä¸ªç«¯å£">â€‹</a></h3>
<p>å¯åŠ¨æ—¶å¼€å¯<code>reuse_port</code>è¿™ä¸ªflagï¼Œå°±å¯ä»¥å¤šè¿›ç¨‹å…±åŒç›‘å¬ä¸€ä¸ªç«¯å£ï¼ˆåº•å±‚æ˜¯SO_REUSEPORTï¼‰ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="åœæ­¢">åœæ­¢<a href="#åœæ­¢" class="hash-link" aria-label="Direct link to åœæ­¢" title="Direct link to åœæ­¢">â€‹</a></h2>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">server.Stop(closewait_ms); // closewait_mså®é™…æ— æ•ˆï¼Œå‡ºäºå†å²åŸå› æœªåˆ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.Join();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Stop()ä¸ä¼šé˜»å¡ï¼ŒJoin()ä¼šã€‚åˆ†æˆä¸¤ä¸ªå‡½æ•°çš„åŸå› åœ¨äºå½“å¤šä¸ªServeréœ€è¦é€€å‡ºæ—¶ï¼Œå¯ä»¥å…ˆå…¨éƒ¨Stopå†ä¸€èµ·Joinï¼Œå¦‚æœä¸€ä¸ªä¸ªStop/Joinï¼Œå¯èƒ½å¾—èŠ±è´¹Serverä¸ªæ•°å€çš„ç­‰å¾…  æ—¶é—´ã€‚</p>
<p>ä¸ç®¡closewait_msæ˜¯ä»€ä¹ˆå€¼ï¼Œserveråœ¨é€€å‡ºæ—¶ä¼šç­‰å¾…æ‰€æœ‰æ­£åœ¨è¢«å¤„ç†çš„è¯·æ±‚å®Œæˆï¼ŒåŒæ—¶å¯¹æ–°è¯·æ±‚ç«‹åˆ»å›å¤ELOGOFFé”™è¯¯ä»¥é˜²æ­¢æ–°è¯·æ±‚åŠ å…¥ã€‚è¿™ä¹ˆåšçš„åŸå› åœ¨äºåªè¦serveré€€å‡ºæ—¶ä»æœ‰å¤„ç†çº¿ç¨‹è¿è¡Œï¼Œå°±æœ‰è®¿é—®åˆ°å·²é‡Šæ”¾å†…å­˜çš„é£é™©ã€‚å¦‚æœä½ çš„serverâ€œé€€ä¸æ‰â€ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯ç”±äºæŸä¸ªæ£€ç´¢çº¿ç¨‹æ²¡ç»“æŸæˆ–å¿˜è®°è°ƒç”¨doneäº†ã€‚</p>
<p>å½“clientçœ‹åˆ°ELOGOFFæ—¶ï¼Œä¼šè·³è¿‡å¯¹åº”çš„serverï¼Œå¹¶åœ¨å…¶ä»–serverä¸Šé‡è¯•å¯¹åº”çš„è¯·æ±‚ã€‚æ‰€ä»¥åœ¨ä¸€èˆ¬æƒ…å†µä¸‹krpcæ€»æ˜¯â€œä¼˜é›…é€€å‡ºâ€çš„ï¼Œé‡å¯æˆ–ä¸Šçº¿æ—¶å‡ ä¹ä¸ä¼šæˆ–åªä¼šä¸¢å¤±å¾ˆå°‘é‡çš„æµé‡ã€‚</p>
<p>RunUntilAskedToQuit()å‡½æ•°å¯ä»¥åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ç®€åŒ–serverçš„è¿è½¬å’Œåœæ­¢ä»£ç ã€‚åœ¨server.Startåï¼Œåªéœ€å¦‚ä¸‹ä»£ç å³ä¼šè®©serverè¿è¡Œç›´åˆ°æŒ‰åˆ°Ctrl-Cã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Wait until Ctrl-C is pressed, then Stop() and Join() the server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.RunUntilAskedToQuit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// serverå·²ç»åœæ­¢äº†ï¼Œè¿™é‡Œå¯ä»¥å†™é‡Šæ”¾èµ„æºçš„ä»£ç ã€‚</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Join()å®Œæˆåå¯ä»¥ä¿®æ”¹å…¶ä¸­çš„Serviceï¼Œå¹¶é‡æ–°Startã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è¢«httph2è®¿é—®">è¢«http/h2è®¿é—®<a href="#è¢«httph2è®¿é—®" class="hash-link" aria-label="Direct link to è¢«http/h2è®¿é—®" title="Direct link to è¢«http/h2è®¿é—®">â€‹</a></h2>
<p>ä½¿ç”¨Protobufçš„æœåŠ¡é€šå¸¸å¯ä»¥é€šè¿‡http/h2+jsonè®¿é—®ï¼Œå­˜äºbodyçš„jsonä¸²å¯ä¸å¯¹åº”protobufæ¶ˆæ¯ç›¸äº’è‡ªåŠ¨è½¬åŒ–ã€‚</p>
<p>ä»¥<a href="https://github.com/apache/krpc/blob/master/example/echo_c%2B%2B/server.cpp" target="_blank" rel="noopener noreferrer">echo server</a>ä¸ºä¾‹ï¼Œä½ å¯ä»¥ç”¨<a href="https://curl.haxx.se/" target="_blank" rel="noopener noreferrer">curl</a>è®¿é—®è¿™ä¸ªæœåŠ¡ã€‚</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic"># -H &#x27;Content-Type: application/json&#x27; is optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#8250DF">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-d</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&#x27;{&quot;message&quot;:&quot;hello&quot;}&#x27;</span><span class="token plain"> http://krpc.baidu.com:8765/EchoService/Echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#C6105F">&quot;message&quot;</span><span class="token builtin class-name" style="color:#116329">:</span><span class="token string" style="color:#C6105F">&quot;hello&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>æ³¨æ„ï¼šä¹Ÿå¯ä»¥æŒ‡å®š<code>Content-Type: application/proto</code>ç”¨http/h2+protobufäºŒè¿›åˆ¶ä¸²è®¿é—®æœåŠ¡ï¼Œåºåˆ—åŒ–æ€§èƒ½æ›´å¥½ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="jsonpb">json<code>&lt;=&gt;</code>pb<a href="#jsonpb" class="hash-link" aria-label="Direct link to jsonpb" title="Direct link to jsonpb">â€‹</a></h3>
<p>jsonå­—æ®µé€šè¿‡åŒ¹é…çš„åå­—å’Œç»“æ„ä¸pbå­—æ®µä¸€ä¸€å¯¹åº”ã€‚jsonä¸­ä¸€å®šè¦åŒ…å«pbçš„requiredå­—æ®µï¼Œå¦åˆ™è½¬åŒ–ä¼šå¤±è´¥ï¼Œå¯¹åº”è¯·æ±‚ä¼šè¢«æ‹’ç»ã€‚jsonä¸­å¯ä»¥åŒ…å«pbä¸­æ²¡æœ‰å®šä¹‰çš„å­—æ®µï¼Œä½†å®ƒä»¬ä¼šè¢«ä¸¢å¼ƒè€Œä¸ä¼šå­˜å…¥pbçš„unknownå­—æ®µã€‚è½¬åŒ–è§„åˆ™è¯¦è§<a href="/docs/cpp/krpc/json2pb"><code>json &lt;=&gt; protobuf</code></a>ã€‚</p>
<p>å¼€å¯é€‰é¡¹-pb_enum_as_numberåï¼Œpbä¸­çš„enumä¼šè½¬åŒ–ä¸ºå®ƒçš„æ•°å€¼è€Œä¸æ˜¯åå­—ï¼Œæ¯”å¦‚åœ¨<code>enum MyEnum { Foo = 1; Bar = 2; };</code>ä¸­ä¸å¼€å¯æ­¤é€‰é¡¹æ—¶MyEnumç±»å‹çš„å­—æ®µä¼šè½¬åŒ–ä¸º&quot;Foo&quot;æˆ–&quot;Bar&quot;ï¼Œå¼€å¯åä¸º1æˆ–2ã€‚æ­¤é€‰é¡¹åŒæ—¶å½±å“clientå‘å‡ºçš„è¯·æ±‚å’Œserverè¿”å›çš„å›å¤ã€‚ç”±äºè½¬åŒ–ä¸ºåå­—ç›¸æ¯”æ•°å€¼æœ‰æ›´å¥½çš„å‰åå…¼å®¹æ€§ï¼Œæ­¤é€‰é¡¹åªåº”ç”¨äºå…¼å®¹æ— æ³•å¤„ç†enumä¸ºåå­—çš„è€ä»£ç ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å…¼å®¹æ—©æœŸç‰ˆæœ¬client">å…¼å®¹æ—©æœŸç‰ˆæœ¬client<a href="#å…¼å®¹æ—©æœŸç‰ˆæœ¬client" class="hash-link" aria-label="Direct link to å…¼å®¹æ—©æœŸç‰ˆæœ¬client" title="Direct link to å…¼å®¹æ—©æœŸç‰ˆæœ¬client">â€‹</a></h3>
<p>æ—©æœŸçš„krpcå…è®¸ä¸€ä¸ªpb serviceè¢«httpåè®®è®¿é—®æ—¶ä¸å¡«å……pbè¯·æ±‚ï¼Œå³ä½¿é‡Œé¢æœ‰requiredå­—æ®µã€‚ä¸€èˆ¬æ¥è¯´è¿™ç§serviceä¼šè‡ªè¡Œè§£æhttpè¯·æ±‚å’Œè®¾ç½®httpå›å¤ï¼Œå¹¶ä¸ä¼šè®¿é—®pbè¯·æ±‚ã€‚ä½†è¿™ä¹Ÿæ˜¯éå¸¸å±é™©çš„è¡Œä¸ºï¼Œæ¯•ç«Ÿè¿™æ˜¯pb serviceï¼Œä½†pbè¯·æ±‚å´æ˜¯æœªå®šä¹‰çš„ã€‚</p>
<p>è¿™ç§æœåŠ¡åœ¨å‡çº§åˆ°æ–°ç‰ˆæœ¬rpcæ—¶ä¼šé‡åˆ°éšœç¢ï¼Œå› ä¸ºkrpcå·²ä¸å…è®¸è¿™ç§è¡Œä¸ºã€‚ä¸ºäº†å¸®åŠ©è¿™ç§æœåŠ¡å‡çº§ï¼Œkrpcå…è®¸ç»è¿‡ä¸€äº›è®¾ç½®åä¸æŠŠhttp bodyè‡ªåŠ¨è½¬åŒ–ä¸ºpb request(ä»è€Œå¯è‡ªè¡Œå¤„ç†ï¼‰ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">krpc::ServiceOptions svc_opt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">svc_opt.ownership = ...;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">svc_opt.restful_mappings = ...;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">svc_opt.allow_http_body_to_pb = false; //å…³é—­http/h2 bodyè‡³pb requestçš„è‡ªåŠ¨è½¬åŒ–</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.AddService(service, svc_opt);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>å¦‚æ­¤è®¾ç½®åserviceæ”¶åˆ°http/h2è¯·æ±‚åä¸ä¼šå°è¯•æŠŠbodyè½¬åŒ–ä¸ºpbè¯·æ±‚ï¼Œæ‰€ä»¥pbè¯·æ±‚æ€»æ˜¯æœªå®šä¹‰çŠ¶æ€ï¼Œç”¨æˆ·å¾—åœ¨<code>cntl-&gt;request_protocol() == krpc::PROTOCOL_HTTP || cntl-&gt;request_protocol() == krpc::PROTOCOL_H2</code>æˆç«‹æ—¶è‡ªè¡Œè§£æbodyã€‚</p>
<p>ç›¸åº”åœ°ï¼Œå½“cntl-&gt;response_attachment()ä¸ä¸ºç©ºä¸”pbå›å¤ä¸ä¸ºç©ºæ—¶ï¼Œæ¡†æ¶ä¸å†æŠ¥é”™ï¼Œè€Œæ˜¯ç›´æ¥æŠŠcntl-&gt;response_attachment()ä½œä¸ºå›å¤çš„bodyã€‚è¿™ä¸ªåŠŸèƒ½å’Œè®¾ç½®allow_http_body_to_pbä¸å¦æ— å…³ã€‚å¦‚æœæ”¾å¼€è‡ªç”±åº¦å¯¼è‡´è¿‡å¤šçš„ç”¨æˆ·çŠ¯é”™ï¼Œå¯èƒ½ä¼šæœ‰è¿›ä¸€æ­¥çš„è°ƒæ•´ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="åè®®æ”¯æŒ">åè®®æ”¯æŒ<a href="#åè®®æ”¯æŒ" class="hash-link" aria-label="Direct link to åè®®æ”¯æŒ" title="Direct link to åè®®æ”¯æŒ">â€‹</a></h2>
<p>serverç«¯ä¼šè‡ªåŠ¨å°è¯•å…¶æ”¯æŒçš„åè®®ï¼Œæ— éœ€ç”¨æˆ·æŒ‡å®šã€‚<code>cntl-&gt;protocol()</code>å¯è·å¾—å½“å‰åè®®ã€‚serverèƒ½ä»ä¸€ä¸ªlistenç«¯å£å»ºç«‹ä¸åŒåè®®çš„è¿æ¥ï¼Œä¸éœ€è¦ä¸ºä¸åŒçš„åè®®ä½¿ç”¨ä¸åŒçš„listenç«¯å£ï¼Œä¸€ä¸ªè¿æ¥ä¸Šä¹Ÿå¯ä»¥ä¼ è¾“å¤šç§åè®®çš„æ•°æ®åŒ…, ä½†ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆåš(ä¹Ÿä¸å»ºè®®)ï¼Œæ”¯æŒçš„åè®®æœ‰ï¼š</p>
<ul>
<li>
<p><a href="/docs/cpp/krpc/kumo_std">kumoæ ‡å‡†åè®®</a>ï¼Œæ˜¾ç¤ºä¸º&quot;baidu_std&quot;ï¼Œé»˜è®¤å¯ç”¨ã€‚</p>
</li>
<li>
<p><a href="/docs/cpp/krpc/streaming_rpc">æµå¼RPCåè®®</a>ï¼Œæ˜¾ç¤ºä¸º&quot;streaming_rpc&quot;, é»˜è®¤å¯ç”¨ã€‚</p>
</li>
<li>
<p>http/1.0å’Œhttp/1.1åè®®ï¼Œæ˜¾ç¤ºä¸ºâ€httpâ€œï¼Œé»˜è®¤å¯ç”¨ã€‚</p>
</li>
<li>
<p>http/2å’ŒgRPCåè®®ï¼Œæ˜¾ç¤ºä¸º&quot;h2c&quot;(æœªåŠ å¯†)æˆ–&quot;h2&quot;(åŠ å¯†)ï¼Œé»˜è®¤å¯ç”¨ã€‚</p>
</li>
<li>
<p>RTMPåè®®ï¼Œæ˜¾ç¤ºä¸º&quot;rtmp&quot;, é»˜è®¤å¯ç”¨ã€‚</p>
</li>
<li>
<p>hulu-pbrpcçš„åè®®ï¼Œæ˜¾ç¤ºä¸º&quot;hulu_pbrpc&quot;ï¼Œé»˜è®¤å¯åŠ¨ã€‚</p>
</li>
<li>
<p>sofa-pbrpcçš„åè®®ï¼Œæ˜¾ç¤ºä¸ºâ€sofa_pbrpcâ€œ, é»˜è®¤å¯ç”¨ã€‚</p>
</li>
<li>
<p>ç™¾ç›Ÿçš„åè®®ï¼Œæ˜¾ç¤ºä¸ºâ€nova_pbrpcâ€œ, é»˜è®¤ä¸å¯ç”¨ï¼Œå¼€å¯æ–¹å¼ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;krpc/policy/nova_pbrpc_protocol.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServerOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.nshead_service = new krpc::policy::NovaServiceAdaptor;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>public_pbrpcåè®®ï¼Œæ˜¾ç¤ºä¸º&quot;public_pbrpc&quot;ï¼Œé»˜è®¤ä¸å¯ç”¨ï¼Œå¼€å¯æ–¹å¼ ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;krpc/policy/public_pbrpc_protocol.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServerOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.nshead_service = new krpc::policy::PublicPkrpcServiceAdaptor;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>nshead+mcpackåè®®ï¼Œæ˜¾ç¤ºä¸º&quot;nshead_mcpack&quot;ï¼Œé»˜è®¤ä¸å¯ç”¨ï¼Œå¼€å¯æ–¹å¼ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;krpc/policy/nshead_mcpack_protocol.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServerOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.nshead_service = new krpc::policy::NsheadMcpackAdaptor;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªåè®®çš„æ•°æ®åŒ…ç”±nshead+mcpackæ„æˆï¼Œmcpackä¸­ä¸åŒ…å«ç‰¹æ®Šå­—æ®µã€‚ä¸åŒäºç”¨æˆ·åŸºäºNsheadServiceçš„å®ç°ï¼Œè¿™ä¸ªåè®®ä½¿ç”¨äº†mcpack2pbï¼Œä½¿å¾—ä¸€ä»½ä»£ç å¯ä»¥åŒæ—¶å¤„ç†mcpackå’Œpbä¸¤ç§æ ¼å¼ã€‚ç”±äºæ²¡æœ‰ä¼ é€’ErrorTextçš„å­—æ®µï¼Œå½“å‘ç”Ÿé”™è¯¯æ—¶serveråªèƒ½å…³é—­è¿æ¥ã€‚</p>
</li>
</ul>
<p>å¦‚æœä½ æœ‰æ›´å¤šçš„åè®®éœ€æ±‚ï¼Œå¯ä»¥è”ç³»æˆ‘ä»¬ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="fork-without-exec">fork without exec<a href="#fork-without-exec" class="hash-link" aria-label="Direct link to fork without exec" title="Direct link to fork without exec">â€‹</a></h2>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œ<a href="https://linux.die.net/man/3/fork" target="_blank" rel="noopener noreferrer">fork</a>å‡ºçš„å­è¿›ç¨‹åº”å°½å¿«è°ƒç”¨<a href="https://linux.die.net/man/3/exec" target="_blank" rel="noopener noreferrer">exec</a>ä»¥é‡ç½®æ‰€æœ‰çŠ¶æ€ï¼Œä¸­é—´åªåº”è°ƒç”¨æ»¡è¶³async-signal-safeçš„å‡½æ•°ã€‚è¿™ä¹ˆä½¿ç”¨forkçš„krpcç¨‹åºåœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¹Ÿä¸ä¼šæœ‰é—®é¢˜ã€‚</p>
<p>ä½†åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œç”¨æˆ·æƒ³ç›´æ¥è¿è¡Œforkå‡ºçš„å­è¿›ç¨‹ï¼Œè€Œä¸è°ƒç”¨execã€‚ç”±äºforkåªå¤åˆ¶å…¶è°ƒç”¨è€…çš„çº¿ç¨‹ï¼Œå…¶ä½™çº¿ç¨‹ä¾¿éšä¹‹æ¶ˆå¤±äº†ã€‚å¯¹åº”åˆ°krpcä¸­ï¼Œkvarä¼šä¾èµ–ä¸€ä¸ªsampling_threadé‡‡æ ·å„ç§ä¿¡æ¯ï¼Œåœ¨forkåä¾¿æ¶ˆå¤±äº†ï¼Œç°è±¡æ˜¯å¾ˆå¤škvarå½’é›¶ã€‚</p>
<p>æœ€æ–°ç‰ˆæœ¬çš„krpcä¼šåœ¨forkåé‡å»ºè¿™ä¸ªçº¿ç¨‹(å¦‚æœ‰å¿…è¦)ï¼Œä»è€Œä½¿kvaråœ¨forkåèƒ½æ­£å¸¸å·¥ä½œï¼Œå†æ¬¡forkä¹Ÿå¯ä»¥ã€‚å·²çŸ¥é—®é¢˜æ˜¯forkåcpu profilerä¸æ­£å¸¸ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸æ„å‘³ç€ç”¨æˆ·å¯éšæ„åœ°forkï¼Œä¸ç®¡æ˜¯krpcè¿˜æ˜¯ä¸Šå±‚åº”ç”¨éƒ½ä¼šå¤§é‡åœ°åˆ›å»ºçº¿ç¨‹ï¼Œå®ƒä»¬åœ¨forkåä¸ä¼šè¢«é‡å»ºï¼Œå› ä¸ºï¼š</p>
<ul>
<li>å¤§éƒ¨åˆ†forkä¼šç´§æ¥execï¼Œæµªè´¹äº†é‡å»º</li>
<li>ç»™ä»£ç ç¼–å†™å¸¦æ¥å¾ˆå¤šçš„éº»çƒ¦å’Œå¤æ‚åº¦</li>
</ul>
<p>krpcçš„ç­–ç•¥æ˜¯æŒ‰éœ€åˆ›å»ºè¿™ç±»çº¿ç¨‹ï¼ŒåŒæ—¶fork without execå¿…é¡»å‘ç”Ÿåœ¨æ‰€æœ‰å¯èƒ½åˆ›å»ºè¿™äº›çº¿ç¨‹çš„ä»£ç å‰ã€‚å…·ä½“åœ°è¯´ï¼Œè‡³å°‘<strong>å‘ç”Ÿåœ¨åˆå§‹åŒ–æ‰€æœ‰Server/Channel/åº”ç”¨ä»£ç å‰</strong>ï¼Œè¶Šæ—©è¶Šå¥½ï¼Œä¸éµå®ˆè¿™ä¸ªçº¦å®šçš„forkä¼šå¯¼è‡´ç¨‹åºä¸æ­£å¸¸ã€‚å¦å¤–ï¼Œä¸æ”¯æŒfork without execçš„libç›¸å½“æ™®éï¼Œæœ€å¥½é¿å…è¿™ç§ç”¨æ³•ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è®¾ç½®">è®¾ç½®<a href="#è®¾ç½®" class="hash-link" aria-label="Direct link to è®¾ç½®" title="Direct link to è®¾ç½®">â€‹</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ç‰ˆæœ¬">ç‰ˆæœ¬<a href="#ç‰ˆæœ¬" class="hash-link" aria-label="Direct link to ç‰ˆæœ¬" title="Direct link to ç‰ˆæœ¬">â€‹</a></h3>
<p>Server.set_version(...)å¯ä»¥ä¸ºserverè®¾ç½®ä¸€ä¸ªåç§°+ç‰ˆæœ¬ï¼Œå¯é€šè¿‡/versionå†…ç½®æœåŠ¡è®¿é—®åˆ°ã€‚è™½ç„¶å«åš&quot;versionâ€œï¼Œä½†è®¾ç½®çš„å€¼è¯·åŒ…å«æœåŠ¡åï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ•°å­—ç‰ˆæœ¬ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å…³é—­é—²ç½®è¿æ¥">å…³é—­é—²ç½®è¿æ¥<a href="#å…³é—­é—²ç½®è¿æ¥" class="hash-link" aria-label="Direct link to å…³é—­é—²ç½®è¿æ¥" title="Direct link to å…³é—­é—²ç½®è¿æ¥">â€‹</a></h3>
<p>å¦‚æœä¸€ä¸ªè¿æ¥åœ¨ServerOptions.idle_timeout_secå¯¹åº”çš„æ—¶é—´å†…æ²¡æœ‰è¯»å–æˆ–å†™å‡ºæ•°æ®ï¼Œåˆ™è¢«è§†ä¸ºâ€é—²ç½®â€è€Œè¢«serverä¸»åŠ¨å…³é—­ã€‚é»˜è®¤å€¼ä¸º-1ï¼Œä»£è¡¨ä¸å¼€å¯ã€‚</p>
<p>æ‰“å¼€<a href="http://krpc.baidu.com:8765/flags/log_idle_connection_close" target="_blank" rel="noopener noreferrer">-log_idle_connection_close</a>åå…³é—­å‰ä¼šæ‰“å°ä¸€æ¡æ—¥å¿—ã€‚</p>
<table><thead><tr><th>Name</th><th>Value</th><th>Description</th><th>Defined At</th></tr></thead><tbody><tr><td>log_idle_connection_close</td><td>false</td><td>Print log when an idle connection is closed</td><td>src/krpc/socket.cpp</td></tr></tbody></table>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="pid_file">pid_file<a href="#pid_file" class="hash-link" aria-label="Direct link to pid_file" title="Direct link to pid_file">â€‹</a></h3>
<p>å¦‚æœè®¾ç½®äº†æ­¤å­—æ®µï¼ŒServerå¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªåŒåæ–‡ä»¶ï¼Œå†…å®¹ä¸ºè¿›ç¨‹å·ã€‚é»˜è®¤ä¸ºç©ºã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="åœ¨æ¯æ¡æ—¥å¿—åæ‰“å°hostname">åœ¨æ¯æ¡æ—¥å¿—åæ‰“å°hostname<a href="#åœ¨æ¯æ¡æ—¥å¿—åæ‰“å°hostname" class="hash-link" aria-label="Direct link to åœ¨æ¯æ¡æ—¥å¿—åæ‰“å°hostname" title="Direct link to åœ¨æ¯æ¡æ—¥å¿—åæ‰“å°hostname">â€‹</a></h3>
<p>æ­¤åŠŸèƒ½åªå¯¹<a href="https://github.com/apache/krpc/blob/master/src/kutil/logging.h" target="_blank" rel="noopener noreferrer">kutil/logging.h</a>ä¸­çš„æ—¥å¿—å®æœ‰æ•ˆã€‚</p>
<p>æ‰“å¼€<a href="http://krpc.baidu.com:8765/flags/log_hostname" target="_blank" rel="noopener noreferrer">-log_hostname</a>åæ¯æ¡æ—¥å¿—åéƒ½ä¼šå¸¦æœ¬æœºåç§°ï¼Œå¦‚æœæ‰€æœ‰çš„æ—¥å¿—éœ€è¦æ±‡æ€»åˆ°ä¸€èµ·è¿›è¡Œåˆ†æï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥å¸®åŠ©ä½ äº†è§£æŸæ¡æ—¥å¿—æ¥è‡ªå“ªå°æœºå™¨ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="æ‰“å°fatalæ—¥å¿—åé€€å‡ºç¨‹åº">æ‰“å°FATALæ—¥å¿—åé€€å‡ºç¨‹åº<a href="#æ‰“å°fatalæ—¥å¿—åé€€å‡ºç¨‹åº" class="hash-link" aria-label="Direct link to æ‰“å°FATALæ—¥å¿—åé€€å‡ºç¨‹åº" title="Direct link to æ‰“å°FATALæ—¥å¿—åé€€å‡ºç¨‹åº">â€‹</a></h3>
<p>æ­¤åŠŸèƒ½åªå¯¹<a href="https://github.com/apache/krpc/blob/master/src/kutil/logging.h" target="_blank" rel="noopener noreferrer">kutil/logging.h</a>ä¸­çš„æ—¥å¿—å®æœ‰æ•ˆï¼Œglogé»˜è®¤åœ¨FATALæ—¥å¿—æ—¶crashã€‚</p>
<p>æ‰“å¼€<a href="http://krpc.baidu.com:8765/flags/crash_on_fatal_log" target="_blank" rel="noopener noreferrer">-crash_on_fatal_log</a>åå¦‚æœç¨‹åºä½¿ç”¨LOG(FATAL)æ‰“å°äº†å¼‚å¸¸æ—¥å¿—æˆ–è¿åäº†CHECKå®ä¸­çš„æ–­è¨€ï¼Œé‚£ä¹ˆç¨‹åºä¼šåœ¨æ‰“å°æ—¥å¿—åabortï¼Œè¿™ä¸€èˆ¬ä¹Ÿä¼šäº§ç”Ÿcoredumpæ–‡ä»¶ï¼Œé»˜è®¤ä¸æ‰“å¼€ã€‚è¿™ä¸ªå¼€å…³å¯åœ¨å¯¹ç¨‹åºçš„å‹åŠ›æµ‹è¯•ä¸­æ‰“å¼€ï¼Œä»¥ç¡®è®¤ç¨‹åºæ²¡æœ‰è¿›å…¥è¿‡ä¸¥é‡é”™è¯¯çš„åˆ†æ”¯ã€‚</p>
<blockquote>
<p>ä¸€èˆ¬çš„æƒ¯ä¾‹æ˜¯ï¼ŒERRORè¡¨ç¤ºå¯å®¹å¿çš„é”™è¯¯ï¼ŒFATALä»£è¡¨ä¸å¯é€†è½¬çš„é”™è¯¯ã€‚</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="æœ€ä½æ—¥å¿—çº§åˆ«">æœ€ä½æ—¥å¿—çº§åˆ«<a href="#æœ€ä½æ—¥å¿—çº§åˆ«" class="hash-link" aria-label="Direct link to æœ€ä½æ—¥å¿—çº§åˆ«" title="Direct link to æœ€ä½æ—¥å¿—çº§åˆ«">â€‹</a></h3>
<p>æ­¤åŠŸèƒ½ç”±<a href="https://github.com/apache/krpc/blob/master/src/kutil/logging.h" target="_blank" rel="noopener noreferrer">kutil/logging.h</a>å’Œglogå„è‡ªå®ç°ï¼Œä¸ºåŒåé€‰é¡¹ã€‚</p>
<p>åªæœ‰<strong>ä¸ä½äº</strong>-minloglevelæŒ‡å®šçš„æ—¥å¿—çº§åˆ«çš„æ—¥å¿—æ‰ä¼šè¢«æ‰“å°ã€‚è¿™ä¸ªé€‰é¡¹å¯ä»¥åŠ¨æ€ä¿®æ”¹ã€‚è®¾ç½®å€¼å’Œæ—¥å¿—çº§åˆ«çš„å¯¹åº”å…³ç³»ï¼š0=INFO 1=NOTICE 2=WARNING 3=ERROR 4=FATALï¼Œé»˜è®¤ä¸º0ã€‚</p>
<p>æœªæ‰“å°æ—¥å¿—çš„å¼€é”€åªæ˜¯ä¸€æ¬¡ifåˆ¤æ–­ï¼Œä¹Ÿä¸ä¼šè¯„ä¼°å‚æ•°(æ¯”å¦‚æŸä¸ªå‚æ•°è°ƒç”¨äº†å‡½æ•°ï¼Œæ—¥å¿—ä¸æ‰“ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¸ä¼šè¢«è°ƒç”¨ï¼‰ã€‚å¦‚æœæ—¥å¿—æœ€ç»ˆæ‰“å°åˆ°è‡ªå®šä¹‰LogSinkï¼Œé‚£ä¹ˆè¿˜è¦ç»è¿‡LogSinkçš„è¿‡æ»¤ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å½’è¿˜ç©ºé—²å†…å­˜è‡³ç³»ç»Ÿ">å½’è¿˜ç©ºé—²å†…å­˜è‡³ç³»ç»Ÿ<a href="#å½’è¿˜ç©ºé—²å†…å­˜è‡³ç³»ç»Ÿ" class="hash-link" aria-label="Direct link to å½’è¿˜ç©ºé—²å†…å­˜è‡³ç³»ç»Ÿ" title="Direct link to å½’è¿˜ç©ºé—²å†…å­˜è‡³ç³»ç»Ÿ">â€‹</a></h3>
<p>é€‰é¡¹-free_memory_to_system_intervalè¡¨ç¤ºæ¯è¿‡è¿™ä¹ˆå¤šç§’å°±å°è¯•å‘ç³»ç»Ÿå½’è¿˜ç©ºé—²å†…å­˜ï¼Œ<code>&lt;=</code> 0è¡¨ç¤ºä¸å¼€å¯ï¼Œé»˜è®¤å€¼ä¸º0ï¼Œè‹¥å¼€å¯å»ºè®®è®¾ä¸º10åŠä»¥ä¸Šçš„å€¼ã€‚æ­¤åŠŸèƒ½æ”¯æŒtcmallocï¼Œä¹‹å‰ç¨‹åºä¸­å¯¹<code>MallocExtension::instance()-&gt;ReleaseFreeMemory()</code>çš„å®šæœŸè°ƒç”¨å¯æ”¹æˆè®¾ç½®æ­¤é€‰é¡¹ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="æ‰“å°å‘é€ç»™clientçš„é”™è¯¯">æ‰“å°å‘é€ç»™clientçš„é”™è¯¯<a href="#æ‰“å°å‘é€ç»™clientçš„é”™è¯¯" class="hash-link" aria-label="Direct link to æ‰“å°å‘é€ç»™clientçš„é”™è¯¯" title="Direct link to æ‰“å°å‘é€ç»™clientçš„é”™è¯¯">â€‹</a></h3>
<p>serverçš„æ¡†æ¶éƒ¨åˆ†ä¸€èˆ¬ä¸é’ˆå¯¹ä¸ªåˆ«clientæ‰“å°é”™è¯¯æ—¥å¿—ï¼Œå› ä¸ºå½“å¤§é‡clientå‡ºç°é”™è¯¯æ—¶ï¼Œå¯èƒ½å¯¼è‡´serveré«˜é¢‘æ‰“å°æ—¥å¿—è€Œä¸¥é‡å½±å“æ€§èƒ½ã€‚ä½†æœ‰æ—¶ä¸ºäº†è°ƒè¯•é—®é¢˜ï¼Œæˆ–å°±æ˜¯éœ€è¦è®©serveræ‰“å°é”™è¯¯ï¼Œæ‰“å¼€å‚æ•°<a href="http://krpc.baidu.com:8765/flags/log_error_text" target="_blank" rel="noopener noreferrer">-log_error_text</a>å³å¯ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å®šåˆ¶å»¶æ—¶çš„åˆ†ä½å€¼">å®šåˆ¶å»¶æ—¶çš„åˆ†ä½å€¼<a href="#å®šåˆ¶å»¶æ—¶çš„åˆ†ä½å€¼" class="hash-link" aria-label="Direct link to å®šåˆ¶å»¶æ—¶çš„åˆ†ä½å€¼" title="Direct link to å®šåˆ¶å»¶æ—¶çš„åˆ†ä½å€¼">â€‹</a></h3>
<p>æ˜¾ç¤ºçš„æœåŠ¡å»¶æ—¶åˆ†ä½å€¼<strong>é»˜è®¤</strong>ä¸º<strong>80</strong> (æ›¾ç»ä¸º50), 90, 99, 99.9, 99.99ï¼Œå‰ä¸‰é¡¹å¯åˆ†åˆ«é€šè¿‡-kvar_latency_p1, -kvar_latency_p2, -kvar_latency_p3ä¸‰ä¸ªgflagså®šåˆ¶ã€‚</p>
<p>ä»¥ä¸‹æ˜¯æ­£ç¡®çš„è®¾ç½®ï¼š</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token parameter variable" style="color:#E36209">-kvar_latency_p3</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">97</span><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># p3ä»é»˜è®¤99ä¿®æ”¹ä¸º97</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#E36209">-kvar_latency_p1</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">60</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-kvar_latency_p2</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">80</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-kvar_latency_p3</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">95</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ä»¥ä¸‹æ˜¯é”™è¯¯çš„è®¾ç½®ï¼š</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token parameter variable" style="color:#E36209">-kvar_latency_p3</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">100</span><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># è®¾ç½®å€¼å¿…é¡»åœ¨[1,99]é—­åŒºé—´å†…ï¼Œgflagsè§£æä¼šå¤±è´¥</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#E36209">-kvar_latency_p1</span><span class="token operator" style="color:#D73A49">=</span><span class="token plain">-1    </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># åŒä¸Š</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è®¾ç½®æ ˆå¤§å°">è®¾ç½®æ ˆå¤§å°<a href="#è®¾ç½®æ ˆå¤§å°" class="hash-link" aria-label="Direct link to è®¾ç½®æ ˆå¤§å°" title="Direct link to è®¾ç½®æ ˆå¤§å°">â€‹</a></h3>
<p>krpcçš„Serveræ˜¯è¿è¡Œåœ¨kthreadä¹‹ä¸Šï¼Œé»˜è®¤æ ˆå¤§å°ä¸º1MBï¼Œè€Œpthreadé»˜è®¤æ ˆå¤§å°ä¸º10MBï¼Œæ‰€ä»¥åœ¨pthreadä¸Šæ­£å¸¸è¿è¡Œçš„ç¨‹åºï¼Œåœ¨kthreadä¸Šå¯èƒ½é‡åˆ°æ ˆä¸è¶³ã€‚</p>
<p>å¯è®¾ç½®å¦‚ä¸‹çš„gflagä»¥è°ƒæ•´æ ˆçš„å¤§å°:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token parameter variable" style="color:#E36209">--stack_size_normal</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">10000000</span><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># è¡¨ç¤ºè°ƒæ•´æ ˆå¤§å°ä¸º10Må·¦å³</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#E36209">--tc_stack_normal</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">1</span><span class="token plain">             </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># é»˜è®¤ä¸º8ï¼Œè¡¨ç¤ºæ¯ä¸ªworkerç¼“å­˜çš„æ ˆçš„ä¸ªæ•°(ä»¥åŠ å¿«åˆ†é…é€Ÿåº¦)ï¼Œsizeè¶Šå¤§ï¼Œç¼“å­˜æ•°ç›®å¯ä»¥é€‚å½“è°ƒå°(ä»¥å‡å°‘å†…å­˜å ç”¨)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>æ³¨æ„ï¼šä¸æ˜¯è¯´ç¨‹åºcoredumpå°±æ„å‘³ç€â€æ ˆä¸å¤Ÿå¤§â€œï¼Œåªæ˜¯å› ä¸ºè¿™ä¸ªè¯•èµ·æ¥æœ€å®¹æ˜“ï¼Œæ‰€ä»¥ä¼˜å…ˆæ’é™¤æ‰å¯èƒ½æ€§ã€‚äº‹å®ä¸Šç™¾åº¦å†…å¦‚æ­¤å¤šçš„åº”ç”¨ä¹Ÿå¾ˆå°‘ç¢°åˆ°æ ˆä¸å¤Ÿå¤§çš„æƒ…å†µã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é™åˆ¶æœ€å¤§æ¶ˆæ¯">é™åˆ¶æœ€å¤§æ¶ˆæ¯<a href="#é™åˆ¶æœ€å¤§æ¶ˆæ¯" class="hash-link" aria-label="Direct link to é™åˆ¶æœ€å¤§æ¶ˆæ¯" title="Direct link to é™åˆ¶æœ€å¤§æ¶ˆæ¯">â€‹</a></h3>
<p>ä¸ºäº†ä¿æŠ¤serverå’Œclientï¼Œå½“serveræ”¶åˆ°çš„requestæˆ–clientæ”¶åˆ°çš„responseè¿‡å¤§æ—¶ï¼Œserveræˆ–clientä¼šæ‹’æ”¶å¹¶å…³é—­è¿æ¥ã€‚æ­¤æœ€å¤§å°ºå¯¸ç”±<a href="http://krpc.baidu.com:8765/flags/max_body_size" target="_blank" rel="noopener noreferrer">-max_body_size</a>æ§åˆ¶ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚</p>
<p>è¶…è¿‡æœ€å¤§æ¶ˆæ¯æ—¶ä¼šæ‰“å°å¦‚ä¸‹é”™è¯¯æ—¥å¿—ï¼š</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FATAL: 05-10 14:40:05: * 0 src/krpc/input_messenger.cpp:89] A message from 127.0.0.1:35217(protocol=baidu_std) is bigger than 67108864 bytes, the connection will be closed. Set max_body_size to allow bigger messages</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>protobufä¸­æœ‰<a href="https://github.com/google/protobuf/blob/master/src/google/protobuf/io/coded_stream.h#L364" target="_blank" rel="noopener noreferrer">ç±»ä¼¼çš„é™åˆ¶</a>ï¼Œå‡ºé”™æ—¶ä¼šæ‰“å°å¦‚ä¸‹æ—¥å¿—ï¼š</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FATAL: 05-10 13:35:02: * 0 google/protobuf/io/coded_stream.cc:156] A protocol message was rejected because it was too big (more than 67108864 bytes). To increase the limit (or to disable these warnings), see CodedInputStream::SetTotalBytesLimit() in google/protobuf/io/coded_stream.h.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>krpcç§»é™¤äº†protobufä¸­çš„é™åˆ¶ï¼Œå…¨äº¤ç”±æ­¤é€‰é¡¹æ§åˆ¶ï¼Œåªè¦-max_body_sizeè¶³å¤Ÿå¤§ï¼Œç”¨æˆ·å°±ä¸ä¼šçœ‹åˆ°é”™è¯¯æ—¥å¿—ã€‚æ­¤åŠŸèƒ½å¯¹protobufçš„ç‰ˆæœ¬æ²¡æœ‰è¦æ±‚ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å‹ç¼©">å‹ç¼©<a href="#å‹ç¼©" class="hash-link" aria-label="Direct link to å‹ç¼©" title="Direct link to å‹ç¼©">â€‹</a></h3>
<p>set_response_compress_type()è®¾ç½®responseçš„å‹ç¼©æ–¹å¼ï¼Œé»˜è®¤ä¸å‹ç¼©ã€‚</p>
<p>æ³¨æ„é™„ä»¶ä¸ä¼šè¢«å‹ç¼©ã€‚HTTP bodyçš„å‹ç¼©æ–¹æ³•è§<a href="/docs/cpp/krpc/http_service#%E5%8E%8B%E7%BC%A9response-body">è¿™é‡Œ</a>ã€‚</p>
<p>æ”¯æŒçš„å‹ç¼©æ–¹æ³•æœ‰ï¼š</p>
<ul>
<li>krpc::CompressTypeSnappy : <a href="http://google.github.io/snappy/" target="_blank" rel="noopener noreferrer">snanpyå‹ç¼©</a>ï¼Œå‹ç¼©å’Œè§£å‹æ˜¾è‘—å¿«äºå…¶ä»–å‹ç¼©æ–¹æ³•ï¼Œä½†å‹ç¼©ç‡æœ€ä½ã€‚</li>
<li>krpc::CompressTypeGzip : <a href="http://en.wikipedia.org/wiki/Gzip" target="_blank" rel="noopener noreferrer">gzipå‹ç¼©</a>ï¼Œæ˜¾è‘—æ…¢äºsnappyï¼Œä½†å‹ç¼©ç‡é«˜</li>
<li>krpc::CompressTypeZlib : <a href="http://en.wikipedia.org/wiki/Zlib" target="_blank" rel="noopener noreferrer">zlibå‹ç¼©</a>ï¼Œæ¯”gzipå¿«10%~20%ï¼Œå‹ç¼©ç‡ç•¥å¥½äºgzipï¼Œä½†é€Ÿåº¦ä»æ˜æ˜¾æ…¢äºsnappyã€‚</li>
</ul>
<p>æ›´å…·ä½“çš„æ€§èƒ½å¯¹æ¯”è§<a href="/docs/cpp/krpc/client#%E5%8E%8B%E7%BC%A9">Client-å‹ç¼©</a>.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é™„ä»¶">é™„ä»¶<a href="#é™„ä»¶" class="hash-link" aria-label="Direct link to é™„ä»¶" title="Direct link to é™„ä»¶">â€‹</a></h3>
<p>baidu_stdå’Œhulu_pbrpcåè®®æ”¯æŒä¼ é€’é™„ä»¶ï¼Œè¿™æ®µæ•°æ®ç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼Œä¸ç»è¿‡protobufçš„åºåˆ—åŒ–ã€‚ç«™åœ¨serverçš„è§’åº¦ï¼Œè®¾ç½®åœ¨Controller.response_attachment()çš„é™„ä»¶ä¼šè¢«clientç«¯æ”¶åˆ°ï¼ŒController.request_attachment()åˆ™åŒ…å«äº†clientç«¯é€æ¥çš„é™„ä»¶ã€‚</p>
<p>é™„ä»¶ä¸ä¼šè¢«æ¡†æ¶å‹ç¼©ã€‚</p>
<p>åœ¨httpåè®®ä¸­ï¼Œé™„ä»¶å¯¹åº”<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html" target="_blank" rel="noopener noreferrer">message body</a>ï¼Œæ¯”å¦‚è¦è¿”å›çš„æ•°æ®å°±è®¾ç½®åœ¨response_attachment()ä¸­ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å¼€å¯ssl">å¼€å¯SSL<a href="#å¼€å¯ssl" class="hash-link" aria-label="Direct link to å¼€å¯SSL" title="Direct link to å¼€å¯SSL">â€‹</a></h3>
<p>è¦å¼€å¯SSLï¼Œé¦–å…ˆç¡®ä¿ä»£ç ä¾èµ–äº†æœ€æ–°çš„opensslåº“ã€‚å¦‚æœopensslç‰ˆæœ¬å¾ˆæ—§ï¼Œä¼šæœ‰ä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”¯æŒçš„åŠ å¯†ç®—æ³•ä¹Ÿå°‘ï¼Œè¿èƒŒäº†å¼€å¯SSLçš„åˆè¡·ã€‚ç„¶åè®¾ç½®<code>ServerOptions.ssl_options</code>ï¼Œå…·ä½“è§<a href="https://github.com/apache/krpc/blob/master/src/krpc/ssl_options.h" target="_blank" rel="noopener noreferrer">ssl_options.h</a>ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Certificate structure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct CertInfo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Certificate in PEM format.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Note that CN and alt subjects will be extracted from the certificate,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // and will be used as hostnames. Requests to this hostname (provided SNI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // extension supported) will be encrypted using this certifcate.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Supported both file path and raw string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::string certificate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Private key in PEM format.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Supported both file path and raw string based on prefix:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::string private_key;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Additional hostnames besides those inside the certificate. Wildcards</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // are supported but it can only appear once at the beginning (i.e. *.xxx.com).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::vector&lt;std::string&gt; sni_filters;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// SSL options at server side</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct ServerSSLOptions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Default certificate which will be loaded into server. Requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // without hostname or whose hostname doesn&#x27;t have a corresponding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // certificate will use this certificate. MUST be set to enable SSL.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CertInfo default_cert;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Additional certificates which will be loaded into server. These</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // provide extra bindings between hostnames and certificates so that</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // we can choose different certificates according to different hostnames.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // See `CertInfo&#x27; for detail.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::vector&lt;CertInfo&gt; certs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // When set, requests without hostname or whose hostname can&#x27;t be found in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // any of the cerficates above will be dropped. Otherwise, `default_cert&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // will be used.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Default: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool strict_sni;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... Other options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p>Serverç«¯å¼€å¯SSL<strong>å¿…é¡»</strong>è¦è®¾ç½®ä¸€å¼ é»˜è®¤è¯ä¹¦<code>default_cert</code>ï¼ˆé»˜è®¤SSLè¿æ¥éƒ½ç”¨æ­¤è¯ä¹¦ï¼‰ï¼Œå¦‚æœå¸Œæœ›serverèƒ½æ”¯æŒåŠ¨æ€é€‰æ‹©è¯ä¹¦ï¼ˆå¦‚æ ¹æ®è¯·æ±‚ä¸­åŸŸåï¼Œè§<a href="https://en.wikipedia.org/wiki/Server_Name_Indication" target="_blank" rel="noopener noreferrer">SNI</a>æœºåˆ¶ï¼‰ï¼Œåˆ™å¯ä»¥å°†è¿™äº›è¯ä¹¦åŠ è½½åˆ°<code>certs</code>ã€‚æœ€åç”¨æˆ·è¿˜å¯ä»¥åœ¨Serverè¿è¡Œæ—¶ï¼ŒåŠ¨æ€å¢å‡è¿™äº›åŠ¨æ€è¯ä¹¦ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int AddCertificate(const CertInfo&amp; cert);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int RemoveCertificate(const CertInfo&amp; cert);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int ResetCertificates(const std::vector&lt;CertInfo&gt;&amp; certs);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>å…¶ä½™é€‰é¡¹è¿˜åŒ…æ‹¬ï¼šå¯†é’¥å¥—ä»¶é€‰æ‹©ï¼ˆæ¨èå¯†é’¥ECDHE-RSA-AES256-GCM-SHA384ï¼Œchromeé»˜è®¤ç¬¬ä¸€ä¼˜å…ˆå¯†é’¥ï¼Œå®‰å…¨æ€§å¾ˆé«˜ï¼Œä½†æ¯”è¾ƒè€—æ€§èƒ½ï¼‰ã€sessionå¤ç”¨ç­‰ã€‚</p>
</li>
<li>
<p>å¦‚æœæƒ³æ”¯æŒåº”ç”¨å±‚åè®®åå•†ï¼Œå¯é€šè¿‡<code>alpns</code>é€‰é¡¹è®¾ç½®Serverç«¯æ”¯æŒçš„åè®®å­—ç¬¦ä¸²ï¼Œåœ¨Serverå¯åŠ¨æ—¶ä¼šæ ¡éªŒåè®®çš„æœ‰æ•ˆæ€§ï¼Œå¤šä¸ªåè®®é—´ä½¿ç”¨é€—å·åˆ†å‰²ã€‚å…·ä½“ ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ServerSSLOptions ssl_options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssl_options.alpns = &quot;http, h2, baidu_std&quot;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>SSLå±‚åœ¨åè®®å±‚ä¹‹ä¸‹ï¼ˆä½œç”¨åœ¨Socketå±‚ï¼‰ï¼Œå³å¼€å¯åï¼Œæ‰€æœ‰åè®®ï¼ˆå¦‚HTTPï¼‰éƒ½æ”¯æŒç”¨SSLåŠ å¯†åä¼ è¾“åˆ°Serverï¼ŒServerç«¯ä¼šå…ˆè¿›è¡ŒSSLè§£å¯†åï¼Œå†æŠŠåŸå§‹æ•°æ®é€åˆ°å„ä¸ªåè®®ä¸­å»ã€‚</p>
</li>
<li>
<p>SSLå¼€å¯åï¼Œç«¯å£ä»ç„¶æ”¯æŒéSSLçš„è¿æ¥è®¿é—®ï¼ŒServerä¼šè‡ªåŠ¨åˆ¤æ–­å“ªäº›æ˜¯SSLï¼Œå“ªäº›ä¸æ˜¯ã€‚å¦‚æœè¦å±è”½éSSLè®¿é—®ï¼Œç”¨æˆ·å¯é€šè¿‡<code>Controller::is_ssl()</code>åˆ¤æ–­æ˜¯å¦æ˜¯SSLï¼ŒåŒæ—¶åœ¨<a href="/docs/cpp/krpc/connections">connections</a>å†…ç½®ç›‘æ§ä¸Šä¹Ÿå¯ä»¥çœ‹åˆ°è¿æ¥çš„SSLä¿¡æ¯ã€‚</p>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="éªŒè¯clientèº«ä»½">éªŒè¯clientèº«ä»½<a href="#éªŒè¯clientèº«ä»½" class="hash-link" aria-label="Direct link to éªŒè¯clientèº«ä»½" title="Direct link to éªŒè¯clientèº«ä»½">â€‹</a></h3>
<p> å¦‚æœserverç«¯è¦å¼€å¯éªŒè¯åŠŸèƒ½ï¼Œéœ€è¦å®ç°<code>Authenticator</code>ä¸­çš„æ¥å£:</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class Authenticator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Implement this method to verify credential information `auth_str&#x27; from</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // `client_addr&#x27;. You can fill credential context (result) into `*out_ctx&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // and later fetch this pointer from `Controller&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Returns 0 on success, error code otherwise</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual int VerifyCredential(const std::string&amp; auth_str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 const base::EndPoint&amp; client_addr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 AuthContext* out_ctx) const = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class AuthContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const std::string&amp; user() const;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const std::string&amp; group() const;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const std::string&amp; roles() const;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const std::string&amp; starter() const;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool is_service() const;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>serverçš„éªŒè¯æ˜¯åŸºäºè¿æ¥çš„ã€‚å½“serveræ”¶åˆ°è¿æ¥ä¸Šçš„ç¬¬ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œä¼šå°è¯•è§£æå‡ºå…¶ä¸­çš„èº«ä»½ä¿¡æ¯éƒ¨åˆ†ï¼ˆå¦‚baidu_stdé‡Œçš„authå­—æ®µã€HTTPåè®®é‡Œçš„Authorizationå¤´ï¼‰ï¼Œç„¶åé™„å¸¦clientåœ°å€ä¿¡æ¯ä¸€èµ·è°ƒç”¨<code>VerifyCredential</code>ã€‚è‹¥è¿”å›0ï¼Œè¡¨ç¤ºéªŒè¯æˆåŠŸï¼Œç”¨æˆ·å¯ä»¥æŠŠéªŒè¯åçš„ä¿¡æ¯å¡«å…¥<code>AuthContext</code>ï¼Œåç»­å¯é€šè¿‡<code>controller-&gt;auth_context()</code>è·å–ï¼Œç”¨æˆ·ä¸éœ€è¦å…³å¿ƒå…¶åˆ†é…å’Œé‡Šæ”¾ã€‚å¦åˆ™è¡¨ç¤ºéªŒè¯å¤±è´¥ï¼Œè¿æ¥ä¼šè¢«ç›´æ¥å…³é—­ï¼Œclientè®¿é—®å¤±è´¥ã€‚</p>
<p>åç»­è¯·æ±‚é»˜è®¤é€šè¿‡éªŒè¯ä¹ˆï¼Œæ²¡æœ‰è®¤è¯å¼€é”€ã€‚</p>
<p>æŠŠå®ç°çš„<code>Authenticator</code>å®ä¾‹èµ‹å€¼åˆ°<code>ServerOptions.auth</code>ï¼Œå³å¼€å¯éªŒè¯åŠŸèƒ½ï¼Œéœ€è¦ä¿è¯è¯¥å®ä¾‹åœ¨æ•´ä¸ªserverè¿è¡Œå‘¨æœŸå†…éƒ½æœ‰æ•ˆï¼Œä¸èƒ½è¢«ææ„ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="workerçº¿ç¨‹æ•°">workerçº¿ç¨‹æ•°<a href="#workerçº¿ç¨‹æ•°" class="hash-link" aria-label="Direct link to workerçº¿ç¨‹æ•°" title="Direct link to workerçº¿ç¨‹æ•°">â€‹</a></h3>
<p>è®¾ç½®ServerOptions.num_threadså³å¯ï¼Œé»˜è®¤æ˜¯cpu coreçš„ä¸ªæ•°ï¼ˆåŒ…å«è¶…çº¿ç¨‹çš„ï¼‰ã€‚</p>
<p>æ³¨æ„: ServerOptions.num_threadsä»…ä»…æ˜¯ä¸ª<strong>æç¤º</strong>ã€‚</p>
<p>ä½ ä¸èƒ½è®¤ä¸ºServerå°±ç”¨äº†è¿™ä¹ˆå¤šçº¿ç¨‹ï¼Œå› ä¸ºè¿›ç¨‹å†…çš„æ‰€æœ‰Serverå’ŒChannelä¼šå…±äº«çº¿ç¨‹èµ„æºï¼Œçº¿ç¨‹æ€»æ•°æ˜¯æ‰€æœ‰ServerOptions.num_threadså’Œ-kthread_concurrencyä¸­çš„æœ€å¤§å€¼ã€‚æ¯”å¦‚ä¸€ä¸ªç¨‹åºå†…æœ‰ä¸¤ä¸ªServerï¼Œnum_threadsåˆ†åˆ«ä¸º24å’Œ36ï¼Œkthread_concurrencyä¸º16ã€‚é‚£ä¹ˆworkerçº¿ç¨‹æ•°ä¸ºmax(24, 36, 16) = 36ã€‚è¿™ä¸åŒäºå…¶ä»–RPCå®ç°ä¸­å¾€å¾€æ˜¯åŠ èµ·æ¥ã€‚</p>
<p>Channelæ²¡æœ‰ç›¸åº”çš„é€‰é¡¹ï¼Œä½†å¯ä»¥é€šè¿‡é€‰é¡¹-kthread_concurrencyè°ƒæ•´ã€‚</p>
<p>å¦å¤–ï¼Œkrpc<strong>ä¸åŒºåˆ†IOçº¿ç¨‹å’Œå¤„ç†çº¿ç¨‹</strong>ã€‚krpcçŸ¥é“å¦‚ä½•ç¼–æ’IOå’Œå¤„ç†ä»£ç ï¼Œä»¥è·å¾—æ›´é«˜çš„å¹¶å‘åº¦å’Œçº¿ç¨‹åˆ©ç”¨ç‡ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é™åˆ¶æœ€å¤§å¹¶å‘">é™åˆ¶æœ€å¤§å¹¶å‘<a href="#é™åˆ¶æœ€å¤§å¹¶å‘" class="hash-link" aria-label="Direct link to é™åˆ¶æœ€å¤§å¹¶å‘" title="Direct link to é™åˆ¶æœ€å¤§å¹¶å‘">â€‹</a></h3>
<p>â€œå¹¶å‘â€å¯èƒ½æœ‰ä¸¤ç§å«ä¹‰ï¼Œä¸€ç§æ˜¯è¿æ¥æ•°ï¼Œä¸€ç§æ˜¯åŒæ—¶åœ¨å¤„ç†çš„è¯·æ±‚æ•°ã€‚è¿™é‡Œæåˆ°çš„æ˜¯åè€…ã€‚</p>
<p>åœ¨ä¼ ç»Ÿçš„åŒæ­¥serverä¸­ï¼Œæœ€å¤§å¹¶å‘ä¸ä¼šè¶…è¿‡å·¥ä½œçº¿ç¨‹æ•°ï¼Œè®¾å®šå·¥ä½œçº¿ç¨‹æ•°é‡ä¸€èˆ¬ä¹Ÿé™åˆ¶äº†å¹¶å‘ã€‚ä½†krpcçš„è¯·æ±‚è¿è¡Œäºkthreadä¸­ï¼ŒMä¸ªkthreadä¼šæ˜ å°„è‡³Nä¸ªworkerä¸­ï¼ˆä¸€èˆ¬Må¤§äºNï¼‰ï¼Œæ‰€ä»¥åŒæ­¥serverçš„å¹¶å‘åº¦å¯èƒ½è¶…è¿‡workeræ•°é‡ã€‚å¦ä¸€æ–¹é¢ï¼Œè™½ç„¶å¼‚æ­¥serverçš„å¹¶å‘ä¸å—çº¿ç¨‹æ•°æ§  åˆ¶ï¼Œä½†æœ‰æ—¶ä¹Ÿéœ€è¦æ ¹æ®å…¶ä»–å› ç´ æ§åˆ¶å¹¶å‘é‡ã€‚</p>
<p>krpcæ”¯æŒè®¾ç½®serverçº§å’Œmethodçº§çš„æœ€å¤§å¹¶å‘ï¼Œå½“serveræˆ–methodåŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°è¶…è¿‡å¹¶å‘åº¦é™åˆ¶æ—¶ï¼Œå®ƒä¼šç«‹åˆ»ç»™clientå›å¤<strong>krpc::ELIMIT</strong>é”™è¯¯ï¼Œè€Œä¸ä¼šè°ƒç”¨æœåŠ¡å›è°ƒã€‚çœ‹åˆ°ELIMITé”™è¯¯çš„clientåº”é‡è¯•å¦ä¸€ä¸ªserverã€‚è¿™ä¸ªé€‰é¡¹å¯ä»¥é˜²æ­¢serverå‡ºç°è¿‡åº¦æ’é˜Ÿï¼Œæˆ–ç”¨äºé™åˆ¶serverå ç”¨çš„èµ„æºã€‚</p>
<p>é»˜è®¤ä¸å¼€å¯ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ä¸ºä»€ä¹ˆè¶…è¿‡æœ€å¤§å¹¶å‘è¦ç«‹åˆ»ç»™clientè¿”å›é”™è¯¯è€Œä¸æ˜¯æ’é˜Ÿ">ä¸ºä»€ä¹ˆè¶…è¿‡æœ€å¤§å¹¶å‘è¦ç«‹åˆ»ç»™clientè¿”å›é”™è¯¯è€Œä¸æ˜¯æ’é˜Ÿï¼Ÿ<a href="#ä¸ºä»€ä¹ˆè¶…è¿‡æœ€å¤§å¹¶å‘è¦ç«‹åˆ»ç»™clientè¿”å›é”™è¯¯è€Œä¸æ˜¯æ’é˜Ÿ" class="hash-link" aria-label="Direct link to ä¸ºä»€ä¹ˆè¶…è¿‡æœ€å¤§å¹¶å‘è¦ç«‹åˆ»ç»™clientè¿”å›é”™è¯¯è€Œä¸æ˜¯æ’é˜Ÿï¼Ÿ" title="Direct link to ä¸ºä»€ä¹ˆè¶…è¿‡æœ€å¤§å¹¶å‘è¦ç«‹åˆ»ç»™clientè¿”å›é”™è¯¯è€Œä¸æ˜¯æ’é˜Ÿï¼Ÿ">â€‹</a></h4>
<p>å½“å‰serverè¾¾åˆ°æœ€å¤§å¹¶å‘å¹¶ä¸æ„å‘³ç€é›†ç¾¤ä¸­çš„å…¶ä»–serverä¹Ÿè¾¾åˆ°æœ€å¤§å¹¶å‘äº†ï¼Œç«‹åˆ»è®©clientè·çŸ¥é”™è¯¯ï¼Œå¹¶å»å°è¯•å¦ä¸€å°serveråœ¨å…¨å±€è§’åº¦æ˜¯æ›´å¥½çš„ç­–ç•¥ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ä¸ºä»€ä¹ˆä¸é™åˆ¶qps">ä¸ºä»€ä¹ˆä¸é™åˆ¶QPS?<a href="#ä¸ºä»€ä¹ˆä¸é™åˆ¶qps" class="hash-link" aria-label="Direct link to ä¸ºä»€ä¹ˆä¸é™åˆ¶QPS?" title="Direct link to ä¸ºä»€ä¹ˆä¸é™åˆ¶QPS?">â€‹</a></h4>
<p>QPSæ˜¯ä¸€ä¸ªç§’çº§çš„æŒ‡æ ‡ï¼Œæ— æ³•å¾ˆå¥½åœ°æ§åˆ¶ç¬é—´çš„æµé‡çˆ†å‘ã€‚è€Œæœ€å¤§å¹¶å‘å’Œå½“å‰å¯ç”¨çš„é‡è¦èµ„æºç´§å¯†ç›¸å…³ï¼š&quot;å·¥ä½œçº¿ç¨‹&quot;ï¼Œâ€œæ§½ä½â€ç­‰ï¼Œèƒ½æ›´å¥½åœ°æŠ‘åˆ¶æ’é˜Ÿã€‚</p>
<p>å¦å¤–å½“serverçš„å»¶æ—¶è¾ƒä¸ºç¨³å®šæ—¶ï¼Œé™åˆ¶å¹¶å‘çš„æ•ˆæœå’Œé™åˆ¶QPSæ˜¯ç­‰ä»·çš„ã€‚ä½†å‰è€…å®ç°èµ·æ¥å®¹æ˜“å¤šäº†ï¼šåªéœ€åŠ å‡ä¸€ä¸ªä»£è¡¨å¹¶å‘åº¦çš„è®¡æ•°å™¨ã€‚è¿™ä¹Ÿæ˜¯å¤§éƒ¨åˆ†æµæ§éƒ½é™åˆ¶å¹¶å‘è€Œä¸æ˜¯QPSçš„åŸå› ï¼Œæ¯”å¦‚TCPä¸­çš„â€œçª—å£&quot;å³æ˜¯ä¸€ç§å¹¶å‘åº¦ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è®¡ç®—æœ€å¤§å¹¶å‘æ•°">è®¡ç®—  æœ€å¤§å¹¶å‘æ•°<a href="#è®¡ç®—æœ€å¤§å¹¶å‘æ•°" class="hash-link" aria-label="Direct link to è®¡ç®—æœ€å¤§å¹¶å‘æ•°" title="Direct link to è®¡ç®—æœ€å¤§å¹¶å‘æ•°">â€‹</a></h4>
<p>æœ€å¤§å¹¶å‘åº¦ = æé™QPS * ä½è´Ÿè½½å»¶æ—¶  (<a href="https://en.wikipedia.org/wiki/Little%27s_law" target="_blank" rel="noopener noreferrer">little&#x27;s law</a>)</p>
<p>æé™QPSæŒ‡çš„æ˜¯serverèƒ½è¾¾åˆ°çš„æœ€å¤§qpsï¼Œä½è´Ÿè½½å»¶æ—¶æŒ‡çš„æ˜¯serveråœ¨æ²¡æœ‰ä¸¥é‡ç§¯å‹è¯·æ±‚çš„å‰æä¸‹æ—¶çš„å¹³å‡å»¶æ—¶ã€‚ä¸€èˆ¬çš„æœåŠ¡ä¸Šçº¿éƒ½ä¼šæœ‰æ€§èƒ½å‹æµ‹ï¼ŒæŠŠæµ‹å¾—çš„QPSå’Œå»¶æ—¶ç›¸ä¹˜ä¸€èˆ¬å°±æ˜¯è¯¥æœåŠ¡çš„æœ€å¤§å¹¶å‘åº¦ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é™åˆ¶serverçº§åˆ«å¹¶å‘åº¦">é™åˆ¶serverçº§åˆ«å¹¶å‘åº¦<a href="#é™åˆ¶serverçº§åˆ«å¹¶å‘åº¦" class="hash-link" aria-label="Direct link to é™åˆ¶serverçº§åˆ«å¹¶å‘åº¦" title="Direct link to é™åˆ¶serverçº§åˆ«å¹¶å‘åº¦">â€‹</a></h3>
<p>è®¾ç½®ServerOptions.max_concurrencyï¼Œé»˜è®¤å€¼0ä»£è¡¨ä¸é™åˆ¶ã€‚è®¿é—®å†…ç½®æœåŠ¡ä¸å—æ­¤é€‰é¡¹é™åˆ¶ã€‚</p>
<p>Server.ResetMaxConcurrency()å¯åœ¨serverå¯åŠ¨ååŠ¨æ€ä¿®æ”¹serverçº§åˆ«çš„max_concurrencyã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é™åˆ¶methodçº§åˆ«å¹¶å‘åº¦">é™åˆ¶methodçº§åˆ«å¹¶å‘åº¦<a href="#é™åˆ¶methodçº§åˆ«å¹¶å‘åº¦" class="hash-link" aria-label="Direct link to é™åˆ¶methodçº§åˆ«å¹¶å‘åº¦" title="Direct link to é™åˆ¶methodçº§åˆ«å¹¶å‘åº¦">â€‹</a></h4>
<p><code>server.MaxConcurrencyOf(&quot;...&quot;) = ...</code>å¯è®¾ç½®methodçº§åˆ«çš„max_concurrencyã€‚ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®<code>ServerOptions.method_max_concurrency</code>ä¸€æ¬¡æ€§ä¸ºæ‰€æœ‰çš„methodè®¾ç½®æœ€å¤§å¹¶å‘ã€‚
å½“<code>ServerOptions.method_max_concurrencyå’Œserver.MaxConcurrencyOf(&quot;...&quot;)=...</code>åŒæ—¶è¢«è®¾ç½®æ—¶ï¼Œä½¿ç”¨server.MaxConcurrencyOf()æ‰€è®¾ç½®çš„å€¼ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ServerOptions.method_max_concurrency = 20;                   // Set the default maximum concurrency for all methods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.MaxConcurrencyOf(&quot;example.EchoService.Echo&quot;) = 10;    // Give priority to the value set by server.MaxConcurrencyOf()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.MaxConcurrencyOf(&quot;example.EchoService&quot;, &quot;Echo&quot;) = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.MaxConcurrencyOf(&amp;service, &quot;Echo&quot;) = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.MaxConcurrencyOf(&quot;example.EchoService.Echo&quot;) = &quot;10&quot;;  // You can also assign a string value</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>æ­¤è®¾ç½®ä¸€èˆ¬<strong>å‘ç”Ÿåœ¨AddServiceåï¼Œserverå¯åŠ¨å‰</strong>ã€‚å½“è®¾ç½®å¤±è´¥æ—¶ï¼ˆæ¯”å¦‚å¯¹åº”çš„methodä¸å­˜åœ¨ï¼‰ï¼Œserverä¼šå¯åŠ¨å¤±è´¥åŒæ—¶æç¤ºç”¨æˆ·ä¿®æ­£MaxConcurrencyOfè®¾ç½®é”™è¯¯ã€‚</p>
<p>å½“methodçº§åˆ«å’Œserverçº§åˆ«çš„max_concurrencyéƒ½è¢«è®¾ç½®æ—¶ï¼Œå…ˆæ£€æŸ¥serverçº§åˆ«çš„ï¼Œå†æ£€æŸ¥methodçº§åˆ«çš„ã€‚</p>
<p>æ³¨æ„ï¼šæ²¡æœ‰serviceçº§åˆ«çš„max_concurrencyã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ä½¿ç”¨è‡ªé€‚åº”é™æµç®—æ³•">ä½¿ç”¨è‡ªé€‚åº”é™æµç®—æ³•<a href="#ä½¿ç”¨è‡ªé€‚åº”é™æµç®—æ³•" class="hash-link" aria-label="Direct link to ä½¿ç”¨è‡ªé€‚åº”é™æµç®—æ³•" title="Direct link to ä½¿ç”¨è‡ªé€‚åº”é™æµç®—æ³•">â€‹</a></h4>
<p>å®é™…ç”Ÿäº§ç¯å¢ƒä¸­,æœ€å¤§å¹¶å‘æœªå¿…ä¸€æˆä¸å˜ï¼Œåœ¨æ¯æ¬¡ä¸Šçº¿å‰é€ä¸ªå‹æµ‹å’Œè®¾ç½®æœåŠ¡çš„æœ€å¤§å¹¶å‘ä¹Ÿå¾ˆç¹çã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨è‡ªé€‚åº”é™æµç®—æ³•ã€‚</p>
<p>è‡ªé€‚åº”é™æµæ˜¯methodçº§åˆ«çš„ã€‚è¦ä½¿ç”¨è‡ªé€‚åº”é™æµç®—æ³•ï¼ŒæŠŠmethodçš„æœ€å¤§å¹¶å‘åº¦è®¾ç½®ä¸º&quot;auto&quot;å³å¯:</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Set auto concurrency limiter for all methods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::ServerOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.method_max_concurrency = &quot;auto&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Set auto concurrency limiter for specific method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.MaxConcurrencyOf(&quot;example.EchoService.Echo&quot;) = &quot;auto&quot;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>å…³äºè‡ªé€‚åº”é™æµçš„æ›´å¤šç»†èŠ‚å¯ä»¥çœ‹<a href="/docs/cpp/krpc/auto_concurrency_limiter">è¿™é‡Œ</a></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="pthreadæ¨¡å¼">pthreadæ¨¡å¼<a href="#pthreadæ¨¡å¼" class="hash-link" aria-label="Direct link to pthreadæ¨¡å¼" title="Direct link to pthreadæ¨¡å¼">â€‹</a></h3>
<p>ç”¨æˆ·ä»£ç ï¼ˆå®¢æˆ·ç«¯çš„doneï¼ŒæœåŠ¡å™¨ç«¯çš„CallMethodï¼‰é»˜è®¤åœ¨æ ˆä¸º1MBçš„kthreadä¸­è¿è¡Œã€‚ä½†æœ‰äº›ç”¨æˆ·ä»£ç æ— æ³•åœ¨kthreadä¸­è¿è¡Œï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>JNIä¼šæ£€æŸ¥stack layoutè€Œæ— æ³•åœ¨kthreadä¸­è¿è¡Œã€‚</li>
<li>ä»£ç ä¸­å¹¿æ³›åœ°ä½¿ç”¨pthread localä¼ é€’sessionçº§åˆ«å…¨å±€æ•°æ®ï¼Œåœ¨RPCå‰åå‡ä½¿ç”¨äº†ç›¸åŒçš„pthread localçš„æ•°æ®ï¼Œä¸”æ•°æ®æœ‰å‰åä¾èµ–æ€§ã€‚æ¯”å¦‚åœ¨RPCå‰å¾€pthread-localä¿å­˜äº†ä¸€ä¸ªå€¼ï¼ŒRPCååˆè¯»å‡ºæ¥å¸Œæœ›å’Œä¹‹å‰ä¿å­˜çš„ç›¸ç­‰ï¼Œå°±ä¼šæœ‰é—®é¢˜ã€‚è€Œåƒtcmallocè™½ç„¶ä¹Ÿä½¿ç”¨äº†pthread/LWP localï¼Œä½†æ¯æ¬¡ä½¿ç”¨ä¹‹é—´æ²¡æœ‰ç›´æ¥çš„ä¾èµ–ï¼Œæ˜¯å®‰å…¨çš„ã€‚</li>
</ul>
<p>å¯¹äºè¿™äº›æƒ…å†µï¼Œkrpcæä¾›äº†pthreadæ¨¡å¼ï¼Œå¼€å¯**-usercode_in_pthread**åï¼Œç”¨æˆ·ä»£ç å‡ä¼šåœ¨pthreadä¸­è¿è¡Œï¼ŒåŸå…ˆé˜»å¡kthreadçš„å‡½æ•°è½¬è€Œé˜»å¡pthreadã€‚</p>
<p>æ³¨æ„ï¼šå¼€å¯-usercode_in_pthreadåï¼Œkrpc::thread_local_data()ä¸ä¿è¯èƒ½è·å–åˆ°å€¼ã€‚</p>
<p>æ‰“å¼€pthreadæ¨¡å¼ååœ¨æ€§èƒ½ä¸Šçš„æ³¨æ„ç‚¹ï¼š</p>
<ul>
<li>åŒæ­¥RPCéƒ½ä¼šé˜»å¡worker pthreadï¼Œserverç«¯ä¸€èˆ¬éœ€è¦è®¾ç½®æ›´å¤šçš„å·¥ä½œçº¿ç¨‹(ServerOptions.num_threads)ï¼Œè°ƒåº¦æ•ˆç‡ä¼šç•¥å¾®é™ä½ã€‚</li>
<li>è¿è¡Œç”¨æˆ·ä»£ç çš„ä»ç„¶æ˜¯kthreadï¼Œåªæ˜¯å¾ˆç‰¹æ®Šï¼Œä¼šç›´æ¥ä½¿ç”¨pthread workerçš„æ ˆã€‚è¿™äº›ç‰¹æ®Škthreadçš„è°ƒåº¦æ–¹å¼å’Œå…¶ä»–kthreadæ˜¯ä¸€è‡´çš„ï¼Œè¿™æ–¹é¢æ€§èƒ½å·®å¼‚å¾ˆå°ã€‚</li>
<li>kthreadæ”¯æŒä¸€ä¸ªç‹¬ç‰¹çš„  åŠŸèƒ½ï¼šæŠŠå½“å‰ä½¿ç”¨çš„pthread worker è®©ç»™å¦ä¸€ä¸ªæ–°åˆ›å»ºçš„kthreadè¿è¡Œï¼Œä»¥æ¶ˆé™¤ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚krpc clientåˆ©ç”¨äº†è¿™ç‚¹ï¼Œä»è€Œä½¿ä¸€æ¬¡RPCè¿‡ç¨‹ä¸­3æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å˜ä¸ºäº†2æ¬¡ã€‚åœ¨é«˜QPSç³»ç»Ÿä¸­ï¼Œæ¶ˆé™¤ä¸Šä¸‹æ–‡åˆ‡æ¢å¯ä»¥æ˜æ˜¾æ”¹å–„æ€§èƒ½å’Œå»¶æ—¶åˆ†å¸ƒã€‚ä½†pthreadæ¨¡å¼ä¸å…·å¤‡è¿™ä¸ªèƒ½åŠ›ï¼Œåœ¨é«˜QPSç³»ç»Ÿä¸­æ€§èƒ½ä¼šæœ‰ä¸€å®šä¸‹é™ã€‚</li>
<li>pthreadæ¨¡å¼ä¸­çº¿ç¨‹èµ„æºæ˜¯ç¡¬é™ï¼Œä¸€æ—¦çº¿ç¨‹è¢«æ‰“æ»¡ï¼Œè¯·æ±‚å°±ä¼šè¿…é€Ÿæ‹¥å¡è€Œé€ æˆå¤§é‡è¶…æ—¶ã€‚ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯ï¼šä¸‹æ¸¸æœåŠ¡å¤§é‡è¶…æ—¶åï¼Œä¸Šæ¸¸æœåŠ¡å¯èƒ½ç”±äºçº¿ç¨‹å¤§éƒ½åœ¨ç­‰å¾…ä¸‹æ¸¸ä¹Ÿè¢«æ‰“æ»¡ä»è€Œå½±å“æ€§èƒ½ã€‚å¼€å¯pthreadæ¨¡å¼åè¯·è€ƒè™‘è®¾ç½®ServerOptions.max_concurrencyä»¥æ§åˆ¶serverçš„æœ€å¤§å¹¶å‘ã€‚è€Œåœ¨kthreadæ¨¡å¼ä¸­kthreadä¸ªæ•°æ˜¯è½¯é™ï¼Œå¯¹æ­¤ç±»é—®é¢˜çš„ååº”ä¼šæ›´åŠ å¹³æ»‘ã€‚</li>
</ul>
<p>pthreadæ¨¡å¼å¯ä»¥è®©ä¸€äº›è€ä»£ç å¿«é€Ÿå°è¯•krpcï¼Œä½†æˆ‘ä»¬ä»ç„¶å»ºè®®é€æ¸åœ°æŠŠä»£ç æ”¹é€ ä¸ºä½¿ç”¨kthread localæˆ–æœ€å¥½ä¸ç”¨TLSï¼Œä»è€Œæœ€ç»ˆèƒ½å…³é—­è¿™ä¸ªå¼€å…³ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å®‰å…¨æ¨¡å¼">å®‰å…¨æ¨¡å¼<a href="#å®‰å…¨æ¨¡å¼" class="hash-link" aria-label="Direct link to å®‰å…¨æ¨¡å¼" title="Direct link to å®‰å…¨æ¨¡å¼">â€‹</a></h3>
<p>å¦‚æœä½ çš„æœåŠ¡æµé‡æ¥è‡ªå¤–éƒ¨ï¼ˆåŒ…æ‹¬ç»è¿‡nginxç­‰è½¬å‘ï¼‰ï¼Œä½ éœ€è¦æ³¨æ„ä¸€äº›å®‰å…¨å› ç´ ï¼š</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å¯¹å¤–éšè—å†…ç½®æœåŠ¡">å¯¹å¤–éšè—å†…ç½®æœåŠ¡<a href="#å¯¹å¤–éšè—å†…ç½®æœåŠ¡" class="hash-link" aria-label="Direct link to å¯¹å¤–éšè—å†…ç½®æœåŠ¡" title="Direct link to å¯¹å¤–éšè—å†…ç½®æœåŠ¡">â€‹</a></h4>
<p>å†…ç½®æœåŠ¡å¾ˆæœ‰ç”¨ï¼Œä½†åŒ…å«äº†å¤§é‡å†…éƒ¨ä¿¡æ¯ï¼Œä¸åº”å¯¹å¤–æš´éœ²ã€‚æœ‰å¤šç§æ–¹å¼å¯ä»¥å¯¹å¤–éšè—å†…ç½®æœåŠ¡ï¼š</p>
<ul>
<li>
<p>è®¾ç½®å†…éƒ¨ç«¯å£ã€‚æŠŠServerOptions.internal_portè®¾ä¸ºä¸€ä¸ª<strong>ä»…å…è®¸å†…ç½‘è®¿é—®</strong>çš„ç«¯å£ã€‚ä½ å¯é€šè¿‡internal_portè®¿é—®åˆ°å†…ç½®æœåŠ¡ï¼Œä½†é€šè¿‡å¯¹å¤–ç«¯å£(Server.Startæ—¶ä¼ å…¥çš„é‚£ä¸ª)è®¿é—®å†…ç½®æœåŠ¡æ—¶å°†çœ‹åˆ°å¦‚ä¸‹é”™è¯¯ï¼š</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[a27eda84bcdeef529a76f22872b78305] Not allowed to access builtin services, try ServerOptions.internal_port=... instead if you&#x27;re inside internal network</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>http proxyæŒ‡å®šè½¬å‘è·¯å¾„ã€‚nginxç­‰å¯é…ç½®URLçš„æ˜ å°„å…³ç³»ï¼Œæ¯”å¦‚ä¸‹é¢çš„é…ç½®æŠŠè®¿é—®/MyAPIçš„å¤–éƒ¨æµé‡æ˜ å°„åˆ°<code>target-server</code>çš„<code>/ServiceName/MethodName</code>ã€‚å½“å¤–éƒ¨æµé‡å°è¯•è®¿é—®å†…ç½®æœåŠ¡ï¼Œæ¯”å¦‚è¯´/statusæ—¶ï¼Œå°†ç›´æ¥è¢«nginxæ‹’ç»ã€‚</p>
</li>
</ul>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  location /MyAPI {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_pass http://&lt;target-server&gt;/ServiceName/MethodName$query_string   # $query_stringæ˜¯nginxå˜é‡ï¼Œæ›´å¤šå˜é‡è¯·æŸ¥è¯¢http://nginx.org/en/docs/http/ngx_http_core_module.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>è¯·å‹¿åœ¨å¯¹å¤–æœåŠ¡ä¸Šå¼€å¯</strong>-enable_dir_serviceå’Œ-enable_threads_serviceä¸¤ä¸ªé€‰é¡¹ï¼Œå®ƒä»¬è™½ç„¶å¾ˆæ–¹ä¾¿ï¼Œä½†ä¼šä¸¥é‡æ³„éœ²æœåŠ¡å™¨ä¸Šçš„å…¶ä»–ä¿¡æ¯ã€‚æ£€æŸ¥å¯¹å¤–çš„rpcæœåŠ¡æ˜¯å¦æ‰“å¼€äº†è¿™ä¸¤ä¸ªå¼€å…³ï¼š</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-s</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-m</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token plain"> </span><span class="token environment constant" style="color:#005CC5">HOSTNAME</span><span class="token plain">:PORT/flags/enable_dir_service,enable_threads_service </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">awk</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&#x27;{if($3==&quot;false&quot;){++falsecnt}else if($3==&quot;Value&quot;){isrpc=1}}END{if(isrpc!=1||falsecnt==2){print &quot;SAFE&quot;}else{print &quot;NOT SAFE&quot;}}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å®Œå…¨ç¦ç”¨å†…ç½®æœåŠ¡">å®Œå…¨ç¦ç”¨å†…ç½®æœåŠ¡<a href="#å®Œå…¨ç¦ç”¨å†…ç½®æœåŠ¡" class="hash-link" aria-label="Direct link to å®Œå…¨ç¦ç”¨å†…ç½®æœåŠ¡" title="Direct link to å®Œå…¨ç¦ç”¨å†…ç½®æœåŠ¡">â€‹</a></h4>
<p>è®¾ç½®<code>ServerOptions.has_builtin_services = false</code>ï¼Œå¯ä»¥å®Œå…¨ç¦ç”¨å†…ç½®æœåŠ¡ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è½¬ä¹‰å¤–éƒ¨å¯æ§çš„url">è½¬ä¹‰å¤–éƒ¨å¯æ§çš„URL<a href="#è½¬ä¹‰å¤–éƒ¨å¯æ§çš„url" class="hash-link" aria-label="Direct link to è½¬ä¹‰å¤–éƒ¨å¯æ§çš„URL" title="Direct link to è½¬ä¹‰å¤–éƒ¨å¯æ§çš„URL">â€‹</a></h4>
<p>å¯è°ƒç”¨krpc::WebEscape()å¯¹urlè¿›è¡Œè½¬ä¹‰ï¼Œé˜²æ­¢æ¶æ„URIæ³¨å…¥æ”»å‡»ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ä¸è¿”å›å†…éƒ¨serveråœ°å€">ä¸è¿” å›å†…éƒ¨serveråœ°å€<a href="#ä¸è¿”å›å†…éƒ¨serveråœ°å€" class="hash-link" aria-label="Direct link to ä¸è¿”å›å†…éƒ¨serveråœ°å€" title="Direct link to ä¸è¿”å›å†…éƒ¨serveråœ°å€">â€‹</a></h4>
<p>å¯ä»¥è€ƒè™‘å¯¹serveråœ°å€åšç­¾åã€‚æ¯”å¦‚åœ¨è®¾ç½®ServerOptions.internal_portåï¼Œserverè¿”å›çš„é”™è¯¯ä¿¡æ¯ä¸­çš„IPä¿¡æ¯æ˜¯å…¶MD5ç­¾åï¼Œè€Œä¸æ˜¯æ˜æ–‡ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å®šåˆ¶healthé¡µé¢">å®šåˆ¶/healthé¡µé¢<a href="#å®šåˆ¶healthé¡µé¢" class="hash-link" aria-label="Direct link to å®šåˆ¶/healthé¡µé¢" title="Direct link to å®šåˆ¶/healthé¡µé¢">â€‹</a></h3>
<p>/healthé¡µé¢é»˜è®¤è¿”å›&quot;OK&quot;ï¼Œè‹¥éœ€å®šåˆ¶/healthé¡µé¢çš„å†…å®¹ï¼šå…ˆç»§æ‰¿<a href="https://github.com/apache/krpc/blob/master/src/krpc/health_reporter.h" target="_blank" rel="noopener noreferrer">HealthReporter</a>ï¼Œåœ¨å…¶ä¸­å®ç°ç”Ÿæˆé¡µé¢çš„é€»è¾‘ï¼ˆå°±åƒå®ç°å…¶ä»–http serviceé‚£æ ·ï¼‰ï¼Œç„¶åæŠŠå®ä¾‹èµ‹ç»™ServerOptions.health_reporterï¼Œè¿™ä¸ªå®ä¾‹ä¸è¢«serveræ‹¥æœ‰ï¼Œå¿…é¡»ä¿è¯åœ¨serverè¿è¡ŒæœŸé—´æœ‰æ•ˆã€‚ç”¨æˆ·åœ¨å®šåˆ¶é€»è¾‘ä¸­å¯ä»¥æ ¹æ®ä¸šåŠ¡çš„è¿è¡ŒçŠ¶æ€è¿”å›æ›´å¤šæ ·çš„çŠ¶æ€ä¿¡æ¯ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="çº¿ç¨‹ç§æœ‰å˜é‡">çº¿ç¨‹ç§æœ‰å˜é‡<a href="#çº¿ç¨‹ç§æœ‰å˜é‡" class="hash-link" aria-label="Direct link to çº¿ç¨‹ç§æœ‰å˜é‡" title="Direct link to çº¿ç¨‹ç§æœ‰å˜é‡">â€‹</a></h3>
<p>ç™¾åº¦å†…çš„æ£€ç´¢ç¨‹åºå¤§é‡åœ°ä½¿ç”¨äº†<a href="https://en.wikipedia.org/wiki/Thread-local_storage" target="_blank" rel="noopener noreferrer">thread-local storage</a> (ç¼©å†™TLS)ï¼Œæœ‰äº›æ˜¯ä¸ºäº†ç¼“å­˜é¢‘ç¹è®¿é—®çš„å¯¹è±¡ä»¥é¿å…åå¤åˆ›å»ºï¼Œæœ‰äº›åˆ™æ˜¯ä¸ºäº†åœ¨å…¨å±€å‡½æ•°é—´éšå¼åœ°ä¼ é€’çŠ¶æ€ã€‚ä½ åº”å½“å°½é‡é¿å…åè€…ï¼Œè¿™æ ·çš„å‡½æ•°éš¾ä»¥æµ‹è¯•ï¼Œä¸è®¾ç½®thread-localå˜é‡ç”šè‡³æ— æ³•è¿è¡Œã€‚krpcä¸­æœ‰ä¸‰å¥—æœºåˆ¶è§£å†³å’Œthread-localç›¸å…³çš„é—®é¢˜ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="session-local">session-local<a href="#session-local" class="hash-link" aria-label="Direct link to session-local" title="Direct link to session-local">â€‹</a></h4>
<p>session-local dataä¸ä¸€æ¬¡serverç«¯RPCç»‘å®š: ä»è¿›å…¥serviceå›è°ƒå¼€å§‹ï¼Œåˆ°è°ƒç”¨serverç«¯çš„doneç»“æŸï¼Œä¸ç®¡è¯¥serviceæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥å¤„ç†ã€‚ session-local dataä¼šå°½é‡è¢«é‡ç”¨ï¼Œåœ¨serveråœæ­¢å‰ä¸ä¼šè¢«åˆ é™¤ã€‚</p>
<p>è®¾ç½®ServerOptions.session_local_data_factoryåè®¿é—®Controller.session_local_data()å³å¯è·å¾—session-localæ•°æ®ã€‚è‹¥æ²¡æœ‰è®¾ç½®ï¼ŒController.session_local_data()æ€»æ˜¯è¿”å›NULLã€‚</p>
<p>è‹¥ServerOptions.reserved_session_local_dataå¤§äº0ï¼ŒServerä¼šåœ¨æä¾›æœåŠ¡å‰å°±åˆ›å»ºè¿™ä¹ˆå¤šä¸ªæ•°æ®ã€‚</p>
<p><strong>ç¤ºä¾‹ç”¨æ³•</strong></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct MySessionLocalData {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MySessionLocalData() : x(123) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class EchoServiceImpl : public example::EchoService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void Echo(google::protobuf::RpcController* cntl_base,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              const example::EchoRequest* request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              example::EchoResponse* response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              google::protobuf::Closure* done) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        krpc::Controller* cntl = static_cast&lt;krpc::Controller*&gt;(cntl_base);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get the session-local data which is created by ServerOptions.session_local_data_factory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // and reused between different RPC.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MySessionLocalData* sd = static_cast&lt;MySessionLocalData*&gt;(cntl-&gt;session_local_data());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (sd == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cntl-&gt;SetFailed(&quot;Require ServerOptions.session_local_data_factory to be set with a correctly implemented instance&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct ServerOptions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // The factory to create/destroy data attached to each RPC session.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // If this field is NULL, Controller::session_local_data() is always NULL.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // NOT owned by Server and must be valid when Server is running.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Default: NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const DataFactory* session_local_data_factory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Prepare so many session-local data before server starts, so that calls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // to Controller::session_local_data() get data directly rather than</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // calling session_local_data_factory-&gt;Create() at first time. Useful when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Create() is slow, otherwise the RPC session may be blocked by the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // creation of data and not served within timeout.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Default: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t reserved_session_local_data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>session_local_data_factoryçš„ç±»å‹ä¸º<a href="https://github.com/apache/krpc/blob/master/src/krpc/data_factory.h" target="_blank" rel="noopener noreferrer">DataFactory</a>ï¼Œä½ éœ€è¦å®ç°å…¶ä¸­çš„CreateDataå’ŒDestroyDataã€‚</p>
<p>æ³¨æ„ï¼šCreateDataå’ŒDestroyDataä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ï¼Œå¿…é¡»çº¿ç¨‹å®‰å…¨ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class MySessionLocalDataFactory : public krpc::DataFactory {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void* CreateData() const {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new MySessionLocalData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void DestroyData(void* d) const {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        delete static_cast&lt;MySessionLocalData*&gt;(d);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySessionLocalDataFactory g_session_local_data_factory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char* argv[]) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    krpc::Server server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    krpc::ServerOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    options.session_local_data_factory = &amp;g_session_local_data_factory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="server-thread-local">server-thread-local<a href="#server-thread-local" class="hash-link" aria-label="Direct link to server-thread-local" title="Direct link to server-thread-local">â€‹</a></h4>
<p>server-thread-localä¸ä¸€æ¬¡serviceå›è°ƒç»‘å®šï¼Œä»è¿›serviceå›è°ƒå¼€å§‹ï¼Œåˆ°å‡ºserviceå›è°ƒç»“æŸã€‚æ‰€æœ‰çš„server-thread-local dataä¼šè¢«å°½é‡é‡ç”¨ï¼Œåœ¨serveråœæ­¢å‰ä¸ä¼šè¢«åˆ é™¤ã€‚åœ¨å®ç°ä¸Šserver-thread-localæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„kthread-localã€‚</p>
<p>è®¾ç½®ServerOptions.thread_local_data_factoryåè®¿é—®krpc::thread_local_data()å³å¯è·å¾—thread-localæ•°æ®ã€‚è‹¥æ²¡æœ‰è®¾ç½®ï¼Œkrpc::thread_local_data()æ€»æ˜¯è¿”å›NULLã€‚</p>
<p>è‹¥ServerOptions.reserved_thread_local_dataå¤§äº0ï¼ŒServerä¼šåœ¨å¯åŠ¨å‰å°±åˆ›å»ºè¿™ä¹ˆå¤šä¸ªæ•°æ®ã€‚</p>
<p><strong>ä¸session-localçš„åŒºåˆ«</strong></p>
<p>session-local dataå¾—ä»serverç«¯çš„Controllerè·å¾—ï¼Œ server-thread-localå¯ä»¥åœ¨ä»»æ„å‡½æ•°ä¸­è·å¾—ï¼Œåªè¦è¿™ä¸ªå‡½æ•°ç›´æ¥æˆ–é—´æ¥åœ°è¿è¡Œåœ¨serverçº¿ç¨‹ä¸­ã€‚</p>
<p>å½“serviceæ˜¯åŒæ­¥æ—¶ï¼Œsession-localå’Œserver-thread-localåŸºæœ¬æ²¡æœ‰å·®åˆ«ï¼Œé™¤äº†å‰è€…éœ€è¦Controlleråˆ›å»ºã€‚å½“serviceæ˜¯å¼‚æ­¥æ—¶ï¼Œä¸”ä½ éœ€è¦åœ¨done-&gt;Run()ä¸­è®¿é—®åˆ°æ•°æ®ï¼Œè¿™æ—¶åªèƒ½ç”¨session-localï¼Œå› ä¸ºserver-thread-localåœ¨serviceå›è°ƒå¤–å·²ç»å¤±æ•ˆã€‚</p>
<p><strong>ç¤ºä¾‹ç”¨æ³•</strong></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct MyThreadLocalData {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyThreadLocalData() : y(0) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int y;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class EchoServiceImpl : public example::EchoService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void Echo(google::protobuf::RpcController* cntl_base,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              const example::EchoRequest* request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              example::EchoResponse* response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              google::protobuf::Closure* done) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        krpc::Controller* cntl = static_cast&lt;krpc::Controller*&gt;(cntl_base);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get the thread-local data which is created by ServerOptions.thread_local_data_factory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // and reused between different threads.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // &quot;tls&quot; is short for &quot;thread local storage&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyThreadLocalData* tls = static_cast&lt;MyThreadLocalData*&gt;(krpc::thread_local_data());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (tls == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cntl-&gt;SetFailed(&quot;Require ServerOptions.thread_local_data_factory &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;to be set with a correctly implemented instance&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct ServerOptions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // The factory to create/destroy data attached to each searching thread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // in server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // If this field is NULL, krpc::thread_local_data() is always NULL.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // NOT owned by Server and must be valid when Server is running.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Default: NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const DataFactory* thread_local_data_factory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Prepare so many thread-local data before server starts, so that calls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // to krpc::thread_local_data() get data directly rather than calling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // thread_local_data_factory-&gt;Create() at first time. Useful when Create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // is slow, otherwise the RPC session may be blocked by the creation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // of data and not served within timeout.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Default: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t reserved_thread_local_data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>thread_local_data_factoryçš„ç±»å‹ä¸º<a href="https://github.com/apache/krpc/blob/master/src/krpc/data_factory.h" target="_blank" rel="noopener noreferrer">DataFactory</a>ï¼Œä½ éœ€è¦å®ç°å…¶ä¸­çš„CreateDataå’ŒDestroyDataã€‚</p>
<p>æ³¨æ„ï¼šCreateDataå’ŒDestroyDataä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ï¼Œå¿…é¡»çº¿ç¨‹å®‰å…¨ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class MyThreadLocalDataFactory : public krpc::DataFactory {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void* CreateData() const {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new MyThreadLocalData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void DestroyData(void* d) const {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        delete static_cast&lt;MyThreadLocalData*&gt;(d);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyThreadLocalDataFactory g_thread_local_data_factory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char* argv[]) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    krpc::Server server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    krpc::ServerOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    options.thread_local_data_factory  = &amp;g_thread_local_data_factory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="kthread-local">kthread-local<a href="#kthread-local" class="hash-link" aria-label="Direct link to kthread-local" title="Direct link to kthread-local">â€‹</a></h4>
<p>Session-localå’Œserver-thread-localå¯¹å¤§éƒ¨åˆ†serverå·²ç»å¤Ÿç”¨ã€‚ä¸è¿‡åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æ›´é€šç”¨çš„thread-localæ–¹æ¡ˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨kthread_key_create, kthread_key_destroy, kthread_getspecific, kthread_setspecificç­‰å‡½æ•°ï¼Œå®ƒä»¬çš„ç”¨æ³•ç±»ä¼¼<a href="http://linux.die.net/man/3/pthread_key_create" target="_blank" rel="noopener noreferrer">pthreadä¸­çš„å‡½æ•°</a>ã€‚</p>
<p>è¿™äº›å‡½æ•°åŒæ—¶æ”¯æŒkthreadå’Œpthreadï¼Œå½“å®ƒä»¬åœ¨kthreadä¸­è¢«è°ƒç”¨æ—¶ï¼Œè·å¾—çš„æ˜¯kthreadç§æœ‰å˜é‡; å½“å®ƒä»¬åœ¨pthreadä¸­è¢«è°ƒç”¨æ—¶ï¼Œè· å¾—çš„æ˜¯pthreadç§æœ‰å˜é‡ã€‚ä½†æ³¨æ„ï¼Œè¿™é‡Œçš„â€œpthreadç§æœ‰å˜é‡â€ä¸æ˜¯é€šè¿‡pthread_key_createåˆ›å»ºçš„ï¼Œä½¿ç”¨pthread_key_createåˆ›å»ºçš„pthread-localæ˜¯æ— æ³•è¢«kthread_getspecificè®¿é—®åˆ°çš„ï¼Œè¿™æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ä½“ç³»ã€‚ç”±gccçš„__threadï¼Œc++11çš„thread_localç­‰å£°æ˜çš„ç§æœ‰å˜é‡ä¹Ÿæ— æ³•è¢«kthread_getspecificè®¿é—®åˆ°ã€‚</p>
<p>ç”±äºkrpcä¼šä¸ºæ¯ä¸ªè¯·æ±‚å»ºç«‹ä¸€ä¸ªkthreadï¼Œserverä¸­çš„kthread-localè¡Œä¸ºç‰¹æ®Šï¼šä¸€ä¸ªserveråˆ›å»ºçš„kthreadåœ¨é€€å‡ºæ—¶å¹¶ä¸åˆ é™¤kthread-localï¼Œè€Œæ˜¯è¿˜å›serverçš„ä¸€ä¸ªpoolä¸­ï¼Œä»¥è¢«å…¶ä»–kthreadå¤ç”¨ã€‚è¿™å¯ä»¥é¿å…kthread-localéšç€kthreadçš„åˆ›å»ºå’Œé€€å‡ºè€Œä¸åœåœ°æ„é€ å’Œææ„ã€‚è¿™å¯¹äºç”¨æˆ·æ˜¯é€æ˜çš„ã€‚</p>
<p><strong>ä¸»è¦æ¥å£</strong></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Create a key value identifying a slot in a thread-specific data area.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Each thread maintains a distinct thread-specific data area.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// `destructor&#x27;, if non-NULL, is called with the value associated to that key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// when the key is destroyed. `destructor&#x27; is not called if the value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// associated is NULL when the key is destroyed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Returns 0 on success, error code otherwise.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extern int kthread_key_create(kthread_key_t* key, void (*destructor)(void* data));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Delete a key previously returned by kthread_key_create().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// It is the responsibility of the application to free the data related to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// the deleted key in any running thread. No destructor is invoked by</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// this function. Any destructor that may have been associated with key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// will no longer be called upon thread exit.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Returns 0 on success, error code otherwise.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extern int kthread_key_delete(kthread_key_t key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Store `data&#x27; in the thread-specific slot identified by `key&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// kthread_setspecific() is callable from within destructor. If the application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// does so, destructors will be repeatedly called for at most</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// PTHREAD_DESTRUCTOR_ITERATIONS times to clear the slots.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// NOTE: If the thread is not created by krpc server and lifetime is</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// very short(doing a little thing and exit), avoid using kthread-local. The</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// reason is that kthread-local always allocate keytable on first call to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// kthread_setspecific, the overhead is negligible in long-lived threads,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// but noticeable in shortly-lived threads. Threads in krpc server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// are special since they reuse keytables from a kthread_keytable_pool_t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// in the server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Returns 0 on success, error code otherwise.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// If the key is invalid or deleted, return EINVAL.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extern int kthread_setspecific(kthread_key_t key, void* data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Return current value of the thread-specific slot identified by `key&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// If kthread_setspecific() had not been called in the thread, return NULL.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// If the key is invalid or deleted, return NULL.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extern void* kthread_getspecific(kthread_key_t key);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>ä½¿ç”¨æ–¹æ³•</strong></p>
<p>ç”¨kthread_key_createåˆ›å»ºä¸€ä¸ªkthread_key_tï¼Œå®ƒä»£è¡¨ä¸€ç§kthreadç§æœ‰å˜é‡ã€‚</p>
<p>ç”¨kthread_[get|set]specificæŸ¥è¯¢å’Œè®¾ç½®kthreadç§æœ‰å˜é‡ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸­ç¬¬ä¸€æ¬¡è®¿é—®æŸä¸ªç§æœ‰å˜é‡è¿”å›NULLã€‚</p>
<p>åœ¨æ‰€æœ‰çº¿ç¨‹éƒ½ä¸ä½¿ç”¨å’ŒæŸä¸ªkthread_key_tç›¸å…³çš„ç§æœ‰å˜é‡åå†åˆ é™¤å®ƒã€‚å¦‚æœåˆ é™¤äº†ä¸€ä¸ªä»åœ¨è¢«ä½¿ç”¨çš„kthread_key_tï¼Œç›¸å…³çš„ç§æœ‰å˜é‡å°±æ³„éœ²äº†ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static void my_data_destructor(void* data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kthread_key_t tls_key;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (kthread_key_create(&amp;tls_key, my_data_destructor) != 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG(ERROR) &lt;&lt; &quot;Fail to create tls_key&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// in some thread ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyThreadLocalData* tls = static_cast&lt;MyThreadLocalData*&gt;(kthread_getspecific(tls_key));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (tls == NULL) {  // First call to kthread_getspecific (and before any kthread_setspecific) returns NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tls = new MyThreadLocalData;   // Create thread-local data on demand.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CHECK_EQ(0, kthread_setspecific(tls_key, tls));  // set the data so that next time kthread_getspecific in the thread returns the data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>ç¤ºä¾‹ä»£ç </strong></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static void my_thread_local_data_deleter(void* d) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delete static_cast&lt;MyThreadLocalData*&gt;(d);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class EchoServiceImpl : public example::EchoService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EchoServiceImpl() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CHECK_EQ(0, kthread_key_create(&amp;_tls2_key, my_thread_local_data_deleter));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ~EchoServiceImpl() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CHECK_EQ(0, kthread_key_delete(_tls2_key));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kthread_key_t _tls2_key;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class EchoServiceImpl : public example::EchoService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void Echo(google::protobuf::RpcController* cntl_base,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              const example::EchoRequest* request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              example::EchoResponse* response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              google::protobuf::Closure* done) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // You can create kthread-local data for your own.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // The interfaces are similar with pthread equivalence:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //   pthread_key_create  -&gt; kthread_key_create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //   pthread_key_delete  -&gt; kthread_key_delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //   pthread_getspecific -&gt; kthread_getspecific</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //   pthread_setspecific -&gt; kthread_setspecific</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyThreadLocalData* tls2 = static_cast&lt;MyThreadLocalData*&gt;(kthread_getspecific(_tls2_key));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (tls2 == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tls2 = new MyThreadLocalData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CHECK_EQ(0, kthread_setspecific(_tls2_key, tls2));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="faq">FAQ<a href="#faq" class="hash-link" aria-label="Direct link to FAQ" title="Direct link to FAQ">â€‹</a></h2>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-fail-to-write-into-fd1865-socketid89051020824543547428230-got-eofæ˜¯ä»€ä¹ˆæ„æ€">Q: Fail to write into fd=1865 SocketId=8905@10.208.245.43:54742@8230: Got EOFæ˜¯ä»€ä¹ˆæ„æ€<a href="#q-fail-to-write-into-fd1865-socketid89051020824543547428230-got-eofæ˜¯ä»€ä¹ˆæ„æ€" class="hash-link" aria-label="Direct link to Q: Fail to write into fd=1865 SocketId=8905@10.208.245.43:54742@8230: Got EOFæ˜¯ä»€ä¹ˆæ„æ€" title="Direct link to Q: Fail to write into fd=1865 SocketId=8905@10.208.245.43:54742@8230: Got EOFæ˜¯ä»€ä¹ˆæ„æ€">â€‹</a></h4>
<p>A: ä¸€èˆ¬æ˜¯clientç«¯ä½¿ç”¨äº†è¿æ¥æ± æˆ–çŸ­è¿æ¥æ¨¡å¼ï¼Œåœ¨RPCè¶…æ—¶åä¼šå…³é—­è¿æ¥ï¼Œserverå†™å›responseæ—¶å‘ç°è¿æ¥å·²ç»å…³äº†å°±æŠ¥è¿™ä¸ªé”™ã€‚Got EOFå°±æ˜¯æŒ‡ä¹‹å‰å·²ç»æ”¶åˆ°äº†EOFï¼ˆå¯¹ç«¯æ­£å¸¸å…³é—­äº†è¿æ¥ï¼‰ã€‚clientç«¯ä½¿ç”¨å•è¿æ¥æ¨¡å¼serverç«¯ä¸€èˆ¬ä¸ä¼šæŠ¥è¿™ä¸ªã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-remote-side-of-fd9-socketid2109466558000-was-closedæ˜¯ä»€ä¹ˆæ„æ€">Q: Remote side of fd=9 SocketId=2@10.94.66.55:8000 was closedæ˜¯ä»€ä¹ˆæ„æ€<a href="#q-remote-side-of-fd9-socketid2109466558000-was-closedæ˜¯ä»€ä¹ˆæ„æ€" class="hash-link" aria-label="Direct link to Q: Remote side of fd=9 SocketId=2@10.94.66.55:8000 was closedæ˜¯ä»€ä¹ˆæ„æ€" title="Direct link to Q: Remote side of fd=9 SocketId=2@10.94.66.55:8000 was closedæ˜¯ä»€ä¹ˆæ„æ€">â€‹</a></h4>
<p>è¿™ä¸æ˜¯é”™è¯¯ï¼Œæ˜¯å¸¸è§çš„warningï¼Œè¡¨ç¤ºå¯¹ç«¯å…³æ‰è¿æ¥äº†ï¼ˆEOF)ã€‚è¿™ä¸ªæ—¥å¿—æœ‰æ—¶å¯¹æ’æŸ¥é—®é¢˜æœ‰å¸®åŠ©ã€‚</p>
<p>é»˜è®¤å…³é—­ï¼ŒæŠŠå‚æ•°-log_connection_closeè®¾ç½®ä¸ºtrueå°±æ‰“å¼€äº†ï¼ˆæ”¯æŒ<a href="/docs/cpp/krpc/flags#change-gflag-on-the-fly">åŠ¨æ€ä¿®æ”¹</a>ï¼‰ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-ä¸ºä»€ä¹ˆserverç«¯çº¿ç¨‹æ•°è®¾äº†æ²¡ç”¨">Q: ä¸ºä»€ä¹ˆserverç«¯çº¿ç¨‹æ•°è®¾äº†æ²¡ç”¨<a href="#q-ä¸ºä»€ä¹ˆserverç«¯çº¿ç¨‹æ•°è®¾äº†æ²¡ç”¨" class="hash-link" aria-label="Direct link to Q: ä¸ºä»€ä¹ˆserverç«¯çº¿ç¨‹æ•°è®¾äº†æ²¡ç”¨" title="Direct link to Q: ä¸ºä»€ä¹ˆserverç«¯çº¿ç¨‹æ•°è®¾äº†æ²¡ç”¨">â€‹</a></h4>
<p>krpcåŒä¸€ä¸ªè¿›ç¨‹ä¸­æ‰€æœ‰çš„server<a href="#worker%E7%BA%BF%E7%A8%8B%E6%95%B0">å…±ç”¨çº¿ç¨‹</a>ï¼Œå¦‚æœåˆ›å»ºäº†å¤šä¸ªserverï¼Œæœ€ç»ˆçš„å·¥ä½œçº¿ç¨‹æ•°å¤šåŠæ˜¯æœ€å¤§çš„é‚£ä¸ªServerOptions.num_threadsã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-ä¸ºä»€ä¹ˆclientç«¯çš„å»¶æ—¶è¿œå¤§äºserverç«¯çš„å»¶æ—¶">Q: ä¸ºä»€ä¹ˆclientç«¯çš„å»¶æ—¶è¿œå¤§äºserverç«¯çš„å»¶æ—¶<a href="#q-ä¸ºä»€ä¹ˆclientç«¯çš„å»¶æ—¶è¿œå¤§äºserverç«¯çš„å»¶æ—¶" class="hash-link" aria-label="Direct link to Q: ä¸ºä»€ä¹ˆclientç«¯çš„å»¶æ—¶è¿œå¤§äºserverç«¯çš„å»¶æ—¶" title="Direct link to Q: ä¸ºä»€ä¹ˆclientç«¯çš„å»¶æ—¶è¿œå¤§äºserverç«¯çš„å»¶æ—¶">â€‹</a></h4>
<p>å¯èƒ½æ˜¯serverç«¯çš„å·¥ä½œçº¿ç¨‹ä¸å¤Ÿç”¨äº†ï¼Œå‡ºç°äº†æ’é˜Ÿç°è±¡ã€‚æ’æŸ¥æ–¹æ³•è¯·æŸ¥çœ‹<a href="/docs/cpp/krpc/server_debugging">é«˜æ•ˆç‡æ’æŸ¥æœåŠ¡å¡é¡¿</a>ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-fail-to-open-procselfio">Q: Fail to open /proc/self/io<a href="#q-fail-to-open-procselfio" class="hash-link" aria-label="Direct link to Q: Fail to open /proc/self/io" title="Direct link to Q: Fail to open /proc/self/io">â€‹</a></h4>
<p>æœ‰äº›å†…æ ¸æ²¡è¿™ä¸ªæ–‡ä»¶ï¼Œä¸å½±å“æœåŠ¡æ­£ç¡®æ€§ï¼Œä½†å¦‚ä¸‹å‡ ä¸ªkvarä¼šæ— æ³•æ›´æ–°ï¼š</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">process_io_read_bytes_second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process_io_write_bytes_second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process_io_read_second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process_io_write_second</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-jsonä¸²123æ²¡æ³•ç›´æ¥è½¬ä¸ºprotobuf-message">Q: jsonä¸²&quot;[1,2,3]&quot;æ²¡æ³•ç›´æ¥è½¬ä¸ºprotobuf message<a href="#q-jsonä¸²123æ²¡æ³•ç›´æ¥è½¬ä¸ºprotobuf-message" class="hash-link" aria-label="Direct link to Q: jsonä¸²&quot;[1,2,3]&quot;æ²¡æ³•ç›´æ¥è½¬ä¸ºprotobuf message" title="Direct link to Q: jsonä¸²&quot;[1,2,3]&quot;æ²¡æ³•ç›´æ¥è½¬ä¸ºprotobuf message">â€‹</a></h4>
<p>è¿™ä¸æ˜¯æ ‡å‡†çš„jsonã€‚æœ€å¤–å±‚å¿…é¡»æ˜¯èŠ±æ‹¬å·<!-- -->åŒ…å›´çš„json objectã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é™„ç«¯åŸºæœ¬æµç¨‹">é™„<!-- -->:Server<!-- -->ç«¯åŸºæœ¬æµç¨‹<a href="#é™„ç«¯åŸºæœ¬æµç¨‹" class="hash-link" aria-label="Direct link to é™„ç«¯åŸºæœ¬æµç¨‹" title="Direct link to é™„ç«¯åŸºæœ¬æµç¨‹">â€‹</a></h2>
<!-- -->
<img src="[object Object]"></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-05-24T10:16:12.000Z" itemprop="dateModified">May 24, 2025</time></b> by <b>Jeff lothar</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/cpp/krpc/getting_started"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">ä½¿ç”¨krpc</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/cpp/krpc/http_service"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">httpæœåŠ¡</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ç¤ºä¾‹ç¨‹åº" class="table-of-contents__link toc-highlight">ç¤ºä¾‹ç¨‹åº</a></li><li><a href="#å¡«å†™protoæ–‡ä»¶" class="table-of-contents__link toc-highlight">å¡«å†™protoæ–‡ä»¶</a></li><li><a href="#å®ç°ç”Ÿæˆçš„serviceæ¥å£" class="table-of-contents__link toc-highlight">å®ç°ç”Ÿæˆçš„Serviceæ¥å£</a><ul><li><a href="#æ ‡è®°å½“å‰è°ƒç”¨ä¸ºå¤±è´¥" class="table-of-contents__link toc-highlight">æ ‡è®°å½“å‰è°ƒç”¨ä¸ºå¤±è´¥</a></li><li><a href="#è·å–clientçš„åœ°å€" class="table-of-contents__link toc-highlight">è·å–Clientçš„åœ°å€</a></li><li><a href="#è·å–serverçš„åœ°å€" class="table-of-contents__link toc-highlight">è·å–Serverçš„åœ°å€</a></li><li><a href="#å¼‚æ­¥service" class="table-of-contents__link toc-highlight">å¼‚æ­¥Service</a></li></ul></li><li><a href="#åŠ å…¥service" class="table-of-contents__link toc-highlight">åŠ å…¥Service</a></li><li><a href="#å¯åŠ¨" class="table-of-contents__link toc-highlight">å¯åŠ¨</a><ul><li><a href="#ç›‘å¬å¤šä¸ªç«¯å£" class="table-of-contents__link toc-highlight">ç›‘å¬å¤šä¸ªç«¯å£</a></li><li><a href="#å¤šè¿›ç¨‹ç›‘å¬ä¸€ä¸ªç«¯å£" class="table-of-contents__link toc-highlight">å¤šè¿›ç¨‹ç›‘å¬ä¸€ä¸ªç«¯å£</a></li></ul></li><li><a href="#åœæ­¢" class="table-of-contents__link toc-highlight">åœæ­¢</a></li><li><a href="#è¢«httph2è®¿é—®" class="table-of-contents__link toc-highlight">è¢«http/h2è®¿é—®</a><ul><li><a href="#jsonpb" class="table-of-contents__link toc-highlight">json<code>&lt;=&gt;</code>pb</a></li><li><a href="#å…¼å®¹æ—©æœŸç‰ˆæœ¬client" class="table-of-contents__link toc-highlight">å…¼å®¹æ—©æœŸç‰ˆæœ¬client</a></li></ul></li><li><a href="#åè®®æ”¯æŒ" class="table-of-contents__link toc-highlight">åè®®æ”¯æŒ</a></li><li><a href="#fork-without-exec" class="table-of-contents__link toc-highlight">fork without exec</a></li><li><a href="#è®¾ç½®" class="table-of-contents__link toc-highlight">è®¾ç½®</a><ul><li><a href="#ç‰ˆæœ¬" class="table-of-contents__link toc-highlight">ç‰ˆæœ¬</a></li><li><a href="#å…³é—­é—²ç½®è¿æ¥" class="table-of-contents__link toc-highlight">å…³é—­é—²ç½®è¿æ¥</a></li><li><a href="#pid_file" class="table-of-contents__link toc-highlight">pid_file</a></li><li><a href="#åœ¨æ¯æ¡æ—¥å¿—åæ‰“å°hostname" class="table-of-contents__link toc-highlight">åœ¨æ¯æ¡æ—¥å¿—åæ‰“å°hostname</a></li><li><a href="#æ‰“å°fatalæ—¥å¿—åé€€å‡ºç¨‹åº" class="table-of-contents__link toc-highlight">æ‰“å°FATALæ—¥å¿—åé€€å‡ºç¨‹åº</a></li><li><a href="#æœ€ä½æ—¥å¿—çº§åˆ«" class="table-of-contents__link toc-highlight">æœ€ä½æ—¥å¿—çº§åˆ«</a></li><li><a href="#å½’è¿˜ç©ºé—²å†…å­˜è‡³ç³»ç»Ÿ" class="table-of-contents__link toc-highlight">å½’è¿˜ç©ºé—²å†…å­˜è‡³ç³»ç»Ÿ</a></li><li><a href="#æ‰“å°å‘é€ç»™clientçš„é”™è¯¯" class="table-of-contents__link toc-highlight">æ‰“å°å‘é€ç»™clientçš„é”™è¯¯</a></li><li><a href="#å®šåˆ¶å»¶æ—¶çš„åˆ†ä½å€¼" class="table-of-contents__link toc-highlight">å®šåˆ¶å»¶æ—¶çš„åˆ†ä½å€¼</a></li><li><a href="#è®¾ç½®æ ˆå¤§å°" class="table-of-contents__link toc-highlight">è®¾ç½®æ ˆå¤§å°</a></li><li><a href="#é™åˆ¶æœ€å¤§æ¶ˆæ¯" class="table-of-contents__link toc-highlight">é™åˆ¶æœ€å¤§æ¶ˆæ¯</a></li><li><a href="#å‹ç¼©" class="table-of-contents__link toc-highlight">å‹ç¼©</a></li><li><a href="#é™„ä»¶" class="table-of-contents__link toc-highlight">é™„ä»¶</a></li><li><a href="#å¼€å¯ssl" class="table-of-contents__link toc-highlight">å¼€å¯SSL</a></li><li><a href="#éªŒè¯clientèº«ä»½" class="table-of-contents__link toc-highlight">éªŒè¯clientèº«ä»½</a></li><li><a href="#workerçº¿ç¨‹æ•°" class="table-of-contents__link toc-highlight">workerçº¿ç¨‹æ•°</a></li><li><a href="#é™åˆ¶æœ€å¤§å¹¶å‘" class="table-of-contents__link toc-highlight">é™åˆ¶æœ€å¤§å¹¶å‘</a></li><li><a href="#é™åˆ¶serverçº§åˆ«å¹¶å‘åº¦" class="table-of-contents__link toc-highlight">é™åˆ¶serverçº§åˆ«å¹¶å‘åº¦</a></li><li><a href="#pthreadæ¨¡å¼" class="table-of-contents__link toc-highlight">pthreadæ¨¡å¼</a></li><li><a href="#å®‰å…¨æ¨¡å¼" class="table-of-contents__link toc-highlight">å®‰å…¨æ¨¡å¼</a></li><li><a href="#å®šåˆ¶healthé¡µé¢" class="table-of-contents__link toc-highlight">å®šåˆ¶/healthé¡µé¢</a></li><li><a href="#çº¿ç¨‹ç§æœ‰å˜é‡" class="table-of-contents__link toc-highlight">çº¿ç¨‹ç§æœ‰å˜é‡</a></li></ul></li><li><a href="#faq" class="table-of-contents__link toc-highlight">FAQ</a></li><li><a href="#é™„ç«¯åŸºæœ¬æµç¨‹" class="table-of-contents__link toc-highlight">é™„ç«¯åŸºæœ¬æµç¨‹</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">é˜…è¯»</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">æ–‡æ¡£</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/installation">å®‰è£…</a></li></ul></div><div class="col footer__col"><div class="footer__title">æ”¯æŒä¸èµ„æº</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/feature-requests">Feature Requests</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/community/support">Help</a></li></ul></div><div class="col footer__col"><div class="footer__title">æ›´å¤š</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">åšå®¢</a></li><li class="footer__item"><a class="footer__link-item" href="/changelog">æ›´æ–°</a></li><li class="footer__item"><a href="https://gitee.com/kumo-pub" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kumo-ai.tech" target="_blank" rel="noopener noreferrer" class="footer__link-item">ç½‘ç«™<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">ç‰ˆæƒ Â© 2025 åŒ—äº¬ç§‘ç±³æ™ºåˆ›ç§‘æŠ€æœ‰é™å…¬å¸</div></div></div></footer></div>
</body>
</html>