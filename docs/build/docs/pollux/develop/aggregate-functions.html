<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-1.1.1 docs-doc-page docs-doc-id-pollux/develop/aggregate-functions" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">如何添加聚合函数？ | Kumo AI</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kumo-pub.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kumo-pub.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kumo-pub.github.io/docs/pollux/develop/aggregate-functions"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="1.1.1"><meta data-rh="true" name="docusaurus_tag" content="docs-default-1.1.1"><meta data-rh="true" name="docsearch:version" content="1.1.1"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-1.1.1"><meta data-rh="true" property="og:title" content="如何添加聚合函数？ | Kumo AI"><meta data-rh="true" name="description" content="聚合函数由 HashAggregation 运算符计算。单个运算符中可以有一个或多个聚合函数。"><meta data-rh="true" property="og:description" content="聚合函数由 HashAggregation 运算符计算。单个运算符中可以有一个或多个聚合函数。"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://kumo-pub.github.io/docs/pollux/develop/aggregate-functions"><link data-rh="true" rel="alternate" href="https://kumo-pub.github.io/docs/pollux/develop/aggregate-functions" hreflang="en"><link data-rh="true" rel="alternate" href="https://kumo-pub.github.io/docs/pollux/develop/aggregate-functions" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kumo AI RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kumo AI Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Kumo AI JSON Feed">


<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E5CR2Q1NRE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-E5CR2Q1NRE",{})</script>


<link rel="alternate" type="application/rss+xml" href="/changelog/rss.xml" title="Docusaurus changelog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/changelog/atom.xml" title="Docusaurus changelog Atom Feed">
<link rel="alternate" type="application/json" href="/changelog/feed.json" title="Docusaurus changelog JSON Feed">



<link rel="icon" href="/img/docusaurus.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/docusaurus.png">
<link rel="mask-icon" href="/img/docusaurus.png" color="rgb(62, 204, 94)">
<meta name="msapplication-TileImage" content="/img/docusaurus.png">
<meta name="msapplication-TileColor" content="#000">



<link rel="alternate" type="application/rss+xml" href="/tests/blog/rss.xml" title="Docusaurus Tests Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tests/blog/atom.xml" title="Docusaurus Tests Blog Atom Feed">
<link rel="alternate" type="application/json" href="/tests/blog/feed.json" title="Docusaurus Tests Blog JSON Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Kumo AI" href="/opensearch.xml">

<link rel="stylesheet" href="/katex/katex.min.css"><link rel="stylesheet" href="/assets/css/styles.21fbef88.css">
<script src="/assets/js/runtime~main.cf79a945.js" defer="defer"></script>
<script src="/assets/js/main.4244a726.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme-b4f")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss-b4f")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">🎉️ <b><a target="_blank" href="https://docusaurus.io/blog/releases/1.1">Kumo v1.1</a> is out!</b> 🥳️</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/kumo_logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE" height="48" width="128"><img src="/img/kumo_logo_white.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="48" width="128"></div><b class="navbar__title text--truncate">主页</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">文档</a><a class="navbar__item navbar__link" href="/docs/category/kmsearch">API</a><a class="navbar__item navbar__link" href="/blog">博客</a><a class="navbar__item navbar__link" href="/changelog">发布</a><a class="navbar__item navbar__link" href="/showcase">应用案例</a><a class="navbar__item navbar__link" href="/community/support">支持与资源</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/pollux/develop/aggregate-functions">1.1.1</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next">nightly 🚧</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/pollux/develop/aggregate-functions">1.1.1</a></li><li><hr class="dropdown-separator"></li><li class="dropdown-archived-versions"><b>Archived versions</b></li><li><a href="https://docusaurus-archive-october-2023.netlify.app/docs/2.3.1" target="_blank" rel="noopener noreferrer" class="dropdown__link">1.0.1<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://v1.docusaurus.io" target="_blank" rel="noopener noreferrer" class="dropdown__link">1.x.x<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><hr class="dropdown-separator"></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/pollux/develop/aggregate-functions" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://github.com/facebook/docusaurus/issues/3526" target="_blank" rel="noopener noreferrer" class="dropdown__link">Help Us Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/kumo_logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE" height="48" width="128"><img src="/img/kumo_logo_white.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="48" width="128"><b>主页</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs">概述</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/基础准备">基础准备</a><button aria-label="Collapse sidebar category &#x27;基础准备&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/env_prepare_be">后端开发环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/env_prepare_fe">前端开发环境</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/持续集成----kmpkg">持续集成 -- kmpkg</a><button aria-label="Expand sidebar category &#x27;持续集成 -- kmpkg&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/c开发">c++开发</a><button aria-label="Expand sidebar category &#x27;c++开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/搜素基础开发">搜素基础开发</a><button aria-label="Expand sidebar category &#x27;搜素基础开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/搜索应用开发">搜索应用开发</a><button aria-label="Expand sidebar category &#x27;搜索应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/向量数据库教程">向量数据库教程</a><button aria-label="Expand sidebar category &#x27;向量数据库教程&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/搜索统一执行引擎">搜索统一执行引擎</a><button aria-label="Collapse sidebar category &#x27;搜索统一执行引擎&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/overview">pollux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/presto-functions">Presto Functions</a><button aria-label="Expand sidebar category &#x27;Presto Functions&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/开发文档">开发文档</a><button aria-label="Collapse sidebar category &#x27;开发文档&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/types">Types(数据类型)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/vectors">Vectors(向量)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/scalar-functions">如何添加标量函数？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/pollux/develop/aggregate-functions">如何添加聚合函数？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/view-and-writer-types">视图和编写器类型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/lambda-functions">如何添加 lambda 函数？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/expression-evaluation">表达式计算 (Expression Evaluation)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/dictionary-encoding">字典编码(Dictionary Encoding)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/arena">Arena Allocation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/hash-table">Hash table</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/aggregations">聚合(Aggregations)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/connectors">Connectors</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/joins">Joins</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/anti-join">Anti joins</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/operators">Plan Nodes and Operators</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/task">What&#x27;s in the Task?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/simd">SIMD Usage in Pollux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/memory">Memory Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/spilling">Spilling</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/serialization">Serialization</a><button aria-label="Expand sidebar category &#x27;Serialization&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/调试">调试</a><button aria-label="Expand sidebar category &#x27;调试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/测试">测试</a><button aria-label="Expand sidebar category &#x27;测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/timestamp">Timestamp and Timezone Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/window">Window functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/pollux/develop/dynamic-loading">Dynamic Loading of Pollux Extensions</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/搜索-ui">搜索 UI</a><button aria-label="Expand sidebar category &#x27;搜索 UI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/搜索统一执行引擎"><span itemprop="name">搜索统一执行引擎</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/开发文档"><span itemprop="name">开发文档</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">如何添加聚合函数？</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 1.1.1</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>如何添加聚合函数？</h1></header>
<p>聚合函数由 HashAggregation 运算符计算。单个运算符中可以有一个或多个聚合函数。
以下是一些示例。</p>
<p>全局聚合（无分组键），单个聚合<code>计数</code>。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">FROM</span><span class="token plain"> t</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>全局聚合，两个聚合：<code>count</code>和<code>sum</code>：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">FROM</span><span class="token plain"> t</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>具有三个聚合的聚合：<code>计数</code>和两个<code>总和</code>。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">SELECT</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">FROM</span><span class="token plain"> t </span><span class="token keyword" style="color:#CF222E">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">BY</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>仅使用一个聚合<code>min</code>和两个分组键进行聚合。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">SELECT</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">FROM</span><span class="token plain"> t </span><span class="token keyword" style="color:#CF222E">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">BY</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通常，聚合计算分为两个步骤：部分聚合和最终聚合。</p>
<p>部分聚合获取原始数据并生成中间结果。最终聚合获取中间结果并生成最终结果。在某些情况下，还会使用单次聚合和中间聚合。
当数据已根据分组键进行分区，因此无需进行混洗时，使用单次聚合。中间聚合用于合并在多个线程中并行计算的部分聚合结果，以减少发送到最终聚合阶段的数据量。</p>
<p>聚合的四种类型和步骤仅通过输入和输出的类型来区分。</p>
<table><thead><tr><th>Step Type</th><th>Input</th><th>Output</th></tr></thead><tbody><tr><td>‌<strong>Partial</strong>‌</td><td>Raw Data</td><td>Intermediate Results</td></tr><tr><td>‌<strong>Final</strong>‌</td><td>Intermediate Results</td><td>Final Results</td></tr><tr><td>‌<strong>Single</strong>‌</td><td>Raw Data</td><td>Final Results</td></tr><tr><td>‌<strong>Intermediate</strong>‌</td><td>Intermediate Results</td><td>Intermediate Results</td></tr></tbody></table>
<p>在某些情况下，部分聚合和最终聚合执行的计算是相同的。例如，<code>sum</code>、<code>min</code> 和 <code>max</code> 聚合。大多数情况下，它们是不同的。例如，部分 <code>count</code>
聚合对输入值进行计数，而最终 <code>count</code> 聚合将部分计数相加以得出总计。</p>
<p>聚合函数的签名由原始输入数据的类型、
中间结果的类型和最终结果的类型组成。</p>
<p>聚合函数也可以在窗口运算符中使用。以下是在窗口运算符中使用 <code>sum</code> 聚合函数计算运行总计的示例。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">SELECT</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">OVER</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">by</span><span class="token plain"> c </span><span class="token keyword" style="color:#CF222E">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">BY</span><span class="token plain"> d </span><span class="token keyword" style="color:#CF222E">DESC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">FROM</span><span class="token plain"> t</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="memory-layout">内存布局<a href="#memory-layout" class="hash-link" aria-label="Direct link to 内存布局" title="Direct link to 内存布局">​</a></h2>
<p>HashAggregation   运算符将数据存储在行中。每行对应一个唯一的分组键值组合。全局聚合将数据存储在一行中。</p>
<p>聚合函数可以根据其累加器的类型分为三类：</p>
<ul>
<li>固定宽度累加器：</li>
<li><code>count</code>、<code>sum</code>、<code>avg</code></li>
<li><code>min</code>、<code>max</code>、<code>arbitrary</code>（适用于固定宽度类型）</li>
<li>具有仅追加语义的可变宽度累加器：</li>
<li><code>array_agg</code></li>
<li><code>map_agg</code></li>
<li>可变宽度累加器，可以以任何方式修改，而不仅仅是追加。</li>
<li><code>min</code>、<code>max</code>（适用于字符串）</li>
<li><code>arbitrary</code>（适用于可变宽度类型）</li>
<li><code>approx_percentile</code></li>
<li><code>approx_distinct</code></li>
</ul>
<p>累加器的固定宽度部分存储在行中。可变宽度部分（如果存在）使用 :doc:<code>HashStringAllocator &lt;arena&gt;</code> 分配，并将一个指针存储在固定宽度部分中。</p>
<p>行是一个连续的字节缓冲区。如果任何累加器有对齐要求，则行首地址和累加器地址将相应地对齐。数据按以下顺序存储：</p>
<ol>
<li>空标志（每项 1 位）</li>
<li>键（仅当可空时）</li>
<li>累加器</li>
<li>空闲标志（1 位）</li>
<li>键</li>
<li>用于对齐的填充</li>
<li>累加器，仅限固定宽度部分</li>
<li>可变大小（32 位）</li>
<li>用于对齐的填充</li>
</ol>
<!-- -->
<img width="800" align="center" src="[object Object]">
<p>要添加聚合函数，有两种选择：将其实现为
简单函数或向量函数。简单函数接口允许作者编写每次处理一行输入数据的方法，而无需自行处理输入向量编码。然而，简单函
数接口目前存在一些限制，例如不支持对常量输入进行高级性能优化。需要此类功能的聚合函数可以通过向量函数接口实现。
使用向量函数接口，作者可以编写每次处理一个向量的方法，并自行处理输入向量编码。</p>
<ul>
<li>准备：<!-- -->
<ul>
<li>确定输入、中间和最终类型。</li>
<li>确定部分计算和最终计算。</li>
<li>设计累加器。确保同一个累加器可以同时接受原始输入和中间结果。</li>
<li>如果实现的是简单函数，请按照以下说明为该函数创建一个类；如果实现的是向量函数，
请创建一个扩展 <code>pollux::exec::Aggregate</code> 基类的新类（参见 <code>pollux/exec/aggregate.h</code> 文件）并实现虚方法。</li>
</ul>
</li>
<li>使用 <code>exec::registerAggregateFunction(...)</code> 注册新函数。</li>
<li>添加测试。</li>
<li>编写文档。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="simple-function-interface">简单函数接口<a href="#simple-function-interface" class="hash-link" aria-label="Direct link to 简单函数接口" title="Direct link to 简单函数接口">​</a></h2>
<p>本节介绍聚合函数的主要概念和简单接口。通过简单函数接口实现的聚合函数示例可在 <code>tests/exec/simple_average_aggregate.cpp</code>
和 <code>tests/exec/simple_array_agg_aggregate.cpp</code> 中找到。</p>
<p>一个简单的聚合函数以类的形式实现，如下所示。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// array_agg(T) -&gt; array(T) -&gt; array(T)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">class</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ArrayAggAggregate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">public</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Type(s) of input vector(s) wrapped in Row.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">using</span><span class="token plain"> InputType </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> Row</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">Generic</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">T1</span><span class="token operator" style="color:#D73A49">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">using</span><span class="token plain"> IntermediateType </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> Array</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">Generic</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">T1</span><span class="token operator" style="color:#D73A49">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">using</span><span class="token plain"> OutputType </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> Array</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">Generic</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">T1</span><span class="token operator" style="color:#D73A49">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Default is true.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> default_null_behavior_ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">toIntermediate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">out_type</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">Array</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">Generic</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">T1</span><span class="token operator" style="color:#D73A49">&gt;&gt;</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> out</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">optional_arg_type</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">Generic</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">T1</span><span class="token operator" style="color:#D73A49">&gt;&gt;</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Define some function-level variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TypePtr inputType_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TypePtr resultType_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Defined only when the aggregation function needs to use function-level variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// This method is called once when the aggregation function is created.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        core</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">AggregationNode</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Step step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">TypePtr</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> argTypes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> TypePtr</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> resultType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#8250DF">POLLUX_CHECK_EQ</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      inputType_ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> argTypes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resultType_ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> resultType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">AccumulatorType</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>作者在简单聚合函数类中声明函数的输入类型、中间类型和输出类型。即使函数只接受一个参数，
输入类型也必须是函数的参数类型，并封装在 <code>Row&lt;&gt;</code> 中。这是 SimpleAggregateAdapter 正确解析任意聚合函数的输入类型所必需的。</p>
<p>作者可以选择在简单聚合函数类中定义函数级变量。这些变量在创建聚合函数时初始化一次，并在向累加器添
加输入或从累加器提取值时用于每一行。例如，如果聚合函数需要获取结果类型或聚合函数的原始输入类型，则可以将这
些类型定义为聚合类中的成员变量，并在 initialize() 方法中初始化。</p>
<p>作者可以定义一个可选标志 <code>default_null_behavior_</code>，指示聚合函数是否具有默认空行为。此标志默认为 true。接下来，该类
可以包含一个可选方法 <code>toIntermediate()</code>，用于将聚合函数的原始输入直接转换为其中间状态。最后，作者
必须在聚合函数类中定义一个名为 <code>AccumulatorType</code> 的结构体。我们将在下面详细解释每个部分。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="default-null-behavior">默认空值行为<a href="#default-null-behavior" class="hash-link" aria-label="Direct link to 默认空值行为" title="Direct link to 默认空值行为">​</a></h3>
<p>当向累加器添加原始输入或中间状态时，默认为空行为的聚合函数会忽略为空
的输入值。对于包含多列的原始输入，如果该行至少有一列为空，则整行都会被忽略。以下是示例。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">values</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#005CC5">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">as</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bigint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#005CC5">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#005CC5">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">AS</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- NULL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当从累加器生成中间或最终输出结果时，具有默认空值行为的聚合函数会针对无输入行或仅有空
值的行生成空值。下面给出了另一个示例。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">values</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">AS</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">WHERE</span><span class="token plain"> c1 </span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">40</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- NULL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>大多数聚合函数都具有默认为空的行为。SimpleAverageAggregate.cpp 中有一个示例。另一方面，<code>simple_array_agg_aggregate.cpp</code> 中
有一个非默认为空的行为示例。此标志会影响 <code>toIntermediate()</code> 的 C++ 函数签名以及 <code>AccumulatorType</code> 结构体中的方法。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="to_intermediate">升级<a href="#to_intermediate" class="hash-link" aria-label="Direct link to 升级" title="Direct link to 升级">​</a></h3>
<p>作者可以选择定义一个静态方法 <code>toIntermediate()</code>，用于将原始输入转换为中间状态。如果定义了此函数，
则在放弃部分聚合步骤的查询计划中使用此函数。如果聚合函数具有默认为空的行为，则 toIntermediate() 函数会
有一个 <code>exec::out_type&lt;IntermediateType&gt;&amp;</code> 类型的输出参数，后跟 <code>exec::arg_type&lt;T&gt;</code> 类型的输
入参数，用于包装在 InputType 中的每个 <code>T</code>。如果聚合函数具有非默认为空的行为，则 toIntermediate() 的
输入参数将改为 <code>exec::optional_arg_type&lt;T&gt;</code> 类型。</p>
<p>当 <code>T</code> 是除 Varchar 和 Varbinary 之外的原始类型时，<code>exec::arg_type&lt;T&gt;</code> 就是 <code>T</code> 本身，而
<code>exec::out_type&lt;T&gt;</code> 则是 <code>T&amp;</code>。<code>exec::optional_arg_type&lt;T&gt;</code> 则是 <code>std::optional&lt;T&gt;</code>。</p>
<p>当 <code>T</code> 是 Varchar、Varbinary 或复杂类型时，<code>exec::arg_type&lt;T&gt;</code>、<code>exec::optional_arg_type&lt;T&gt;</code>
和 <code>exec::out_type&lt;T&gt;</code> 分别是 <code>T</code> 对应的视图类型和写入类型。详  细解释请参阅 :doc:<code>view-and-writer-types</code>。</p>
<table><thead><tr><th>Default-Null Behavior</th><th>Non-Default-Null Behavior</th></tr></thead><tbody><tr><td><code>static bool SimpleAverageAggregate::toIntermediate(&lt;br&gt;exec::out_type&lt;Row&lt;double, int64_t&gt;&gt;&amp; out,&lt;br&gt;exec::arg_type&lt;T&gt; in)</code></td><td><code>static bool SimpleArrayAggAggregate::toIntermediate(&lt;br&gt;exec::out_type&lt;Array&lt;Generic&lt;T1&gt;&gt;&gt;&amp; out,&lt;br&gt;exec::optional_arg_type&lt;Generic&lt;T1&gt;&gt; in)</code></td></tr></tbody></table>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="accumulator_type-of-default-null-behavior">默认空行为的累加器类型<a href="#accumulator_type-of-default-null-behavior" class="hash-link" aria-label="Direct link to 默认空行为的累加器类型" title="Direct link to 默认空行为的累加器类型">​</a></h3>
<p>对于具有默认空行为的聚合函数，作者定义了一个 <code>AccumulatorType</code> 结构体，如下所示。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">AccumulatorType</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Author defines data members</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Define a pointer to the UDAF class if the aggregation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// function uses function-level variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ArrayAggAggregate</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> fn_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Default is true.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> is_fixed_size_ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Default is false.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> use_external_memory_ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Default is false.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> is_aligned_ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">explicit</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">AccumulatorType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HashStringAllocator</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ArrayAggAggregate</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> fn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">fn_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">addInput</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HashStringAllocator</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">arg_type</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">T1</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"> value1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">combine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HashStringAllocator</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">arg_type</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">IntermediateType</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"> other</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">writeIntermediateResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">out_type</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">IntermediateType</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">writeFinalResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">out_type</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">OutputType</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Called during destruction.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">destroy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HashStringAllocator</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>作者定义了一个可选标志<code>is_fixed_size_</code>，指示每个累加器是否占用固定大小的内存。此标志默认为 true。
接下来，作者定义了另一个可选标志<code>use_external_memory_</code>，指示累加器是否使用 Pollux 未跟踪的内存。
此标志默认为 false。然后，作者可以定义一个可选标志<code>is_aligned_</code>，指示累加器是否需要对齐访问。此标志默认为 false。</p>
<p>作者定义了一个构造函数，该构造函数接受一个参数：
<code>HashStringAllocator*</code>。此构造函数在聚合开始之前调用，用于初始化所有累加器。</p>
<p>作者还可以选择定义一个 <code>destroy</code> 函数，该函数在
<em>此</em>累加器对象被析构时调用。</p>
<p>请注意，<code>writeIntermediateResult</code> 和 <code>writeFinalResult</code> 不应修改累加器中的内容。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="addInput">添加输入<a href="#addInput" class="hash-link" aria-label="Direct link to 添加输入" title="Direct link to 添加输入">​</a></h4>
<p>此方法将原始输入值添加到 <em>this</em> 累加器。它接收一个 <code>HashStringAllocator*</code> 后跟 <code>exec::arg_type&lt;T1&gt;</code> 类型的值，每个参数类型 <code>Ti</code> 都包装在 InputType 中。</p>
<p>在默认为空的情况下，在调用 <code>addInput</code> 之前，至少有一列为空的原始输入行将被忽略。调用 <code>addInput</code> 后，<em>this</em> 累加器将被假定为非空。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="合并combine">合并(combine)<a href="#合并combine" class="hash-link" aria-label="Direct link to 合并(combine)" title="Direct link to 合并(combine)">​</a></h4>
<p>此方法将一个输入中间状态添加到 <em>this</em> 累加器。它接收一个 <code>HashStringAllocator*</code> 和一个 <code>exec::arg_type&lt;IntermediateType&gt;</code>
值。在 default-null 行为下，在调用 <code>combine</code> 之前，输入中间状态中的空值将被忽略。调用 <code>combine</code> 之后，<em>this</em> 累加器将被假定为非空。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="写入中间结果writeintermediateresult">写入中间结果(writeIntermediateResult)<a href="#写入中间结果writeintermediateresult" class="hash-link" aria-label="Direct link to 写入中间结果(writeIntermediateResult)" title="Direct link to 写入中间结果(writeIntermediateResult)">​</a></h4>
<p>此方法将<em>此</em>累加器写入中间状态向量。它有一个类型为 <code>exec::out_type&lt;IntermediateType&gt;&amp;</code> 的输出参数。如果将
非空值写入 <code>out</code>，则此方法返回 true；否则返回 false，表示应将空值写入中间状态向量。如果累加器为空（即未向其添
加任何值），则在中间状态向量中将自动变为空值，而无需调用 <code>writeIntermediateResult</code>。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="写入最终结果writefinalresult">写入最终结果(writeFinalResult)<a href="#写入最终结果writefinalresult" class="hash-link" aria-label="Direct link to 写入最终结果(writeFinalResult)" title="Direct link to 写入最终结果(writeFinalResult)">​</a></h4>
<p>此方法将<em>此</em>累加器写入最终结果向量。它
具有一个 <code>exec::out_type&lt;OutputType&gt;&amp;</code> 类型的输出参数。如果将非空值写入 <code>out</code>，则此方
法返回 true；否则返回 false，表示应将空值写入最终结果向量。为空（即未向其添加任何值）的累加器在最终结果
向量中将自动变为空值，而无需调用 <code>writeFinalResult</code>。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="非默认空行为的-accumulatortypeaccumulatortype-of-non-default-null-behavior">非默认空行为的 AccumulatorType(AccumulatorType of Non-Default-Null Behavior)<a href="#非默认空行为的-accumulatortypeaccumulatortype-of-non-default-null-behavior" class="hash-link" aria-label="Direct link to 非默认空行为的 AccumulatorType(AccumulatorType of Non-Default-Null Behavior)" title="Direct link to 非默认空行为的 AccumulatorType(AccumulatorType of Non-Default-Null Behavior)">​</a></h3>
<p>对于非默认空行为的聚合函数，作者定义了一个 <code>AccumulatorType</code> 结构体，如下所示。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">AccumulatorType</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Author defines data members</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Default is true.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> is_fixed_size_ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Default is false.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> use_external_memory_ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional. Default is false.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> is_aligned_ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">explicit</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">AccumulatorType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HashStringAllocator</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ArrayAggAggregate</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> fn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">addInput</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HashStringAllocator</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">optional_arg_type</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">T1</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"> value1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">combine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HashStringAllocator</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">optional_arg_type</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">IntermediateType</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"> other</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">writeIntermediateResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> nonNullGroup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">out_type</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">IntermediateType</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">writeFinalResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> nonNullGroup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">out_type</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">OutputType</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Optional.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">destroy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HashStringAllocator</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>is_fixed_size_</code>、<code>use_external_memory_</code>、
<code>is_aligned_</code>、构造函数和 <code>destroy</code> 方法的定义与 <code>default-null</code> 行为完全相同。</p>
<p>另一方面，<code>addInput</code>、<code>combine</code>、
<code>writeIntermediateResult</code> 和 <code>writeFinalResult</code> 的 C++ 函数签名不同。</p>
<p>与 default-null 行为的情况相同，<code>writeIntermediateResult</code> 和
<code>writeFinalResult</code> 不应修改累加器中的内容。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="addinput">addInput<a href="#addinput" class="hash-link" aria-label="Direct link to addInput" title="Direct link to addInput">​</a></h4>
<p>此方法接收一个 <code>HashStringAllocator*</code> 值，后跟 <code>exec::optional_arg_type&lt;T1&gt;</code> 值，每个值对应一个封装在 InputType 中的参数类型 <code>Ti</code>。</p>
<p>即使某些列可能为空，也会对所有原始输入行调用此方法。
它返回一个布尔值，表示调用后 <em>此</em> 累加器是否为非空。所有累加器在聚合开始前都会初始化为 <em>null</em>。
原本为空的累加器可以转换为非空。  但
原本为非空的累加器无论 <code>addInput</code> 的返回值如何，都将保持非空状态。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="combine">combine<a href="#combine" class="hash-link" aria-label="Direct link to combine" title="Direct link to combine">​</a></h4>
<p>此方法接收一个 <code>HashStringAllocator*</code> 和一个 <code>exec::optional_arg_type&lt;IntermediateType&gt;</code> 值。所有中间状态都会
调用此方法，即使某些中间状态为空。与 <code>addInput</code> 相同，此方法返回一个布尔值，表示调用后 <em>此</em> 累加器是否为非空。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="writeintermediateresult">writeIntermediateResult<a href="#writeintermediateresult" class="hash-link" aria-label="Direct link to writeIntermediateResult" title="Direct link to writeIntermediateResult">​</a></h4>
<p>此方法具有一个类型为 <code>exec::out_type&lt;IntermediateType&gt;&amp;</code> 的输出参数，以及一个布尔标志
<code>nonNullGroup</code>，用于指示<em>此</em>累加器是否为非空。如果将非空值写入 <code>out</code>，则此方法返回 true；否则，返回 false，表示应将空值写入中间状态向量。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="writefinalresult">writeFinalResult<a href="#writefinalresult" class="hash-link" aria-label="Direct link to writeFinalResult" title="Direct link to writeFinalResult">​</a></h4>
<p>此方法将<em>此</em>累加器写入最终结果向量。它有一个类型为 <code>exec::out_type&lt;OutputType&gt;&amp;</code> 的输出参数，以
及一个布尔值标志 <code>nonNullGroup</code>，用于指示<em>此</em>累加器是否为非空。如果将非空值写入 <code>out</code>，则此方法返回 true；否则，返回 false，表示应将
空值写入最终结果向量。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="limitations">Limitations<a href="#limitations" class="hash-link" aria-label="Direct link to Limitations" title="Direct link to Limitations">​</a></h3>
<p>简单聚合函数接口目前有三个限制。</p>
<ol>
<li>
<p>聚合函数读取或写入的所有值都必须是累加器的一部分。这意味着函数级状态不能保存在累加器之外。</p>
</li>
<li>
<p>不支持对常量输入进行优化。也就是说，常量输入参数每行处理一次，处理方式与非常量输入相同。</p>
</li>
<li>
<p>目前尚不支持聚合下推到表扫描。我们计划添加此支持。</p>
</li>
</ol>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="vector-function-interface">Vector Function Interface<a href="#vector-function-interface" class="hash-link" aria-label="Direct link to Vector Function Interface" title="Direct link to Vector Function Interface">​</a></h2>
<p>不能使用简单函数接口的聚合函数可以写成向量函数。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="accumulator-size">Accumulator size<a href="#accumulator-size" class="hash-link" aria-label="Direct link to Accumulator size" title="Direct link to Accumulator size">​</a></h3>
<p><code>pollux::exec::Aggregate</code> 接口的实现可以从 <em>accumulatorFixedWidthSize()</em> 方法开始。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Returns the fixed number of bytes the accumulator takes on a group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// row. Variable width accumulators will reference the variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// width part of the state from the fixed part.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">accumulatorFixedWidthSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果累加器需要特定的对齐，则需要实现 <code>*accumulatorAlignmentSize()*</code> 方法。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// Returns the alignment size of the accumulator.  Some types such as</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// int128_t require aligned access.  This value must be a power of 2.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">accumulatorAlignmentSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>HashAggregation 运算符在初始化期间使用这些方法来计算行的总大小，并确定不同聚合将存储其数据的偏移量。然后，该运算符为每个聚合调用
<code>pollux::exec::Aggregate::setOffsets</code> 方法来指定累加器的位置。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Sets the offset and null indicator position of &#x27;this&#x27;.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param offset Offset in bytes from the start of the row of the accumulator</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param nullByte Offset in bytes from the start of the row of the null flag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param nullMask The specific bit in the nullByte that stores the null flag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param initializedByte Offset in bytes from the start of the row of the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// initialized flag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param initializedMask The specific bit in the initializedByte that stores</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// the initialized flag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param rowSizeOffset The offset of a uint32_t row size from the start of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// the row. Only applies to accumulators that store variable size data out of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// line. Fixed length accumulators do not use this. 0 if the row does not have</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// a size field.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">setOffsets</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> nullByte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">uint8_t</span><span class="token plain"> nullMask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> initializedByte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">int8_t</span><span class="token plain"> initializedMask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> rowSizeOffset</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>基类通过将偏移量存储在成员变量中来实现 setOffsets 方法。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Byte position of null flag in group row.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> nullByte_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">uint8_t</span><span class="token plain"> nullMask_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Byte position of the initialized flag in group row.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> initializedByte_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">uint8_t</span><span class="token plain"> initializedMask_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Offset of fixed length accumulator state in group row.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> offset_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Offset of uint32_t row byte size of row. 0 if there are no</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// variable width fields or accumulators on the row.  The size is</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// capped at 4G and will stay at 4G and not wrap around if growing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// past this. This serves to track the batch size when extracting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// rows. A size in excess of 4G would finish the batch in any case,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// so larger values need not be represented.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> rowSizeOffset_ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通常，聚合函数不会直接使用偏移量，而是使用基类中的辅助方法。</p>
<p>要访问累加器，请执行以下操作：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">template</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token keyword" style="color:#CF222E">typename</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">T</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      T</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> group</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token generic-function function" style="color:#8250DF">reinterpret_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name" style="color:#116329">T</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">group </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> offset_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>要操作空标志：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">isNull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> group</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Sets null flag for all specified groups to true.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// For any given group, this method can be called at most once.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">setAllNulls</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> groups</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> melon</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Range</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> vector_size_t</span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"> indices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">clearNull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> group</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="initialization">Initialization<a href="#initialization" class="hash-link" aria-label="Direct link to Initialization" title="Direct link to Initialization">​</a></h3>
<p>一旦有了 accumulatorFixedWidthSize()，下一个要实现的方法就是 initializeNewGroupsInternal()。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Initializes null flags and accumulators for newly encountered groups.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param groups Pointers to the start of the new group rows.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param indices Indices into &#x27;groups&#x27; of the new entries.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">initializeNewGroupsInternal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> groups</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          melon</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Range</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> vector_size_t</span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"> indices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>每次遇到新的分组键组合时，HashAggregation 运算符都会调用此方法。此方法应该初始化新组的累加器。
例如，部分“count”和“sum”聚合会将累加器设置为零。许多聚合函数会通过调用 <code>exec::Aggregate::setAllNulls(groups, indices)</code>
辅助方法将空值标志设置为 true。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="groupby-aggregation">GroupBy aggregation<a href="#groupby-aggregation" class="hash-link" aria-label="Direct link to GroupBy aggregation" title="Direct link to GroupBy aggregation">​</a></h3>
<p>此时，您已实现 accumulatorFixedWidthSize() 和 initialiseNewGroupsInternal() 方法。现在，
我们可以继续实现端到端的分组聚合。我们需要以下部分：</p>
<ul>
<li>将原始输入添加到累加器的逻辑：</li>
<li>addRawInput() 方法。</li>
<li>从累加器生成中间结果的逻辑：</li>
<li>extractAccumulators() 方法。</li>
<li>将中间结果添加到累加器的逻辑：</li>
<li>addIntermediateResults() 方法。</li>
<li>从累加器生成最终结果的逻辑：</li>
<li>extractValues() 方法。</li>
<li>将先前溢出的数据添加回累加器的逻辑：</li>
<li>addSingleGroupIntermediateResults() 方法。</li>
<li>将原始输入转换为中间结果的可选逻辑：</li>
<li>supportToIntermediate() 和 toIntermediate() 方法。</li>
</ul>
<p>有些方法仅用于部分聚合工作流。下表显示了哪些方法用于哪些工作流。</p>
<table><thead><tr><th>Method</th><th>Partial</th><th>Final</th><th>Single</th><th>Intermediate</th><th>Streaming</th></tr></thead><tbody><tr><td>addRawInput</td><td>Y</td><td>N</td><td>Y</td><td>N</td><td>Y</td></tr><tr><td>extractAccumulators</td><td>Y</td><td>Y (used for spilling)</td><td>Y (used for spilling)</td><td>Y</td><td>Y</td></tr><tr><td>addIntermediateResults</td><td>N</td><td>Y</td><td>N</td><td>Y</td><td>Y</td></tr><tr><td>extractValues</td><td>N</td><td>Y</td><td>Y</td><td>N</td><td>Y</td></tr><tr><td>addSingleGroupIntermediateResults</td><td>N</td><td>Y</td><td>Y</td><td>N</td><td>N</td></tr><tr><td>toIntermediate</td><td>Y</td><td>N</td><td>N</td><td>N</td><td>N</td></tr></tbody></table>
<p>我们从 addRawInput() 方法开始，该方法接收原始输入向量并将数据添加到累加器。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Updates the accumulator in &#x27;groups&#x27; with the values in &#x27;args&#x27;.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param groups Pointers to the start of the group rows. These are aligned</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// with the &#x27;args&#x27;, e.g. data in the i-th row of the &#x27;args&#x27; goes to the i-th group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// The groups may repeat if different rows go into the same group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param rows Rows of the &#x27;args&#x27; to add to the accumulators. These may not be</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// contiguous if the aggregation is configured to drop null grouping keys.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// This would be the case when aggregation is followed by the join on the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// grouping keys.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param args Data to add to the accumulators.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param mayPushdown True if aggregation can be pushdown down via LazyVector.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// The pushdown can happen only if this flag is true and &#x27;args&#x27; is a single</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// LazyVector.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">addRawInput</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> groups</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> SelectivityVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">VectorPtr</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> mayPushdown </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>addRawInput() 方法会使用 DecodedVector 来解码输入数据。然后，循环遍历行来更新累加器。为每个输入向量定义一个 DecodedVector
类型的成员变量是一种很好的做法。这样可以在输入批次之间重用解码输入所需的内存。</p>
<p>实现 addRawInput() 方法后，我们继续添加用于提取中间结果的逻辑。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Extracts partial results (used for partial and intermediate aggregations).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// This method is expected to not modify contents in accumulators.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param groups Pointers to the start of the group rows.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param numGroups Number of groups to extract results from.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param result The result vector to store the results in.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#8250DF">extractAccumulators</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> groups</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> numGroups</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VectorPtr</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接下来，我们实现接收中间结果并更新累加器的 addIntermediateResults() 方法。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">addIntermediateResults</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> groups</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> SelectivityVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">VectorPtr</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> mayPushdown </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接下来，我们实现从累加器中提取最终结果的 extractValues() 方法。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Extracts final results (used for final and single aggregations). This method</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// is expected to not modify contents in accumulators.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param groups Pointers to the start of the group rows.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param numGroups Number of groups to extract results from.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param result The result vector to store the results in.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#8250DF">extractValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> groups</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">int32_t</span><span class="token plain"> numGroups</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VectorPtr</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后，我们实现 addSingleGroupIntermediateResults() 方法，用于将先前溢出的数据添加回累加器。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Updates the single final accumulator from intermediate results for global</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// aggregation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param group Pointer to the start of the group row.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param rows Rows of the &#x27;args&#x27; to add to the accumulators. These may not</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// be contiguous if the aggregation has mask. &#x27;rows&#x27; is guaranteed to have at</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// least one active row.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param args Intermediate results produced by extractAccumulators().</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param mayPushdown True if aggregation can be pushdown down via LazyVector.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// The pushdown can happen only if this flag is true and &#x27;args&#x27; is a single</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// LazyVector.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">addSingleGroupIntermediateResults</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> group</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> SelectivityVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">VectorPtr</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> mayPushdown</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后，我们可以实现可选方法，将原始输入转换为中间结果。如果部分聚合遇到的键大多是唯一的，并且无法有效地降低基数，则运算
符可以决定放弃部分聚合。在这种情况下，运算符首先发出已累积的数据（例如由于内存压力而刷新的情况），然后将每一批新的输入
转换为中间结果并立即发出。默认情况下，为了将原始输入转换为中间结果，运算符会为每个输入行创建一个虚拟组，通过调用
initializeNewGroups初始化这些组，使用addRawInput将每行添加到其自己 的组中，然后调用extractAccumulators。
这种方法有效，但效率不高。各个聚合函数可以通过实现toIntermediate()方法来提供更高效的实现。如果它们决定这样做，
它们也应该重写supportsToIntermediate()方法。例如，min和max聚合函数实现了toIntermediate()方法，该方法仅返回未修改的输入。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// Returns true if toIntermediate() is supported.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">supportsToIntermediate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// Produces an accumulator initialized from a single value for each</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// row in &#x27;rows&#x27;. The raw arguments of the aggregate are in &#x27;args&#x27;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// which have the same meaning as in addRawInput. The result is</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// placed in &#x27;result&#x27;. &#x27;result&#x27; is expected to be a writable flat vector of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// the right type.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">///</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// @param rows A set of rows to produce intermediate results for. The</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// &#x27;result&#x27; is expected to have rows.size() rows. Invalid rows represent rows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// that were masked out, these need to have correct intermediate results as</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// well. It is possible that all entries in &#x27;rows&#x27; are invalid (masked out).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">toIntermediate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> SelectivityVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">VectorPtr</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      VectorPtr</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">POLLUX_NYI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;toIntermediate not supported&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>GroupBy 聚合代码路径已完成。我们继续进行全局聚合。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="global-aggregation">Global aggregation<a href="#global-aggregation" class="hash-link" aria-label="Direct link to Global aggregation" title="Direct link to Global aggregation">​</a></h3>
<p>全局聚合与分组聚合类似，但只有一个组和一个累加器。实现分组聚合后，只需实现 addSingleGroupRawInput() 方
法即可启用全局聚合（addSingleGroupIntermediateResults() 方法已实现，因为它用于溢出分组）。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Updates the single accumulator used for global aggregation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param group Pointer to the start of the group row.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param allRows A contiguous range of row numbers starting from 0.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param args Data to add to the accumulators.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// @param mayPushdown True if aggregation can be pushdown down via LazyVector.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// The pushdown can happen only if this flag is true and &#x27;args&#x27; is a single</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// LazyVector.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">addSingleGroupRawInput</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> group</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> SelectivityVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> allRows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">VectorPtr</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> mayPushdown</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>溢出对全局聚合无益，因此不支持。下表显示了不同全局聚合工作流中使用的方法。</p>
<table><thead><tr><th>Method</th><th>Partial</th><th>Final</th><th>Single</th><th>Intermediate</th><th>Streaming</th></tr></thead><tbody><tr><td>addSingleGroupRawInput</td><td>Y</td><td>N</td><td>Y</td><td>N</td><td>Y</td></tr><tr><td>extractAccumulators</td><td>Y</td><td>N</td><td>N</td><td>Y</td><td>Y</td></tr><tr><td>addSingleGroupIntermediateResults</td><td>N</td><td>Y</td><td>N</td><td>Y</td><td>Y</td></tr><tr><td>extractValues</td><td>N</td><td>Y</td><td>Y</td><td>N</td><td>Y</td></tr></tbody></table>
<p>窗口运算符也使用全局聚合。对于每一行，都会清除全局累加器 <code>(clear + initializeNewGroups)</code>，然后添加窗口框架中的所有行 (addSingleGroupRawInput)，最后提取结果 (extractValues)。</p>
<p>计算累计总数时，即当窗口框架位于 UNBOUNDED PRECEDING AND CURRENT ROW 之间时，窗口运算符会重复使用累加器进行多行计算，而无需重置
。对于每一行，窗口运算符都会将该行添加到累加器，然后提取结果。聚合函数会发现 addSingleGroupRawInput + extractValues 调用的重复序列，因此需要正确处理这些调用。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="factory-function">Factory function<a href="#factory-function" class="hash-link" aria-label="Direct link to Factory function" title="Direct link to Factory function">​</a></h2>
<p>现在，我们可以编写一个工厂函数来创建新聚合函数的实例，并通过调用 exec::registerAggregateFunction
(...) 并指定函数名称和签名来注册它。</p>
<p>HashAggregation 运算符使用此函数创建聚合函数的实例。每个执行线程都会创建一个新实例。当
部分聚合在 5 个线程上运行时，它将使用每个聚合函数的 5 个实例。</p>
<p>工厂函数接受 <code>core::AggregationNode::Step</code>
(<code>partial/final/intermediate/single</code>)，它指定预期的输入类型、输入类型和结果类型。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">AggregateRegistrationResult </span><span class="token function" style="color:#8250DF">registerApproxPercentile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">AggregateFunctionSignature</span><span class="token operator" style="color:#D73A49">&gt;&gt;</span><span class="token plain"> signatures</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">registerAggregateFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">move</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">signatures</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  core</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">AggregationNode</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Step step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">TypePtr</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> argTypes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> TypePtr</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> resultType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">unique_ptr</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Aggregate</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">step </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> core</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">AggregationNode</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Step</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">kIntermediate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#8250DF">make_unique</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name" style="color:#116329">ApproxPercentileAggregate</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">double</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">VARBINARY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> hasWeight </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> argTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TypePtr type </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isRawInput</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">?</span><span class="token plain"> argTypes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> resultType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">kind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#CF222E">case</span><span class="token plain"> TypeKind</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BIGINT</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#8250DF">make_unique</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name" style="color:#116329">ApproxPercentileAggregate</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">int64_t</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        hasWeight</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resultType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#CF222E">case</span><span class="token plain"> TypeKind</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">DOUBLE</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#8250DF">make_unique</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name" style="color:#116329">ApproxPercentileAggregate</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">double</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        hasWeight</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resultType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">FB_ANONYMOUS_VARIABLE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">g_AggregateFunction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#8250DF">registerApproxPercentile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kApproxPercentile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果聚合函数是通过简单函数接口实现的，则在创建唯一指针时使用 <code>SimpleAggregateAdapter&lt;FunctionClassName&gt;</code>。以下是示例。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">AggregateRegistrationResult </span><span class="token function" style="color:#8250DF">registerSimpleArrayAggAggregate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">registerAggregateFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">move</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">signatures</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          core</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">AggregationNode</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Step step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">TypePtr</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> argTypes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> TypePtr</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> resultType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> core</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">QueryConfig</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/*config*/</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">unique_ptr</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Aggregate</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">POLLUX_CHECK_EQ</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            argTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;{} takes at most one argument&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#8250DF">make_unique</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name" style="color:#116329">SimpleAggregateAdapter</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name" style="color:#116329">SimpleArrayAggAggregate</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argTypes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resultType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用 FunctionSignatureBuilder 创建 FunctionSignature 实例，该实例描述支持的签名。每个签名包含零个或多个输入类型、一个中间结果类型和最终结果类型。</p>
<p>FunctionSignatureBuilder 和 FunctionSignature 支持类似 Java 的泛型、可变数量的参数和 lambda 表达式。更多信息请参阅 <code>scalar-functions</code> 指南中的
:ref:<code>function-signature</code> 部分。</p>
<p>以下是 <code>approx_percentile</code> 函数的签名示例。该函数接受一个数值类型的值参数、一个可选的 INTEGER 类型的权重参数和一个 DOUBLE 类型的百分
比参数。中间类型与输入类型无关，始终为 VARBINARY。最终结果类型与输入值类型相同。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">auto</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> inputType </span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#C6105F">&quot;tinyint&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;smallint&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;integer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;bigint&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;real&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;double&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// (x, double percentage) -&gt; varbinary -&gt; x</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            signatures</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">AggregateFunctionSignatureBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">returnType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">intermediateType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;varbinary&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">argumentType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">argumentType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;double&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// (x, integer weight, double percentage) -&gt; varbinary -&gt; x</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            signatures</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exec</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">AggregateFunctionSignatureBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">returnType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">intermediateType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;varbinary&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">argumentType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">argumentType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;bigint&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">argumentType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;double&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="testing">Testing<a href="#testing" class="hash-link" aria-label="Direct link to Testing" title="Direct link to Testing">​</a></h2>
<p>现在是时候将所有部分组合在一起，并测试新函数的运行效果了。</p>
<p>使用 <code>pollux/aggregates/tests/AggregationTestBase.h</code> 中的 AggregationTestBase 作为测试的基类。</p>
<p>如果 <a href="https://duckdb.org/docs/sql/aggregates" target="_blank" rel="noopener noreferrer">DuckDB</a> 支持新的聚合函数，您可以使用 DuckDB 检查结果。在这种情况下，
您需要指定输入数据、分组键、聚合列表以及要在 DuckDB 上运行的 SQL 查询以计算预期结果，并调用 AggregationTestBase 类中定义的辅助  函数 testAggregates。
对于全局聚合，分组键可以为空。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Global aggregation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">testAggregations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vectors</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#C6105F">&quot;sum(c1)&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;SELECT sum(c1) FROM tmp&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Group by aggregation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">testAggregations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vectors</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#C6105F">&quot;c0&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#C6105F">&quot;sum(c1)&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;SELECT c0, sum(c1) FROM tmp GROUP BY 1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果 DuckDB 不支持该新功能，您需要手动指定预期结果。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Global aggregation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">testAggregations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vectors</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#C6105F">&quot;map_union(c1)&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expectedResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Group by aggregation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">testAggregations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vectors</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#C6105F">&quot;c0&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#C6105F">&quot;map_union(c1)&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expectedResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>testAggregations 方法在后台生成多个不同但逻辑上等效的计划，执行这些计划，验证是否成功完成，并将结果与​​ DuckDB 或指定的预期结果进行比较。</p>
<p>正在测试以下查询计划。</p>
<ul>
<li>部分聚合，然后进行最终聚合。查询以单线程运行。</li>
<li>单次聚合。查询以单线程运行。</li>
<li>部分聚合，然后进行中间聚合，然后进行最终聚合。查询以单线程运行。</li>
<li>部分聚合，然后进行分组键的本地交换，然后进行最终聚合。查询使用 4 个线程运行。</li>
<li>使用循环重新分区的本地交换，然后进行部分聚合，然后进行分组键的本地交换，然后进行强制溢出的最终聚合。查询使用 4 个线程运行。</li>
</ul>
<p>强制溢出查询仅适用于分组聚合，并且
且仅当聚合函数对顺序不敏感时才启用。溢出测试需要多批次输入。
为了将输入数据拆分为多个批次，我们在部分聚合之前添加了本地交换和
循环重新分区。这会改变聚合输入的处理顺序，因此，只有当查询中使用的聚合函数对输入顺序不敏感时，溢出查询的结果才预期与不溢出查询的结果相同。许多
函数无论输入顺序如何都会产生相同的结果，但某些函数可能会在输入顺序不同的情况下返回不同的结果。例如，<code>arbitrary</code>、<code>array_agg</code>、<code>map_agg</code> 和 <code>map_union</code> 函数对输入顺序敏感，
而 <code>min_by</code> 和 <code>max_by</code> 函数在存在关联的情况下对输入顺序敏感。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="function-names">Function names<a href="#function-names" class="hash-link" aria-label="Direct link to Function names" title="Direct link to Function names">​</a></h2>
<p>与标量函数一样，聚合函数名称不区分大小写。函数注册时以及解析给定表达式时，名称会自动转换为小写。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="documentation">Documentation<a href="#documentation" class="hash-link" aria-label="Direct link to Documentation" title="Direct link to Documentation">​</a></h2>
<p>最后，通  过在 pollux/docs/functions/presto/aggregate.rst 文件中添加一个条目来记录新函数。</p>
<p>您可以在 <code>../functions/presto/aggregate</code> 查看所有函数的文档。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="accumulator">Accumulator<a href="#accumulator" class="hash-link" aria-label="Direct link to Accumulator" title="Direct link to Accumulator">​</a></h2>
<p>在 Pollux 中，高效利用内存是首要任务。这包括优化
内存使用总量以及内存分配次数。
请注意，Pollux 报告的运行时统计信息包括每个运算符的峰值内存使用量（以字节为单位）和内存分配次数。</p>
<p>聚合函数使用内存将中间结果存储在累加器中。它们从 arena（:doc:<code>HashStringAllocator &lt;arena&gt;</code> 类）分配内存。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="array_agg-and-valuelist">array_agg and ValueList<a href="#array_agg-and-valuelist" class="hash-link" aria-label="Direct link to array_agg and ValueList" title="Direct link to array_agg and ValueList">​</a></h3>
<p>StlAllocator 是一个兼容 STL 的分配器，由 HashStringAllocator 支持，
可以与 STL 容器一起使用。例如，可以定义一个 <code>std::vector</code>，
从 arena 中分配内存，如下所示：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token keyword" style="color:#CF222E">int64_t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> StlAllocator</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token keyword" style="color:#CF222E">int64_t</span><span class="token operator" style="color:#D73A49">&gt;&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>例如，这在带有固定宽度类型输入（例如整数）的 3 参数版本的 <code>min_by</code> 和 <code>max_by</code> 中得到使用。</p>
<p>还有一个 AlignedStlAllocator，它提供从 arena 进行对齐分配的功能，
并且可以与需要 16 字节对齐的 <code>F14 &lt;https://engineering.fb.com/2019/04/25/developer-tools/f14/&gt;</code> 容器一起使用。可以定义一个 F14FastMap，
从 arena 分配内存，如下所示：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   melon</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">F14FastMap</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#CF222E">int64_t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#CF222E">double</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">hash</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token keyword" style="color:#CF222E">int64_t</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">equal_to</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token keyword" style="color:#CF222E">int64_t</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         AlignedStlAllocator</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">pair</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">int64_t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">double</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">16</span><span class="token operator" style="color:#D73A49">&gt;&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>您可以在 <code>histogram</code> 聚合函数中找到一个示例用法。</p>
<p>可以使用 <code>std::vector&lt;T&gt;</code> 实现针对原始类型的 <code>array_agg</code> 函数，但效率不高。为什么呢？如果不使用 <code>reserve</code> 方法向 <code>std::vector</code>
提供关于将添加多少个条目的提示，则默认行为是按 2 的幂分配内存，例如，首先分配 1 个条目，然后分配 2 个，然后是 4 个、8 个、16 个等
等。每次进行新的分配时，数据都会复制到新的内存缓冲区中，并释放旧缓冲区。您可以通过检测 <code>StlAllocator::allocate</code> 和
deallocate 方法添加日志记录并运行一个简单的循环来向向量添加元素来查看这一点：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token keyword" style="color:#CF222E">double</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> StlAllocator</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token keyword" style="color:#CF222E">double</span><span class="token operator" style="color:#D73A49">&gt;&gt;</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token generic-function function" style="color:#8250DF">StlAllocator</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">double</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allocator_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> i </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.717708 975289 HashStringAllocator.h:497] allocate 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734280 975289 HashStringAllocator.h:497] allocate 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734321 975289 HashStringAllocator.h:506] free 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734352 975289 HashStringAllocator.h:497] allocate 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734381 975289 HashStringAllocator.h:506] free 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734416 975289 HashStringAllocator.h:497] allocate 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734445 975289 HashStringAllocator.h:506] free 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734481 975289 HashStringAllocator.h:497] allocate 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734513 975289 HashStringAllocator.h:506] free 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734544 975289 HashStringAllocator.h:497] allocate 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734575 975289 HashStringAllocator.h:506] free 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734606 975289 HashStringAllocator.h:497] allocate 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734637 975289 HashStringAllocator.h:506] free 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734668 975289 HashStringAllocator.h:497] allocate 128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734699 975289 HashStringAllocator.h:506] free 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E20230714 14:57:33.734731 975289 HashStringAllocator.h:506] free 128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>重新分配内存和复制数据并不便宜。为了避免这种开销，我们
引入了 ValueList 原语，并用它来实现 array_agg。</p>
<p>ValueList 是一种仅追加的数据结构，允许从任何 Pollux Vector 追加值，并将值读回 Pollux Vector。ValueList 不需
要连续的内存块，因此在空间不足时无需重新分配和复制。它只需分配另一个内存块并开始填充即可。</p>
<p>ValueList 旨在处理来自 Pollux Vector 的数据，因此，
它的 API 与 <code>std::vector</code> 不同。您可以从 DecodedVector 追加值，
并将值读回平面 Vector。以下是使用示例：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   DecodedVector </span><span class="token function" style="color:#8250DF">decoded</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Store data.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ValueList values</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> i </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">appendValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">decoded</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">allocator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Read data back.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> copy </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">BaseVector</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">DOUBLE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">pool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   aggregate</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">ValueListReader </span><span class="token function" style="color:#8250DF">reader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> i </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ValueList 支持所有类型，因此您可以使用它来附加固定宽度的值以及字符串、数组、映射和结构体。</p>
<p>存储复杂类型时，ValueList 使用 ContainerRowSerde 对值进行序列化。</p>
<p>ValueList 还保留了空值标志，因此您可以在其中存储可空值的列表。</p>
<p>array_agg 是使用 ValueList 实现的累加器。</p>
<p>ValueList 需要一个指向存储区的指针来附加数据。它在构造函数中不接受存储区，也不会存储它，因为那样在聚合运算符中每个组需
要 8 个字节的内存。相反，<code>ValueList::appendValue</code> 方法接受一个指向存储区的指针作为参数。
因此，ValueList 的析构函数无法将内存释放回存储区，需要用户显式调用 free(HashStringAllocator*) 方法。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="min-max-and-singlevalueaccumulator">min, max, and SingleValueAccumulator<a href="#min-max-and-singlevalueaccumulator" class="hash-link" aria-label="Direct link to min, max, and SingleValueAccumulator" title="Direct link to min, max, and SingleValueAccumulator">​</a></h3>
<p><code>min</code> 和 <code>max</code> 函数将单个值存储在累加器中（当前最小值或最大值）。它们使用 SingleValueAccumulator 存储字符串、数组、
Map 和结构体。处理新值时，我们会将其与存储的值进行比较，并在必要时替换存储的值。</p>
<p>与 ValueList 类似，SingleValueAccumulator 使用 ContainerRowSerde 序列化值。SingleValueAccumulator 提供了一个 compare 方法，用于将存储的值与 DecodedVector 的一行进行比较。</p>
<p>此累加器也用于实现 <code>arbitrary</code> 聚合函数，该函数将第一个值存储在累加器中。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="set_agg-set_union-strings-and-addressablenonnullvaluelist">set_agg, set_union, Strings and AddressableNonNullValueList<a href="#set_agg-set_union-strings-and-addressablenonnullvaluelist" class="hash-link" aria-label="Direct link to set_agg, set_union, Strings and AddressableNonNullValueList" title="Direct link to set_agg, set_union, Strings and AddressableNonNullValueList">​</a></h3>
<p><code>set_agg</code> 函数将一组唯一值累积到一个 <code>melon::F14FastSet</code> 中，该集合配置为通过 AlignedStlAllocator 从 arena 分配内存。
固定宽度的值直接存储在 <code>melon::F14FastSet</code> 中。F14 数据结构的内存分配模式与 <code>std::vector</code> 类似。F14 以幂 2 的方式分配内存，
复制数据并释放先前分配的内存。因此，我们不会将字符串直接存储在 F14 集合中。相反，Pollux 会将字符串写入 arena，并在集合中存储一个指向该 arena 的 StringView。</p>
<p>通常，写入 arena 时，无法保证写入的连续性。
但是，为了使 StringView 正常工作，我们必须确保写入 arena 的字符串是连续的。Strings 辅助类提供了此功能。它的
append 方法接受一个 StringView 和一个指向 arena 的指针，将字符串复制到 arena 中，并返回一个指向副本的 StringView。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// Copies the string into contiguous memory allocated via</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// HashStringAllocator. Returns StringView over the copy.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   StringView </span><span class="token function" style="color:#8250DF">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">StringView value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> HashStringAllocator</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Strings 类提供了一种释放内存并返回给竞技场的免费方法。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// Frees memory used by the strings. StringViews returned from &#x27;append&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// become invalid after this call.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HashStringAllocator</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当聚合复杂类型（数组、映射或结构体）时，我们使用 AddressableNonNullValueList ，它将值写入 arena，并
返回指向写入值的<code>指针</code>，该指针存储在 F14 集合中。AddressableNonNullValueList 提供了计算值哈
希值和比较两个值的方法。AddressableNonNullValueList 使用 ContainerRowSerde 来序列化数据并比较序列化的值。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// A set of pointers to values stored in AddressableNonNullValueList.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SetAccumulator</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HashStringAllocator</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Position</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AddressableNonNullValueList</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AddressableNonNullValueList</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">EqualTo</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      base</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>AddressableNonNullValueList 允许附加一个值并删除最后一个值。
此功能对于 set_agg 和 set_union 来说已经足够了。处理新值时，我们会将其附加到列表中，获取一个<code>指针</code>，并将该<code>指针</code>插入 F14 集
合，如果该“指针”指向重复值，则将其从列表中移除。</p>
<p>与所有其他基于 arena 的累加器一样，AddressableNonNullValueList 提供了一个自由方法将内存返回给 arena。</p>
<p>注意：<code>AddressableNonNullValueList</code> 与 ValueList 的不同之处在于，它提供对单个值的访问（因此名称中带有<code>Addressable</code>前缀）
，而 ValueList 则不提供。使用 ValueList，可以附加值，然后将所有值复制到 Vector 中。ValueList 不支持对单个元素的临时访问。</p>
<p><code>SetAccumulator&lt;T&gt;</code> 模板实现了一个简单的接口来累积唯一值。它使用 <code>melon::F14FastSet</code>、<code>Strings</code> 和 <code>AddressableNonNullValueList</code> 实现。T 可以是固定宽度类型，例如 <code>int32_t</code> 或 <code>int64_t</code>、<code>StringView</code> 或 <code>ComplexType</code>。</p>
<p>addValue 和 addValues 方法允许从向量中添加一个或多个值。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// Adds value if new. No-op if the value was added before.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">addValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> DecodedVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> decoded</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vector_size_t index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HashStringAllocator</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// Adds new values from an array.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">addValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> ArrayVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> arrayVector</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vector_size_t index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> DecodedVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HashStringAllocator</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>size() 方法返回唯一值的数量。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// Returns number of unique values including null.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   size_t </span><span class="token function" style="color:#8250DF">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>extractValues 方法允许将唯一值提取到向量中。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// Copies the unique values and null into the specified vector starting at</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// the specified offset.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   vector_size_t </span><span class="token function" style="color:#8250DF">extractValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FlatVector</span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#D73A49">&gt;</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vector_size_t offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// For complex types.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   vector_size_t </span><span class="token function" style="color:#8250DF">extractValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vector_size_t offset</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>set_agg</code> 和 <code>set_union</code> 函数均使用 SetAccumulator 实现。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="map_agg-map_union-and-mapaccumulator">map_agg, map_union, and MapAccumulator<a href="#map_agg-map_union-and-mapaccumulator" class="hash-link" aria-label="Direct link to map_agg, map_union, and MapAccumulator" title="Direct link to map_agg, map_union, and MapAccumulator">​</a></h3>
<p><code>map_agg</code> 函数将键和值累积到一个 Map 中。它会丢弃重复的键，并为每个唯一键保留一个值。Map_agg 使用
<code>MapAccumulator&lt;T&gt;</code> 模板来累积值。与 SetAccumulator 类似，
MapAccumulator 使用 <code>F14FastMap</code>、<code>AlignedStlAllocator</code>、Strings 和
AddressableNonNullValueList 构建。</p>
<p><code>insert()</code> 方法将一对 <code>(key, value)</code> 添加到 Map 中，如果匹配的键已经存在，则丢弃该值。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/// Adds key-value pair if entry with that key doesn&#x27;t exist yet.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> DecodedVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> decodedKeys</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> DecodedVector</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> decodedValues</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vector_size_t index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HashStringAllocator</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> allocator</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>size() 方法返回唯一值的数量。</p>
<p>extract() 方法将键和值复制到向量中，这些向量可以组合形成 MapVector。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> VectorPtr</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> mapKeys</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> VectorPtr</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> mapValues</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vector_size_t offset</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>map_agg</code> 和 <code>map_union</code> 函数均使用 MapAccumulator 实现。</p>
<p>在实现新的聚合函数时，请考虑使用 ValueList、SingleValueAccumulator、Strings、AddressableNonNullValueList 和 F14 容器来构建一个高效利用内存的累加器。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="tracking-memory-usage">Tracking Memory Usage<a href="#tracking-memory-usage" class="hash-link" aria-label="Direct link to Tracking Memory Usage" title="Direct link to Tracking Memory Usage">​</a></h3>
<p>聚合运算符需要知道每个组的内存使用量。
例如，当内存紧张时，此信息用于决定溢出多少行以及哪些行。</p>
<p>聚合函数应该使用 RowSizeTracker 来帮助跟踪每个组的内存使用情况。聚合基类提供了辅助方法 trackRowSize(group)，
其使用方式如下：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rows</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">applyToSelected</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vector_size_t row</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> group </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> groups</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> tracker </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">trackRowSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        accumulator</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>&#x27;trackRowSize&#x27; 方法返回一个 RowSizeTracker 实例，该实例使用指向竞技场的引用和一个计数器进行
初始化，计数器会在销毁时递增。当 trackRowSize 返回的对象超出范围时，计数器会进行更新，添加自对象创建以来分配的内存。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="end-to-end-testing">End-to-End Testing<a href="#end-to-end-testing" class="hash-link" aria-label="Direct link to End-to-End Testing" title="Direct link to End-to-End Testing">​</a></h2>
<p>为了确认聚合函数作为查询的一部分端到端工作，请更新 presto_cpp repo 中 TestHiveAggregationQueries.java
中的 testAggregations() 测试以添加使用新函数的查询。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">assertQuery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;SELECT orderkey, array_agg(linenumber) FROM lineitem GROUP BY 1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="overwrite-intermediate-type-in-presto">Overwrite Intermediate Type in Presto<a href="#overwrite-intermediate-type-in-presto" class="hash-link" aria-label="Direct link to Overwrite Intermediate Type in Presto" title="Direct link to Overwrite Intermediate Type in Presto">​</a></h2>
<p>有时，由于实现方式或工作节点接收的类型信息存在差异，我们需要更改 Presto 中聚合函数的中间类型。这在
Presto 类 <code>com.facebook.presto.metadata.BuiltInTypeAndFunctionNamespaceManager</code> 中完
成。启用 <code>FeaturesConfig.isUseAlternativeFunctionSignatures()</code> 后，我们可以注册一组 Pollux
专用的不同函数签名。在 <code>com.facebook.presto.operator.aggregation.AlternativeApproxPercentile</code>
中可以找到如何从头创建此类替代函数签名的示例。示例拉取请求位于 <a href="https://github.com/prestodb/presto/pull/18386" target="_blank" rel="noopener noreferrer">presto</a>。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-05-25T03:28:26.000Z" itemprop="dateModified">May 25, 2025</time></b> by <b>Jeff lothar</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/pollux/develop/scalar-functions"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">如何添加标量函数？</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/pollux/develop/view-and-writer-types"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">视图和编写器类型</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#memory-layout" class="table-of-contents__link toc-highlight">内存布局</a></li><li><a href="#simple-function-interface" class="table-of-contents__link toc-highlight">简单函数接口</a><ul><li><a href="#default-null-behavior" class="table-of-contents__link toc-highlight">默认空值行为</a></li><li><a href="#to_intermediate" class="table-of-contents__link toc-highlight">升级</a></li><li><a href="#accumulator_type-of-default-null-behavior" class="table-of-contents__link toc-highlight">默认空行为的累加器类型</a></li><li><a href="#非默认空行为的-accumulatortypeaccumulatortype-of-non-default-null-behavior" class="table-of-contents__link toc-highlight">非默认空行为的 AccumulatorType(AccumulatorType of Non-Default-Null Behavior)</a></li><li><a href="#limitations" class="table-of-contents__link toc-highlight">Limitations</a></li></ul></li><li><a href="#vector-function-interface" class="table-of-contents__link toc-highlight">Vector Function Interface</a><ul><li><a href="#accumulator-size" class="table-of-contents__link toc-highlight">Accumulator size</a></li><li><a href="#initialization" class="table-of-contents__link toc-highlight">Initialization</a></li><li><a href="#groupby-aggregation" class="table-of-contents__link toc-highlight">GroupBy aggregation</a></li><li><a href="#global-aggregation" class="table-of-contents__link toc-highlight">Global aggregation</a></li></ul></li><li><a href="#factory-function" class="table-of-contents__link toc-highlight">Factory function</a></li><li><a href="#testing" class="table-of-contents__link toc-highlight">Testing</a></li><li><a href="#function-names" class="table-of-contents__link toc-highlight">Function names</a></li><li><a href="#documentation" class="table-of-contents__link toc-highlight">Documentation</a></li><li><a href="#accumulator" class="table-of-contents__link toc-highlight">Accumulator</a><ul><li><a href="#array_agg-and-valuelist" class="table-of-contents__link toc-highlight">array_agg and ValueList</a></li><li><a href="#min-max-and-singlevalueaccumulator" class="table-of-contents__link toc-highlight">min, max, and SingleValueAccumulator</a></li><li><a href="#set_agg-set_union-strings-and-addressablenonnullvaluelist" class="table-of-contents__link toc-highlight">set_agg, set_union, Strings and AddressableNonNullValueList</a></li><li><a href="#map_agg-map_union-and-mapaccumulator" class="table-of-contents__link toc-highlight">map_agg, map_union, and MapAccumulator</a></li><li><a href="#tracking-memory-usage" class="table-of-contents__link toc-highlight">Tracking Memory Usage</a></li></ul></li><li><a href="#end-to-end-testing" class="table-of-contents__link toc-highlight">End-to-End Testing</a></li><li><a href="#overwrite-intermediate-type-in-presto" class="table-of-contents__link toc-highlight">Overwrite Intermediate Type in Presto</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">阅读</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">文档</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/installation">安装</a></li></ul></div><div class="col footer__col"><div class="footer__title">支持与资源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/feature-requests">Feature Requests</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/community/support">Help</a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" href="/changelog">更新</a></li><li class="footer__item"><a href="https://gitee.com/kumo-pub" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kumo-ai.tech" target="_blank" rel="noopener noreferrer" class="footer__link-item">网站<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">版权 © 2025 北京科米智创科技有限公司</div></div></div></footer></div>
</body>
</html>