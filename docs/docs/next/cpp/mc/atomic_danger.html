<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-cpp/mc/atomic_danger" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">The Danger of Atomic Operations | Kumo AI</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kumo-pub.github.io/img/kumo_logo.svg"><meta data-rh="true" name="twitter:image" content="https://kumo-pub.github.io/img/kumo_logo.svg"><meta data-rh="true" property="og:url" content="https://kumo-pub.github.io/docs/next/cpp/mc/atomic_danger"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="The Danger of Atomic Operations | Kumo AI"><meta data-rh="true" name="description" content="Dmitry Vyukov, Sanjay Ghemawat, Mike Burrows, Jeffrey Yasskin, Kostya"><meta data-rh="true" property="og:description" content="Dmitry Vyukov, Sanjay Ghemawat, Mike Burrows, Jeffrey Yasskin, Kostya"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://kumo-pub.github.io/docs/next/cpp/mc/atomic_danger"><link data-rh="true" rel="alternate" href="https://kumo-pub.github.io/docs/next/cpp/mc/atomic_danger" hreflang="en"><link data-rh="true" rel="alternate" href="https://kumo-pub.github.io/docs/next/cpp/mc/atomic_danger" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kumo AI RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kumo AI Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Kumo AI JSON Feed">


<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E5CR2Q1NRE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-E5CR2Q1NRE",{})</script>


<link rel="alternate" type="application/rss+xml" href="/changelog/rss.xml" title="Docusaurus changelog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/changelog/atom.xml" title="Docusaurus changelog Atom Feed">
<link rel="alternate" type="application/json" href="/changelog/feed.json" title="Docusaurus changelog JSON Feed">



<link rel="icon" href="/img/favicon.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon.png">
<link rel="mask-icon" href="/img/favicon.png" color="rgb(62, 204, 94)">
<meta name="msapplication-TileImage" content="/img/favicon.png">
<meta name="msapplication-TileColor" content="#000">



<link rel="alternate" type="application/rss+xml" href="/tests/blog/rss.xml" title="Docusaurus Tests Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tests/blog/atom.xml" title="Docusaurus Tests Blog Atom Feed">
<link rel="alternate" type="application/json" href="/tests/blog/feed.json" title="Docusaurus Tests Blog JSON Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Kumo AI" href="/opensearch.xml">

<link rel="stylesheet" href="/katex/katex.min.css"><link rel="stylesheet" href="/assets/css/styles.21fbef88.css">
<script src="/assets/js/runtime~main.8e97d312.js" defer="defer"></script>
<script src="/assets/js/main.130eda4d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme-b4f")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss-b4f")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">🎉️ <b><a target="_blank" href="https://docusaurus.io/blog/releases/1.1">Kumo v1.1</a> is out!</b> 🥳️</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/kumo_logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE" height="48" width="128"><img src="/img/kumo_logo_white.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="48" width="128"></div><b class="navbar__title text--truncate">主页</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/next">文档</a><a class="navbar__item navbar__link" href="/docs/next/category/kmsearch">API</a><a class="navbar__item navbar__link" href="/blog">博客</a><a class="navbar__item navbar__link" href="/changelog">发布</a><a class="navbar__item navbar__link" href="/showcase">应用案例</a><a class="navbar__item navbar__link" href="/community/support">支持与资源</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/next/cpp/mc/atomic_danger">nightly 🚧</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/next/cpp/mc/atomic_danger">nightly 🚧</a></li><li><a class="dropdown__link" href="/docs">1.1.1</a></li><li><hr class="dropdown-separator"></li><li class="dropdown-archived-versions"><b>Archived versions</b></li><li><a href="https://docusaurus-archive-october-2023.netlify.app/docs/2.3.1" target="_blank" rel="noopener noreferrer" class="dropdown__link">1.0.1<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://v1.docusaurus.io" target="_blank" rel="noopener noreferrer" class="dropdown__link">1.x.x<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><hr class="dropdown-separator"></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/next/cpp/mc/atomic_danger" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://github.com/facebook/docusaurus/issues/3526" target="_blank" rel="noopener noreferrer" class="dropdown__link">Help Us Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/kumo_logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE" height="48" width="128"><img src="/img/kumo_logo_white.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="48" width="128"><b>主页</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/next">概述</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/基础准备">基础准备</a><button aria-label="Collapse sidebar category &#x27;基础准备&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/env_prepare_be">后端开发环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/env_prepare_fe">前端开发环境</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/持续集成----kmpkg">持续集成 -- kmpkg</a><button aria-label="Expand sidebar category &#x27;持续集成 -- kmpkg&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/next/category/服务端开发">服务端开发</a><button aria-label="Collapse sidebar category &#x27;服务端开发&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/overview">概述</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/next/category/规范错误与错误返回值">规范错误与错误返回值</a><button aria-label="Expand sidebar category &#x27;规范错误与错误返回值&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/next/category/性能测试与单元测试">性能测试与单元测试</a><button aria-label="Expand sidebar category &#x27;性能测试与单元测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/next/category/基础应用">基础应用</a><button aria-label="Expand sidebar category &#x27;基础应用&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/next/category/多核编程">多核编程</a><button aria-label="Collapse sidebar category &#x27;多核编程&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/next/cpp/mc/atomic_danger">The Danger of Atomic Operations</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/next/category/log日志库">log日志库</a><button aria-label="Expand sidebar category &#x27;log日志库&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/next/category/krpc教程">krpc教程</a><button aria-label="Expand sidebar category &#x27;krpc教程&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/搜索应用开发">搜索应用开发</a><button aria-label="Expand sidebar category &#x27;搜索应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/向量数据库教程">向量数据库教程</a><button aria-label="Expand sidebar category &#x27;向量数据库教程&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/分布式数据库">分布式数据库</a><button aria-label="Expand sidebar category &#x27;分布式数据库&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/搜索统一执行引擎">搜索统一执行引擎</a><button aria-label="Expand sidebar category &#x27;搜索统一执行引擎&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/搜索-ui">搜索 UI</a><button aria-label="Expand sidebar category &#x27;搜索 UI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Kumo AI<!-- --> <b>nightly 🚧</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs">latest version</a></b> (<!-- -->1.1.1<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/next/category/服务端开发"><span itemprop="name">服务端开发</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/next/category/多核编程"><span itemprop="name">多核编程</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">The Danger of Atomic Operations</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: nightly 🚧</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>The Danger of Atomic Operations</h1></header>
<p>Dmitry Vyukov, Sanjay Ghemawat, Mike Burrows, Jeffrey Yasskin, Kostya
Serebryany, Hans Boehm, Ashley Hedberg</p>
<p>First written Apr 22, 2014. Updated Jun 23, 2021.</p>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#existing-components">Existing Components</a></li>
<li><a href="#atomic-trickiness">Atomic Trickiness</a></li>
<li><a href="#performance-considerations">Performance Considerations</a></li>
<li><a href="#testing-considerations">Testing Considerations</a></li>
<li><a href="#bug-examples">Bug Examples</a></li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>Most engineers reach for atomic operations in an attempt to produce some
lock-free mechanism. Furthermore, programmers enjoy the intellectual puzzle of
using atomic operations. Both of these lead to clever implementations which are
almost always ill-advised and often incorrect. Algorithms involving atomic
operations are extremely subtle. For example, discovering a general-purpose,
efficient, lock-free, singly-linked list algorithm took significant research and
required care to implement. Almost all programmers make mistakes when they
attempt direct use of atomic operations. Even when they don&#x27;t make mistakes, the
resulting code is hard for others to maintain.</p>
<p>Atomic operations should be used only in a handful of low-level data structures
which are written by a few experts and then reviewed and tested thoroughly.
Unfortunately, many people attempt to write lock-free code, and this is almost
always a mistake. Please do not fall into this trap: do not use atomic
operations. If you do, you will make mistakes, and those will cost the owners of
that code time and money.</p>
<p>There are a number of existing higher-level components that are already
carefully crafted, reviewed, and tested. Use them if they do what you need.
Otherwise, use mutexes.</p>
<p>Note: the document is centered around C++, but similar arguments apply to other
languages as well. See <a href="https://research.swtch.com/mm" target="_blank" rel="noopener noreferrer">research!rsc</a> for a more
detailed discussion of hardware, programming language, and Go memory models.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="existing-components">Existing Components<a href="#existing-components" class="hash-link" aria-label="Direct link to Existing Components" title="Direct link to Existing Components">​</a></h2>
<p>Reach for commonly-available concurrency components before inventing your own
solution using atomics. The list below serves as a guide, but is not exhaustive.
Libraries such as the <a href="https://en.cppreference.com/w/cpp" target="_blank" rel="noopener noreferrer">C++ Standard Library</a>,
<a href="https://abseil.io/" target="_blank" rel="noopener noreferrer">Abseil</a>, and <a href="https://github.com/facebook/folly" target="_blank" rel="noopener noreferrer">Folly</a> all
contain relevant components.</p>
<ul>
<li><a href="https://en.cppreference.com/w/cpp/memory/shared_ptr" target="_blank" rel="noopener noreferrer">std::shared_ptr</a> and
<a href="https://github.com/facebook/folly/blob/master/folly/synchronization/Hazptr.h" target="_blank" rel="noopener noreferrer">folly&#x27;s hazard pointer</a>
for reference counting</li>
<li><a href="https://en.cppreference.com/w/cpp/thread/call_once" target="_blank" rel="noopener noreferrer">std::call_once</a> and
<a href="https://github.com/abseil/abseil-cpp/blob/master/absl/base/call_once.h" target="_blank" rel="noopener noreferrer">absl::call_once</a>
for one-time initialization</li>
<li><a href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/thread_pool.html" target="_blank" rel="noopener noreferrer">boost::asio::thread_pool</a>
for thread pooling</li>
<li><a href="https://github.com/abseil/abseil-cpp/blob/master/absl/synchronization/notification.h" target="_blank" rel="noopener noreferrer">absl::Notification</a>
for one-time notifications</li>
<li><a href="https://en.cppreference.com/w/cpp/thread/latch" target="_blank" rel="noopener noreferrer">std::latch</a>,
<a href="https://en.cppreference.com/w/cpp/thread/barrier" target="_blank" rel="noopener noreferrer">std::barrier</a>,
<a href="https://github.com/abseil/abseil-cpp/blob/master/absl/synchronization/barrier.h" target="_blank" rel="noopener noreferrer">absl::Barrier</a>,
and
<a href="https://github.com/abseil/abseil-cpp/blob/master/absl/synchronization/blocking_counter.h" target="_blank" rel="noopener noreferrer">absl::BlockingCounter</a>
for barrier synchronization</li>
<li><a href="https://en.cppreference.com/w/cpp/thread/future" target="_blank" rel="noopener noreferrer">std::future</a> for creating
value promises</li>
<li><a href="https://github.com/urcu/userspace-rcu/blob/master/doc/cds-api.md" target="_blank" rel="noopener noreferrer">Userspace RCU</a>
for read-copy-update algorithms and lock-free containers</li>
<li><a href="https://en.cppreference.com/w/cpp/language/storage_duration" target="_blank" rel="noopener noreferrer">thread_local</a>
for better locality</li>
<li><a href="https://github.com/facebook/folly/tree/master/folly/concurrency" target="_blank" rel="noopener noreferrer">folly&#x27;s concurrency library</a>
for concurrent storage and queues</li>
<li><a href="https://github.com/facebook/folly/blob/master/folly/TokenBucket.h" target="_blank" rel="noopener noreferrer">folly::TokenBucket</a>
for rate limiting</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="atomic-trickiness">Atomic Trickiness<a href="#atomic-trickiness" class="hash-link" aria-label="Direct link to Atomic Trickiness" title="Direct link to Atomic Trickiness">​</a></h2>
<p>Atomic operations introduce two separate kinds of hazards:</p>
<p>First, unless you exclusively use atomic operations that maintain ordering
semantics for all shared memory accesses (notably <code>memory_order_seq_cst</code>
operations), both compilers and processors can and will visibly reorder memory
accesses
<a href="https://en.cppreference.com/w/cpp/atomic/memory_order" target="_blank" rel="noopener noreferrer">per the C++ standard</a>.
Programming rules in these cases become far more complicated, and experts often
still have trouble pinning them down precisely. Many people find it particularly
surprising that such reordering doesn&#x27;t always stop at traditional
synchronization operations, like a mutex acquisition.</p>
<p>If you do restrict yourself to sequentially-consistent operations, you avoid
this issue, but may well find that your code now runs slower on ARM and POWER
than if you had used mutexes. ARM and POWER are weakly-ordered systems, so
special CPU load instructions or memory fences are required to achieve
sequential consistency. This is not required on strongly-ordered platforms like
x86.</p>
<p>Second, it&#x27;s extremely difficult to write code in a world in which a) only
individual memory accesses are atomic, and b) no way to achieve mutual exclusion
over larger code sections exists. Object lifetime management is difficult in a
concurrent setting. <a href="http://en.wikipedia.org/wiki/Compare-and-swap" target="_blank" rel="noopener noreferrer">CAS-based</a>
algorithms are subject to the
<a href="http://en.wikipedia.org/wiki/ABA_problem" target="_blank" rel="noopener noreferrer">ABA problem</a>. Unexpected and
unreproducible thread interleavings occur. Sequences of atomic operations are
then not atomic as a whole. Before approaching atomic operations, you must be
ready for all of these problems and understand the language memory model with
respect to ordering, atomicity, visibility, and data races.</p>
<p>Don&#x27;t assume x86 semantics. Hardware platform guarantees matter only if you are
programming in assembly. Higher-level language (C++/Java/Go) compilers can break
your code. Furthermore, ARM and POWER provide notably different and more complex
memory models; these can also break your code if you run on a variety of
hardware.</p>
<p>Let&#x27;s consider two examples based on real code that demonstrate these two kinds
of subtleties related to atomic operations. First example:</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">std::atomic&lt;bool&gt; data_ready = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double data = 0.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Thread1() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data = 1.23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data_ready.store(true, std::memory_order_relaxed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Thread2() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (data_ready.load(std::memory_order_relaxed))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CHECK(data == 1.23);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The code is seemingly correct: Thread1 initializes the data first and then sets
the flag, Thread2 ensures that the flag is set and only then reads the data.
What can possibly go wrong?</p>
<p>With optimizations enabled, gcc compiles this code to:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% g++ -O2 test.cc -S &amp;&amp; cat test.s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  movabsq $4608218246714312622, %rax # 1. Load the constant into RAX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  movl    $1, data_ready(%rip)       # 2. Store 1 into data_ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  movq    %rax, data(%rip)           # 3. Store RAX register into data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If Thread2 is executed between instructions 2 and 3 of Thread1, the <code>CHECK</code> in
Thread2 will fail. Note that the compiler does exactly what we asked it to do.
The operations on <code>data_ready</code> are indeed atomic; they are just reordered with
other memory accesses.</p>
<p>Another example, this time with implicit <code>memory_order_seq_cst</code>. Here, we have a
concurrent object pool based on a lock-free stack, whose algorithm tries to work
around the ABA problem in a non-traditional way:</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">template&lt;typename T&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ConcurrentPool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ConcurrentPool(size_t size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      : head_(0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       size_(size),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       array_(new Node[size]) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (size_t i = 0; i &lt; size; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      array_[i].next.store(i + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    array_[size - 1].next.store(kEnd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  T* Get() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (size_.load() &gt; 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      size_t head1 = head_.load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      size_t next1 = array_[head1].next.exchange(kEnd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (next1 != kEnd) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (head_.compare_exchange_strong(head1, next1)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          size_.fetch_sub(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          return &amp;array_[head1].v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          array_[head1].next.exchange(next1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nullptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void Put(T* v) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Node *n = reinterpret_cast&lt;Node*&gt;(v);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t i = n - &amp;array_[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t head1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      head1 = head_.load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      n-&gt;next.store(head1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } while (!head_.compare_exchange_strong(head1, i));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_.fetch_add(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> private:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct Node {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    T v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atomic&lt;size_t&gt; next;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  atomic&lt;size_t&gt; head_;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  atomic&lt;size_t&gt; size_;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unique_ptr&lt;Node[]&gt; array_;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static const size_t kEnd = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Before reading further try to spot the bug in this code.</p>
<p>The bug is basically impossible to discover by testing and manual code
inspection. It was found by an automatic checker of synchronization algorithms.
The particular execution that leads to the bug:</p>
<ol>
<li>Thread 1 reads <code>head_ = 0</code> in <code>Get()</code>.</li>
<li>Thread 0 reads <code>head_ = 0</code> in <code>Get()</code>.</li>
<li>Thread 0 removes element 0 from the stack, <code>now head_ = 1</code>.</li>
<li>Thread 0 starts putting the element 0.</li>
<li>Thread 0 reads <code>head_ = 1</code>, and sets the next field of the element 0 to 1.</li>
<li>Thread 1 executes <code>exchange</code> on the next field of the element 0. It reads 1
and writes -1.</li>
<li>Thread 2 gets the element 1 from the stack, now <code>head_ = 2</code>.</li>
<li>Thread 0 fails with <code>compare_exchange</code> in <code>Put()</code>, re-reads <code>head_ = 2</code>, and
writes 2 to the next field of the element 0.</li>
<li>Thread 0 succeeds with <code>compare_exchange</code> in <code>Put()</code>. Now <code>head_ = 0</code>.</li>
<li>Thread 1 succeeds with <code>compare_exchange</code> in <code>Get()</code>. Now <code>head_ = 1</code>
(however <code>head_</code> must be equal to 2!).</li>
<li>Thread 0 pops element 1 from the stack.</li>
</ol>
<p>Now both threads 0 and 2 work with the element 1. Bang!</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="performance-considerations">Performance Considerations<a href="#performance-considerations" class="hash-link" aria-label="Direct link to Performance Considerations" title="Direct link to Performance Considerations">​</a></h2>
<p>Programmers assume that mutexes are expensive, and that using atomic operations
will be more efficient. But in reality, acquiring and releasing a mutex is
cheaper than a cache miss; attention to cache behavior is usually a more
fruitful way to improve performance. Furthermore, lock-free data structures are
often more expensive than using mutexes. A mutex allows arbitrary changes to be
made to a complex data structure; if the same changes must be made without a
mutex, the result is likely to take more atomic read-modify-write and memory
fence instructions, not fewer.</p>
<p>People wish to avoid mutex contention when concurrency is high. Reducing
concurrency is best solved by partitioning locked data structures to avoid mutex
contention. For example, it is easier, more efficient, and more useful to build
a high-concurrency hash table from many normal hash tables, each with its own
reader-writer mutex, than to build one lock-free hash table using atomic
operations.</p>
<p><a href="https://en.cppreference.com/w/cpp/language/storage_duration" target="_blank" rel="noopener noreferrer">Thread-local</a>
caching and batching of updates of centralized state is another technique that
usually vastly outperforms centralized lock-free algorithms. For example,
<a href="https://github.com/google/tcmalloc" target="_blank" rel="noopener noreferrer">tcmalloc</a> uses it to achieve outstanding
scaling while relying only on mutexes for synchronization.</p>
<p><a href="https://en.wikipedia.org/wiki/Reference_counting" target="_blank" rel="noopener noreferrer">Reference-counting</a> can help
to significantly reduce the size of critical sections in some scenarios. Namely,
read-lock a container, find the necessary object, increment reference counter,
unlock, and return:</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">V *find(T key) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lock_guard l(mutex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  V *v = container.find(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (v != nullptr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v-&gt;refcount.Acquire();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Work with the object v happens outside of the mutex.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Caller calls v-&gt;refcount.Release() when done with the object.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The
<a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control" target="_blank" rel="noopener noreferrer">Read-Copy-Update/Multiversion-Concurrency-Control</a>
technique allows one to achieve linear scaling for read-mostly data structures.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="testing-considerations">Testing Considerations<a href="#testing-considerations" class="hash-link" aria-label="Direct link to Testing Considerations" title="Direct link to Testing Considerations">​</a></h2>
<p>Unit tests do not provide good enough coverage for lock-free algorithms; they
explore a negligible part of all possible thread interleavings. For a small
synchronization algorithm with N=10 atomic operations and T=4 threads, the total
number of possible thread interleavings is O(T^(T*N)) ~= 10^24. Memory order
relaxations result in an even larger number of potential executions. Unit tests
will cover a thousand executions at best.</p>
<p>Moreover, x86 hardware can&#x27;t yield all executions possible on POWER and ARM
platforms. Code compiled with a particular version of compiler and flags may not
be able to yield executions possible with a different compiler or flags. Future
compilers are likely to more aggressively reorder memory accesses than current
compilers.</p>
<p>The human brain is poor at reasoning about concurrent algorithms that are not
sequentially consistent. Any non-trivial lock-free algorithm requires careful
review by several experts, verification with formal checkers, and exhaustive
stress testing on different hardware at a minimum.</p>
<p>Note that even mutex-based algorithms can be complex (or a lock can be simply
forgotten). Use <a href="https://github.com/google/sanitizers" target="_blank" rel="noopener noreferrer">ThreadSanitizer</a> to test
for data races and certain kinds of deadlocks.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="bug-examples">Bug Examples<a href="#bug-examples" class="hash-link" aria-label="Direct link to Bug Examples" title="Direct link to Bug Examples">​</a></h2>
<p>Here are examples of several bugs in algorithms based on atomic operations. The
bugs are harmful, tricky, and were lurking in our codebases for years.</p>
<p><strong>Linux kernel lock-free fd lookup</strong></p>
<p>The bug was introduced on
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ab2af1f5005069321c5d130f09cce577b03f43ef" target="_blank" rel="noopener noreferrer">Sep 9, 2005</a>
as part of a migration from a spinlock to RCU refcounting. The change introduced
a bug in how the code needs to react on a narrow window of semi-inconsistent
state exposed by concurrent updates. It was fixed ten years later, on
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=5ba97d2832f8" target="_blank" rel="noopener noreferrer">Jul 1, 2015</a>.</p>
<p><strong>Data Plane Development Kit&#x27;s RTE Ring</strong></p>
<p>The bug existed in the first public release of DPDK, which was on
<a href="http://git.dpdk.org/dpdk/commit/?id=af75078fece3" target="_blank" rel="noopener noreferrer">Mar 11, 2013</a>. There was a
bug with issuing a zero objects dequeue with multiple consumers. It was possible
to get more than one thread to succeed the compare-and-set operation and observe
starvation or even deadlock in the while loop that checks for preceding
dequeues. The same was possible on the enqueue path. The bug was fixed on
<a href="http://git.dpdk.org/dpdk/commit/?id=d0979646166e740917baaabc4b78ded3482226b7" target="_blank" rel="noopener noreferrer">Mar 22, 2016</a>.</p>
<p><strong>sync.WaitGroup</strong></p>
<p>The bug was introduced on
<a href="https://github.com/golang/go/commit/ee6e1a3ff77" target="_blank" rel="noopener noreferrer">Jul 18, 2011</a> as part of a
WaitGroup rewrite that was intended to improve scalability. The change indeed
improved performance and scalability, but it also replaced a simple mutex-based
algorithm with a trickier one based on atomic operations. The bug occurred in
very rare circumstances but led to arbitrary memory corruptions. It was
discovered and fixed only on
<a href="https://github.com/golang/go/commit/e9347c781be" target="_blank" rel="noopener noreferrer">Apr 10, 2014</a>. The bug was
caused by an unexpected thread interleaving.</p>
<p><strong>Parallel GC</strong></p>
<p>The bug was introduced on
<a href="https://github.com/golang/go/commit/d324f2143b2" target="_blank" rel="noopener noreferrer">Sep 30, 2011</a> and fixed only
on <a href="https://github.com/golang/go/commit/b3a3afc9b78" target="_blank" rel="noopener noreferrer">Jan 15, 2014</a>. The bug led
to arbitrary memory corruptions on overloaded machines. The bug was due to
unexpected thread interleaving.</p>
<p><strong>org.jctools.maps.NonBlockingHashMap</strong></p>
<p>The bug was introduced sometime before
<a href="https://twitter.com/nitsanw/status/1406871256486580229" target="_blank" rel="noopener noreferrer">Feb 2009</a>. The bug
allowed the remove operation to return the same item more than once. The root
cause was an inconsistency between a failed CAS and a subsequent atomic read of
the same field. It was identified on
<a href="https://github.com/JCTools/JCTools/issues/205#" target="_blank" rel="noopener noreferrer">Jan 15, 2018</a> and fixed on
<a href="https://github.com/JCTools/JCTools/commit/69786bb178f194b7dad5e4dbf84bed41db5af94e" target="_blank" rel="noopener noreferrer">Jan 21, 2018</a>
after much discussion.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-05-24T10:16:12.000Z" itemprop="dateModified">May 24, 2025</time></b> by <b>Jeff lothar</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/next/category/多核编程"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">多核编程</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/next/category/log日志库"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">log日志库</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#existing-components" class="table-of-contents__link toc-highlight">Existing Components</a></li><li><a href="#atomic-trickiness" class="table-of-contents__link toc-highlight">Atomic Trickiness</a></li><li><a href="#performance-considerations" class="table-of-contents__link toc-highlight">Performance Considerations</a></li><li><a href="#testing-considerations" class="table-of-contents__link toc-highlight">Testing Considerations</a></li><li><a href="#bug-examples" class="table-of-contents__link toc-highlight">Bug Examples</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">阅读</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">文档</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/installation">安装</a></li></ul></div><div class="col footer__col"><div class="footer__title">支持与资源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/feature-requests">Feature Requests</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/community/support">Help</a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" href="/changelog">更新</a></li><li class="footer__item"><a href="https://gitee.com/kumo-pub" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kumo-ai.tech" target="_blank" rel="noopener noreferrer" class="footer__link-item">网站<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">版权 © 2025 北京科米智创科技有限公司</div></div></div></footer></div>
</body>
</html>