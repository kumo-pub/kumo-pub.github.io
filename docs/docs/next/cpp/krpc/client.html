<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-cpp/krpc/client" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">å®¢æˆ·ç«¯æœåŠ¡ | Kumo AI</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kumo-pub.github.io/img/kumo_logo.svg"><meta data-rh="true" name="twitter:image" content="https://kumo-pub.github.io/img/kumo_logo.svg"><meta data-rh="true" property="og:url" content="https://kumo-pub.github.io/docs/next/cpp/krpc/client"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="å®¢æˆ·ç«¯æœåŠ¡ | Kumo AI"><meta data-rh="true" name="description" content="äº‹å®é€ŸæŸ¥"><meta data-rh="true" property="og:description" content="äº‹å®é€ŸæŸ¥"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://kumo-pub.github.io/docs/next/cpp/krpc/client"><link data-rh="true" rel="alternate" href="https://kumo-pub.github.io/docs/next/cpp/krpc/client" hreflang="en"><link data-rh="true" rel="alternate" href="https://kumo-pub.github.io/docs/next/cpp/krpc/client" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kumo AI RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kumo AI Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Kumo AI JSON Feed">


<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E5CR2Q1NRE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-E5CR2Q1NRE",{})</script>


<link rel="alternate" type="application/rss+xml" href="/changelog/rss.xml" title="Docusaurus changelog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/changelog/atom.xml" title="Docusaurus changelog Atom Feed">
<link rel="alternate" type="application/json" href="/changelog/feed.json" title="Docusaurus changelog JSON Feed">



<link rel="icon" href="/img/favicon.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon.png">
<link rel="mask-icon" href="/img/favicon.png" color="rgb(62, 204, 94)">
<meta name="msapplication-TileImage" content="/img/favicon.png">
<meta name="msapplication-TileColor" content="#000">



<link rel="alternate" type="application/rss+xml" href="/tests/blog/rss.xml" title="Docusaurus Tests Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tests/blog/atom.xml" title="Docusaurus Tests Blog Atom Feed">
<link rel="alternate" type="application/json" href="/tests/blog/feed.json" title="Docusaurus Tests Blog JSON Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Kumo AI" href="/opensearch.xml">

<link rel="stylesheet" href="/katex/katex.min.css"><link rel="stylesheet" href="/assets/css/styles.21fbef88.css">
<script src="/assets/js/runtime~main.dbfb52d2.js" defer="defer"></script>
<script src="/assets/js/main.94389b5b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme-b4f")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss-b4f")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">ğŸ‰ï¸ <b><a target="_blank" href="https://docusaurus.io/blog/releases/1.1">Kumo v1.1</a> is out!</b> ğŸ¥³ï¸</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/kumo_logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE" height="48" width="128"><img src="/img/kumo_logo_white.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="48" width="128"></div><b class="navbar__title text--truncate">ä¸»é¡µ</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/next">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/docs/next/category/kmsearch">API</a><a class="navbar__item navbar__link" href="/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/changelog">å‘å¸ƒ</a><a class="navbar__item navbar__link" href="/showcase">åº”ç”¨æ¡ˆä¾‹</a><a class="navbar__item navbar__link" href="/community/support">æ”¯æŒä¸èµ„æº</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/next/cpp/krpc/client">nightly ğŸš§</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/next/cpp/krpc/client">nightly ğŸš§</a></li><li><a class="dropdown__link" href="/docs/cpp/krpc/client">1.1.1</a></li><li><hr class="dropdown-separator"></li><li class="dropdown-archived-versions"><b>Archived versions</b></li><li><a href="https://docusaurus-archive-october-2023.netlify.app/docs/2.3.1" target="_blank" rel="noopener noreferrer" class="dropdown__link">1.0.1<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://v1.docusaurus.io" target="_blank" rel="noopener noreferrer" class="dropdown__link">1.x.x<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><hr class="dropdown-separator"></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/next/cpp/krpc/client" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://github.com/facebook/docusaurus/issues/3526" target="_blank" rel="noopener noreferrer" class="dropdown__link">Help Us Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/kumo_logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE" height="48" width="128"><img src="/img/kumo_logo_white.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="48" width="128"><b>ä¸»é¡µ</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/next">æ¦‚è¿°</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/åŸºç¡€å‡†å¤‡">åŸºç¡€å‡†å¤‡</a><button aria-label="Collapse sidebar category &#x27;åŸºç¡€å‡†å¤‡&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/env_prepare_be">åç«¯å¼€å‘ç¯å¢ƒ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/env_prepare_fe">å‰ç«¯å¼€å‘ç¯å¢ƒ</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/æŒç»­é›†æˆ----kmpkg">æŒç»­é›†æˆ -- kmpkg</a><button aria-label="Expand sidebar category &#x27;æŒç»­é›†æˆ -- kmpkg&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/next/category/æœåŠ¡ç«¯å¼€å‘">æœåŠ¡ç«¯å¼€å‘</a><button aria-label="Collapse sidebar category &#x27;æœåŠ¡ç«¯å¼€å‘&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/overview">æ¦‚è¿°</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/next/category/è§„èŒƒé”™è¯¯ä¸é”™è¯¯è¿”å›å€¼">è§„èŒƒé”™è¯¯ä¸é”™è¯¯è¿”å›å€¼</a><button aria-label="Expand sidebar category &#x27;è§„èŒƒé”™è¯¯ä¸é”™è¯¯è¿”å›å€¼&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/next/category/æ€§èƒ½æµ‹è¯•ä¸å•å…ƒæµ‹è¯•">æ€§èƒ½æµ‹è¯•ä¸å•å…ƒæµ‹è¯•</a><button aria-label="Expand sidebar category &#x27;æ€§èƒ½æµ‹è¯•ä¸å•å…ƒæµ‹è¯•&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/next/category/åŸºç¡€åº”ç”¨">åŸºç¡€åº”ç”¨</a><button aria-label="Expand sidebar category &#x27;åŸºç¡€åº”ç”¨&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/next/category/å¤šæ ¸ç¼–ç¨‹">å¤šæ ¸ç¼–ç¨‹</a><button aria-label="Expand sidebar category &#x27;å¤šæ ¸ç¼–ç¨‹&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/next/category/logæ—¥å¿—åº“">logæ—¥å¿—åº“</a><button aria-label="Expand sidebar category &#x27;logæ—¥å¿—åº“&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/next/category/krpcæ•™ç¨‹">krpcæ•™ç¨‹</a><button aria-label="Collapse sidebar category &#x27;krpcæ•™ç¨‹&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/getting_started">ä½¿ç”¨krpc</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/server">æœåŠ¡å¼€å‘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/http_service">httpæœåŠ¡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/thrift">ThriftæœåŠ¡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/cpu_profiler">CPUä½¿ç”¨åˆ†æ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/heap_profiler">å †æ ˆåˆ†æ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/contention_profiler">ç«æ€åˆ†æ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/dummy_server">server dummy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/rpcz">rpcè¿½è¸ª</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/thread_local">thread local</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/json2pb">jsonå’Œprotobufè½¬æ¢</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/threading_overview">å¸¸è§çº¿ç¨‹æ¨¡å‹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/atomic_instructions">atomicä½¿ç”¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/flags">flagsä½¿ç”¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/io">IOè¯¦è§£</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/vars">å¤šå†™å˜é‡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/kvar">kvarä½¿ç”¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/kvar_c++">å•ç»´åº¦kvar</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/mkvar_c++">å¤šç»´åº¦kvar</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/streaming_rpc">æµå¼rpc</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/endpoint">EndPointå·¥å…·ç±»</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/kumo_std">kumoæ ‡å‡†åè®®</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/next/cpp/krpc/client">å®¢æˆ·ç«¯æœåŠ¡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/circuit_breaker">ç†”æ–­åŠŸèƒ½</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/connections">connectionsæœåŠ¡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/lalb">lalbè°ƒåº¦</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/consistent_hashing">ä¸€è‡´æ€§hash</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/http_client">httpå®¢æˆ·ç«¯</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/http_derivatives">httpå»¶å±•é˜…è¯»</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/combo_channel">æœåŠ¡æ²»ç†</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/kthread">kthread</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/kthread_or_not">çº¿ç¨‹æ¨¡å‹é€‰æ‹©</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/execution_queue">æ‰§è¡Œé˜Ÿåˆ—</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/memcache_client">memcachedå®¢æˆ·ç«¯</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/redis_client">redisæ”¯æŒ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/auto_concurrency_limiter">è‡ªé€‚åº”é™æµ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/cpp/krpc/server_debugging">rpcè°ƒè¯•</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/æœç´¢åº”ç”¨å¼€å‘">æœç´¢åº”ç”¨å¼€å‘</a><button aria-label="Expand sidebar category &#x27;æœç´¢åº”ç”¨å¼€å‘&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/å‘é‡æ•°æ®åº“æ•™ç¨‹">å‘é‡æ•°æ®åº“æ•™ç¨‹</a><button aria-label="Expand sidebar category &#x27;å‘é‡æ•°æ®åº“æ•™ç¨‹&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/åˆ†å¸ƒå¼æ•°æ®åº“">åˆ†å¸ƒå¼æ•°æ®åº“</a><button aria-label="Expand sidebar category &#x27;åˆ†å¸ƒå¼æ•°æ®åº“&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/æœç´¢ç»Ÿä¸€æ‰§è¡Œå¼•æ“">æœç´¢ç»Ÿä¸€æ‰§è¡Œå¼•æ“</a><button aria-label="Expand sidebar category &#x27;æœç´¢ç»Ÿä¸€æ‰§è¡Œå¼•æ“&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/next/category/æœç´¢-ui">æœç´¢ UI</a><button aria-label="Expand sidebar category &#x27;æœç´¢ UI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Kumo AI<!-- --> <b>nightly ğŸš§</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/cpp/krpc/client">latest version</a></b> (<!-- -->1.1.1<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/next/category/æœåŠ¡ç«¯å¼€å‘"><span itemprop="name">æœåŠ¡ç«¯å¼€å‘</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/next/category/krpcæ•™ç¨‹"><span itemprop="name">krpcæ•™ç¨‹</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">å®¢æˆ·ç«¯æœåŠ¡</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: nightly ğŸš§</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>å®¢æˆ·ç«¯æœåŠ¡</h1></header>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="äº‹å®é€ŸæŸ¥">äº‹å®é€ŸæŸ¥<a href="#äº‹å®é€ŸæŸ¥" class="hash-link" aria-label="Direct link to äº‹å®é€ŸæŸ¥" title="Direct link to äº‹å®é€ŸæŸ¥">â€‹</a></h2>
<ul>
<li>Channel.Init()æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</li>
<li>Channel.CallMethod()æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸€ä¸ªChannelå¯ä»¥è¢«æ‰€æœ‰çº¿ç¨‹åŒæ—¶ä½¿ç”¨ã€‚</li>
<li>Channelå¯ä»¥åˆ†é…åœ¨æ ˆä¸Šã€‚</li>
<li>Channelåœ¨å‘é€å¼‚æ­¥è¯·æ±‚åå¯ä»¥ææ„ã€‚</li>
<li>æ²¡æœ‰krpc::Clientè¿™ä¸ªç±»ã€‚</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="channel">Channel<a href="#channel" class="hash-link" aria-label="Direct link to Channel" title="Direct link to Channel">â€‹</a></h2>
<p>ClientæŒ‡å‘èµ·è¯·æ±‚çš„ä¸€ç«¯ï¼Œåœ¨krpcä¸­æ²¡æœ‰å¯¹åº”çš„å®ä½“ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯<a href="https://github.com/apache/krpc/blob/master/src/krpc/channel.h" target="_blank" rel="noopener noreferrer">krpc::Channel</a>ï¼Œå®ƒä»£è¡¨å’Œä¸€å°æˆ–ä¸€ç»„æœåŠ¡å™¨çš„äº¤äº’é€šé“ï¼ŒClientå’ŒChannelåœ¨è§’è‰²ä¸Šçš„å·®åˆ«åœ¨å®è·µä¸­å¹¶ä¸é‡è¦ï¼Œä½ å¯ä»¥æŠŠChannelè§†ä½œClientã€‚</p>
<p>Channelå¯ä»¥<strong>è¢«æ‰€æœ‰çº¿ç¨‹å…±ç”¨</strong>ï¼Œä½ ä¸éœ€è¦ä¸ºæ¯ä¸ªçº¿ ç¨‹åˆ›å»ºç‹¬ç«‹çš„Channelï¼Œä¹Ÿä¸éœ€è¦ç”¨é”äº’æ–¥ã€‚ä¸è¿‡Channelçš„åˆ›å»ºå’ŒInitå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¯·ç¡®ä¿åœ¨InitæˆåŠŸåå†è¢«å¤šçº¿ç¨‹è®¿é—®ï¼Œåœ¨æ²¡æœ‰çº¿ç¨‹è®¿é—®åå†ææ„ã€‚</p>
<p>ä¸€äº›RPCå®ç°ä¸­æœ‰ClientManagerçš„æ¦‚å¿µï¼ŒåŒ…å«äº†Clientç«¯çš„é…ç½®ä¿¡æ¯å’Œèµ„æºç®¡ç†ã€‚krpcä¸éœ€è¦è¿™äº›ï¼Œä»¥å¾€åœ¨ClientManagerä¸­é…ç½®çš„çº¿ç¨‹æ•°ã€é•¿çŸ­è¿æ¥ç­‰ç­‰è¦ä¹ˆè¢«åŠ å…¥äº†krpc::ChannelOptionsï¼Œè¦ä¹ˆå¯ä»¥é€šè¿‡gflagså…¨å±€é…ç½®ï¼Œè¿™ä¹ˆåšçš„å¥½å¤„ï¼š</p>
<ol>
<li>æ–¹ä¾¿ã€‚ä½ ä¸éœ€è¦åœ¨åˆ›å»ºChannelæ—¶ä¼ å…¥ClientManagerï¼Œä¹Ÿä¸éœ€è¦å­˜å‚¨ClientManagerã€‚å¦åˆ™ä¸å°‘ä»£ç éœ€è¦ä¸€å±‚å±‚åœ°ä¼ é€’ClientManagerï¼Œå¾ˆéº»çƒ¦ã€‚gflagsä½¿ä¸€äº›å…¨å±€è¡Œä¸ºçš„é…ç½®æ›´åŠ ç®€å•ã€‚</li>
<li>å…±ç”¨èµ„æºã€‚æ¯”å¦‚serverå’Œchannelå¯ä»¥å…±ç”¨åå°çº¿ç¨‹ã€‚(kthreadçš„å·¥ä½œçº¿ç¨‹)</li>
<li>ç”Ÿå‘½å‘¨æœŸã€‚ææ„ClientManagerçš„è¿‡ç¨‹å¾ˆå®¹æ˜“å‡ºé”™ï¼Œç°åœ¨ç”±æ¡†æ¶è´Ÿè´£åˆ™ä¸ä¼šæœ‰é—®é¢˜ã€‚</li>
</ol>
<p>å°±åƒå¤§éƒ¨åˆ†ç±»é‚£æ ·ï¼ŒChannelå¿…é¡»åœ¨<strong>Init</strong>ä¹‹åæ‰èƒ½ä½¿ç”¨ï¼Œoptionsä¸ºNULLæ—¶æ‰€æœ‰å‚æ•°å–é»˜è®¤å€¼ï¼Œå¦‚æœä½ è¦ä½¿ç”¨éé»˜è®¤å€¼ï¼Œè¿™ä¹ˆåšå°±è¡Œäº†ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">krpc::ChannelOptions options;  // åŒ…å«äº†é»˜è®¤å€¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.xxx = yyy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.Init(..., &amp;options);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>æ³¨æ„Channelä¸ä¼šä¿®æ”¹optionsï¼ŒInitç»“æŸåä¸ä¼šå†è®¿é—®optionsã€‚æ‰€ä»¥optionsä¸€èˆ¬å°±åƒä¸Šé¢ä»£ç ä¸­é‚£æ ·æ”¾æ ˆä¸Šã€‚Channel.options()å¯ä»¥è·å¾—channelåœ¨ä½¿ç”¨çš„æ‰€æœ‰é€‰é¡¹ã€‚</p>
<p>Initå‡½æ•°åˆ†ä¸ºè¿æ¥ä¸€å°æœåŠ¡å™¨å’Œè¿æ¥æœåŠ¡é›†ç¾¤ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è¿æ¥ä¸€å°æœåŠ¡å™¨">è¿æ¥ä¸€å°æœåŠ¡å™¨<a href="#è¿æ¥ä¸€å°æœåŠ¡å™¨" class="hash-link" aria-label="Direct link to è¿æ¥ä¸€å°æœåŠ¡å™¨" title="Direct link to è¿æ¥ä¸€å°æœåŠ¡å™¨">â€‹</a></h2>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// optionsä¸ºNULLæ—¶å–é»˜è®¤å€¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int Init(EndPoint server_addr_and_port, const ChannelOptions* options);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int Init(const char* server_addr_and_port, const ChannelOptions* options);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int Init(const char* server_addr, int port, const ChannelOptions* options);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>è¿™ç±»Initè¿æ¥çš„æœåŠ¡å™¨å¾€å¾€æœ‰å›ºå®šçš„ipåœ°å€ï¼Œä¸éœ€è¦å‘½åæœåŠ¡å’Œè´Ÿè½½å‡è¡¡ï¼Œåˆ›å»ºèµ·æ¥ç›¸å¯¹è½»é‡ã€‚ä½†æ˜¯<strong>è¯·å‹¿é¢‘ç¹åˆ›å»ºä½¿ç”¨åŸŸåçš„Channel</strong>ã€‚è¿™éœ€è¦æŸ¥è¯¢dnsï¼Œå¯èƒ½æœ€å¤šè€—æ—¶10ç§’(æŸ¥è¯¢DNSçš„é»˜è®¤è¶…æ—¶)ã€‚é‡ç”¨å®ƒä»¬ã€‚</p>
<p>åˆæ³•çš„â€œserver_addr_and_portâ€ï¼š</p>
<ul>
<li>127.0.0.1:80</li>
<li><a href="http://www.foo.com:8765" target="_blank" rel="noopener noreferrer">www.foo.com:8765</a></li>
<li>localhost:9000</li>
<li>[::1]:8080      # IPV6</li>
<li>unix<!-- -->:path<!-- -->.sock  # Unix domain socket</li>
</ul>
<p>ä¸åˆæ³•çš„&quot;server_addr_and_port&quot;ï¼š</p>
<ul>
<li>127.0.0.1:90000     # ç«¯å£è¿‡å¤§</li>
<li>10.39.2.300:8000   # éæ³•çš„ip</li>
</ul>
<p>å…³äºIPV6å’ŒUnix domain socketçš„ä½¿ç”¨ï¼Œè¯¦è§ <a href="/docs/next/cpp/krpc/endpoint">EndPoint</a>ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è¿æ¥æœåŠ¡é›†ç¾¤">è¿æ¥æœåŠ¡é›†ç¾¤<a href="#è¿æ¥æœåŠ¡é›†ç¾¤" class="hash-link" aria-label="Direct link to è¿æ¥æœåŠ¡é›†ç¾¤" title="Direct link to è¿æ¥æœåŠ¡é›†ç¾¤">â€‹</a></h2>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int Init(const char* naming_service_url,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         const char* load_balancer_name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         const ChannelOptions* options);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>è¿™ç±»Channeléœ€è¦å®šæœŸä»<code>naming_service_url</code>æŒ‡å®šçš„å‘½åæœåŠ¡ä¸­è·å¾—æœåŠ¡å™¨åˆ—è¡¨ï¼Œå¹¶é€šè¿‡<code>load_balancer_name</code>æŒ‡å®šçš„è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©å‡ºä¸€å°æœºå™¨å‘é€è¯·æ±‚ã€‚</p>
<p>ä½ <strong>ä¸åº”è¯¥</strong>åœ¨æ¯æ¬¡è¯·æ±‚å‰åŠ¨æ€åœ°åˆ›å»ºæ­¤ç±»ï¼ˆè¿æ¥æœåŠ¡é›†ç¾¤çš„ï¼‰Channelã€‚å› ä¸ºåˆ›å»ºå’Œææ„æ­¤ç±»Channelç‰µæ¶‰åˆ°è¾ƒå¤šçš„èµ„æºï¼Œæ¯”å¦‚åœ¨åˆ›å»ºæ—¶å¾—è®¿é—®ä¸€æ¬¡å‘½åæœåŠ¡ï¼Œå¦åˆ™ä¾¿ä¸çŸ¥é“æœ‰å“ªäº›æœåŠ¡å™¨å¯é€‰ã€‚ç”±äºChannelå¯è¢«å¤šä¸ªçº¿ç¨‹å…±ç”¨ï¼Œä¸€èˆ¬ä¹Ÿæ²¡æœ‰å¿…è¦åŠ¨æ€åˆ›å»ºã€‚</p>
<p>å½“<code>load_balancer_name</code>ä¸ºNULLæˆ–ç©ºæ—¶ï¼Œæ­¤Initç­‰åŒäºè¿æ¥å•å°serverçš„Initï¼Œ<code>naming_service_url</code>åº”è¯¥æ˜¯&quot;ip<!-- -->:port<!-- -->&quot;æˆ–&quot;åŸŸå<!-- -->:port<!-- -->&quot;ã€‚ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªInitå‡½æ•°ç»Ÿä¸€Channelçš„åˆå§‹åŒ–æ–¹å¼ã€‚æ¯”å¦‚ä½ å¯ä»¥æŠŠ<code>naming_service_url</code>å’Œ<code>load_balancer_name</code>æ”¾åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè¦è¿æ¥å•å°serveræ—¶æŠŠ<code>load_balancer_name</code>ç½®ç©ºï¼Œè¦è¿æ¥æœåŠ¡é›†ç¾¤æ—¶åˆ™è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆçš„ç®—æ³•åç§°ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å‘½åæœåŠ¡">å‘½å  æœåŠ¡<a href="#å‘½åæœåŠ¡" class="hash-link" aria-label="Direct link to å‘½åæœåŠ¡" title="Direct link to å‘½åæœåŠ¡">â€‹</a></h3>
<p>å‘½åæœåŠ¡æŠŠä¸€ä¸ªåå­—æ˜ å°„ä¸ºå¯ä¿®æ”¹çš„æœºå™¨åˆ—è¡¨ï¼Œåœ¨clientç«¯çš„ä½ç½®å¦‚ä¸‹ï¼š</p>
<!-- -->
<img src="[object Object]">
<p>æœ‰äº†å‘½åæœåŠ¡åclientè®°å½•çš„æ˜¯ä¸€ä¸ªåå­—ï¼Œè€Œä¸æ˜¯æ¯ä¸€å°ä¸‹æ¸¸æœºå™¨ã€‚è€Œå½“ä¸‹æ¸¸æœºå™¨å˜åŒ–æ—¶ï¼Œå°±åªéœ€è¦ä¿®æ”¹å‘½åæœåŠ¡ä¸­çš„åˆ—è¡¨ï¼Œè€Œä¸éœ€è¦é€å°ä¿®æ”¹æ¯ä¸ªä¸Šæ¸¸ã€‚è¿™ä¸ªè¿‡ç¨‹ä¹Ÿå¸¸è¢«ç§°ä¸ºâ€œè§£è€¦ä¸Šä¸‹æ¸¸â€ã€‚å½“ç„¶åœ¨å…·ä½“å®ç°ä¸Šï¼Œä¸Šæ¸¸ä¼šè®°å½•æ¯ä¸€å°ä¸‹æ¸¸æœºå™¨ï¼Œå¹¶å®šæœŸå‘å‘½åæœåŠ¡è¯·æ±‚æˆ–è¢«æ¨é€æœ€æ–°çš„åˆ—è¡¨ï¼Œä»¥é¿å…åœ¨RPCè¯·æ±‚æ—¶æ‰å»è®¿é—®å‘½åæœåŠ¡ã€‚ä½¿ç”¨å‘½åæœåŠ¡ä¸€èˆ¬ä¸ä¼šå¯¹è®¿é—®æ€§èƒ½é€ æˆå½±å“ï¼Œå¯¹å‘½åæœåŠ¡çš„å‹åŠ›ä¹Ÿå¾ˆå°ã€‚</p>
<p><code>naming_service_url</code>çš„ä¸€èˆ¬å½¢å¼æ˜¯&quot;<strong>protocol://service_name</strong>&quot;</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="bnsbns-name">bns://&lt;bns-name&gt;<a href="#bnsbns-name" class="hash-link" aria-label="Direct link to bns://&lt;bns-name&gt;" title="Direct link to bns://&lt;bns-name&gt;">â€‹</a></h4>
<!-- -->
<p>BNSæ˜¯ç™¾åº¦å†…å¸¸ç”¨çš„å‘½åæœåŠ¡ï¼Œæ¯”å¦‚bns://rdev.matrix.allï¼Œå…¶ä¸­&quot;bns&quot;æ˜¯protocolï¼Œ&quot;rdev.matrix.all&quot;æ˜¯service-nameã€‚ç›¸å…³ä¸€ä¸ªgflagæ˜¯-ns_access_interval: <img src="[object Object]"></p>
<p>å¦‚æœBNSä¸­æ˜¾ç¤ºä¸ä¸ºç©ºï¼Œä½†Channelå´è¯´æ‰¾ä¸åˆ°æœåŠ¡å™¨ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½BNSåˆ—è¡¨ä¸­çš„æœºå™¨çŠ¶æ€ä½ï¼ˆstatusï¼‰ä¸ºé0ï¼Œå«ä¹‰ä¸ºæœºå™¨ä¸å¯ç”¨ï¼Œæ‰€ä»¥ä¸ä¼šè¢«åŠ å…¥åˆ°serverå€™é€‰é›†ä¸­ï¼çŠ¶æ€ä½å¯é€šè¿‡å‘½ä»¤è¡ŒæŸ¥çœ‹ï¼š</p>
<p><code>get_instance_by_service [bns_node_name] -s</code></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="filepath">file://&lt;path&gt;<a href="#filepath" class="hash-link" aria-label="Direct link to file://&lt;path&gt;" title="Direct link to file://&lt;path&gt;">â€‹</a></h4>
<p>æœåŠ¡å™¨åˆ—è¡¨æ”¾åœ¨<code>path</code>æ‰€åœ¨çš„æ–‡ä»¶é‡Œï¼Œæ¯”å¦‚&quot;file://conf/machine_list&quot;ä¸­çš„â€œconf/machine_listâ€å¯¹åº”ä¸€ä¸ªæ–‡ä»¶:</p>
<ul>
<li>æ¯è¡Œæ˜¯ä¸€å°æœåŠ¡å™¨çš„åœ°å€ã€‚</li>
<li>#ä¹‹åçš„æ˜¯æ³¨é‡Šä¼šè¢«å¿½ç•¥</li>
<li>åœ°å€åå‡ºç°çš„éæ³¨é‡Šå†…å®¹è¢«è®¤ä¸ºæ˜¯tagï¼Œç”±ä¸€ä¸ªæˆ–å¤šä¸ªç©ºæ ¼ä¸å‰é¢çš„åœ°å€åˆ†éš”ï¼Œç›¸åŒçš„åœ°å€+ä¸åŒçš„tagè¢«è®¤ä¸ºæ˜¯ä¸åŒçš„å®ä¾‹ã€‚</li>
<li>å½“æ–‡ä»¶æ›´æ–°æ—¶, krpcä¼šé‡æ–°åŠ è½½ã€‚</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># æ­¤è¡Œä¼šè¢«å¿½ç•¥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.24.234.17:8080 tag1  # è¿™æ˜¯æ³¨é‡Šï¼Œä¼šè¢«å¿½ç•¥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.24.234.17:8090 tag2  # æ­¤è¡Œå’Œä¸Šä¸€è¡Œè¢«è®¤ä¸ºæ˜¯ä¸åŒçš„å®ä¾‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.24.234.18:8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.24.234.19:8080</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ä¼˜ç‚¹: æ˜“äºä¿®æ”¹ï¼Œæ–¹ä¾¿å•æµ‹ã€‚</p>
<p>ç¼ºç‚¹: æ›´æ–°æ—¶éœ€è¦ä¿®æ”¹æ¯ä¸ªä¸Šæ¸¸çš„åˆ—è¡¨æ–‡ä»¶ï¼Œä¸é€‚åˆçº¿ä¸Šéƒ¨ç½² ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="listaddr1addr2">list://&lt;addr1&gt;,&lt;addr2&gt;...<a href="#listaddr1addr2" class="hash-link" aria-label="Direct link to list://&lt;addr1&gt;,&lt;addr2&gt;..." title="Direct link to list://&lt;addr1&gt;,&lt;addr2&gt;...">â€‹</a></h4>
<p>æœåŠ¡å™¨åˆ—è¡¨ç›´æ¥è·Ÿåœ¨list://ä¹‹åï¼Œä»¥é€—å·åˆ†éš”ï¼Œæ¯”å¦‚&quot;list://db-bce-81-3-186.db01:7000,m1-bce-44-67-72.m1:7000,cp01-rd-cos-006.cp01:7000&quot;ä¸­æœ‰ä¸‰ä¸ªåœ°å€ã€‚</p>
<p>åœ°å€åå¯ä»¥å£°æ˜tagï¼Œç”¨ä¸€ä¸ªæˆ–å¤šä¸ªç©ºæ ¼åˆ†éš”ï¼Œç›¸åŒçš„åœ°å€+ä¸åŒçš„tagè¢«è®¤ä¸ºæ˜¯ä¸åŒçš„å®ä¾‹ã€‚</p>
<p>ä¼˜ç‚¹: å¯åœ¨å‘½ä»¤è¡Œä¸­ç›´æ¥é…ç½®ï¼Œæ–¹ä¾¿å•æµ‹ã€‚</p>
<p>ç¼ºç‚¹: æ— æ³•åœ¨è¿è¡Œæ—¶ä¿®æ”¹ï¼Œå®Œå…¨ä¸èƒ½ç”¨äºçº¿ä¸Šéƒ¨ç½²ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="httpurl">http://&lt;url&gt;<a href="#httpurl" class="hash-link" aria-label="Direct link to http://&lt;url&gt;" title="Direct link to http://&lt;url&gt;">â€‹</a></h4>
<p>è¿æ¥ä¸€ä¸ªåŸŸåä¸‹æ‰€æœ‰çš„æœºå™¨, ä¾‹å¦‚<a href="http://www.baidu.com:80" target="_blank" rel="noopener noreferrer">http://www.baidu.com:80</a> ï¼Œæ³¨æ„è¿æ¥å•ç‚¹çš„Initï¼ˆä¸¤ä¸ªå‚æ•°ï¼‰è™½ç„¶ä¹Ÿå¯ä¼ å…¥åŸŸåï¼Œä½†åªä¼šè¿æ¥åŸŸåä¸‹çš„ä¸€å°æœºå™¨ã€‚</p>
<p>ä¼˜ç‚¹: DNSçš„é€šç”¨æ€§ï¼Œå…¬ç½‘å†…ç½‘å‡å¯ä½¿ç”¨ã€‚</p>
<p>ç¼ºç‚¹: å—é™äºDNSçš„æ ¼å¼é™åˆ¶æ— æ³•ä¼ é€’å¤æ‚çš„metaæ•°æ®ï¼Œä¹Ÿæ— æ³•å®ç°é€šçŸ¥æœºåˆ¶ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="httpsurl">https://&lt;url&gt;<a href="#httpsurl" class="hash-link" aria-label="Direct link to https://&lt;url&gt;" title="Direct link to https://&lt;url&gt;">â€‹</a></h4>
<p>å’Œhttpå‰ç¼€ç±»ä¼¼ï¼Œåªæ˜¯ä¼šè‡ªåŠ¨å¼€å¯SSLã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="consulservice-name">consul://&lt;service-name&gt;<a href="#consulservice-name" class="hash-link" aria-label="Direct link to consul://&lt;service-name&gt;" title="Direct link to consul://&lt;service-name&gt;">â€‹</a></h4>
<p>é€šè¿‡consulè·å–æœåŠ¡åç§°ä¸ºservice-nameçš„æœåŠ¡åˆ—è¡¨  ã€‚consulçš„é»˜è®¤åœ°å€æ˜¯localhost:8500ï¼Œå¯é€šè¿‡gflagsè®¾ç½®-consul_agent_addræ¥ä¿®æ”¹ã€‚consulçš„è¿æ¥è¶…æ—¶æ—¶é—´é»˜è®¤æ˜¯200msï¼Œå¯é€šè¿‡-consul_connect_timeout_msæ¥ä¿®æ”¹ã€‚</p>
<p>é»˜è®¤åœ¨consulè¯·æ±‚å‚æ•°ä¸­æ·»åŠ <a href="https://www.consul.io/api/index.html#consistency-modes" target="_blank" rel="noopener noreferrer">stale</a>å’Œpassingï¼ˆä»…è¿”å›çŠ¶æ€ä¸ºpassingçš„æœåŠ¡åˆ—è¡¨ï¼‰ï¼Œå¯é€šè¿‡gflagsä¸­-consul_url_parameteræ”¹å˜<a href="https://www.consul.io/api/health.html#parameters-2" target="_blank" rel="noopener noreferrer">consulè¯·æ±‚å‚æ•°</a>ã€‚</p>
<p>é™¤äº†å¯¹consulçš„é¦–æ¬¡è¯·æ±‚ï¼Œåç»­å¯¹consulçš„è¯·æ±‚éƒ½é‡‡ç”¨<a href="https://www.consul.io/api/index.html#blocking-queries" target="_blank" rel="noopener noreferrer">long polling</a>çš„æ–¹å¼ï¼Œå³ä»…å½“æœåŠ¡åˆ—è¡¨æ›´æ–°æˆ–è¯·æ±‚è¶…æ—¶åconsulæ‰è¿”å›ç»“æœï¼Œè¿™é‡Œè¶…æ—¶æ—¶é—´é»˜è®¤ä¸º60sï¼Œå¯é€šè¿‡-consul_blocking_query_wait_secsæ¥è®¾ç½®ã€‚</p>
<p>è‹¥consulè¿”å›çš„æœåŠ¡åˆ—è¡¨<a href="https://www.consul.io/api/health.html#sample-response-2" target="_blank" rel="noopener noreferrer">å“åº”æ ¼å¼</a>æœ‰é”™è¯¯ï¼Œæˆ–è€…åˆ—è¡¨ä¸­æ‰€æœ‰æœåŠ¡éƒ½å› ä¸ºåœ°å€ã€ç«¯å£ç­‰å…³é”®å­—æ®µç¼ºå¤±æˆ–æ— æ³•è§£æè€Œè¢«è¿‡æ»¤ï¼Œconsul naming serverä¼šæ‹’ç»æ›´æ–°æœåŠ¡åˆ—è¡¨ï¼Œå¹¶åœ¨ä¸€æ®µæ—¶é—´åï¼ˆé»˜è®¤500msï¼Œå¯é€šè¿‡-consul_retry_interval_msè®¾ç½®ï¼‰é‡æ–°è®¿é—®consulã€‚</p>
<p>å¦‚æœconsulä¸å¯è®¿é—®ï¼ŒæœåŠ¡å¯è‡ªåŠ¨é™çº§åˆ°file naming serviceè·å–æœåŠ¡åˆ—è¡¨ã€‚æ­¤åŠŸèƒ½é»˜è®¤å…³é—­ï¼Œå¯é€šè¿‡è®¾ç½®-consul_enable_degrade_to_file_naming_serviceæ¥æ‰“å¼€ã€‚æœåŠ¡åˆ—è¡¨æ–‡ä»¶ç›®å½•é€šè¿‡-consul _file_naming_service_diræ¥è®¾ç½®ï¼Œä½¿ç”¨service-nameä½œä¸ºæ–‡ä»¶åã€‚è¯¥æ–‡ä»¶å¯é€šè¿‡consul-templateç”Ÿæˆï¼Œé‡Œé¢ä¼šä¿å­˜consulä¸å¯ç”¨ä¹‹å‰æœ€æ–°çš„ä¸‹æ¸¸æœåŠ¡èŠ‚ç‚¹ã€‚å½“consulæ¢å¤æ—¶å¯è‡ªåŠ¨æ¢å¤åˆ°consul naming serviceã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nacosservice-name">nacos://&lt;service-name&gt;<a href="#nacosservice-name" class="hash-link" aria-label="Direct link to nacos://&lt;service-name&gt;" title="Direct link to nacos://&lt;service-name&gt;">â€‹</a></h4>
<p>NacosNamingServiceä½¿ç”¨<a href="https://nacos.io/zh-cn/docs/open-api.html" target="_blank" rel="noopener noreferrer">Open-Api</a>å®šæ—¶ä»nacosè·å–æœåŠ¡åˆ—è¡¨ã€‚
NacosNamingServiceæ”¯æŒ<a href="https://nacos.io/zh-cn/docs/auth.html" target="_blank" rel="noopener noreferrer">ç®€å•é‰´æƒ</a>ã€‚</p>
<p><code>&lt;service-name&gt;</code>æ˜¯ä¸€ä¸ªhttp uri queryï¼Œå…·ä½“å‚æ•°å‚è§<code>/nacos/v1/ns/instance/list</code>æ–‡æ¡£ã€‚
æ³¨æ„ï¼š<code>&lt;service-name&gt;</code>éœ€è¦urlencodeã€‚</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nacos://serviceName=test&amp;groupName=g&amp;namespaceId=n&amp;clusters=c&amp;healthyOnly=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>NacosNamingServiceæ‹‰å–åˆ—è¡¨çš„æ—¶é—´é—´éš”ä¸º<code>/nacos/v1/ns/instance/list</code>apiè¿”å›çš„<code>cacheMillis</code>ã€‚
NacosNamingServiceåªæ”¯æŒæ•´å½¢çš„æƒé‡å€¼ã€‚</p>
<table><thead><tr><th>GFlags</th><th>æè¿°</th><th>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td>nacos_address</td><td>nacos http url</td><td>&quot;&quot;</td></tr><tr><td>nacos_service_discovery_path</td><td>nacosæœåŠ¡å‘ç°è·¯å¾„</td><td>&quot;/nacos/v1/ns/instance/list&quot;</td></tr><tr><td>nacos_service_auth_path</td><td>nacosç™»é™†è·¯å¾„</td><td>&quot;/nacos/v1/auth/login&quot;</td></tr><tr><td>nacos_service_timeout_ms</td><td>è¿æ¥nacosè¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</td><td>200</td></tr><tr><td>nacos_username</td><td>ç”¨æˆ·åï¼ˆurlencodeç¼–ç ï¼‰</td><td>&quot;&quot;</td></tr><tr><td>nacos_password</td><td>å¯†ç ï¼ˆurlencodeç¼–ç ï¼‰</td><td>&quot;&quot;</td></tr><tr><td>nacos_load_balancer</td><td>nacosé›†ç¾¤çš„è´Ÿè½½å‡è¡¡</td><td>&quot;rr&quot;</td></tr></tbody></table>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="æ›´å¤šå‘½åæœåŠ¡">æ›´å¤šå‘½åæœåŠ¡<a href="#æ›´å¤šå‘½åæœåŠ¡" class="hash-link" aria-label="Direct link to æ›´å¤šå‘½åæœåŠ¡" title="Direct link to æ›´å¤šå‘½åæœåŠ¡">â€‹</a></h4>
<p>ç”¨æˆ·å¯ä»¥é€šè¿‡å®ç°krpc::NamingServiceæ¥å¯¹æ¥æ›´å¤šå‘½åæœåŠ¡ï¼Œå…·ä½“è§<a href="https://github.com/apache/krpc/blob/master/docs/cn/load_balancing.mdx#%E5%91%BD%E5%90%8D%E6%9C%8D%E5%8A%A1" target="_blank" rel="noopener noreferrer">è¿™é‡Œ</a></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å‘½åæœåŠ¡ä¸­çš„tag">å‘½åæœåŠ¡ä¸­çš„tag<a href="#å‘½åæœåŠ¡ä¸­çš„tag" class="hash-link" aria-label="Direct link to å‘½åæœåŠ¡ä¸­çš„tag" title="Direct link to å‘½åæœåŠ¡ä¸­çš„tag">â€‹</a></h4>
<p>æ¯ä¸ªåœ°å€å¯ä»¥é™„å¸¦ä¸€ä¸ªtagï¼Œåœ¨å¸¸è§çš„å‘½åæœåŠ¡ä¸­ï¼Œå¦‚æœåœ°å€åæœ‰ç©ºæ ¼ï¼Œåˆ™ç©ºæ ¼ä¹‹åçš„å†…å®¹å‡ä¸ºtagã€‚
ç›¸åŒçš„åœ°å€é…åˆä¸åŒçš„tagè¢«è®¤ä¸ºæ˜¯ä¸åŒçš„å®ä¾‹ï¼Œkrpcä¼šå»ºç«‹ä¸åŒçš„è¿æ¥ã€‚ç”¨æˆ·å¯åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æ›´çµæ´»åœ°æ§åˆ¶ä¸å•ä¸ªåœ°å€çš„è¿æ¥æ–¹å¼ã€‚
å¦‚æœä½ éœ€è¦&quot;å¸¦æƒé‡çš„è½®è¯¢&quot;ï¼Œä½ åº”å½“ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨<a href="#wrr">wrrç®—æ³•</a>ï¼Œè€Œä¸æ˜¯ç”¨tagæ¥æ¨¡æ‹Ÿã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="vipç›¸å…³çš„é—®é¢˜">VIPç›¸å…³çš„é—®é¢˜<a href="#vipç›¸å…³çš„é—®é¢˜" class="hash-link" aria-label="Direct link to VIPç›¸å…³çš„é—®é¢˜" title="Direct link to VIPç›¸å…³çš„é—®é¢˜">â€‹</a></h4>
<p>VIPä¸€èˆ¬æ˜¯4å±‚è´Ÿè½½å‡è¡¡å™¨çš„å…¬ç½‘ipï¼ŒèƒŒåæœ‰å¤šä¸ªRSã€‚å½“å®¢æˆ·ç«¯è¿æ¥è‡³VIPæ—¶ï¼ŒVIPä¼šé€‰æ‹©ä¸€ä¸ªRSå»ºç«‹è¿æ¥ï¼Œå½“å®¢æˆ·ç«¯è¿æ¥æ–­å¼€æ—¶ï¼ŒVIPä¹Ÿä¼šæ–­å¼€ä¸å¯¹åº”RSçš„è¿æ¥ã€‚</p>
<p>å¦‚æœå®¢æˆ·ç«¯åªä¸VIPå»ºç«‹ä¸€ä¸ªè¿æ¥(krpcä¸­çš„å•è¿æ¥)ï¼Œé‚£ä¹ˆæ¥è‡ªè¿™ä¸ªå®¢æˆ·ç«¯çš„æ‰€æœ‰æµé‡éƒ½ä¼šè½åˆ°ä¸€å°RSä¸Šã€‚å¦‚æœå®¢æˆ·ç«¯çš„æ•°é‡éå¸¸å¤šï¼Œè‡³å°‘åœ¨é›†ç¾¤çš„è§’åº¦ï¼Œæ‰€æœ‰çš„RSè¿˜æ˜¯ä¼šåˆ†åˆ°è¶³å¤Ÿå¤šçš„è¿æ¥ï¼Œä»è€ŒåŸºæœ¬å‡è¡¡ã€‚ä½†å¦‚æœå®¢æˆ·ç«¯çš„æ•°é‡ä¸å¤šï¼Œæˆ–å®¢æˆ·ç«¯çš„è´Ÿè½½å·®å¼‚å¾ˆå¤§ï¼Œé‚£ä¹ˆå¯èƒ½åœ¨ä¸ªåˆ«RSä¸Šå‡ºç°çƒ­ç‚¹ã€‚å¦ä¸€ä¸ªé—®é¢˜æ˜¯å½“æœ‰å¤šä¸ªVIPå¯é€‰æ—¶ï¼Œå®¢æˆ·ç«¯åˆ†ç»™å®ƒä»¬çš„æµé‡ä¸å„è‡ªåé¢çš„RSæ•°é‡å¯èƒ½ä¸ä¸€è‡´ã€‚</p>
<p>è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨è¿æ¥æ± æ¨¡å¼(pooled)ï¼Œè¿™æ ·å®¢æˆ·ç«¯å¯¹ä¸€ä¸ªVIPå°±å¯èƒ½å»ºç«‹å¤šä¸ªè¿æ¥(çº¦ä¸ºä¸€æ®µæ—¶é—´å†…çš„æœ€å¤§å¹¶å‘åº¦)ï¼Œä»è€Œè®©è´Ÿè½½è½åˆ°å¤šä¸ªRSä¸Šã€‚å¦‚æœæœ‰å¤šä¸ªVIPï¼Œå¯ä»¥ç”¨<a href="#wrr">wrrè´Ÿè½½å‡è¡¡</a>ç»™ä¸åŒçš„VIPå£°æ˜ä¸åŒçš„æƒé‡ä»è€Œåˆ†åˆ°å¯¹åº”æ¯”ä¾‹çš„æµé‡ï¼Œæˆ–ç»™ç›¸åŒçš„VIPååŠ ä¸Šå¤šä¸ªä¸åŒçš„tagè€Œè¢«è®¤ä¸ºæ˜¯å¤šä¸ªä¸åŒçš„å®ä¾‹ã€‚</p>
<p>å¦‚æœå¯¹æ€§èƒ½æœ‰æ›´é«˜çš„è¦æ±‚ï¼Œæˆ–è¦é™åˆ¶å¤§é›†ç¾¤ä¸­è¿æ¥çš„æ•°é‡ï¼Œå¯ä»¥ä½¿ç”¨å•è¿æ¥å¹¶ç»™ç›¸åŒçš„VIPåŠ ä¸Šä¸åŒçš„tagä»¥å»ºç«‹å¤šä¸ªè¿æ¥ã€‚ç›¸æ¯”è¿æ¥æ± ä¸€èˆ¬è¿æ¥æ•°é‡æ›´å°ï¼Œç³»ç»Ÿè°ƒç”¨å¼€é”€æ›´ä½ï¼Œä½†å¦‚æœtagä¸å¤Ÿå¤šï¼Œä»å¯èƒ½å‡ºç°RSçƒ­ç‚¹ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å‘½åæœåŠ¡è¿‡æ»¤å™¨">å‘½åæœåŠ¡è¿‡æ»¤å™¨<a href="#å‘½åæœåŠ¡è¿‡æ»¤å™¨" class="hash-link" aria-label="Direct link to å‘½åæœåŠ¡è¿‡æ»¤å™¨" title="Direct link to å‘½åæœåŠ¡è¿‡æ»¤å™¨">â€‹</a></h4>
<p>å½“å‘½åæœåŠ¡è·å¾—æœºå™¨åˆ—è¡¨åï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨è¿›è¡Œç­›é€‰ï¼Œæœ€åæŠŠç»“æœä¼ é€’ç»™è´Ÿè½½å‡è¡¡ï¼š</p>
<!-- -->
<img src="[object Object]">
<p>è¿‡æ»¤å™¨çš„æ¥å£å¦‚ä¸‹ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// naming_service_filter.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class NamingServiceFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Return true to take this `server&#x27; as a candidate to issue RPC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Return false to filter it out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual bool Accept(const ServerNode&amp; server) const = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// naming_service.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct ServerNode {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kutil::EndPoint addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::string tag;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>å¸¸è§çš„ä¸šåŠ¡ç­–ç•¥å¦‚æ ¹æ®serverçš„tagè¿›è¡Œè¿‡æ»¤ã€‚</p>
<p>è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨é…ç½®åœ¨ChannelOptionsä¸­ï¼Œé»˜è®¤ä¸ºNULLï¼ˆä¸è¿‡æ»¤ï¼‰ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class MyNamingServiceFilter : public krpc::NamingServiceFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool Accept(const krpc::ServerNode&amp; server) const {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return server.tag == &quot;main&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyNamingServiceFilter my_filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    krpc::ChannelOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    options.ns_filter = &amp;my_filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡<a href="#è´Ÿè½½å‡è¡¡" class="hash-link" aria-label="Direct link to è´Ÿè½½å‡è¡¡" title="Direct link to è´Ÿè½½å‡è¡¡">â€‹</a></h3>
<p>å½“ä¸‹æ¸¸æœºå™¨è¶…è¿‡ä¸€å°æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ†å‰²æµé‡ï¼Œæ­¤è¿‡ç¨‹ä¸€èˆ¬ç§°ä¸ºè´Ÿè½½å‡è¡¡ï¼Œåœ¨clientç«¯çš„ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<!-- -->
<img src="[object Object]">
<p>ç†æƒ³çš„ç®—æ³•æ˜¯æ¯ä¸ªè¯·æ±‚éƒ½å¾—åˆ°åŠæ—¶çš„å¤„ç†ï¼Œä¸”ä»»æ„æœºå™¨crashå¯¹å…¨å±€å½±å“è¾ƒå°ã€‚ä½†ç”±äºclientç«¯æ— æ³•åŠæ—¶è·å¾—serverç«¯çš„å»¶è¿Ÿæˆ–æ‹¥å¡ï¼Œè€Œä¸”è´Ÿè½½å‡è¡¡ç®—æ³•ä¸èƒ½è€—è´¹å¤ªå¤šçš„cpuï¼Œä¸€èˆ¬æ¥è¯´ç”¨æˆ·å¾—æ ¹æ®å…·ä½“çš„åœºæ™¯é€‰æ‹©åˆé€‚çš„ç®—æ³•ï¼Œç›®å‰rpcæä¾›çš„ç®—æ³•æœ‰ï¼ˆé€šè¿‡load_balancer_nameæŒ‡å®šï¼‰ï¼š</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="rr">rr<a href="#rr" class="hash-link" aria-label="Direct link to rr" title="Direct link to rr">â€‹</a></h4>
<p>å³round robinï¼Œæ€»æ˜¯é€‰æ‹©åˆ—è¡¨ä¸­çš„ä¸‹ä¸€å°æœåŠ¡å™¨ï¼Œç»“å°¾çš„ä¸‹ä¸€å°æ˜¯å¼€å¤´ï¼Œæ— éœ€å…¶ä»–è®¾ç½®ã€‚æ¯”å¦‚æœ‰3å°æœºå™¨a,b,cï¼Œé‚£ä¹ˆkrpcä¼šä¾æ¬¡å‘a, b, c, a, b, c, ...å‘é€è¯·æ±‚ã€‚æ³¨æ„è¿™ä¸ªç®—æ³•çš„å‰ææ˜¯æœåŠ¡å™¨çš„é…ç½®ï¼Œç½‘ç»œæ¡ä»¶ï¼Œè´Ÿè½½éƒ½æ˜¯ç±»ä¼¼çš„ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="wrr">wrr<a href="#wrr" class="hash-link" aria-label="Direct link to wrr" title="Direct link to wrr">â€‹</a></h4>
<p>å³weighted round robin, æ ¹æ®æœåŠ¡å™¨åˆ—è¡¨é…ç½®çš„æƒé‡å€¼æ¥é€‰æ‹©æœåŠ¡å™¨ã€‚æœåŠ¡å™¨è¢«é€‰åˆ°çš„æœºä¼šæ­£æ¯”äºå…¶æƒé‡å€¼ï¼Œå¹¶ä¸”è¯¥ç®—æ³•èƒ½ä¿è¯åŒä¸€æœåŠ¡å™¨è¢«é€‰åˆ°çš„ç»“æœè¾ƒå‡è¡¡çš„æ•£å¼€ã€‚</p>
<p>å®ä¾‹çš„tagéœ€è¦æ˜¯è¡¨ç¤ºæƒå€¼çš„int32æ•°å­—ï¼Œå¦‚tag=&quot;50&quot;ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="random">random<a href="#random" class="hash-link" aria-label="Direct link to random" title="Direct link to random">â€‹</a></h4>
<p>éšæœºä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°æœåŠ¡å™¨ï¼Œæ— éœ€å…¶ä»–è®¾ç½®ã€‚å’Œround robinç±»ä¼¼ï¼Œè¿™ä¸ªç®—æ³•çš„å‰æä¹Ÿæ˜¯æœåŠ¡å™¨éƒ½æ˜¯ç±»ä¼¼çš„ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="wr">wr<a href="#wr" class="hash-link" aria-label="Direct link to wr" title="Direct link to wr">â€‹</a></h4>
<p>å³weighted random, æ ¹æ®æœåŠ¡å™¨åˆ—è¡¨é…ç½®çš„æƒé‡å€¼æ¥é€‰æ‹©æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è¢«é€‰åˆ°çš„æœºä¼šæ­£æ¯”äºå…¶æƒé‡å€¼ã€‚</p>
<p>å®ä¾‹tagçš„è¦æ±‚åŒwrrã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="la">la<a href="#la" class="hash-link" aria-label="Direct link to la" title="Direct link to la">â€‹</a></h4>
<p>locality-awareï¼Œä¼˜å…ˆé€‰æ‹©å»¶æ—¶ä½çš„ä¸‹æ¸¸ï¼Œç›´åˆ°å…¶å»¶æ—¶é«˜äºå…¶ä»–æœºå™¨ï¼Œæ— éœ€å…¶ä»–è®¾ç½®ã€‚å®ç°åŸç†è¯·æŸ¥çœ‹<a href="/docs/next/cpp/krpc/lalb">Locality-aware load balancing</a>ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="c_murmurhash-or-c_md5">c_murmurhash or c_md5<a href="#c_murmurhash-or-c_md5" class="hash-link" aria-label="Direct link to c_murmurhash or c_md5" title="Direct link to c_murmurhash or c_md5">â€‹</a></h4>
<p>ä¸€è‡´æ€§å“ˆå¸Œï¼Œä¸ç®€å•hashçš„ä¸åŒä¹‹å¤„åœ¨äºå¢åŠ æˆ–åˆ é™¤æœºå™¨æ—¶ä¸ä¼šä½¿åˆ†æ¡¶ç»“æœå‰§çƒˆå˜åŒ–ï¼Œç‰¹åˆ«é€‚åˆcache ç±»æœåŠ¡ã€‚</p>
<p>å‘èµ·RPCå‰éœ€è¦è®¾ç½®Controller.set_request_code()ï¼Œå¦åˆ™RPCä¼šå¤±è´¥ã€‚request_codeä¸€èˆ¬æ˜¯è¯·æ±‚ä¸­ä¸»é”®éƒ¨åˆ†çš„32ä½å“ˆå¸Œå€¼ï¼Œ<strong>ä¸éœ€è¦å’Œè´Ÿè½½å‡è¡¡ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ä¸€è‡´</strong>ã€‚æ¯”å¦‚ç”¨c_murmurhashç®—æ³•ä¹Ÿå¯ä»¥ç”¨md5è®¡ç®—å“ˆå¸Œå€¼ã€‚</p>
<p><a href="https://github.com/apache/krpc/blob/master/src/krpc/policy/hasher.h" target="_blank" rel="noopener noreferrer">src/krpc/policy/hasher.h</a>ä¸­åŒ…å«äº†å¸¸ç”¨çš„hashå‡½æ•°ã€‚å¦‚æœç”¨std::string keyä»£è¡¨è¯·æ±‚çš„ä¸»é”®ï¼Œcontroller.set_request_code(krpc::policy::MurmurHash32(key.data(), key.size()))å°±æ­£ç¡®åœ°è®¾ç½®äº†request_codeã€‚</p>
<p>æ³¨æ„ç”„åˆ«è¯·æ±‚ä¸­çš„ <code>ä¸»é”®</code> éƒ¨åˆ†å’Œ <code>å±æ€§</code> éƒ¨åˆ†ï¼Œä¸è¦ä¸ºäº†å·æ‡’æˆ–é€šç”¨ï¼Œå°±æŠŠè¯·æ±‚çš„æ‰€æœ‰å†…å®¹ä¸€è‚¡è„‘å„¿è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œå±æ€§çš„å˜åŒ–ä¼šä½¿è¯·æ±‚çš„ç›®çš„åœ°å‘ç”Ÿå‰§çƒˆçš„å˜åŒ–ã€‚å¦å¤–ä¹Ÿè¦æ³¨æ„paddingé—®é¢˜ï¼Œæ¯”å¦‚<code>struct Foo { int32_t a; int64_t b; }</code>åœ¨64ä½æœºå™¨ä¸Šaå’Œbä¹‹é—´æœ‰4ä¸ªå­—èŠ‚çš„ç©ºéš™ï¼Œå†…å®¹æœªå®šä¹‰ï¼Œå¦‚æœåƒ<code>hash(&amp;foo, sizeof(foo))</code>è¿™æ ·è®¡ç®—å“ˆå¸Œå€¼ï¼Œç»“æœå°±æ˜¯æœªå®šä¹‰çš„ï¼Œå¾—æŠŠå†…å®¹ç´§å¯†æ’åˆ—æˆ–åºåˆ—åŒ–åå†ç®—ã€‚</p>
<p>å®ç°åŸç†è¯·æŸ¥çœ‹<a href="/docs/next/cpp/krpc/consistent_hashing">Consistent Hashing</a>ã€‚</p>
<p>å…¶ä»–lbä¸éœ€è¦è®¾ç½®Controller.set_request_code()ï¼Œå¦‚æœè°ƒç”¨äº†request_codeä¹Ÿä¸ä¼šè¢«lbä½¿ç”¨ï¼Œä¾‹å¦‚ï¼šlb=rrè°ƒç”¨äº†Controller.set_request_code()ï¼Œå³ä½¿æ‰€æœ‰RPCçš„request_codeéƒ½ç›¸åŒï¼Œä¹Ÿä¾ç„¶æ˜¯rrã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ä»é›†ç¾¤å®•æœºåæ¢å¤æ—¶çš„å®¢æˆ·ç«¯é™æµ">ä»é›†ç¾¤å®•æœºåæ¢å¤æ—¶çš„å®¢æˆ·ç«¯é™æµ<a href="#ä»é›†ç¾¤å®•æœºåæ¢å¤æ—¶çš„å®¢æˆ·ç«¯é™æµ" class="hash-link" aria-label="Direct link to ä»é›†ç¾¤å®•æœºåæ¢å¤æ—¶çš„å®¢æˆ·ç«¯é™æµ" title="Direct link to ä»é›†ç¾¤å®•æœºåæ¢å¤æ—¶çš„å®¢æˆ·ç«¯é™æµ">â€‹</a></h4>
<p>é›†ç¾¤å®•æœºæŒ‡çš„æ˜¯é›†ç¾¤ä¸­æ‰€æœ‰serveréƒ½å¤„äºä¸å¯ç”¨çš„çŠ¶æ€ã€‚ç”±äºå¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œå½“é›†ç¾¤æ¢å¤æ­£å¸¸åï¼Œserver  ä¼šé—´éš”æ€§åœ°ä¸Šçº¿ã€‚å½“æŸä¸€ä¸ªserverä¸Šçº¿åï¼Œæ‰€æœ‰çš„æµé‡ä¼šå‘é€è¿‡å»ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å†æ¬¡è¿‡è½½ã€‚è‹¥ç†”æ–­å¼€å¯ï¼Œåˆ™å¯èƒ½å¯¼è‡´å…¶å®ƒserverä¸Šçº¿å‰è¯¥serverå†æ¬¡ç†”æ–­ï¼Œé›†ç¾¤æ°¸è¿œæ— æ³•æ¢å¤ã€‚ä½œä¸ºè§£å†³æ–¹æ¡ˆï¼Œkrpcæä¾›äº†åœ¨é›†ç¾¤å®•æœºåæ¢å¤æ—¶çš„é™æµæœºåˆ¶ï¼šå½“é›†ç¾¤ä¸­æ²¡æœ‰å¯ç”¨serveræ—¶ï¼Œé›†ç¾¤è¿›å…¥æ¢å¤çŠ¶æ€ï¼Œå‡è®¾æ­£å¥½èƒ½æœåŠ¡æ‰€æœ‰è¯·æ±‚çš„serveræ•°é‡ä¸ºmin_working_instancesï¼Œå½“å‰é›†ç¾¤å¯ç”¨çš„serveræ•°é‡ä¸ºqï¼Œåˆ™åœ¨æ¢å¤çŠ¶æ€æ—¶ï¼Œclientæ¥å—è¯·æ±‚çš„æ¦‚ç‡ä¸ºq/min_working_instancesï¼Œå¦åˆ™ä¸¢å¼ƒï¼›è‹¥ä¸€æ®µæ—¶é—´hold_secondså†…qä¿æŒä¸å˜ï¼Œåˆ™æŠŠæµé‡é‡æ–°å‘é€å…¨éƒ¨å¯ç”¨çš„serverä¸Šï¼Œå¹¶ç¦»å¼€æ¢å¤çŠ¶æ€ã€‚åœ¨æ¢å¤é˜¶æ®µæ—¶ï¼Œå¯ä»¥é€šè¿‡åˆ¤æ–­controller.ErrorCode()æ˜¯å¦ç­‰äºkrpc::ERJECTæ¥åˆ¤æ–­è¯¥æ¬¡è¯·æ±‚æ˜¯å¦è¢«æ‹’ç»ï¼Œè¢«æ‹’ç»çš„è¯·æ±‚ä¸ä¼šè¢«æ¡†æ¶é‡è¯•ã€‚</p>
<p>æ­¤æ¢å¤æœºåˆ¶è¦æ±‚ä¸‹æ¸¸serverçš„èƒ½åŠ›æ˜¯ç±»ä¼¼çš„ï¼Œæ‰€ä»¥ç›®å‰åªé’ˆå¯¹rrå’Œrandomæœ‰æ•ˆï¼Œå¼€å¯æ–¹å¼æ˜¯åœ¨<em>load_balancer_name</em>åé¢åŠ ä¸Šmin_working_instanceså’Œhold_secondså‚æ•°çš„å€¼ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">channel.Init(&quot;http://...&quot;, &quot;random:min_working_instances=6 hold_seconds=10&quot;, &amp;options);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å¥åº·æ£€æŸ¥">å¥åº·æ£€æŸ¥<a href="#å¥åº·æ£€æŸ¥" class="hash-link" aria-label="Direct link to å¥åº·æ£€æŸ¥" title="Direct link to å¥åº·æ£€æŸ¥">â€‹</a></h3>
<p>è¿æ¥æ–­å¼€çš„serverä¼šè¢«æš‚æ—¶éš”ç¦»è€Œä¸ä¼šè¢«è´Ÿè½½å‡è¡¡ç®—æ³•é€‰ä¸­ï¼Œkrpcä¼šå®šæœŸè¿æ¥è¢«éš”ç¦»çš„serverï¼Œä»¥æ£€æŸ¥ä»–ä»¬æ˜¯å¦æ¢å¤æ­£å¸¸ï¼Œé—´éš”ç”±å‚æ•°-health_check_intervalæ§åˆ¶:</p>
<table><thead><tr><th>Name</th><th>Value</th><th>Description</th><th>Defined At</th></tr></thead><tbody><tr><td>health_check_interval ï¼ˆRï¼‰</td><td>3</td><td>seconds between consecutive health-checkings</td><td>src/krpc/socket_map.cpp</td></tr></tbody></table>
<p>åœ¨é»˜è®¤çš„é…ç½®ä¸‹ï¼Œä¸€æ—¦serverè¢«è¿æ¥ä¸Šï¼Œå®ƒä¼šæ¢å¤ä¸ºå¯ç”¨çŠ¶æ€ï¼›krpcè¿˜æä¾›äº†åº”ç”¨å±‚å¥åº·æ£€æŸ¥çš„æœºåˆ¶ï¼Œæ¡†æ¶ä¼šå‘é€ä¸€ä¸ªHTTP GETè¯·æ±‚åˆ°è¯¥serverï¼Œè¯·æ±‚è·¯å¾„é€šè¿‡-health_check_pathè®¾ç½®ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰ï¼Œåªæœ‰å½“serverè¿”å›200æ—¶ï¼Œå®ƒæ‰ä¼šæ¢å¤ã€‚åœ¨ä¸¤ç§å¥åº·æ£€æŸ¥æœºåˆ¶ä¸‹ï¼Œéƒ½å¯é€šè¿‡-health_check_timeout_msè®¾ç½®è¶…æ—¶ï¼ˆé»˜è®¤500msï¼‰ã€‚å¦‚æœåœ¨éš”ç¦»è¿‡ç¨‹ä¸­ï¼Œserverä»å‘½åæœåŠ¡ä¸­åˆ é™¤äº†ï¼Œkrpcä¹Ÿä¼šåœæ­¢è¿æ¥å°è¯•ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å‘èµ·è®¿é—®">å‘èµ·è®¿é—®<a href="#å‘èµ·è®¿é—®" class="hash-link" aria-label="Direct link to å‘èµ·è®¿é—®" title="Direct link to å‘èµ·è®¿é—®">â€‹</a></h2>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¸ç›´æ¥è°ƒç”¨Channel.CallMethodï¼Œè€Œæ˜¯é€šè¿‡protobufç”Ÿæˆçš„æ¡©XXX_Stubï¼Œè¿‡ç¨‹æ›´åƒæ˜¯â€œè°ƒç”¨å‡½æ•°â€ã€‚stubå†…æ²¡ä»€ä¹ˆæˆå‘˜å˜é‡ï¼Œå»ºè®®åœ¨æ ˆä¸Šåˆ›å»ºå’Œä½¿ç”¨ï¼Œè€Œä¸å¿…newï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æŠŠstubå­˜ä¸‹æ¥å¤ç”¨ã€‚Channel::CallMethodå’Œstubè®¿é—®éƒ½æ˜¯<strong>çº¿ç¨‹å®‰å…¨</strong>çš„ï¼Œå¯ä»¥è¢«æ‰€æœ‰çº¿ç¨‹åŒæ—¶è®¿é—®ã€‚æ¯”å¦‚ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">XXX_Stub stub(&amp;channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stub.some_method(controller, request, response, done);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ç”šè‡³</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">XXX_Stub(&amp;channel).some_method(controller, request, response, done);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ä¸€ä¸ªä¾‹å¤–æ˜¯http/h2 clientã€‚è®¿é—®httpæœåŠ¡å’Œprotobufæ²¡ä»€ä¹ˆå…³ç³»ï¼Œç›´æ¥è°ƒç”¨CallMethodå³å¯ï¼Œé™¤äº†Controllerå’Œdoneå‡ä¸ºNULLï¼Œè¯¦è§<a href="/docs/next/cpp/krpc/http_client">è®¿é—®http/h2æœåŠ¡</a>ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="åŒæ­¥è®¿é—®">åŒæ­¥è®¿é—®<a href="#åŒæ­¥è®¿é—®" class="hash-link" aria-label="Direct link to åŒæ­¥è®¿é—®" title="Direct link to åŒæ­¥è®¿é—®">â€‹</a></h3>
<p>æŒ‡çš„æ˜¯ï¼šCallMethodä¼šé˜»å¡åˆ°æ”¶åˆ°serverç«¯è¿”å›responseæˆ–å‘ç”Ÿé”™è¯¯ï¼ˆåŒ…æ‹¬è¶…æ—¶ï¼‰ã€‚</p>
<p>åŒæ­¥è®¿é—®ä¸­çš„response/controllerä¸ä¼šåœ¨CallMethodåè¢«æ¡†æ¶ä½¿ç”¨ï¼Œå®ƒä»¬éƒ½å¯ä»¥åˆ†é…åœ¨æ ˆä¸Šã€‚æ³¨æ„ï¼Œå¦‚æœrequest/responseå­—æ®µç‰¹åˆ«å¤šå­—èŠ‚æ•°ç‰¹åˆ«å¤§çš„è¯ï¼Œè¿˜æ˜¯æ›´é€‚åˆåˆ†é…åœ¨å †ä¸Šã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MyRequest request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyResponse response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Controller cntl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XXX_Stub stub(&amp;channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">request.set_foo(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cntl.set_timeout_ms(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stub.some_method(&amp;cntl, &amp;request, &amp;response, NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (cntl-&gt;Failed()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // RPCå¤±è´¥äº†. responseé‡Œçš„å€¼æ˜¯æœªå®šä¹‰çš„ï¼Œå‹¿ç”¨ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // RPCæˆåŠŸäº†ï¼Œresponseé‡Œæœ‰æˆ‘ä»¬æƒ³è¦çš„å›å¤æ•°æ®ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>è­¦å‘Š: è¯·å‹¿åœ¨æŒæœ‰pthreadé”çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨krpcçš„åŒæ­¥CallMethodï¼å¦åˆ™å¾ˆå®¹æ˜“å¯¼è‡´æ­»é”ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼ˆäºŒé€‰ä¸€ï¼‰ï¼š</p>
<ol>
<li>å°†pthreadé”æ¢æˆkthreadé”(kthread_mutex_tï¼‰</li>
<li>åœ¨CallMethodä¹‹å‰å°†é”é‡Šæ”¾</li>
</ol>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å¼‚æ­¥è®¿é—®">å¼‚æ­¥è®¿é—®<a href="#å¼‚æ­¥è®¿é—®" class="hash-link" aria-label="Direct link to å¼‚æ­¥è®¿é—®" title="Direct link to å¼‚æ­¥è®¿é—®">â€‹</a></h3>
<p>æŒ‡çš„æ˜¯ï¼šç»™CallMethodä¼ é€’ä¸€ä¸ªé¢å¤–çš„å›è°ƒå¯¹è±¡doneï¼ŒCallMethodåœ¨å‘å‡ºrequeståå°±ç»“æŸäº†ï¼Œè€Œä¸æ˜¯åœ¨RPCç»“æŸåã€‚å½“serverç«¯è¿”å›responseæˆ–å‘ç”Ÿé”™è¯¯ï¼ˆåŒ…æ‹¬è¶…æ—¶ï¼‰æ—¶ï¼Œdone-&gt;Run()ä¼šè¢«è°ƒç”¨ã€‚å¯¹RPCçš„åç»­å¤„ç†åº”è¯¥å†™åœ¨done-&gt;Run()é‡Œï¼Œè€Œä¸æ˜¯CallMethodåã€‚</p>
<p>ç”±äºCallMethodç»“æŸä¸æ„å‘³ç€RPCç»“æŸï¼Œresponse/controllerä»å¯èƒ½è¢«æ¡†æ¶åŠdone-&gt;Run()ä½¿ç”¨ï¼Œå®ƒä»¬ä¸€èˆ¬å¾—åˆ›å»ºåœ¨å †ä¸Šï¼Œå¹¶åœ¨done-&gt;Run()ä¸­åˆ é™¤ã€‚å¦‚æœæå‰åˆ é™¤äº†å®ƒä»¬ï¼Œé‚£å½“done-&gt;Run()è¢«è°ƒç”¨æ—¶ï¼Œå°†è®¿é—®åˆ°æ— æ•ˆå†…å­˜ã€‚</p>
<p>ä½ å¯ä»¥ç‹¬ç«‹åœ°åˆ›å»ºè¿™äº›å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨<a href="#use-new_callback">NewCallback</a>ç”Ÿæˆdoneï¼Œä¹Ÿå¯ä»¥æŠŠResponseå’ŒControllerä½œä¸ºdoneçš„æˆå‘˜å˜é‡ï¼Œ<a href="#inh-google-protobuf-Closure">ä¸€èµ·newå‡ºæ¥</a>ï¼Œä¸€èˆ¬ä½¿ç”¨å‰ä¸€ç§æ–¹æ³•ã€‚</p>
<p>å‘èµ·å¼‚æ­¥è¯·æ±‚åRequestå¯ä»¥ç«‹åˆ»ææ„ã€‚(SelectiveChannelæ˜¯ä¸ªä¾‹å¤–ï¼ŒSelectiveChannelæƒ…å†µä¸‹å¿…é¡»åœ¨è¯·æ±‚å¤„ç†å®Œæˆåå†é‡Šæ”¾requestå¯¹è±¡ï¼‰</p>
<p>å‘èµ·å¼‚æ­¥è¯·æ±‚åChannelå¯ä»¥ç«‹åˆ»ææ„ã€‚</p>
<p>æ³¨æ„:è¿™æ˜¯è¯´Request/Channelçš„ææ„å¯ä»¥ç«‹åˆ»å‘ç”Ÿåœ¨CallMethod<strong>ä¹‹å</strong>ï¼Œå¹¶ä¸æ˜¯è¯´ææ„å¯ä»¥å’ŒCallMethodåŒæ—¶å‘ç”Ÿï¼Œåˆ é™¤æ­£è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨çš„Channelæ˜¯æœªå®šä¹‰è¡Œä¸ºï¼ˆå¾ˆå¯èƒ½crashï¼‰ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="use-new_callback">ä½¿ç”¨NewCallback<a href="#use-new_callback" class="hash-link" aria-label="Direct link to ä½¿ç”¨NewCallback" title="Direct link to ä½¿ç”¨NewCallback">â€‹</a></h4>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static void OnRPCDone(MyResponse* response, krpc::Controller* cntl) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // unique_pträ¼šå¸®åŠ©æˆ‘ä»¬åœ¨returnæ—¶è‡ªåŠ¨åˆ æ‰response/cntlï¼Œé˜²æ­¢å¿˜è®°ã€‚gcc 3.4ä¸‹çš„unique_ptræ˜¯  æ¨¡æ‹Ÿç‰ˆæœ¬ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::unique_ptr&lt;MyResponse&gt; response_guard(response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::unique_ptr&lt;krpc::Controller&gt; cntl_guard(cntl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (cntl-&gt;Failed()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // RPCå¤±è´¥äº†. responseé‡Œçš„å€¼æ˜¯æœªå®šä¹‰çš„ï¼Œå‹¿ç”¨ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // RPCæˆåŠŸäº†ï¼Œresponseé‡Œæœ‰æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚å¼€å§‹RPCçš„åç»­å¤„ç†ã€‚    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // NewCallbackäº§ç”Ÿçš„Closureä¼šåœ¨Runç»“æŸååˆ é™¤è‡ªå·±ï¼Œä¸ç”¨æˆ‘ä»¬åšã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyResponse* response = new MyResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Controller* cntl = new krpc::Controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyService_Stub stub(&amp;channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyRequest request;  // ä½ ä¸ç”¨new request,å³ä½¿åœ¨å¼‚æ­¥è®¿é—®ä¸­.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">request.set_foo(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cntl-&gt;set_timeout_ms(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stub.some_method(cntl, &amp;request, response, krpc::NewCallback(OnRPCDone, response, cntl));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ç”±äºprotobuf 3æŠŠNewCallbackè®¾ç½®ä¸ºç§æœ‰ï¼Œr32035åkrpcæŠŠNewCallbackç‹¬ç«‹äº<a href="https://github.com/apache/krpc/blob/master/src/krpc/callback.h" target="_blank" rel="noopener noreferrer">src/krpc/callback.h</a>ï¼ˆå¹¶å¢åŠ äº†ä¸€äº›é‡è½½ï¼‰ã€‚å¦‚æœä½ çš„ç¨‹åºå‡ºç°NewCallbackç›¸å…³çš„ç¼–è¯‘é”™è¯¯ï¼ŒæŠŠgoogle::protobuf::NewCallbackæ›¿æ¢ä¸ºkrpc::NewCallbackå°±è¡Œäº†ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="inh-google-protobuf-Closure">ç»§æ‰¿google::protobuf::Closure<a href="#inh-google-protobuf-Closure" class="hash-link" aria-label="Direct link to ç»§æ‰¿google::protobuf::Closure" title="Direct link to ç»§æ‰¿google::protobuf::Closure">â€‹</a></h4>
<p>ä½¿ç”¨NewCallbackçš„ç¼ºç‚¹æ˜¯è¦åˆ†é…ä¸‰æ¬¡å†…å­˜ï¼šresponse, controller, doneã€‚å¦‚æœprofilerè¯æ˜è¿™å„¿çš„å†…å­˜åˆ†é…æœ‰ç“¶é¢ˆï¼Œå¯ä»¥è€ƒè™‘è‡ªå·±ç»§æ‰¿Closureï¼ŒæŠŠresponse/controllerä½œä¸ºæˆå‘˜å˜é‡ï¼Œè¿™æ ·å¯ä»¥æŠŠä¸‰æ¬¡newåˆå¹¶ä¸ºä¸€æ¬¡ã€‚ä½†ç¼ºç‚¹å°±æ˜¯ä»£ç ä¸å¤Ÿç¾è§‚ï¼Œå¦‚æœå†…å­˜åˆ†é…ä¸æ˜¯ç“¶é¢ˆï¼Œåˆ«ç”¨è¿™ç§æ–¹æ³•ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class OnRPCDone: public google::protobuf::Closure {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void Run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // unique_pträ¼šå¸®åŠ©æˆ‘ä»¬åœ¨returnæ—¶è‡ªåŠ¨delete thisï¼Œé˜²æ­¢å¿˜è®°ã€‚gcc 3.4ä¸‹çš„unique_ptræ˜¯æ¨¡æ‹Ÿç‰ˆæœ¬ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::unique_ptr&lt;OnRPCDone&gt; self_guard(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cntl-&gt;Failed()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // RPCå¤±è´¥äº†. responseé‡Œçš„å€¼æ˜¯æœªå®šä¹‰çš„ï¼Œå‹¿ç”¨ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // RPCæˆåŠŸäº†ï¼Œresponseé‡Œæœ‰æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚å¼€å§‹RPCçš„åç»­å¤„ç†ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyResponse response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    krpc::Controller cntl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OnRPCDone* done = new OnRPCDone;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyService_Stub stub(&amp;channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyRequest request;  // ä½ ä¸ç”¨new request,å³ä½¿åœ¨å¼‚æ­¥è®¿é—®ä¸­.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">request.set_foo(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done-&gt;cntl.set_timeout_ms(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stub.some_method(&amp;done-&gt;cntl, &amp;request, &amp;done-&gt;response, done);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å¦‚æœå¼‚æ­¥è®¿é—®ä¸­çš„å›è°ƒå‡½æ•°ç‰¹åˆ«å¤æ‚ä¼šæœ‰ä»€ä¹ˆå½±å“å—">å¦‚æœå¼‚æ­¥è®¿é—®ä¸­çš„å›è°ƒå‡½æ•°ç‰¹åˆ«å¤æ‚ä¼šæœ‰ä»€ä¹ˆå½±å“å—?<a href="#å¦‚æœå¼‚æ­¥è®¿é—®ä¸­çš„å›è°ƒå‡½æ•°ç‰¹åˆ«å¤æ‚ä¼šæœ‰ä»€ä¹ˆå½±å“å—" class="hash-link" aria-label="Direct link to å¦‚æœå¼‚æ­¥è®¿é—®ä¸­çš„å›è°ƒå‡½æ•°ç‰¹åˆ«å¤æ‚ä¼šæœ‰ä»€ä¹ˆå½±å“å—?" title="Direct link to å¦‚æœå¼‚æ­¥è®¿é—®ä¸­çš„å›è°ƒå‡½æ•°ç‰¹åˆ«å¤æ‚ä¼šæœ‰ä»€ä¹ˆå½±å“å—?">â€‹</a></h4>
<p>æ²¡æœ‰ç‰¹åˆ«çš„å½±å“ï¼Œå›è°ƒä¼šè¿è¡Œåœ¨ç‹¬ç«‹çš„kthreadä¸­ï¼Œä¸ä¼šé˜»å¡å…¶ä»–çš„é€»è¾‘ã€‚ä½ å¯ä»¥åœ¨å›è°ƒä¸­åšå„ç§é˜»å¡æ“ä½œã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="rpcå‘é€å¤„çš„ä»£ç å’Œå›è°ƒå‡½æ•°æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œå—">rpcå‘é€å¤„çš„ä»£ç å’Œå›è°ƒå‡½æ•°æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œå—?<a href="#rpcå‘é€å¤„çš„ä»£ç å’Œå›è°ƒå‡½æ•°æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œå—" class="hash-link" aria-label="Direct link to rpcå‘é€å¤„çš„ä»£ç å’Œå›è°ƒå‡½æ•°æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œå—?" title="Direct link to rpcå‘é€å¤„çš„ä»£ç å’Œå›è°ƒå‡½æ•°æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œå—?">â€‹</a></h4>
<p>ä¸€å®šä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œè¿è¡Œï¼Œå³ä½¿è¯¥æ¬¡rpcè°ƒç”¨åˆšè¿›å»å°±å¤±è´¥äº†ï¼Œå›è°ƒä¹Ÿä¼šåœ¨å¦ä¸€ä¸ªkthreadä¸­è¿è¡Œã€‚è¿™å¯ä»¥åœ¨åŠ é”è¿›è¡Œrpcï¼ˆä¸æ¨èï¼‰çš„ä»£ç ä¸­é¿å…æ­»é”ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ç­‰å¾…rpcå®Œæˆ">ç­‰å¾…RPCå®Œæˆ<a href="#ç­‰å¾…rpcå®Œæˆ" class="hash-link" aria-label="Direct link to ç­‰å¾…RPCå®Œæˆ" title="Direct link to ç­‰å¾…RPCå®Œæˆ">â€‹</a></h3>
<p>æ³¨æ„ï¼šå½“ä½ éœ€è¦å‘èµ·å¤šä¸ªå¹¶å‘æ“ä½œæ—¶ï¼Œå¯èƒ½<a href="/docs/next/cpp/krpc/combo_channel#ParallelChannel">ParallelChannel</a>æ›´æ–¹ä¾¿ã€‚</p>
<p>å¦‚ä¸‹ä»£ç å‘èµ·ä¸¤ä¸ªå¼‚æ­¥RPCåç­‰å¾…å®ƒä»¬å®Œæˆã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">const krpc::CallId cid1 = controller1-&gt;call_id();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const krpc::CallId cid2 = controller2-&gt;call_id();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stub.method1(controller1, request1, response1, done1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stub.method2(controller2, request2, response2, done2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Join(cid1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Join(cid2);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>åœ¨å‘èµ·RPCå‰</strong>è°ƒç”¨Controller.call_id()è·å¾—ä¸€ä¸ªidï¼Œå‘èµ·RPCè°ƒç”¨åJoiné‚£ä¸ªidã€‚</p>
<p>Join()çš„è¡Œä¸ºæ˜¯ç­‰åˆ°RPCç»“æŸ<strong>ä¸”done-&gt;Run()è¿è¡Œå</strong>ï¼Œä¸€äº›Joinçš„æ€§è´¨å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœå¯¹åº”çš„RPCå·²ç»ç»“æŸï¼ŒJoinå°†ç«‹åˆ»è¿”å›ã€‚</li>
<li>å¤šä¸ªçº¿ç¨‹å¯ä»¥JoinåŒä¸€ä¸ªidï¼Œå®ƒä»¬éƒ½ä¼šé†’æ¥ã€‚</li>
<li>åŒæ­¥RPCä¹Ÿå¯ä»¥åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¢«Joinï¼Œä½†ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆåšã€‚</li>
</ul>
<p>Join()åœ¨ä¹‹å‰çš„ç‰ˆæœ¬å«åšJoinResponse()ï¼Œå¦‚æœä½ åœ¨ç¼–  è¯‘æ—¶è¢«æç¤ºdeprecatedä¹‹ç±»çš„ï¼Œä¿®æ”¹ä¸ºJoin()ã€‚</p>
<p>åœ¨RPCè°ƒç”¨å<code>Join(controller-&gt;call_id())</code>æ˜¯<strong>é”™è¯¯</strong>çš„è¡Œä¸ºï¼Œä¸€å®šè¦å…ˆæŠŠcall_idä¿å­˜ä¸‹æ¥ã€‚å› ä¸ºRPCè°ƒç”¨åcontrollerå¯èƒ½è¢«éšæ—¶å¼€å§‹è¿è¡Œçš„doneåˆ é™¤ã€‚ä¸‹é¢ä»£ç çš„Joinæ–¹å¼æ˜¯<strong>é”™è¯¯</strong>çš„ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static void on_rpc_done(Controller* controller, MyResponse* response) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... Handle response ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delete controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delete response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Controller* controller1 = new Controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Controller* controller2 = new Controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyResponse* response1 = new MyResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyResponse* response2 = new MyResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stub.method1(controller1, &amp;request1, response1, google::protobuf::NewCallback(on_rpc_done, controller1, response1));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stub.method2(controller2, &amp;request2, response2, google::protobuf::NewCallback(on_rpc_done, controller2, response2));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Join(controller1-&gt;call_id());   // é”™è¯¯ï¼Œcontroller1å¯èƒ½è¢«on_rpc_doneåˆ é™¤äº†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Join(controller2-&gt;call_id());   // é”™è¯¯ï¼Œcontroller2å¯èƒ½è¢«on_rpc_doneåˆ é™¤äº†</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="åŠåŒæ­¥">åŠåŒæ­¥<a href="#åŠåŒæ­¥" class="hash-link" aria-label="Direct link to åŠåŒæ­¥" title="Direct link to åŠåŒæ­¥">â€‹</a></h3>
<p>Joinå¯ç”¨æ¥å®ç°â€œåŠåŒæ­¥â€è®¿é—®ï¼šå³ç­‰å¾…å¤šä¸ªå¼‚æ­¥è®¿é—®å®Œæˆã€‚ç”±äºè°ƒç”¨å¤„çš„ä»£ç ä¼šç­‰åˆ°æ‰€æœ‰RPCéƒ½ç»“æŸåå†é†’æ¥ï¼Œæ‰€ä»¥controllerå’Œresponseéƒ½å¯ä»¥æ”¾æ ˆä¸Šã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Controller cntl1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Controller cntl2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyResponse response1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyResponse response2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stub1.method1(&amp;cntl1, &amp;request1, &amp;response1, krpc::DoNothing());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stub2.method2(&amp;cntl2, &amp;request2, &amp;response2, krpc::DoNothing());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Join(cntl1.call_id());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Join(cntl2.call_id());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>krpc::DoNothing()å¯è·å¾—ä¸€ä¸ªä»€ä¹ˆéƒ½ä¸å¹²çš„doneï¼Œä¸“é—¨ç”¨äºåŠåŒæ­¥è®¿é—®ã€‚å®ƒçš„ç”Ÿå‘½å‘¨æœŸç”±æ¡†æ¶ç®¡ç†ï¼Œç”¨æˆ·ä¸ ç”¨å…³å¿ƒã€‚</p>
<p>æ³¨æ„åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨RPCç»“æŸååˆè®¿é—®äº†controller.call_id()ï¼Œè¿™æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºDoNothingä¸­å¹¶ä¸ä¼šåƒä¸ŠèŠ‚ä¸­çš„on_rpc_doneä¸­é‚£æ ·åˆ é™¤Controllerã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å–æ¶ˆrpc">å–æ¶ˆRPC<a href="#å–æ¶ˆrpc" class="hash-link" aria-label="Direct link to å–æ¶ˆRPC" title="Direct link to å–æ¶ˆRPC">â€‹</a></h3>
<p>krpc::StartCancel(call_id)å¯å–æ¶ˆå¯¹åº”çš„RPCï¼Œcall_idå¿…é¡»<strong>åœ¨å‘èµ·RPCå‰</strong>é€šè¿‡Controller.call_id()è·å¾—ï¼Œå…¶ä»–æ—¶åˆ»éƒ½å¯èƒ½æœ‰race conditionã€‚</p>
<p>æ³¨æ„ï¼šæ˜¯krpc::StartCancel(call_id)ï¼Œä¸æ˜¯controller-&gt;StartCancel()ï¼Œåè€…è¢«ç¦ç”¨ï¼Œæ²¡æœ‰æ•ˆæœã€‚åè€…æ˜¯protobufé»˜è®¤æä¾›çš„æ¥å£ï¼Œä½†æ˜¯åœ¨controllerå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸Šæœ‰ä¸¥é‡çš„ç«äº‰é—®é¢˜ã€‚</p>
<p>é¡¾åæ€ä¹‰ï¼ŒStartCancelè°ƒç”¨å®ŒæˆåRPCå¹¶æœªç«‹åˆ»ç»“æŸï¼Œä½ ä¸åº”è¯¥ç¢°è§¦Controllerçš„ä»»ä½•å­—æ®µæˆ–åˆ é™¤ä»»ä½•èµ„æºï¼Œå®ƒä»¬è‡ªç„¶ä¼šåœ¨RPCç»“æŸæ—¶è¢«doneä¸­å¯¹åº”é€»è¾‘å¤„ç†ã€‚å¦‚æœä½ ä¸€å®šè¦åœ¨åŸåœ°ç­‰åˆ°RPCç»“æŸï¼ˆä¸€èˆ¬ä¸éœ€è¦ï¼‰ï¼Œåˆ™å¯é€šè¿‡Join(call_id)ã€‚</p>
<p>å…³äºStartCancelçš„ä¸€äº›äº‹å®ï¼š</p>
<ul>
<li>call_idåœ¨å‘èµ·RPCå‰å°±å¯ä»¥è¢«å–æ¶ˆï¼ŒRPCä¼šç›´æ¥ç»“æŸï¼ˆdoneä»ä¼šè¢«è°ƒç”¨ï¼‰ã€‚</li>
<li>call_idå¯ä»¥åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¢«å–æ¶ˆã€‚</li>
<li>å–æ¶ˆä¸€ä¸ªå·²ç»å–æ¶ˆçš„call_idä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚æ¨è®ºï¼šåŒä¸€ä¸ªcall_idå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶å–æ¶ˆï¼Œä½†æœ€å¤šä¸€æ¬¡æœ‰æ•ˆæœã€‚</li>
<li>è¿™é‡Œçš„å–æ¶ˆæ˜¯çº¯clientç«¯çš„åŠŸèƒ½ï¼Œ<strong>serverç«¯æœªå¿…ä¼šå–æ¶ˆå¯¹åº”çš„æ“ä½œ</strong>ï¼Œserver cancelationæ˜¯å¦ä¸€ä¸ªåŠŸèƒ½ã€‚</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è·å–serverçš„åœ°å€å’Œç«¯å£">è·å–Serverçš„åœ°å€å’Œç«¯å£<a href="#è·å–serverçš„åœ°å€å’Œç«¯å£" class="hash-link" aria-label="Direct link to è·å–Serverçš„åœ°å€å’Œç«¯å£" title="Direct link to è·å–Serverçš„åœ°å€å’Œç«¯å£">â€‹</a></h3>
<p>remote_side()æ–¹æ³•å¯çŸ¥é“requestè¢«é€å‘äº†å“ªä¸ªserverï¼Œè¿”å›å€¼ç±»å‹æ˜¯<a href="https://github.com/apache/krpc/blob/master/src/kutil/endpoint.h" target="_blank" rel="noopener noreferrer">kutil::EndPoint</a>ï¼ŒåŒ…å«ä¸€ä¸ªip4åœ°å€å’Œç«¯å£ã€‚åœ¨RPCç»“æŸå‰è°ƒç”¨è¿™ä¸ªæ–¹æ³•éƒ½æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚</p>
<p>æ‰“å°æ–¹å¼ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOG(INFO) &lt;&lt; &quot;remote_side=&quot; &lt;&lt; cntl-&gt;remote_side();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;remote_side=%s\n&quot;, kutil::endpoint2str(cntl-&gt;remote_side()).c_str());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è·å–clientçš„åœ°å€å’Œç«¯å£">è·å–Clientçš„åœ°å€å’Œç«¯å£<a href="#è·å–clientçš„åœ°å€å’Œç«¯å£" class="hash-link" aria-label="Direct link to è·å–Clientçš„åœ°å€å’Œç«¯å£" title="Direct link to è·å–Clientçš„åœ°å€å’Œç«¯å£">â€‹</a></h3>
<p>r31384åé€šè¿‡local_side()æ–¹æ³•å¯<strong>åœ¨RPCç»“æŸå</strong>è·å¾—å‘èµ·RPCçš„åœ°å€å’Œç«¯å£ã€‚</p>
<p>æ‰“å°æ–¹å¼ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOG(INFO) &lt;&lt; &quot;local_side=&quot; &lt;&lt; cntl-&gt;local_side(); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;local_side=%s\n&quot;, kutil::endpoint2str(cntl-&gt;local_side()).c_str());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="åº”è¯¥é‡ç”¨krpccontrollerå—">åº”è¯¥é‡ç”¨krpc::Controllerå—?<a href="#åº”è¯¥é‡ç”¨krpccontrollerå—" class="hash-link" aria-label="Direct link to åº”è¯¥é‡ç”¨krpc::Controllerå—?" title="Direct link to åº”è¯¥é‡ç”¨krpc::Controllerå—?">â€‹</a></h3>
<p>ä¸ç”¨åˆ»æ„åœ°é‡ç”¨ï¼Œä½†Controlleræ˜¯ä¸ªå¤§æ‚çƒ©ï¼Œå¯èƒ½ä¼šåŒ…å«ä¸€äº›ç¼“å­˜ï¼ŒReset()å¯ä»¥é¿å…åå¤åœ°åˆ›å»ºè¿™äº›ç¼“å­˜ã€‚</p>
<p>åœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ï¼Œæ„é€ Controller(snippet1)å’Œé‡ç½®Controller(snippet2)çš„æ€§èƒ½å·®å¼‚ä¸å¤§ã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// snippet1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (int i = 0; i &lt; n; ++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    krpc::Controller controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stub.CallSomething(..., &amp;controller);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// snippet2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::Controller controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (int i = 0; i &lt; n; ++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    controller.Reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stub.CallSomething(..., &amp;controller);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ä½†å¦‚æœsnippet1ä¸­çš„Controlleræ˜¯newå‡ºæ¥çš„ï¼Œé‚£ä¹ˆsnippet1å°±ä¼šå¤šå‡ºâ€œå†…å­˜åˆ†é…â€çš„å¼€é”€ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹å¯èƒ½ä¼šæ…¢ä¸€äº›ã€‚</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è®¾ç½®">è®¾ç½®<a href="#è®¾ç½®" class="hash-link" aria-label="Direct link to è®¾ç½®" title="Direct link to è®¾ç½®">â€‹</a></h2>
<p>Clientç«¯çš„è®¾ç½®ä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>krpc::ChannelOptions: å®šä¹‰åœ¨<a href="https://github.com/apache/krpc/blob/master/src/krpc/channel.h" target="_blank" rel="noopener noreferrer">src/krpc/channel.h</a>ä¸­ï¼Œç”¨äºåˆå§‹åŒ–Channelï¼Œä¸€æ—¦åˆå§‹åŒ–æˆåŠŸæ— æ³•ä¿®æ”¹ã€‚</li>
<li>krpc::Controller: å®šä¹‰åœ¨<a href="https://github.com/apache/krpc/blob/master/src/krpc/controller.h" target="_blank" rel="noopener noreferrer">src/krpc/controller.h</a>ä¸­ï¼Œç”¨äºåœ¨æŸæ¬¡RPCä¸­è¦†ç›–ChannelOptionsä¸­çš„é€‰é¡¹ï¼Œå¯æ ¹æ®ä¸Šä¸‹æ–‡æ¯æ¬¡å‡ä¸åŒã€‚</li>
<li>å…¨å±€gflagsï¼šå¸¸ç”¨äºè°ƒèŠ‚ä¸€äº›åº•å±‚ä»£ç çš„è¡Œä¸ºï¼Œä¸€èˆ¬ä¸ç”¨ä¿®æ”¹ã€‚è¯·è‡ªè¡Œé˜…è¯»æœåŠ¡<a href="/docs/next/cpp/krpc/flags">/flagsé¡µé¢</a>ä¸­çš„è¯´æ˜ã€‚</li>
</ul>
<p>ControlleråŒ…å«äº†requestä¸­æ²¡æœ‰çš„æ•°æ®å’Œé€‰é¡¹ã€‚serverç«¯å’Œclientç«¯çš„Controllerç»“æ„ä½“æ˜¯ä¸€æ ·çš„ï¼Œä½†ä½¿ç”¨çš„å­—æ®µå¯èƒ½æ˜¯ä¸åŒçš„ï¼Œä½ éœ€è¦ä»”ç»†é˜…è¯»Controllerä¸­çš„æ³¨é‡Šï¼Œæ˜ç¡®å“ªäº›å­—æ®µå¯ä»¥åœ¨serverç«¯ä½¿ç”¨ï¼Œå“ªäº›å¯ä»¥åœ¨clientç«¯ä½¿ç”¨ã€‚</p>
<p>ä¸€ä¸ªControllerå¯¹åº”ä¸€æ¬¡RPCã€‚ä¸€ä¸ªControllerå¯ä»¥åœ¨Reset()åè¢«å¦ä¸€ä¸ªRPCå¤ç”¨ï¼Œä½†ä¸€ä¸ªControllerä¸èƒ½è¢«å¤šä¸ªRPCåŒæ—¶ä½¿ç”¨ï¼ˆä¸è®ºæ˜¯å¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹å‘èµ·ï¼‰ã€‚</p>
<p>Controllerçš„ç‰¹ç‚¹ï¼š</p>
<ol>
<li>ä¸€ä¸ªControlleråªèƒ½æœ‰ä¸€ä¸ªä½¿ç”¨è€…ï¼Œæ²¡æœ‰ç‰¹æ®Šè¯´æ˜çš„è¯ï¼ŒControllerä¸­çš„æ–¹æ³•é»˜è®¤çº¿ç¨‹ä¸å®‰å…¨ã€‚</li>
<li>å› ä¸ºä¸èƒ½è¢«å…±äº«ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä¼šç”¨å…±äº«æŒ‡é’ˆç®¡ç†Controllerï¼Œå¦‚æœä½ ç”¨å…±äº«æŒ‡é’ˆäº†ï¼Œå¾ˆå¯èƒ½æ„å‘³ç€å‡ºé”™äº†ã€‚</li>
<li>Controlleråˆ›å»ºäºå¼€å§‹RPC å‰ï¼Œææ„äºRPCç»“æŸåï¼Œå¸¸è§å‡ ç§æ¨¡å¼ï¼š<!-- -->
<ul>
<li>åŒæ­¥RPCå‰Controlleræ”¾æ ˆä¸Šï¼Œå‡ºä½œç”¨åŸŸåè‡ªè¡Œææ„ã€‚æ³¨æ„å¼‚æ­¥RPCçš„Controllerç»å¯¹ä¸èƒ½æ”¾æ ˆä¸Šï¼Œå¦åˆ™å…¶ææ„æ—¶å¼‚æ­¥è°ƒç”¨å¾ˆå¯èƒ½è¿˜åœ¨è¿›è¡Œä¸­ï¼Œä»è€Œå¼•å‘æœªå®šä¹‰è¡Œä¸ºã€‚</li>
<li>å¼‚æ­¥RPCå‰new Controllerï¼Œdoneä¸­åˆ é™¤ã€‚</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="çº¿ç¨‹æ•°">çº¿ç¨‹æ•°<a href="#çº¿ç¨‹æ•°" class="hash-link" aria-label="Direct link to çº¿ç¨‹æ•°" title="Direct link to çº¿ç¨‹æ•°">â€‹</a></h3>
<p>å’Œå¤§éƒ¨åˆ†çš„RPCæ¡†æ¶ä¸åŒï¼Œkrpcä¸­å¹¶æ²¡æœ‰ç‹¬ç«‹çš„Clientçº¿ç¨‹æ± ã€‚æ‰€æœ‰Channelå’ŒServeré€šè¿‡<a href="/docs/next/cpp/krpc/kthread">kthread</a>å…±äº«ç›¸åŒçš„çº¿ç¨‹æ± . å¦‚æœä½ çš„ç¨‹åºåŒæ ·ä½¿ç”¨äº†krpcçš„server, ä»…ä»…éœ€è¦è®¾ç½®Serverçš„çº¿ç¨‹æ•°ã€‚ æˆ–è€…å¯ä»¥é€šè¿‡<a href="/docs/next/cpp/krpc/flags">gflags</a>è®¾ç½®<a href="http://krpc.baidu.com:8765/flags/kthread_concurrency" target="_blank" rel="noopener noreferrer">-kthread_concurrency</a>æ¥è®¾ç½®å…¨å±€çš„çº¿ç¨‹æ•°.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è¶…æ—¶">è¶…æ—¶<a href="#è¶…æ—¶" class="hash-link" aria-label="Direct link to è¶…æ—¶" title="Direct link to è¶…æ—¶">â€‹</a></h3>
<p><strong>ChannelOptions.timeout_ms</strong>æ˜¯å¯¹åº”Channelä¸Šæ‰€æœ‰RPCçš„æ€»è¶…æ—¶ï¼ŒController.set_timeout_ms()å¯ä¿®æ”¹æŸæ¬¡RPCçš„å€¼ã€‚å•ä½æ¯«ç§’ï¼Œé»˜è®¤å€¼1ç§’ï¼Œæœ€å¤§å€¼2^31ï¼ˆçº¦24å¤©ï¼‰ï¼Œ-1è¡¨ç¤ºä¸€ç›´ç­‰åˆ°å›å¤æˆ–é”™è¯¯ã€‚</p>
<p><strong>ChannelOptions.connect_timeout_ms</strong>æ˜¯å¯¹åº”Channelä¸Šæ‰€æœ‰RPCçš„è¿æ¥è¶…æ—¶(å•ä½æ¯«ç§’)ã€‚-1è¡¨ç¤ºç­‰åˆ°è¿æ¥å»ºç«‹æˆ–å‡ºé”™ï¼Œæ­¤å€¼è¢«é™åˆ¶ä¸ºä¸èƒ½è¶…è¿‡timeout_msã€‚æ³¨æ„æ­¤è¶…æ—¶ç‹¬ç«‹äºTCPçš„è¿æ¥è¶…æ—¶ï¼Œä¸€èˆ¬æ¥è¯´å‰è€…å°äºåè€…ï¼Œåä¹‹åˆ™å¯èƒ½åœ¨connect_timeout_msæœªè¾¾åˆ°å‰ç”±äºTCPè¿æ¥è¶…æ—¶è€Œå‡ºé”™ã€‚</p>
<p>æ³¨æ„1ï¼škrpcä¸­çš„è¶…æ—¶æ˜¯deadlineï¼Œè¶…è¿‡å°±æ„å‘³ç€RPCç»“æŸï¼Œè¶…æ—¶åæ²¡æœ‰é‡è¯•ã€‚å…¶ä»–å®ç°å¯èƒ½æ—¢æœ‰å•æ¬¡è®¿é—®çš„è¶…æ—¶ï¼Œä¹Ÿæœ‰ä»£è¡¨deadlineçš„è¶…æ—¶ã€‚è¿ç§»åˆ°krpcæ—¶è¯·ä»”ç»†åŒº åˆ†ã€‚</p>
<p>æ³¨æ„2ï¼šRPCè¶…æ—¶çš„é”™è¯¯ç ä¸º<strong>ERPCTIMEDOUT (1008)</strong>ï¼ŒETIMEDOUTçš„æ„æ€æ˜¯è¿æ¥è¶…æ—¶ï¼Œä¸”å¯é‡è¯•ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é‡è¯•">é‡è¯•<a href="#é‡è¯•" class="hash-link" aria-label="Direct link to é‡è¯•" title="Direct link to é‡è¯•">â€‹</a></h3>
<p>ChannelOptions.max_retryæ˜¯è¯¥Channelä¸Šæ‰€æœ‰RPCçš„é»˜è®¤æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤å€¼3ï¼Œ0è¡¨ç¤ºä¸é‡è¯•ã€‚Controller.set_max_retry()å¯ä¿®æ”¹æŸæ¬¡RPCçš„å€¼ã€‚</p>
<p>r32111åController.retried_count()è¿”å›é‡è¯•æ¬¡æ•°ã€‚</p>
<p>r34717åController.has_backup_request()è·çŸ¥æ˜¯å¦å‘é€è¿‡backup_requestã€‚</p>
<p><strong>é‡è¯•æ—¶æ¡†æ¶ä¼šå°½é‡é¿å¼€ä¹‹å‰å°è¯•è¿‡çš„serverã€‚</strong></p>
<p>é‡è¯•çš„è§¦å‘æ¡ä»¶æœ‰(æ¡ä»¶ä¹‹é—´æ˜¯ANDå…³ç³»ï¼‰ï¼š</p>
<ul>
<li>è¿æ¥å‡ºé”™</li>
<li>æ²¡åˆ°è¶…æ—¶</li>
<li>æœ‰å‰©ä½™é‡è¯•æ¬¡æ•°</li>
<li>é”™è¯¯å€¼å¾—é‡è¯•</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è¿æ¥å‡ºé”™">è¿æ¥å‡ºé”™<a href="#è¿æ¥å‡ºé”™" class="hash-link" aria-label="Direct link to è¿æ¥å‡ºé”™" title="Direct link to è¿æ¥å‡ºé”™">â€‹</a></h4>
<p>å¦‚æœserverä¸€ç›´æ²¡æœ‰è¿”å›ï¼Œä½†è¿æ¥æ²¡æœ‰é—®é¢˜ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸ä¼šé‡è¯•ã€‚å¦‚æœä½ éœ€è¦åœ¨ä¸€å®šæ—¶é—´åå‘é€å¦ä¸€ä¸ªè¯·æ±‚ï¼Œä½¿ç”¨backup requestã€‚</p>
<p>å·¥ä½œæœºåˆ¶å¦‚ä¸‹ï¼šå¦‚æœresponseæ²¡æœ‰åœ¨backup_request_mså†…è¿”å›ï¼Œåˆ™å‘é€å¦å¤–ä¸€ä¸ªè¯·æ±‚ï¼Œå“ªä¸ªå…ˆå›æ¥å°±å–å“ªä¸ªã€‚æ–°è¯·æ±‚ä¼šè¢«å°½é‡é€åˆ°ä¸åŒçš„serverã€‚æ³¨æ„å¦‚æœbackup_request_mså¤§äºè¶…æ—¶ï¼Œåˆ™backup requestæ€»ä¸ä¼šè¢«å‘é€ã€‚backup requestä¼šæ¶ˆè€—ä¸€æ¬¡é‡è¯•æ¬¡æ•°ã€‚backup requestä¸æ„å‘³ç€serverç«¯cancelã€‚</p>
<p>ChannelOptions.backup_request_mså½±å“è¯¥Channelä¸Šæ‰€æœ‰RPCï¼Œå•ä½æ¯«ç§’ï¼Œé»˜è®¤å€¼-1ï¼ˆè¡¨ç¤ºä¸å¼€å¯ï¼‰ï¼ŒController.set_backup_request_ms()å¯ä¿®æ”¹æŸæ¬¡RPCçš„å€¼ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="æ²¡åˆ°è¶…æ—¶">æ²¡åˆ°è¶…æ—¶<a href="#æ²¡åˆ°è¶…æ—¶" class="hash-link" aria-label="Direct link to æ²¡åˆ°è¶…æ—¶" title="Direct link to æ²¡åˆ°è¶…æ—¶">â€‹</a></h4>
<p>è¶…æ—¶åRPCä¼šå°½å¿«ç»“æŸã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="æœ‰å‰©ä½™é‡è¯•æ¬¡æ•°">æœ‰å‰©ä½™é‡è¯•æ¬¡æ•°<a href="#æœ‰å‰©ä½™é‡è¯•æ¬¡æ•°" class="hash-link" aria-label="Direct link to æœ‰å‰©ä½™é‡è¯•æ¬¡æ•°" title="Direct link to æœ‰å‰©ä½™é‡è¯•æ¬¡æ•°">â€‹</a></h4>
<p>Controller.set_max_retry(0)æˆ–ChannelOptions.max_retry=0å…³é—­é‡è¯•ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é”™è¯¯å€¼å¾—é‡è¯•">é”™è¯¯å€¼å¾—é‡è¯•<a href="#é”™è¯¯å€¼å¾—é‡è¯•" class="hash-link" aria-label="Direct link to é”™è¯¯å€¼å¾—é‡è¯•" title="Direct link to é”™è¯¯å€¼å¾—é‡è¯•">â€‹</a></h4>
<p>ä¸€äº›é”™è¯¯é‡è¯•æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå°±ä¸ä¼šé‡è¯•ï¼Œæ¯”å¦‚è¯·æ±‚æœ‰é”™æ—¶(EREQUEST)ä¸ä¼šé‡è¯•ï¼Œå› ä¸ºserveræ€»ä¸ä¼šæ¥å—,æ²¡æœ‰æ„ä¹‰ã€‚</p>
<p>ç”¨æˆ·å¯ä»¥é€šè¿‡ç»§æ‰¿<a href="https://github.com/apache/krpc/blob/master/src/krpc/retry_policy.h" target="_blank" rel="noopener noreferrer">krpc::RetryPolicy</a>è‡ªå®šä¹‰é‡è¯•æ¡ä»¶ã€‚æ¯”å¦‚krpcé»˜è®¤ä¸é‡è¯•http/h2ç›¸å…³çš„é”™è¯¯ï¼Œè€Œä½ çš„ç¨‹åºä¸­å¸Œæœ›åœ¨ç¢°åˆ°HTTP_STATUS_FORBIDDEN (403)æ—¶é‡è¯•ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;krpc/retry_policy.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyRetryPolicy : public krpc::RetryPolicy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool DoRetry(const krpc::Controller* cntl) const {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cntl-&gt;ErrorCode() == krpc::EHTTP &amp;&amp; // http/h2é”™è¯¯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cntl-&gt;http_response().status_code() == krpc::HTTP_STATUS_FORBIDDEN) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æŠŠå…¶ä»–æƒ…å†µä¸¢ç»™æ¡†æ¶ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return krpc::DefaultRetryPolicy()-&gt;DoRetry(cntl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ç»™ChannelOptions.retry_policyèµ‹å€¼å°±è¡Œäº†ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// æ³¨æ„ï¼šretry_policyå¿…é¡»åœ¨Channelä½¿ç”¨æœŸé—´ä¿æŒæœ‰æ•ˆï¼ŒChannelä¹Ÿä¸ä¼šåˆ é™¤retry_policyï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹RetryPolicyéƒ½åº”ä»¥å•ä¾‹æ¨¡å¼åˆ›å»ºã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::ChannelOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static MyRetryPolicy g_my_retry_policy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.retry_policy = &amp;g_my_retry_policy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ä¸€äº›æç¤ºï¼š</p>
<ul>
<li>é€šè¿‡cntl-&gt;response()å¯è·å¾—å¯¹åº”RPCçš„responseã€‚</li>
<li>å¯¹ERPCTIMEDOUTä»£è¡¨çš„RPCè¶…æ—¶æ€»æ˜¯ä¸é‡è¯•ï¼Œå³ä½¿ä½ ç»§æ‰¿çš„RetryPolicyä¸­å…è®¸ã€‚</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é‡è¯•é€€é¿">é‡è¯•é€€é¿<a href="#é‡è¯•é€€é¿" class="hash-link" aria-label="Direct link to é‡è¯•é€€é¿" title="Direct link to é‡è¯•é€€é¿">â€‹</a></h4>
<p>å¯¹äºä¸€äº›æš‚æ—¶æ€§çš„é”™è¯¯ï¼Œå¦‚ç½‘ç»œæŠ–åŠ¨ç­‰ï¼Œç­‰å¾…ä¸€å°ä¼šå„¿å†é‡è¯•çš„æˆåŠŸç‡æ¯”ç«‹å³é‡è¯•çš„æˆåŠŸç‡é«˜ï¼ŒåŒæ—¶å¯ä»¥æ‰“æ•£ä¸Šæ¸¸é‡è¯•çš„æ—¶æœºï¼Œå‡è½»æœåŠ¡ç«¯å‹åŠ›ï¼Œé¿å…é‡è¯•é£æš´å¯¼è‡´æœåŠ¡ç«¯å‡ºç°ç¬é—´æµé‡æ´ªå³°ã€‚</p>
<p>æ¡†æ¶æ”¯æŒä¸¤ç§é‡è¯•é€€é¿ç­–ç•¥ï¼šå›ºå®šæ—¶é—´é—´éš”é€€é¿ç­–ç•¥å’Œéšæœºæ—¶é—´é—´éš”é€€é¿ç­–ç•¥ã€‚</p>
<p>å›ºå®šæ—¶é—´é—´éš”é€€é¿ç­–ç•¥éœ€è¦è®¾ç½®å›ºå®šæ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰ã€æ— éœ€é‡è¯•é€€é¿çš„å‰©ä½™rpcæ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼Œå½“å‰©ä½™rpcæ—¶é—´å°äºé˜ˆå€¼ï¼Œåˆ™ä¸è¿›è¡Œé‡è¯•é€€é¿ï¼‰ã€æ˜¯å¦å…è®¸åœ¨pthreadè¿›è¡Œé‡è¯•é€€é¿ã€‚ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ç»™ChannelOptions.retry_policyèµ‹å€¼å°±è¡Œäº†ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// æ³¨æ„ï¼šretry_policyå¿…é¡»åœ¨Channelä½¿ç”¨æœŸé—´ä¿æŒæœ‰æ•ˆï¼ŒChannelä¹Ÿä¸ä¼šåˆ é™¤retry_policyï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹RetryPolicyéƒ½åº”ä»¥å•ä¾‹æ¨¡å¼åˆ›å»ºã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::ChannelOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int32_t fixed_backoff_time_ms = 100; // å›ºå®šæ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int32_t no_backoff_remaining_rpc_time_ms = 150; // æ— éœ€é‡è¯•é€€é¿çš„å‰©ä½™rpcæ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bool retry_backoff_in_pthread = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static krpc::RpcRetryPolicyWithFixedBackoff g_retry_policy_with_fixed_backoff(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fixed_backoff_time_ms, no_backoff_remaining_rpc_time_ms, retry_backoff_in_pthread);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.retry_policy = &amp;g_retry_policy_with_fixed_backoff;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>éšæœºæ—¶é—´é—´éš”é€€é¿ç­–ç•¥éœ€è¦è®¾ç½®æœ€å°æ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰ã€æœ€å¤§æ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰ã€æ— éœ€é‡è¯•é€€é¿çš„å‰©ä½™rpcæ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼Œå½“å‰©ä½™rpcæ—¶é—´å°äºé˜ˆå€¼ï¼Œåˆ™ä¸è¿›è¡Œé‡è¯•é€€é¿ï¼‰ã€æ˜¯å¦å…è®¸åœ¨pthreadåšé‡è¯•é€€é¿ã€‚æ¯æ¬¡ç­–ç•¥ä¼šéšæœºç”Ÿæˆä¸€ä¸ªåœ¨æœ€å°æ—¶é—´é—´éš”å’Œæœ€å¤§æ—¶é—´é—´éš”ä¹‹é—´çš„é‡è¯•é€€é¿é—´éš”ã€‚ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ç»™ChannelOptions.retry_policyèµ‹å€¼å°±è¡Œäº†ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// æ³¨æ„ï¼šretry_policyå¿…é¡»åœ¨Channelä½¿ç”¨æœŸé—´ä¿æŒæœ‰æ•ˆï¼ŒChannelä¹Ÿä¸ä¼šåˆ é™¤retry_policyï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹RetryPolicyéƒ½åº”ä»¥å•ä¾‹æ¨¡å¼åˆ›å»ºã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::ChannelOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int32_t min_backoff_time_ms = 100; // æœ€å°æ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int32_t max_backoff_time_ms = 200; // æœ€å¤§æ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int32_t no_backoff_remaining_rpc_time_ms = 150; // æ— éœ€é‡è¯•é€€é¿çš„å‰©ä½™rpcæ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bool retry_backoff_in_pthread = false; //   æ˜¯å¦å…è®¸åœ¨pthreadåšé‡è¯•é€€é¿</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static krpc::RpcRetryPolicyWithJitteredBackoff g_retry_policy_with_jitter_backoff(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        min_backoff_time_ms, max_backoff_time_ms, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        no_backoff_remaining_rpc_time_ms, retry_backoff_in_pthread);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.retry_policy = &amp;g_retry_policy_with_jitter_backoff;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ç”¨æˆ·å¯ä»¥é€šè¿‡ç»§æ‰¿<a href="https://github.com/apache/krpc/blob/master/src/krpc/retry_policy.h" target="_blank" rel="noopener noreferrer">krpc::RetryPolicy</a>è‡ªå®šä¹‰é‡è¯•é€€é¿ç­–ç•¥ã€‚æ¯”å¦‚åªéœ€è¦é’ˆå¯¹æœåŠ¡ç«¯å¹¶å‘æ•°è¶…é™çš„æƒ…å†µè¿›è¡Œé‡è¯•é€€é¿ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class MyRetryPolicy : public krpc::RetryPolicy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool DoRetry(const krpc::Controller* cntl) const {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒã€Šé”™è¯¯å€¼å¾—é‡è¯•ã€‹ä¸€èŠ‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t GetBackoffTimeMs(const krpc::Controller* cntl) const {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (controller-&gt;ErrorCode() == krpc::ELIMIT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 100; // é€€é¿100æ¯«ç§’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0; // è¿”å›0è¡¨ç¤ºä¸è¿›è¡Œé‡è¯•é€€é¿ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool CanRetryBackoffInPthread() const {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ç»™ChannelOptions.retry_policyèµ‹å€¼å°±è¡Œäº†ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// æ³¨æ„ï¼šretry_policyå¿…é¡»åœ¨Channelä½¿ç”¨æœŸé—´ä¿æŒæœ‰æ•ˆï¼ŒChannelä¹Ÿä¸ä¼šåˆ é™¤retry_policyï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹RetryPolicyéƒ½åº”ä»¥å•ä¾‹æ¨¡å¼åˆ›å»ºã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">krpc::ChannelOptions options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static MyRetryPolicy g_my_retry_policy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.retry_policy = &amp;g_my_retry_policy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>å¦‚æœç”¨æˆ·å¸Œæœ›ä½¿ç”¨æ¡†æ¶é»˜è®¤çš„DoRetryï¼Œåªå®ç°è‡ªå®šä¹‰çš„é‡è¯•é€€é¿ç­–ç•¥ï¼Œåˆ™å¯ä»¥ç»§æ‰¿<a href="https://github.com/apache/krpc/blob/master/src/krpc/retry_policy.h" target="_blank" rel="noopener noreferrer">krpc::RpcRetryPolicy</a>ã€‚</p>
<p>ä¸€äº›æç¤ºï¼š</p>
<ul>
<li>å½“ç­–ç•¥è¿”å›çš„é‡è¯•é€€é¿æ—¶é—´å¤§äºç­‰äºå‰©ä½™çš„rpcæ—¶é—´æˆ–è€…ç­‰äº0ï¼Œæ¡†æ¶ä¸ä¼šè¿›è¡Œé‡è¯•é€€é¿ï¼Œè€Œæ˜¯ç«‹å³è¿›è¡Œé‡è¯•ã€‚</li>
<li><a href="https://github.com/apache/krpc/blob/master/src/krpc/retry_policy.h" target="_blank" rel="noopener noreferrer">krpc::RpcRetryPolicyWithFixedBackoff</a>ï¼ˆå›ºå®šæ—¶é—´é—´éš”é€€ç­–ç•¥ï¼‰å’Œ<a href="https://github.com/apache/krpc/blob/master/src/krpc/retry_policy.h" target="_blank" rel="noopener noreferrer">krpc::RpcRetryPolicyWithJitteredBackoff</a>ï¼ˆéšæœºæ—¶é—´é—´éš”é€€ç­–ç•¥ï¼‰ç»§æ‰¿äº†<a href="https://github.com/apache/krpc/blob/master/src/krpc/retry_policy.h" target="_blank" rel="noopener noreferrer">krpc::RpcRetryPolicy</a>ï¼Œä½¿ç”¨æ¡†æ¶é»˜è®¤çš„DoRetryã€‚</li>
<li>åœ¨pthreadä¸­è¿›è¡Œé‡è¯•é€€é¿ï¼ˆå®é™…ä¸Šé€šè¿‡kthread_usleepå®ç°ï¼‰ä¼šé˜»å¡pthreadï¼Œæ‰€ä»¥é»˜è®¤ä¸ä¼šåœ¨pthreadä¸Šè¿›è¡Œé‡è¯•é€€é¿ã€‚</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é‡è¯•åº”å½“ä¿å®ˆ">é‡è¯•åº”å½“ä¿å®ˆ<a href="#é‡è¯•åº”å½“ä¿å®ˆ" class="hash-link" aria-label="Direct link to é‡è¯•åº”å½“ä¿å®ˆ" title="Direct link to é‡è¯•åº”å½“ä¿å®ˆ">â€‹</a></h4>
<p>ç”±äºæˆæœ¬çš„é™åˆ¶ï¼Œå¤§éƒ¨åˆ†çº¿ä¸Šserverçš„å†—ä½™åº¦æ˜¯æœ‰é™çš„ï¼Œä¸»è¦æ˜¯æ»¡è¶³å¤šæœºæˆ¿äº’å¤‡çš„éœ€æ±‚ã€‚è€Œæ¿€è¿›çš„é‡è¯•é€»è¾‘å¾ˆå®¹æ˜“å¯¼è‡´ä¼—å¤šclientå¯¹serveré›†ç¾¤é€ æˆ2-3å€çš„å‹åŠ›ï¼Œæœ€ç»ˆä½¿é›†ç¾¤é›ªå´©ï¼šç”±äºserveræ¥ä¸åŠå¤„ç†å¯¼è‡´é˜Ÿåˆ—è¶Šç§¯è¶Šé•¿ï¼Œä½¿æ‰€æœ‰çš„è¯·æ±‚å¾—ç»è¿‡å¾ˆé•¿çš„æ’é˜Ÿæ‰è¢«å¤„ç†è€Œæœ€ç»ˆè¶…æ—¶ï¼Œç›¸å½“äºæœåŠ¡åœæ‘†ã€‚é»˜è®¤çš„é‡è¯•æ˜¯æ¯”è¾ƒå®‰å…¨çš„: åªè¦è¿æ¥ä¸æ–­RPCå°±ä¸ä¼šé‡è¯•ï¼Œä¸€èˆ¬ä¸ä¼šäº§ç”Ÿå¤§é‡çš„é‡è¯•è¯·æ±‚ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡RetryPolicyå®šåˆ¶é‡è¯•ç­–ç•¥ï¼Œä½†ä¹Ÿå¯èƒ½ä½¿é‡è¯•å˜æˆä¸€åœºâ€œé£æš´â€ã€‚å½“ä½ å®šåˆ¶RetryPolicyæ—¶ï¼Œä½ éœ€è¦ä»”ç»†è€ƒè™‘clientå’Œserverçš„åä½œå…³ç³»ï¼Œå¹¶è®¾è®¡å¯¹åº”çš„å¼‚å¸¸æµ‹è¯•ï¼Œä»¥ç¡®ä¿è¡Œä¸ºç¬¦åˆé¢„æœŸã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ç†”æ–­">ç†”æ–­<a href="#ç†”æ–­" class="hash-link" aria-label="Direct link to ç†”æ–­" title="Direct link to ç†”æ–­">â€‹</a></h3>
<p>å…·ä½“æ–¹æ³•è§<a href="/docs/next/cpp/krpc/circuit_breaker">è¿™é‡Œ</a>ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="åè®®">åè®®<a href="#åè®®" class="hash-link" aria-label="Direct link to åè®®" title="Direct link to åè®®">â€‹</a></h4>
<p>Channelçš„é»˜è®¤åè®®æ˜¯baidu_stdï¼Œå¯é€šè¿‡è®¾ç½®ChannelOptions.protocolæ¢ä¸ºå…¶ä»–åè®®ï¼Œè¿™ä¸ªå­—æ®µæ—¢æ¥å—enumä¹Ÿæ¥å—å­—ç¬¦ä¸²ã€‚</p>
<p>ç›®å‰æ”¯æŒçš„æœ‰ï¼š</p>
<ul>
<li>PROTOCOL_BAIDU_STD æˆ– â€œbaidu_std&quot;ï¼Œå³<a href="/docs/next/cpp/krpc/kumo_std">kumoæ ‡å‡†åè®®</a>ï¼Œé»˜è®¤ä¸ºå•è¿æ¥ã€‚</li>
<li>PROTOCOL_HTTP æˆ– â€http&quot;, http/1.0æˆ–http/1.1åè®®ï¼Œé»˜è®¤ä¸ºè¿æ¥æ± (Keep-Alive)ã€‚<!-- -->
<ul>
<li>è®¿é—®æ™®é€šhttpæœåŠ¡çš„æ–¹æ³•è§<a href="/docs/next/cpp/krpc/http_client">è®¿é—®http/h2æœåŠ¡</a></li>
<li>é€šè¿‡http<!-- -->:json<!-- -->æˆ–http<!-- -->:proto<!-- -->è®¿é—®pbæœåŠ¡çš„æ–¹æ³•è§<a href="/docs/next/cpp/krpc/http_derivatives">http/h2è¡ç”Ÿåè®®</a></li>
</ul>
</li>
<li>PROTOCOL_H2 æˆ– â€h2&quot;, http/2åè®®ï¼Œé»˜è®¤æ˜¯å•è¿æ¥ã€‚<!-- -->
<ul>
<li>è®¿é—®æ™®é€šh2æœåŠ¡çš„æ–¹æ³•è§<a href="/docs/next/cpp/krpc/http_client">è®¿é—®http/h2æœåŠ¡</a>ã€‚</li>
<li>é€šè¿‡h2<!-- -->:json<!-- -->æˆ–h2<!-- -->:proto<!-- -->è®¿é—®pbæœåŠ¡çš„æ–¹æ³•è§<a href="/docs/next/cpp/krpc/http_derivatives">http/h2è¡ç”Ÿåè®®</a></li>
</ul>
</li>
<li>&quot;h2<!-- -->:grpc<!-- -->&quot;, <a href="https://grpc.io" target="_blank" rel="noopener noreferrer">gRPC</a>çš„åè®®ï¼Œä¹Ÿæ˜¯h2çš„è¡ç”Ÿåè®®ï¼Œé»˜è®¤ä¸ºå•è¿æ¥ï¼Œå…·ä½“è§<a href="/docs/next/cpp/krpc/http_derivatives#h2grpc">h2<!-- -->:grpc</a>ã€‚</li>
<li>PROTOCOL_THRIFT æˆ– &quot;thrift&quot;ï¼Œ<a href="https://thrift.apache.org" target="_blank" rel="noopener noreferrer">apache thrift</a>çš„åè®®ï¼Œé»˜è®¤ä¸ºè¿æ¥æ± , å…·ä½“æ–¹æ³•è§<a href="/docs/next/cpp/krpc/thrift">è®¿é—®thrift</a>ã€‚</li>
<li>PROTOCOL_MEMCACHE æˆ– &quot;memcache&quot;ï¼Œmemcachedçš„äºŒè¿›åˆ¶åè®®ï¼Œé»˜è®¤ä¸ºå•è¿æ¥ã€‚å…·ä½“æ–¹æ³•è§<a href="/docs/next/cpp/krpc/memcache_client">è®¿é—®memcached</a>ã€‚</li>
<li>PROTOCOL_REDIS æˆ– &quot;redis&quot;ï¼Œredis 1.2åçš„åè®®(ä¹Ÿæ˜¯hiredisæ”¯æŒçš„åè®®)ï¼Œé»˜è®¤ä¸ºå•è¿æ¥ã€‚å…·ä½“æ–¹æ³•è§<a href="/docs/next/cpp/krpc/redis_client">è®¿é—®Redis</a>ã€‚</li>
<li>PROTOCOL_HULU_PKRPC æˆ– &quot;hulu_pbrpc&quot;ï¼Œhuluçš„åè®®ï¼Œé»˜è®¤ä¸ºå•è¿æ¥ã€‚</li>
<li>PROTOCOL_NOVA_PKRPC æˆ– â€nova_pbrpcâ€œï¼Œç½‘ç›Ÿçš„åè®®ï¼Œé»˜è®¤ä¸ºè¿æ¥æ± ã€‚</li>
<li>PROTOCOL_SOFA_PKRPC æˆ– &quot;sofa_pbrpc&quot;ï¼Œsofa-pbrpcçš„åè®®ï¼Œé»˜è®¤ä¸ºå•è¿æ¥ã€‚</li>
<li>PROTOCOL_PUBLIC_PKRPC æˆ– &quot;public_pbrpc&quot;ï¼Œpublic_pbrpcçš„åè®®ï¼Œé»˜è®¤ä¸ºè¿æ¥æ± ã€‚</li>
<li>PROTOCOL_NSHEAD_MCPACK æˆ– &quot;nshead_mcpack&quot;, é¡¾åæ€ä¹‰ï¼Œæ ¼å¼ä¸ºnshead + mcpackï¼Œä½¿ç”¨mcpack2pbé€‚é…ï¼Œé»˜è®¤ä¸ºè¿æ¥æ± ã€‚</li>
<li>PROTOCOL_ESP æˆ– &quot;esp&quot;ï¼Œè®¿é—®ä½¿ç”¨espåè®®çš„æœåŠ¡ï¼Œé»˜è®¤ä¸ºè¿æ¥æ± ã€‚</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è¿æ¥æ–¹å¼">è¿æ¥æ–¹å¼<a href="#è¿æ¥æ–¹å¼" class="hash-link" aria-label="Direct link to è¿æ¥æ–¹å¼" title="Direct link to è¿æ¥æ–¹å¼">â€‹</a></h3>
<p>krpcæ”¯æŒä»¥ä¸‹è¿æ¥æ–¹å¼ï¼š</p>
<ul>
<li>çŸ­è¿æ¥ï¼šæ¯æ¬¡RPCå‰å»ºç«‹è¿æ¥ï¼Œç»“æŸåå…³é—­è¿æ¥ã€‚ç”±äºæ¯æ¬¡è°ƒç”¨å¾—æœ‰å»ºç«‹è¿æ¥çš„å¼€é”€ï¼Œè¿™ç§æ–¹å¼ä¸€èˆ¬ç”¨äºå¶å°”å‘èµ·çš„æ“ä½œï¼Œè€Œä¸æ˜¯æŒç»­å‘èµ·è¯·æ±‚çš„åœºæ™¯ã€‚æ²¡æœ‰åè®®é»˜è®¤ä½¿ç”¨è¿™ç§è¿æ¥æ–¹å¼ï¼Œhttp/1.0å¯¹è¿æ¥çš„å¤„ç†æ•ˆæœç±»ä¼¼çŸ­é“¾æ¥ã€‚</li>
<li>è¿æ¥æ± ï¼šæ¯æ¬¡RPCå‰å–ç”¨ç©ºé—²è¿æ¥ï¼Œç»“æŸåå½’è¿˜ï¼Œä¸€ä¸ªè¿æ¥ä¸Šæœ€å¤šåªæœ‰ä¸€ä¸ªè¯·æ±‚ï¼Œä¸€ä¸ªclientå¯¹ä¸€å°serverå¯èƒ½æœ‰å¤šæ¡è¿æ¥ã€‚http/1.1å’Œå„ç±»ä½¿ç”¨nsheadçš„åè®®éƒ½æ˜¯è¿™ä¸ªæ–¹å¼ã€‚</li>
<li>å•è¿æ¥ï¼šè¿›ç¨‹å†…æ‰€æœ‰clientä¸ä¸€å°serveræœ€å¤šåªæœ‰ä¸€ä¸ªè¿æ¥ï¼Œä¸€ä¸ªè¿æ¥ä¸Šå¯èƒ½åŒæ—¶æœ‰å¤šä¸ªè¯·æ±‚ï¼Œå›å¤è¿”å›é¡ºåºå’Œè¯·æ±‚é¡ºåºä¸éœ€è¦ä¸€è‡´ï¼Œè¿™æ˜¯baidu_stdï¼Œhulu_pbrpcï¼Œsofa_pbrpcåè®®çš„é»˜è®¤é€‰é¡¹ã€‚</li>
</ul>
<table><thead><tr><th></th><th>çŸ­è¿æ¥</th><th>è¿æ¥æ± </th><th>å•è¿æ¥</th></tr></thead><tbody><tr><td>é•¿è¿æ¥</td><td>å¦</td><td>æ˜¯</td><td>æ˜¯</td></tr><tr><td>serverç«¯è¿æ¥æ•°(å•client)</td><td>qps*latency (åŸç†è§<a href="https://en.wikipedia.org/wiki/Little%27s_law" target="_blank" rel="noopener noreferrer">little&#x27;s law</a>)</td><td>qps*latency</td><td>1</td></tr><tr><td>æé™qps</td><td>å·®ï¼Œä¸”å—é™äºå•æœºç«¯å£æ•°</td><td>ä¸­ç­‰</td><td>é«˜</td></tr><tr><td>latency</td><td>1.5RTT(connect) + 1RTT + å¤„ç†æ—¶é—´</td><td>1RTT + å¤„ç†æ—¶é—´</td><td>1RTT + å¤„ç†æ—¶é—´</td></tr><tr><td>cpuå ç”¨</td><td>é«˜, æ¯æ¬¡éƒ½è¦tcp connect</td><td>ä¸­ç­‰, æ¯ä¸ªè¯·æ±‚éƒ½è¦ä¸€æ¬¡sys write</td><td>ä½, åˆå¹¶å†™å‡ºåœ¨å¤§æµé‡æ—¶å‡å°‘cpuå ç”¨</td></tr></tbody></table>
<p>æ¡†æ¶ä¼šä¸ºåè®®é€‰æ‹©é»˜è®¤çš„è¿æ¥æ–¹å¼ï¼Œç”¨æˆ·<strong>ä¸€èˆ¬ä¸ç”¨ä¿®æ”¹</strong>ã€‚è‹¥éœ€è¦ï¼ŒæŠŠChannelOptions.connection_typeè®¾ä¸ºï¼š</p>
<ul>
<li>
<p>CONNECTION_TYPE_SINGLE æˆ– &quot;single&quot; ä¸ºå•è¿æ¥</p>
</li>
<li>
<p>CONNECTION_TYPE_POOLED æˆ– &quot;pooled&quot; ä¸ºè¿æ¥æ± , å•ä¸ªè¿œç«¯å¯¹åº”çš„è¿æ¥æ± æœ€å¤šèƒ½å®¹çº³çš„è¿æ¥æ•°ç”±-max_connection_pool_sizeæ§åˆ¶ã€‚æ³¨æ„,æ­¤é€‰é¡¹ä¸ç­‰ä»·äºâ€œæœ€å¤§è¿æ¥æ•°â€ã€‚éœ€è¦è¿æ¥æ—¶åªè¦æ²¡æœ‰é—²ç½®çš„ï¼Œå°±ä¼šæ–°å»ºï¼›å½’è¿˜æ—¶ï¼Œè‹¥æ± ä¸­å·²æœ‰max_connection_pool_sizeä¸ªè¿æ¥çš„è¯ï¼Œä¼šç›´æ¥å…³é—­ã€‚max_connection_pool_sizeçš„å–å€¼è¦ç¬¦åˆå¹¶å‘ï¼Œå¦åˆ™è¶…å‡ºçš„éƒ¨åˆ†ä¼šè¢«é¢‘ç¹å»ºç«‹å’Œå…³é—­ï¼Œæ•ˆæœç±»ä¼¼çŸ­è¿æ¥ã€‚è‹¥max_connection_pool_sizeä¸º0ï¼Œå°±è¿‘ä¼¼äºå®Œå…¨çš„çŸ­è¿æ¥ã€‚</p>
<table><thead><tr><th>Name</th><th>Value</th><th>Description</th><th>Defined At</th></tr></thead><tbody><tr><td>max_connection_pool_size (R)</td><td>100</td><td>Max number of pooled connections to a single endpoint</td><td>src/krpc/socket.cpp</td></tr></tbody></table>
</li>
<li>
<p>CONNECTION_TYPE_SHORT æˆ– &quot;short&quot; ä¸ºçŸ­è¿æ¥</p>
</li>
<li>
<p>è®¾ç½®ä¸ºâ€œâ€ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰åˆ™è®©æ¡†æ¶é€‰æ‹©åè®®å¯¹åº”çš„é»˜è®¤è¿æ¥æ–¹å¼ã€‚</p>
</li>
</ul>
<p>krpcæ”¯æŒ<a href="/docs/next/cpp/krpc/streaming_rpc">Streaming RPC</a>ï¼Œè¿™æ˜¯ä¸€ç§åº”ç”¨å±‚çš„è¿æ¥ï¼Œç”¨äºä¼ é€’æµå¼æ•°æ®ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å…³é—­è¿æ¥æ± ä¸­çš„é—²  ç½®è¿æ¥">å…³é—­è¿æ¥æ± ä¸­çš„é—²ç½®è¿æ¥<a href="#å…³é—­è¿æ¥æ± ä¸­çš„é—²ç½®è¿æ¥" class="hash-link" aria-label="Direct link to å…³é—­è¿æ¥æ± ä¸­çš„é—²ç½®è¿æ¥" title="Direct link to å…³é—­è¿æ¥æ± ä¸­çš„é—²ç½®è¿æ¥">â€‹</a></h3>
<p>å½“è¿æ¥æ± ä¸­çš„æŸä¸ªè¿æ¥åœ¨-idle_timeout_secondæ—¶é—´å†…æ²¡æœ‰è¯»å†™ï¼Œåˆ™è¢«è§†ä½œâ€œé—²ç½®â€ï¼Œä¼šè¢«è‡ªåŠ¨å…³é—­ã€‚é»˜è®¤å€¼ä¸º10ç§’ã€‚æ­¤åŠŸèƒ½åªå¯¹è¿æ¥æ± (pooled)æœ‰æ•ˆã€‚æ‰“å¼€-log_idle_connection_closeåœ¨å…³é—­å‰ä¼šæ‰“å°ä¸€æ¡æ—¥å¿—ã€‚</p>
<table><thead><tr><th>Name</th><th>Value</th><th>Description</th><th>Defined At</th></tr></thead><tbody><tr><td>idle_timeout_second</td><td>10</td><td>Pooled connections without data transmission for so many seconds will be closed. No effect for non-positive values</td><td>src/krpc/socket_map.cpp</td></tr><tr><td>log_idle_connection_close</td><td>false</td><td>Print log when an idle connection is closed</td><td>src/krpc/socket.cpp</td></tr></tbody></table>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å»¶è¿Ÿå…³é—­è¿æ¥">å»¶è¿Ÿå…³é—­è¿æ¥<a href="#å»¶è¿Ÿå…³é—­è¿æ¥" class="hash-link" aria-label="Direct link to å»¶è¿Ÿå…³é—­è¿æ¥" title="Direct link to å»¶è¿Ÿå…³é—­è¿æ¥">â€‹</a></h3>
<p>å¤šä¸ªchannelå¯èƒ½é€šè¿‡å¼•ç”¨è®¡æ•°å¼•ç”¨åŒä¸€ä¸ªè¿æ¥ï¼Œå½“å¼•ç”¨æŸä¸ªè¿æ¥çš„æœ€åä¸€ä¸ªchannelææ„æ—¶ï¼Œè¯¥è¿æ¥å°†è¢«å…³é—­ã€‚ä½†åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œchannelåœ¨ä½¿ç”¨å‰æ‰è¢«åˆ›å»ºï¼Œç”¨å®Œç«‹åˆ»ææ„ï¼Œè¿™æ—¶å…¶ä¸­ä¸€äº›è¿æ¥å°±ä¼šè¢«æ— è°“åœ°å…³é—­å†è¢«æ‰“å¼€ï¼Œæ•ˆæœç±»ä¼¼çŸ­è¿æ¥ã€‚</p>
<p>ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯ç”¨æˆ·æŠŠæ‰€æœ‰æˆ–å¸¸ç”¨çš„channelç¼“å­˜ä¸‹æ¥ï¼Œè¿™æ ·è‡ªç„¶èƒ½é¿å…channelé¢‘ç¹äº§ç”Ÿå’Œææ„ï¼Œä½†ç›®å‰krpcæ²¡æœ‰æä¾›è¿™æ ·ä¸€ä¸ªutilityï¼Œç”¨æˆ·è‡ªå·±ï¼ˆæ­£ç¡®ï¼‰å®ç°æœ‰ä¸€äº›å·¥ä½œé‡ã€‚</p>
<p>å¦ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯è®¾ç½®å…¨å±€é€‰é¡¹-defer_close_second</p>
<table><thead><tr><th>Name</th><th>Value</th><th>Description</th><th>Defined At</th></tr></thead><tbody><tr><td>defer_close_second</td><td>0</td><td>Defer close of connections for so many seconds even if the connection is not used by anyone. Close immediately for non-positive values</td><td>src/krpc/socket_map.cpp</td></tr></tbody></table>
<p>è®¾ç½®åå¼•ç”¨è®¡æ•°æ¸…0æ—¶è¿æ¥å¹¶ä¸ä¼šç«‹åˆ»è¢«å…³é—­ï¼Œè€Œæ˜¯ä¼šç­‰å¾…è¿™ä¹ˆå¤šç§’å†å…³é—­ï¼Œå¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…åˆæœ‰channelå¼•ç”¨äº†è¿™ä¸ªè¿æ¥ï¼Œå®ƒä¼šæ¢å¤æ­£å¸¸è¢«ä½¿ç”¨çš„çŠ¶æ€ã€‚ä¸ç®¡channelåˆ›å»ºææ„æœ‰å¤šé¢‘ç‡ï¼Œè¿™ä¸ªé€‰é¡¹ä½¿å¾—å…³é—­è¿æ¥çš„é¢‘ç‡æœ‰ä¸Šé™ã€‚è¿™ä¸ªé€‰é¡¹çš„å‰¯ä½œç”¨æ˜¯ä¸€äº›fdä¸ä¼šè¢«åŠæ—¶å…³é—­ï¼Œå¦‚æœå»¶æ—¶è¢«è¯¯è®¾ä¸ºä¸€ä¸ªå¤§æ•°å€¼ï¼Œç¨‹åºå æ®çš„fdä¸ªæ•°å¯èƒ½ä¼šå¾ˆå¤§ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è¿æ¥çš„ç¼“å†²åŒºå¤§å°">è¿æ¥çš„ç¼“å†²åŒºå¤§å°<a href="#è¿æ¥çš„ç¼“å†²åŒºå¤§å°" class="hash-link" aria-label="Direct link to è¿æ¥çš„ç¼“å†²åŒºå¤§å°" title="Direct link to è¿æ¥çš„ç¼“å†²åŒºå¤§å°">â€‹</a></h3>
<p>-socket_recv_buffer_sizeè®¾ç½®æ‰€æœ‰è¿æ¥çš„æ¥æ”¶ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤-1ï¼ˆä¸ä¿®æ”¹ï¼‰</p>
<p>-socket_send_buffer_sizeè®¾ç½®æ‰€æœ‰è¿æ¥çš„å‘é€ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤-1ï¼ˆä¸ä¿®æ”¹ï¼‰</p>
<table><thead><tr><th>Name</th><th>Value</th><th>Description</th><th>Defined At</th></tr></thead><tbody><tr><td>socket_recv_buffer_size</td><td>-1</td><td>Set the recv buffer size of socket if this value is positive</td><td>src/krpc/socket.cpp</td></tr><tr><td>socket_send_buffer_size</td><td>-1</td><td>Set send buffer size of sockets if this value is positive</td><td>src/krpc/socket.cpp</td></tr></tbody></table>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="log_id">log_id<a href="#log_id" class="hash-link" aria-label="Direct link to log_id" title="Direct link to log_id">â€‹</a></h3>
<p>é€šè¿‡set_log_id()å¯è®¾ç½®64ä½æ•´å‹log_idã€‚è¿™ä¸ªidä¼šå’Œè¯·æ±‚ä¸€èµ·è¢«é€åˆ°æœåŠ¡å™¨ç«¯ï¼Œä¸€èˆ¬ä¼šè¢«æ‰“åœ¨æ—¥å¿—é‡Œï¼Œä»è€ŒæŠŠä¸€æ¬¡æ£€ç´¢ç»è¿‡çš„æ‰€æœ‰æœåŠ¡ä¸²è”èµ·æ¥ã€‚å­—ç¬¦ä¸²æ ¼å¼çš„éœ€è¦è½¬åŒ–ä¸º64ä½æ•´å½¢æ‰èƒ½è®¾å…¥log_idã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é™„ä»¶">é™„ä»¶<a href="#é™„ä»¶" class="hash-link" aria-label="Direct link to é™„ä»¶" title="Direct link to é™„ä»¶">â€‹</a></h3>
<p>baidu_stdå’Œhulu_pbrpcåè®®æ”¯æŒé™„ä»¶ï¼Œè¿™æ®µæ•°æ®ç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼Œä¸ç»è¿‡protobufçš„åºåˆ—åŒ–ã€‚ç«™åœ¨clientçš„è§’åº¦ï¼Œè®¾ç½®åœ¨Controller::request_attachment()çš„é™„ä»¶ä¼šè¢«serverç«¯æ”¶åˆ°ï¼Œresponse_attachment()åˆ™åŒ…å«äº†serverç«¯é€å›çš„é™„ä»¶ã€‚é™„ä»¶ä¸å—å‹ç¼©é€‰é¡¹å½±å“ã€‚</p>
<p>åœ¨http/h2åè®®ä¸­ï¼Œé™„ä»¶å¯¹åº”<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html" target="_blank" rel="noopener noreferrer">message body</a>ï¼Œæ¯”å¦‚è¦POSTçš„æ•°æ®å°±è®¾ç½®åœ¨request_attachment()ä¸­ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å¼€å¯ssl">å¼€å¯SSL<a href="#å¼€å¯ssl" class="hash-link" aria-label="Direct link to å¼€å¯SSL" title="Direct link to å¼€å¯SSL">â€‹</a></h3>
<p>è¦å¼€å¯SSLï¼Œé¦–å…ˆç¡®ä¿ä»£ç ä¾èµ–äº†æœ€æ–°çš„opensslåº“ã€‚å¦‚æœopensslç‰ˆæœ¬å¾ˆæ—§ï¼Œä¼šæœ‰ä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”¯æŒçš„åŠ å¯†ç®—æ³•ä¹Ÿå°‘ï¼Œè¿èƒŒäº†å¼€å¯SSLçš„åˆè¡·ã€‚
ç„¶åè®¾ç½®<code>ChannelOptions.mutable_ssl_options()</code>ï¼Œå…·ä½“é€‰é¡¹è§<a href="https://github.com/apache/krpc/blob/master/src/krpc/ssl_options.h" target="_blank" rel="noopener noreferrer">ssl_options.h</a>ã€‚ChannelOptions.has_ssl_options()å¯æŸ¥è¯¢æ˜¯å¦è®¾ç½®è¿‡ssl_options, ChannelOptions.ssl_options()å¯è®¿é—®åˆ°è®¾ç½®è¿‡çš„åªè¯»ssl_optionsã€‚</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// å¼€å¯å®¢æˆ·ç«¯SSLå¹¶ä½¿ç”¨é»˜è®¤å€¼ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.mutable_ssl_options();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// å¼€å¯å®¢æˆ·ç«¯SSLå¹¶å®šåˆ¶é€‰é¡¹ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.mutable_ssl_options()-&gt;ciphers_name = &quot;...&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.mutable_ssl_options()-&gt;sni_name = &quot;...&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// è®¾ç½® ALPN çš„åè®®ä¼˜å…ˆçº§ï¼ˆé»˜è®¤ä¸å¯ç”¨ ALPNï¼‰ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options.mutable_ssl_options()-&gt;alpn_protocols = {&quot;h2&quot;, &quot;http/1.1&quot;};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>è¿æ¥å•ç‚¹å’Œé›†ç¾¤çš„Channelå‡å¯ä»¥å¼€å¯SSLè®¿é—®ï¼ˆåˆå§‹å®ç°æ›¾ä¸æ”¯æŒé›†ç¾¤ï¼‰ã€‚</li>
<li>å¼€å¯åï¼Œè¯¥Channelä¸Šä»»ä½•åè®®çš„è¯·æ±‚ï¼Œéƒ½ä¼šè¢«SSLåŠ å¯†åå‘é€ã€‚å¦‚æœå¸Œæœ›æŸäº›è¯·æ±‚ä¸åŠ å¯†ï¼Œéœ€è¦é¢å¤–å†åˆ›å»ºä¸€ä¸ªChannelã€‚</li>
<li>é’ˆå¯¹HTTPSåšäº†äº›æ˜“ç”¨æ€§ä¼˜åŒ–ï¼šChannel.Initèƒ½è‡ªåŠ¨è¯†åˆ«<code>https://</code>å‰ç¼€å¹¶è‡ªåŠ¨å¼€å¯SSLï¼›å¼€å¯-http_verboseä¹Ÿä¼šè¾“å‡ºè¯ä¹¦ä¿¡æ¯ã€‚</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="è®¤è¯">è®¤è¯<a href="#è®¤è¯" class="hash-link" aria-label="Direct link to è®¤è¯" title="Direct link to è®¤è¯">â€‹</a></h3>
<p>clientç«¯çš„è®¤è¯ä¸€èˆ¬åˆ†ä¸º2ç§ï¼š</p>
<ol>
<li>åŸºäºè¯·æ±‚çš„è®¤è¯ï¼šæ¯æ¬¡è¯·æ±‚éƒ½ä¼šå¸¦ä¸Šè®¤è¯ä¿¡æ¯ã€‚è¿™ç§æ–¹å¼æ¯”è¾ƒçµæ´»ï¼Œè®¤è¯ä¿¡æ¯ä¸­å¯ä»¥å«æœ‰æœ¬æ¬¡è¯·æ±‚ä¸­çš„å­—æ®µï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯æ¯æ¬¡è¯·æ±‚éƒ½ä¼šéœ€è¦è®¤è¯ï¼Œæ€§èƒ½ä¸Šæœ‰æ‰€æŸå¤±</li>
<li>åŸºäºè¿æ¥çš„è®¤è¯ï¼šå½“TCPè¿æ¥å»ºç«‹åï¼Œclientå‘é€è®¤è¯åŒ…ï¼Œè®¤è¯æˆåŠŸåï¼Œåç»­è¯¥è¿æ¥ä¸Šçš„è¯·æ±‚ä¸å†éœ€è¦è®¤è¯ã€‚ç›¸æ¯”å‰è€…ï¼Œè¿™ç§æ–¹å¼çµæ´»åº¦ä¸é«˜ï¼ˆä¸€èˆ¬è®¤è¯åŒ…é‡Œåªèƒ½æºå¸¦æœ¬æœºä¸€äº›é™æ€ä¿¡æ¯ï¼‰ï¼Œä½†æ€§èƒ½è¾ƒå¥½ï¼Œä¸€èˆ¬ç”¨äºå•è¿æ¥/è¿æ¥æ± åœºæ™¯</li>
</ol>
<p>é’ˆå¯¹ç¬¬ä¸€ç§è®¤è¯åœºæ™¯ï¼Œåœ¨å®ç°ä¸Šéå¸¸ç®€å•ï¼Œå°†è®¤è¯çš„æ ¼å¼å®šä¹‰åŠ åˆ°è¯·æ±‚ç»“æ„ä½“ä¸­ï¼Œæ¯æ¬¡å½“åšæ­£å¸¸RPCå‘é€å‡ºå»å³å¯ï¼›é’ˆå¯¹ç¬¬äºŒç§åœºæ™¯ï¼Œkrpcæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œåªè¦ç”¨æˆ·ç»§æ‰¿å®ç°ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class Authenticator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual ~Authenticator() {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Implement this method to generate credential information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // into `auth_str&#x27; which will be sent to `VerifyCredential&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // at server side. This method will be called on client side.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Returns 0 on success, error code otherwise</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual int GenerateCredential(std::string* auth_str) const = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>é‚£ä¹ˆå½“ç”¨æˆ·å¹¶å‘è°ƒç”¨RPCæ¥å£ç”¨å•è¿æ¥å¾€åŒä¸€ä¸ªserverå‘è¯·æ±‚æ—¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨ä¿è¯ï¼šå»ºç«‹TCPè¿æ¥åï¼Œè¿æ¥ä¸Šçš„ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸­ä¼šå¸¦æœ‰ä¸Šè¿°<code>GenerateCredential</code>äº§ç”Ÿçš„è®¤è¯åŒ…ï¼Œå…¶ä½™å‰©ä¸‹çš„å¹¶å‘è¯·æ±‚ä¸ä¼šå¸¦æœ‰è®¤è¯ä¿¡æ¯ï¼Œä¾æ¬¡æ’åœ¨ç¬¬ä¸€ä¸ªè¯·æ±‚ä¹‹åã€‚æ•´ä¸ªå‘é€è¿‡ç¨‹ä¾æ—§æ˜¯å¹¶å‘çš„ï¼Œå¹¶ä¸ä¼šç­‰ç¬¬ä¸€ä¸ªè¯·æ±‚å…ˆè¿”å›ã€‚è‹¥serverç«¯è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆæ‰€æœ‰è¯·æ±‚éƒ½èƒ½æˆåŠŸè¿”å›ï¼›è‹¥è®¤è¯å¤±è´¥ï¼Œä¸€èˆ¬serverç«¯åˆ™ä¼šå…³é—­è¿æ¥ï¼Œè¿™äº›è¯·æ±‚åˆ™ä¼šæ”¶åˆ°ç›¸åº”é”™è¯¯ã€‚</p>
<p>ç›®å‰è‡ªå¸¦åè®®ä¸­æ”¯æŒå®¢æˆ·ç«¯è®¤è¯çš„æœ‰ï¼š<a href="/docs/next/cpp/krpc/kumo_std">kumo_std</a>(é»˜è®¤åè®®), HTTP, hulu_pbrpc, ESPã€‚å¯¹äºè‡ªå®šä¹‰åè®®ï¼Œä¸€èˆ¬å¯ä»¥åœ¨ç»„è£…è¯·æ±‚é˜¶æ®µï¼Œè°ƒç”¨Authenticatoræ¥å£ç”Ÿæˆè®¤è¯ä¸²ï¼Œæ¥æ”¯æŒå®¢æˆ·ç«¯è®¤è¯ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="é‡ç½®">é‡ç½®<a href="#é‡ç½®" class="hash-link" aria-label="Direct link to é‡ç½®" title="Direct link to é‡ç½®">â€‹</a></h3>
<p>è°ƒç”¨Resetæ–¹æ³•å¯è®©Controllerå›åˆ°åˆšåˆ›å»ºæ—¶çš„çŠ¶æ€ã€‚</p>
<p>åˆ«åœ¨RPCç»“æŸå‰é‡ç½®Controllerï¼Œè¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="å‹ç¼©">å‹ç¼©<a href="#å‹ç¼©" class="hash-link" aria-label="Direct link to å‹ç¼©" title="Direct link to å‹ç¼©">â€‹</a></h3>
<p>set_request_compress_type()è®¾ç½®requestçš„å‹ç¼©æ–¹å¼ï¼Œé»˜è®¤ä¸å‹ç¼©ã€‚</p>
<p>æ³¨æ„ï¼šé™„ä»¶ä¸ä¼šè¢«å‹ç¼©ã€‚</p>
<p>http/h2 bodyçš„å‹ç¼©æ–¹æ³•è§<a href="/docs/next/cpp/krpc/http_client#%E5%8E%8B%E7%BC%A9request-body">clientå‹ç¼©request body</a>ã€‚</p>
<p>æ”¯æŒçš„å‹ç¼©æ–¹æ³•æœ‰ï¼š</p>
<ul>
<li>krpc::CompressTypeSnappy : <a href="http://google.github.io/snappy/" target="_blank" rel="noopener noreferrer">snappyå‹ç¼©</a>ï¼Œå‹ç¼©å’Œè§£å‹æ˜¾è‘—å¿«äºå…¶ä»–å‹ç¼©æ–¹æ³•ï¼Œä½†å‹ç¼©ç‡æœ€ä½ã€‚</li>
<li>krpc::CompressTypeGzip : <a href="http://en.wikipedia.org/wiki/Gzip" target="_blank" rel="noopener noreferrer">gzipå‹ç¼©</a>ï¼Œæ˜¾è‘—æ…¢äºsnappyï¼Œä½†å‹ç¼©ç‡é«˜</li>
<li>krpc::CompressTypeZlib : <a href="http://en.wikipedia.org/wiki/Zlib" target="_blank" rel="noopener noreferrer">zlibå‹ç¼©</a>ï¼Œæ¯”gzipå¿«10%~20%ï¼Œå‹ç¼©ç‡ç•¥å¥½äºgzipï¼Œä½†é€Ÿåº¦ä»æ˜æ˜¾æ…¢äºsnappyã€‚</li>
</ul>
<p>ä¸‹è¡¨æ˜¯å¤šç§å‹ç¼©ç®—æ³•åº”å¯¹é‡å¤ç‡å¾ˆé«˜çš„æ•°æ®æ—¶çš„æ€§èƒ½ï¼Œä»…ä¾›å‚è€ƒã€‚</p>
<table><thead><tr><th>Compress method</th><th>Compress size(B)</th><th>Compress time(us)</th><th>Decompress time(us)</th><th>Compress throughput(MB/s)</th><th>Decompress throughput(MB/s)</th><th>Compress ratio</th></tr></thead><tbody><tr><td>Snappy</td><td>128</td><td>0.753114</td><td>0.890815</td><td>162.0875</td><td>137.0322</td><td>37.50%</td></tr><tr><td>Gzip</td><td>10.85185</td><td>1.849199</td><td>11.2488</td><td>66.01252</td><td>47.66%</td><td></td></tr><tr><td>Zlib</td><td>10.71955</td><td>1.66522</td><td>11.38763</td><td>73.30581</td><td>38.28%</td><td></td></tr><tr><td>Snappy</td><td>1024</td><td>1.404812</td><td>1.374915</td><td>695.1555</td><td>710.2713</td><td>8.79%</td></tr><tr><td>Gzip</td><td>16.97748</td><td>3.950946</td><td>57.52106</td><td>247.1718</td><td>6.64%</td><td></td></tr><tr><td>Zlib</td><td>15.98913</td><td>3.06195</td><td>61.07665</td><td>318.9348</td><td>5.47%</td><td></td></tr><tr><td>Snappy</td><td>16384</td><td>8.822967</td><td>9.865008</td><td>1770.946</td><td>1583.881</td><td>4.96%</td></tr><tr><td>Gzip</td><td>160.8642</td><td>43.85911</td><td>97.13162</td><td>356.2544</td><td>0.78%</td><td></td></tr><tr><td>Zlib</td><td>147.6828</td><td>29.06039</td><td>105.8011</td><td>537.6734</td><td>0.71%</td><td></td></tr><tr><td>Snappy</td><td>32768</td><td>16.16362</td><td>19.43596</td><td>1933.354</td><td>1607.844</td><td>4.82%</td></tr><tr><td>Gzip</td><td>229.7803</td><td>82.71903</td><td>135.9995</td><td>377.7849</td><td>0.54%</td><td></td></tr><tr><td>Zlib</td><td>240.7464</td><td>54.44099</td><td>129.8046</td><td>574.0161</td><td>0.50%</td><td></td></tr></tbody></table>
<p>ä¸‹è¡¨æ˜¯å¤šç§å‹ç¼©ç®—æ³•åº”å¯¹é‡å¤ç‡å¾ˆä½çš„æ•°æ®æ—¶çš„æ€§èƒ½ï¼Œä»…ä¾›å‚è€ƒã€‚</p>
<table><thead><tr><th>Compress method</th><th>Compress size(B)</th><th>Compress time(us)</th><th>Decompress time(us)</th><th>Compress throughput(MB/s)</th><th>Decompress throughput(MB/s)</th><th>Compress ratio</th></tr></thead><tbody><tr><td>Snappy</td><td>128</td><td>0.866002</td><td>0.718052</td><td>140.9584</td><td>170.0021</td><td>105.47%</td></tr><tr><td>Gzip</td><td>15.89855</td><td>4.936242</td><td>7.678077</td><td>24.7294</td><td>116.41%</td><td></td></tr><tr><td>Zlib</td><td>15.88757</td><td>4.793953</td><td>7.683384</td><td>25.46339</td><td>107.03%</td><td></td></tr><tr><td>Snappy</td><td>1024</td><td>2.087972</td><td>1.06572</td><td>467.7087</td><td>916.3403</td><td>100.78%</td></tr><tr><td>Gzip</td><td>32.54279</td><td>12.27744</td><td>30.00857</td><td>79.5412</td><td>79.79%</td><td></td></tr><tr><td>Zlib</td><td>31.51397</td><td>11.2374</td><td>30.98824</td><td>86.90288</td><td>78.61%</td><td></td></tr><tr><td>Snappy</td><td>16384</td><td>12.598</td><td>6.306592</td><td>1240.276</td><td>2477.566</td><td>100.06%</td></tr><tr><td>Gzip</td><td>537.1803</td><td>129.7558</td><td>29.08707</td><td>120.4185</td><td>75.32%</td><td></td></tr><tr><td>Zlib</td><td>519.5705</td><td>115.1463</td><td>30.07291</td><td>135.697</td><td>75.24%</td><td></td></tr><tr><td>Snappy</td><td>32768</td><td>22.68531</td><td>12.39793</td><td>1377.543</td><td>2520.582</td><td>100.03%</td></tr><tr><td>Gzip</td><td>1403.974</td><td>258.9239</td><td>22.25825</td><td>120.6919</td><td>75.25%</td><td></td></tr><tr><td>Zlib</td><td>1370.201</td><td>230.3683</td><td>22.80687</td><td>135.6524</td><td>75.21%</td><td></td></tr></tbody></table>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="faq">FAQ<a href="#faq" class="hash-link" aria-label="Direct link to FAQ" title="Direct link to FAQ">â€‹</a></h2>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-krpcèƒ½ç”¨unix-domain-socketå—">Q: krpcèƒ½ç”¨unix domain socketå—<a href="#q-krpcèƒ½ç”¨unix-domain-socketå—" class="hash-link" aria-label="Direct link to Q: krpcèƒ½ç”¨unix domain socketå—" title="Direct link to Q: krpcèƒ½ç”¨unix domain socketå—">â€‹</a></h4>
<p>æ”¯æŒï¼Œå‚è€ƒ <a href="/docs/next/cpp/krpc/endpoint">EndPoint</a>.</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-fail-to-connect-to-xxxxxxxx-connection-refused">Q: Fail to connect to xx.xx.xx.xx<!-- -->:xxxx<!-- -->, Connection refused<a href="#q-fail-to-connect-to-xxxxxxxx-connection-refused" class="hash-link" aria-label="Direct link to q-fail-to-connect-to-xxxxxxxx-connection-refused" title="Direct link to q-fail-to-connect-to-xxxxxxxx-connection-refused">â€‹</a></h4>
<p>ä¸€èˆ¬æ˜¯å¯¹ç«¯serveræ²¡æ‰“å¼€ç«¯å£ï¼ˆå¾ˆå¯èƒ½æŒ‚äº†ï¼‰ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-ç»å¸¸é‡åˆ°è‡³å¦ä¸€ä¸ªæœºæˆ¿çš„connection-timedout">Q: ç»å¸¸é‡åˆ°è‡³å¦ä¸€ä¸ªæœºæˆ¿çš„Connection timedout<a href="#q-ç»å¸¸é‡åˆ°è‡³å¦ä¸€ä¸ªæœºæˆ¿çš„connection-timedout" class="hash-link" aria-label="Direct link to Q: ç»å¸¸é‡åˆ°è‡³å¦ä¸€ä¸ªæœºæˆ¿çš„Connection timedout" title="Direct link to Q: ç»å¸¸é‡åˆ°è‡³å¦ä¸€ä¸ªæœºæˆ¿çš„Connection timedout">â€‹</a></h4>
<!-- -->
<img src="[object Object]">
<p>è¿™ä¸ªå°±æ˜¯è¿æ¥è¶…æ—¶äº†ï¼Œè°ƒå¤§è¿æ¥å’ŒRPCè¶…æ—¶ï¼š</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct ChannelOptions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Issue error when a connection is not established after so many</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // milliseconds. -1 means wait indefinitely.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Default: 200 (milliseconds)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Maximum: 0x7fffffff (roughly 30 days)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t connect_timeout_ms;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Max duration of RPC over this Channel. -1 means wait indefinitely.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Overridable by Controller.set_timeout_ms().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Default: 500 (milliseconds)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Maximum: 0x7fffffff (roughly 30 days)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t timeout_ms;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>æ³¨æ„: è¿æ¥è¶…æ—¶ä¸æ˜¯RPCè¶…æ—¶ï¼ŒRPCè¶…æ—¶æ‰“å°çš„æ—¥å¿—æ˜¯&quot;Reached timeout=...&quot;ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-ä¸ºä»€ä¹ˆåŒæ­¥æ–¹å¼æ˜¯å¥½çš„å¼‚æ­¥å°±crashäº†">Q: ä¸ºä»€ä¹ˆåŒæ­¥æ–¹å¼æ˜¯å¥½çš„ï¼Œå¼‚æ­¥å°±crashäº†<a href="#q-ä¸ºä»€ä¹ˆåŒæ­¥æ–¹å¼æ˜¯å¥½çš„å¼‚æ­¥å°±crashäº†" class="hash-link" aria-label="Direct link to Q: ä¸ºä»€ä¹ˆåŒæ­¥æ–¹å¼æ˜¯å¥½çš„ï¼Œå¼‚æ­¥å°±crashäº†" title="Direct link to Q: ä¸ºä»€ä¹ˆåŒæ­¥æ–¹å¼æ˜¯å¥½çš„ï¼Œå¼‚æ­¥å°±crashäº†">â€‹</a></h4>
<p>é‡ç‚¹æ£€æŸ¥Controllerï¼ŒResponseå’Œdoneçš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨å¼‚æ­¥è®¿é—®ä¸­ï¼ŒRPCè°ƒç”¨ç»“æŸå¹¶ä¸æ„å‘³ç€RPCæ•´ä¸ªè¿‡ç¨‹ç»“æŸï¼Œè€Œæ˜¯åœ¨è¿›å…¥done-&gt;Run()æ—¶æ‰ä¼šç»“æŸã€‚æ‰€ä»¥è¿™äº›å¯¹è±¡ä¸åº”åœ¨è°ƒç”¨RPCåå°±é‡Šæ”¾ï¼Œè€Œæ˜¯è¦åœ¨done-&gt;Run()é‡Œé‡Šæ”¾ã€‚ä½ ä¸€èˆ¬ä¸èƒ½æŠŠè¿™äº›å¯¹è±¡åˆ†é…åœ¨æ ˆä¸Šï¼Œè€Œåº”è¯¥åˆ†é…åœ¨å †ä¸Šã€‚è¯¦è§<a href="/docs/next/cpp/krpc/client#%E5%BC%82%E6%AD%A5%E8%AE%BF%E9%97%AE">å¼‚æ­¥è®¿é—®</a>ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-æ€ä¹ˆç¡®ä¿è¯·æ±‚åªè¢«å¤„ç†ä¸€æ¬¡">Q: æ€ä¹ˆç¡®ä¿è¯·æ±‚åªè¢«å¤„ç†ä¸€æ¬¡<a href="#q-æ€ä¹ˆç¡®ä¿è¯·æ±‚åªè¢«å¤„ç†ä¸€æ¬¡" class="hash-link" aria-label="Direct link to Q: æ€ä¹ˆç¡®ä¿è¯·æ±‚åªè¢«å¤„ç†ä¸€æ¬¡" title="Direct link to Q: æ€ä¹ˆç¡®ä¿è¯·æ±‚åªè¢«å¤„ç†ä¸€æ¬¡">â€‹</a></h4>
<p>è¿™ä¸æ˜¯RPCå±‚é¢çš„äº‹æƒ…ã€‚å½“responseè¿”å›ä¸”æˆåŠŸæ—¶ï¼Œæˆ‘ä»¬ç¡®è®¤è¿™ä¸ªè¿‡ç¨‹ä¸€å®šæˆåŠŸäº†ã€‚å½“responseè¿”å›ä¸”å¤±è´¥æ—¶ï¼Œæˆ‘ä»¬ç¡®è®¤è¿™ä¸ªè¿‡ç¨‹ä¸€å®šå¤±è´¥äº†ã€‚ä½†å½“responseæ²¡æœ‰è¿”å›æ—¶ï¼Œå®ƒå¯èƒ½å¤±è´¥ï¼Œä¹Ÿå¯èƒ½æˆåŠŸã€‚å¦‚æœæˆ‘ä»¬é€‰æ‹©é‡è¯•ï¼Œé‚£ä¸€ä¸ªæˆåŠŸçš„è¿‡ç¨‹ä¹Ÿå¯èƒ½ä¼šè¢«å†æ‰§è¡Œä¸€æ¬¡ã€‚ä¸€èˆ¬æ¥è¯´å¸¦å‰¯ä½œç”¨çš„RPCæœåŠ¡éƒ½åº”å½“è€ƒè™‘<a href="http://en.wikipedia.org/wiki/Idempotence" target="_blank" rel="noopener noreferrer">å¹‚ç­‰</a>é—®é¢˜ï¼Œå¦åˆ™é‡è¯•å¯èƒ½ä¼šå¯¼è‡´å¤šæ¬¡å åŠ å‰¯ä½œç”¨è€Œäº§ç”Ÿæ„å‘ä¸åˆ°çš„ç»“æœã€‚åªæœ‰è¯»çš„æ£€ç´¢æœåŠ¡å¤§éƒ½æ²¡æœ‰å‰¯ä½œç”¨è€Œå¤©ç„¶å¹‚ç­‰ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†ã€‚è€Œå¸¦å†™çš„å­˜å‚¨æœåŠ¡åˆ™è¦åœ¨è®¾è®¡æ—¶å°±åŠ å…¥ç‰ˆæœ¬å·æˆ–åºåˆ—å·ä¹‹ç±»çš„æœºåˆ¶ä»¥æ‹’ç»å·²ç»å‘ç”Ÿçš„è¿‡ç¨‹ï¼Œä¿è¯å¹‚ç­‰ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-invalid-addressbnsgroupuser-personaduminj03">Q: Invalid address=`bns://group.user-persona.dumi.nj03&#x27;<a href="#q-invalid-addressbnsgroupuser-personaduminj03" class="hash-link" aria-label="Direct link to Q: Invalid address=`bns://group.user-persona.dumi.nj03&#x27;" title="Direct link to Q: Invalid address=`bns://group.user-persona.dumi.nj03&#x27;">â€‹</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FATAL 04-07 20:00:03 7778 src/krpc/channel.cpp:123] Invalid address=`bns://group.user-persona.dumi.nj03&#x27;. You should use Init(naming_service_name, load_balancer_name, options) to access multiple servers.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>è®¿é—®å‘½åæœåŠ¡è¦ä½¿ç”¨ä¸‰ä¸ªå‚æ•°çš„Initï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°æ˜¯load_balancer_nameï¼Œè€Œè¿™é‡Œç”¨çš„æ˜¯ä¸¤ä¸ªå‚æ•°çš„Initï¼Œæ¡†æ¶è®¤ä¸ºæ˜¯è®¿é—®å•ç‚¹ï¼Œå°±ä¼šæŠ¥è¿™ä¸ªé”™ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-ä¸¤ç«¯éƒ½ç”¨protobufä¸ºä»€ä¹ˆä¸èƒ½äº’ç›¸è®¿é—®">Q: ä¸¤ç«¯éƒ½ç”¨protobufï¼Œä¸ºä»€ä¹ˆä¸èƒ½äº’ç›¸è®¿é—®<a href="#q-ä¸¤ç«¯éƒ½ç”¨protobufä¸ºä»€ä¹ˆä¸èƒ½äº’ç›¸è®¿é—®" class="hash-link" aria-label="Direct link to Q: ä¸¤ç«¯éƒ½ç”¨protobufï¼Œä¸ºä»€ä¹ˆä¸èƒ½äº’ç›¸è®¿é—®" title="Direct link to Q: ä¸¤ç«¯éƒ½ç”¨protobufï¼Œä¸ºä»€ä¹ˆä¸èƒ½äº’ç›¸è®¿é—®">â€‹</a></h4>
<p><strong>åè®® !=protobuf</strong>ã€‚protobufè´Ÿè´£ä¸€ä¸ªåŒ…çš„åºåˆ—åŒ–ï¼Œåè®®ä¸­çš„ä¸€ä¸ªæ¶ˆæ¯å¯èƒ½ä¼šåŒ…å«å¤šä¸ªprotobufåŒ…ï¼Œä»¥åŠé¢å¤–çš„é•¿åº¦ã€æ ¡éªŒç ã€magic numberç­‰ç­‰ã€‚æ‰“åŒ…æ ¼å¼ç›¸åŒä¸æ„å‘³ç€åè®®å¯ä»¥äº’é€šã€‚åœ¨krpcä¸­å†™ä¸€ä»½ä»£ç å°±èƒ½æœåŠ¡å¤šåè®®çš„èƒ½åŠ›æ˜¯é€šè¿‡æŠŠä¸åŒåè®®çš„æ•°æ®è½¬åŒ–ä¸ºç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£å®Œæˆçš„ï¼Œè€Œä¸æ˜¯åœ¨protobufå±‚é¢ã€‚</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="q-ä¸ºä»€ä¹ˆc-clientserver-èƒ½å¤Ÿäº’ç›¸é€šä¿¡-å’Œå…¶ä»–è¯­è¨€çš„clientserver-é€šä¿¡ä¼šæŠ¥åºåˆ—åŒ–å¤±è´¥çš„é”™è¯¯">Q: ä¸ºä»€ä¹ˆC++ client/server èƒ½å¤Ÿäº’ç›¸é€šä¿¡ï¼Œ å’Œå…¶ä»–è¯­è¨€çš„client/server é€šä¿¡ä¼šæŠ¥åºåˆ—åŒ–å¤±è´¥çš„é”™è¯¯<a href="#q-ä¸ºä»€ä¹ˆc-clientserver-èƒ½å¤Ÿäº’ç›¸é€šä¿¡-å’Œå…¶ä»–è¯­è¨€çš„clientserver-é€šä¿¡ä¼šæŠ¥åºåˆ—åŒ–å¤±è´¥çš„é”™è¯¯" class="hash-link" aria-label="Direct link to Q: ä¸ºä»€ä¹ˆC++ client/server èƒ½å¤Ÿäº’ç›¸é€šä¿¡ï¼Œ å’Œå…¶ä»–è¯­è¨€çš„client/server é€šä¿¡ä¼šæŠ¥åºåˆ—åŒ–å¤±è´¥çš„é”™è¯¯" title="Direct link to Q: ä¸ºä»€ä¹ˆC++ client/server èƒ½å¤Ÿäº’ç›¸é€šä¿¡ï¼Œ å’Œå…¶ä»–è¯­è¨€çš„client/server é€šä¿¡ä¼šæŠ¥åºåˆ—åŒ–å¤±è´¥çš„é”™è¯¯">â€‹</a></h4>
<p>æ£€æŸ¥ä¸€ä¸‹C++ ç‰ˆæœ¬æ˜¯å¦å¼€å¯äº†å‹ç¼© (Controller::set_compress_type), ç›®å‰å…¶ä»–è¯­è¨€çš„rpcæ¡†æ¶è¿˜æ²¡æœ‰å®ç°å‹ç¼©ï¼Œäº’ç›¸è¿”å›ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<h1>é™„<!-- -->:Client<!-- -->ç«¯åŸºæœ¬æµç¨‹</h1>
<!-- -->
<img src="[object Object]">
<p>ä¸»è¦æ­¥éª¤ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ª<a href="https://github.com/apache/krpc/blob/master/src/kthread/id.h" target="_blank" rel="noopener noreferrer">kthread_id</a>ä½œä¸ºæœ¬æ¬¡RPCçš„correlation_idã€‚</li>
<li>æ ¹æ®Channelçš„åˆ›å»ºæ–¹å¼ï¼Œä»è¿›ç¨‹çº§çš„<a href="https://github.com/apache/krpc/blob/master/src/krpc/socket_map.h" target="_blank" rel="noopener noreferrer">SocketMap</a>ä¸­æˆ–ä»<a href="https://github.com/apache/krpc/blob/master/src/krpc/load_balancer.h" target="_blank" rel="noopener noreferrer">LoadBalancer</a>ä¸­é€‰æ‹©ä¸€å°ä¸‹æ¸¸serverä½œä¸ºæœ¬æ¬¡RPCå‘é€çš„ç›®çš„åœ°ã€‚</li>
<li>æ ¹æ®è¿æ¥æ–¹å¼ï¼ˆå•è¿æ¥ã€è¿æ¥æ± ã€çŸ­è¿æ¥ï¼‰ï¼Œé€‰æ‹©ä¸€ä¸ª<a href="https://github.com/apache/krpc/blob/master/src/krpc/socket.h" target="_blank" rel="noopener noreferrer">Socket</a>ã€‚</li>
<li>å¦‚æœå¼€å¯éªŒè¯ä¸”å½“å‰Socketæ²¡æœ‰è¢«éªŒè¯è¿‡æ—¶ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚è¿›å…¥éªŒè¯åˆ†æ”¯ï¼Œå…¶ä½™è¯·æ±‚ä¼šé˜»å¡ç›´åˆ°ç¬¬ä¸€ä¸ªåŒ…å«è®¤è¯ä¿¡æ¯çš„è¯·æ±‚å†™å…¥Socketã€‚serverç«¯åªå¯¹ç¬¬ä¸€ä¸ªè¯·æ±‚è¿›è¡ŒéªŒè¯ã€‚</li>
<li>æ ¹æ®Channelçš„åè®®ï¼Œé€‰æ‹©å¯¹åº”çš„åºåˆ—åŒ–å‡½æ•°æŠŠrequeståºåˆ—åŒ–è‡³<a href="https://github.com/apache/krpc/blob/master/src/kutil/iobuf.h" target="_blank" rel="noopener noreferrer">IOBuf</a>ã€‚</li>
<li>å¦‚æœé…ç½®äº†è¶…æ—¶ï¼Œè®¾ç½®å®šæ—¶å™¨ã€‚ä»è¿™ä¸ªç‚¹å¼€å§‹è¦é¿å…ä½¿ç”¨Controllerå¯¹è±¡ï¼Œå› ä¸ºåœ¨è®¾å®šå®šæ—¶å™¨åéšæ—¶å¯èƒ½è§¦å‘è¶…æ—¶-&gt;è°ƒç”¨åˆ°ç”¨æˆ·çš„è¶…æ—¶å›è°ƒ-&gt;ç”¨æˆ·åœ¨å›è°ƒä¸­ææ„Controllerã€‚</li>
<li>å‘é€å‡†å¤‡é˜¶æ®µç»“æŸï¼Œè‹¥ä¸Šè¿°ä»»ä½•æ­¥éª¤å‡ºé”™ï¼Œä¼šè°ƒç”¨Channel::HandleSendFailedã€‚</li>
<li>å°†ä¹‹å‰åºåˆ—åŒ–å¥½çš„IOBufå†™å‡ºåˆ°Socketä¸Šï¼ŒåŒæ—¶ä¼ å…¥å›è°ƒChannel::HandleSocketFailedï¼Œå½“è¿æ¥æ–­å¼€ã€å†™å¤±è´¥ç­‰é”™è¯¯å‘ç”Ÿæ—¶ä¼šè°ƒç”¨æ­¤å›è°ƒã€‚</li>
<li>å¦‚æœæ˜¯åŒæ­¥å‘é€ï¼ŒJoin correlation_idï¼›å¦åˆ™è‡³æ­¤CallMethodç»“æŸã€‚</li>
<li>ç½‘ç»œä¸Šå‘æ¶ˆæ¯+æ”¶æ¶ˆæ¯ã€‚</li>
<li>æ”¶åˆ°responseåï¼Œæå–å‡ºå…¶ä¸­çš„correlation_idï¼Œåœ¨O(1)æ—¶é—´å†…æ‰¾åˆ°å¯¹åº”çš„Controllerã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸éœ€è¦æŸ¥æ‰¾å…¨å±€å“ˆå¸Œè¡¨ï¼Œæœ‰è‰¯å¥½çš„å¤šæ ¸æ‰©å±•æ€§ã€‚</li>
<li>æ ¹æ®åè®®æ ¼å¼ååºåˆ—åŒ–responseã€‚</li>
<li>è°ƒç”¨Controller::OnRPCReturnedï¼Œå¯èƒ½ä¼šæ ¹æ®é”™è¯¯ç åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•ï¼Œæˆ–è®©RPCç»“æŸã€‚å¦‚æœæ˜¯å¼‚æ­¥å‘é€ï¼Œè°ƒç”¨ç”¨æˆ·å›è°ƒã€‚æœ€åæ‘§æ¯correlation_idå”¤é†’Joinç€çš„çº¿ç¨‹ã€‚</li>
</ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-05-24T10:16:12.000Z" itemprop="dateModified">May 24, 2025</time></b> by <b>Jeff lothar</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/next/cpp/krpc/kumo_std"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">kumoæ ‡å‡†åè®®</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/next/cpp/krpc/circuit_breaker"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ç†”æ–­åŠŸèƒ½</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#äº‹å®é€ŸæŸ¥" class="table-of-contents__link toc-highlight">äº‹å®é€ŸæŸ¥</a></li><li><a href="#channel" class="table-of-contents__link toc-highlight">Channel</a></li><li><a href="#è¿æ¥ä¸€å°æœåŠ¡å™¨" class="table-of-contents__link toc-highlight">è¿æ¥ä¸€å°æœåŠ¡å™¨</a></li><li><a href="#è¿æ¥æœåŠ¡é›†ç¾¤" class="table-of-contents__link toc-highlight">è¿æ¥æœåŠ¡é›†ç¾¤</a><ul><li><a href="#å‘½åæœåŠ¡" class="table-of-contents__link toc-highlight">å‘½åæœåŠ¡</a></li><li><a href="#è´Ÿè½½å‡è¡¡" class="table-of-contents__link toc-highlight">è´Ÿè½½å‡è¡¡</a></li><li><a href="#å¥åº·æ£€æŸ¥" class="table-of-contents__link toc-highlight">å¥åº·æ£€æŸ¥</a></li></ul></li><li><a href="#å‘èµ·è®¿é—®" class="table-of-contents__link toc-highlight">å‘èµ·è®¿é—®</a><ul><li><a href="#åŒæ­¥è®¿é—®" class="table-of-contents__link toc-highlight">åŒæ­¥è®¿é—®</a></li><li><a href="#å¼‚æ­¥è®¿é—®" class="table-of-contents__link toc-highlight">å¼‚æ­¥è®¿é—®</a></li><li><a href="#ç­‰å¾…rpcå®Œæˆ" class="table-of-contents__link toc-highlight">ç­‰å¾…RPCå®Œæˆ</a></li><li><a href="#åŠåŒæ­¥" class="table-of-contents__link toc-highlight">åŠåŒæ­¥</a></li><li><a href="#å–æ¶ˆrpc" class="table-of-contents__link toc-highlight">å–æ¶ˆRPC</a></li><li><a href="#è·å–serverçš„åœ°å€å’Œç«¯å£" class="table-of-contents__link toc-highlight">è·å–Serverçš„åœ°å€å’Œç«¯å£</a></li><li><a href="#è·å–clientçš„åœ°å€å’Œç«¯å£" class="table-of-contents__link toc-highlight">è·å–Clientçš„åœ°å€å’Œç«¯å£</a></li><li><a href="#åº”è¯¥é‡ç”¨krpccontrollerå—" class="table-of-contents__link toc-highlight">åº”è¯¥é‡ç”¨krpc::Controllerå—?</a></li></ul></li><li><a href="#è®¾ç½®" class="table-of-contents__link toc-highlight">è®¾ç½®</a><ul><li><a href="#çº¿ç¨‹æ•°" class="table-of-contents__link toc-highlight">çº¿ç¨‹æ•°</a></li><li><a href="#è¶…æ—¶" class="table-of-contents__link toc-highlight">è¶…æ—¶</a></li><li><a href="#é‡è¯•" class="table-of-contents__link toc-highlight">é‡è¯•</a></li><li><a href="#ç†”æ–­" class="table-of-contents__link toc-highlight">ç†”æ–­</a></li><li><a href="#è¿æ¥æ–¹å¼" class="table-of-contents__link toc-highlight">è¿æ¥æ–¹å¼</a></li><li><a href="#å…³ é—­è¿æ¥æ± ä¸­çš„é—²ç½®è¿æ¥" class="table-of-contents__link toc-highlight">å…³é—­è¿æ¥æ± ä¸­çš„é—²ç½®è¿æ¥</a></li><li><a href="#å»¶è¿Ÿå…³é—­è¿æ¥" class="table-of-contents__link toc-highlight">å»¶è¿Ÿå…³é—­è¿æ¥</a></li><li><a href="#è¿æ¥çš„ç¼“å†²åŒºå¤§å°" class="table-of-contents__link toc-highlight">è¿æ¥çš„ç¼“å†²åŒºå¤§å°</a></li><li><a href="#log_id" class="table-of-contents__link toc-highlight">log_id</a></li><li><a href="#é™„ä»¶" class="table-of-contents__link toc-highlight">é™„ä»¶</a></li><li><a href="#å¼€å¯ssl" class="table-of-contents__link toc-highlight">å¼€å¯SSL</a></li><li><a href="#è®¤è¯" class="table-of-contents__link toc-highlight">è®¤è¯</a></li><li><a href="#é‡ç½®" class="table-of-contents__link toc-highlight">é‡ç½®</a></li><li><a href="#å‹ç¼©" class="table-of-contents__link toc-highlight">å‹ç¼©</a></li></ul></li><li><a href="#faq" class="table-of-contents__link toc-highlight">FAQ</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">é˜…è¯»</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">æ–‡æ¡£</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/installation">å®‰è£…</a></li></ul></div><div class="col footer__col"><div class="footer__title">æ”¯æŒä¸èµ„æº</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/feature-requests">Feature Requests</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/community/support">Help</a></li></ul></div><div class="col footer__col"><div class="footer__title">æ›´å¤š</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">åšå®¢</a></li><li class="footer__item"><a class="footer__link-item" href="/changelog">æ›´æ–°</a></li><li class="footer__item"><a href="https://gitee.com/kumo-pub" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kumo-ai.tech" target="_blank" rel="noopener noreferrer" class="footer__link-item">ç½‘ç«™<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">ç‰ˆæƒ Â© 2025 åŒ—äº¬ç§‘ç±³æ™ºåˆ›ç§‘æŠ€æœ‰é™å…¬å¸</div></div></div></footer></div>
</body>
</html>